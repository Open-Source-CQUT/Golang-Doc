import{_ as p,V as e,W as o,X as s,Y as n,Z as c,$ as l,a0 as a,F as i}from"./framework-f06be456.js";const u={},d=a(`<h1 id="memory" tabindex="-1"><a class="header-anchor" href="#memory" aria-hidden="true">#</a> memory</h1><p>与传统的c/c++不同，go是一个gc语言，大多数情况下内存的分配和销毁由go来进行自动管理，一个对象的内存应该被分配到栈上还是堆上由编译器来进行决定，基本上不需要用户参与内存管理，用户要做的仅仅就是使用内存。在go中堆内存管理主要有两个大的组件，内存分配器负责堆内存的分配，垃圾回收器负责回收释放无用的堆内存，本文主要讲的就是内存分配器的工作方式，go内存分配器很大程度上受到了谷歌的TCMalloc内存分配器的影响。</p><h2 id="分配器" tabindex="-1"><a class="header-anchor" href="#分配器" aria-hidden="true">#</a> 分配器</h2><p>在go中有两种内存分配器，一种是线性分配器，另一种就是链式分配。</p><h3 id="线性分配" tabindex="-1"><a class="header-anchor" href="#线性分配" aria-hidden="true">#</a> 线性分配</h3><p>线性分配器对应着<code>runtime.linearAlloc</code>结构体，如下所示</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> linearAlloc <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	next   <span class="token builtin">uintptr</span> <span class="token comment">// next free byte</span>
	mapped <span class="token builtin">uintptr</span> <span class="token comment">// one byte past end of mapped space</span>
	end    <span class="token builtin">uintptr</span> <span class="token comment">// end of reserved space</span>

	mapMemory <span class="token builtin">bool</span> <span class="token comment">// transition memory from Reserved to Ready if true</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该分配器会向操作系统预先申请一片连续的内存空间，<code>next</code>指向可使用的内存地址，<code>end</code>指向内存空间的末尾地址，大概可以理解为下图。</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202401161928884.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>线性分配器的内存分配方式非常好理解，根据要申请的内存大小检查是否有足够的剩余空间来容纳，如果足够的话就更新<code>next</code>字段并返回剩余空间的起始地址，代码如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>linearAlloc<span class="token punctuation">)</span> <span class="token function">alloc</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> align <span class="token builtin">uintptr</span><span class="token punctuation">,</span> sysStat <span class="token operator">*</span>sysMemStat<span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer <span class="token punctuation">{</span>
	p <span class="token operator">:=</span> <span class="token function">alignUp</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>next<span class="token punctuation">,</span> align<span class="token punctuation">)</span>
	<span class="token keyword">if</span> p<span class="token operator">+</span>size <span class="token operator">&gt;</span> l<span class="token punctuation">.</span>end <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	l<span class="token punctuation">.</span>next <span class="token operator">=</span> p <span class="token operator">+</span> size
	<span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这种分配方式的优点就是快速和简单，缺点也相当明显，就是无法重新利用已释放的内存，因为<code>next</code>字段只会指向剩余的空间内存地址，对于先前已使用后被释放的内存空间则无法感知，这样做会造成很大的内存空间浪费，如下图所示。</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202401161941200.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>所以线性分配并不是go中主要的分配方式，它只在32位机器上作为内存预分配的功能来使用。</p><h3 id="链式分配" tabindex="-1"><a class="header-anchor" href="#链式分配" aria-hidden="true">#</a> 链式分配</h3><p>链式分配器器对应着结构体<code>runtime.fixalloc</code>，链式分配器分配的内存不是连续的，以单向链表的形式存在。链式分配器由若干个固定大小的内存块组成，而每一个内存块由若干个固定大小的内存片组成，每一次进行内存分配时，都会使用一个固定大小的内存片。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> fixalloc <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	size   <span class="token builtin">uintptr</span>
	first  <span class="token keyword">func</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> p unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token comment">// called first time p is returned</span>
	arg    unsafe<span class="token punctuation">.</span>Pointer
	list   <span class="token operator">*</span>mlink
	chunk  <span class="token builtin">uintptr</span> <span class="token comment">// use uintptr instead of unsafe.Pointer to avoid write barriers</span>
	nchunk <span class="token builtin">uint32</span>  <span class="token comment">// bytes remaining in current chunk</span>
	nalloc <span class="token builtin">uint32</span>  <span class="token comment">// size of new chunks in bytes</span>
	inuse  <span class="token builtin">uintptr</span> <span class="token comment">// in-use bytes now</span>
	stat   <span class="token operator">*</span>sysMemStat
	zero   <span class="token builtin">bool</span> <span class="token comment">// zero allocations</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> mlink <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token boolean">_</span>    sys<span class="token punctuation">.</span>NotInHeap
	next <span class="token operator">*</span>mlink
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它的字段不像线性分配器一样简单易懂，这里简单介绍一下重要的</p><ul><li><code>size</code>，指的是每次内存分配时使用多少的内存。</li><li><code>list</code>，指向可复用内存片的头节点，每一片内存空间的大小由<code>size</code>决定。</li><li><code>chunk</code>，指向当前正在使用的内存块中的空闲地址</li><li><code>nchunk</code>，当前内存块的剩余可用字节数</li><li><code>nalloc</code>， 内存块的大小，固定为16KB。</li><li><code>inuse</code>，总共已使用了多少字节的内存</li><li><code>zero</code>，在复用内存块时，是否将内存清零</li></ul><p>链式分配器持有着当前内存块和可复用内存片的引用，每一个内存块的大小都固定为16KB，这个值在初始化时就被设置好了。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> _FixAllocChunk <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span> 

<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>fixalloc<span class="token punctuation">)</span> <span class="token function">init</span><span class="token punctuation">(</span>size <span class="token builtin">uintptr</span><span class="token punctuation">,</span> first <span class="token keyword">func</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> p unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">,</span> arg unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> stat <span class="token operator">*</span>sysMemStat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> size <span class="token operator">&gt;</span> _FixAllocChunk <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: fixalloc size too large&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> min <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>mlink<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> size <span class="token operator">&lt;</span> min <span class="token punctuation">{</span>
		size <span class="token operator">=</span> min
	<span class="token punctuation">}</span>

	f<span class="token punctuation">.</span>size <span class="token operator">=</span> size
	f<span class="token punctuation">.</span>first <span class="token operator">=</span> first
	f<span class="token punctuation">.</span>arg <span class="token operator">=</span> arg
	f<span class="token punctuation">.</span>list <span class="token operator">=</span> <span class="token boolean">nil</span>
	f<span class="token punctuation">.</span>chunk <span class="token operator">=</span> <span class="token number">0</span>
	f<span class="token punctuation">.</span>nchunk <span class="token operator">=</span> <span class="token number">0</span>
	f<span class="token punctuation">.</span>nalloc <span class="token operator">=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>_FixAllocChunk <span class="token operator">/</span> size <span class="token operator">*</span> size<span class="token punctuation">)</span>
	f<span class="token punctuation">.</span>inuse <span class="token operator">=</span> <span class="token number">0</span>
	f<span class="token punctuation">.</span>stat <span class="token operator">=</span> stat
	f<span class="token punctuation">.</span>zero <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>内存块的分布如下图所示，图中的内存块是按照创建时间的先后来进行排列的，实际上它们的地址是不连续的。</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202401162113071.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>链式分配器每一次分配的内存大小也是固定的，由<code>fixalloc.size</code>来决定，在分配时会首先检查是否有可复用的内存块，如果有的话则优先使用复用内存块，然后才会去使用当前的内存块，如果当前的内存块的剩余空间不足以容纳就会创建一个新的内存块，这部分逻辑对应如下代码。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>fixalloc<span class="token punctuation">)</span> <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer <span class="token punctuation">{</span>
	<span class="token keyword">if</span> f<span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: use of FixAlloc_Alloc before FixAlloc_Init\\n&quot;</span><span class="token punctuation">)</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: internal error&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> f<span class="token punctuation">.</span>list <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		v <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>list<span class="token punctuation">)</span>
		f<span class="token punctuation">.</span>list <span class="token operator">=</span> f<span class="token punctuation">.</span>list<span class="token punctuation">.</span>next
		f<span class="token punctuation">.</span>inuse <span class="token operator">+=</span> f<span class="token punctuation">.</span>size
		<span class="token keyword">if</span> f<span class="token punctuation">.</span>zero <span class="token punctuation">{</span>
			<span class="token function">memclrNoHeapPointers</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> f<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> v
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>nchunk<span class="token punctuation">)</span> <span class="token operator">&lt;</span> f<span class="token punctuation">.</span>size <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span>chunk <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">persistentalloc</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>nalloc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>stat<span class="token punctuation">)</span><span class="token punctuation">)</span>
		f<span class="token punctuation">.</span>nchunk <span class="token operator">=</span> f<span class="token punctuation">.</span>nalloc
	<span class="token punctuation">}</span>

	v <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>chunk<span class="token punctuation">)</span>
	<span class="token keyword">if</span> f<span class="token punctuation">.</span>first <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>arg<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	f<span class="token punctuation">.</span>chunk <span class="token operator">=</span> f<span class="token punctuation">.</span>chunk <span class="token operator">+</span> f<span class="token punctuation">.</span>size
	f<span class="token punctuation">.</span>nchunk <span class="token operator">-=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
	f<span class="token punctuation">.</span>inuse <span class="token operator">+=</span> f<span class="token punctuation">.</span>size
	<span class="token keyword">return</span> v
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>链式分配器的优点正是它可以复用被释放的内存，复用内存的基本单位是一个固定大小的内存片，其大小由<code>fixalloc.size</code>决定，在释放内存时，链式分配器会将该内存片作为头结点添加到空闲内存片链表中，代码如下所示</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>fixalloc<span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>p unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>inuse <span class="token operator">-=</span> f<span class="token punctuation">.</span>size
	v <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>mlink<span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
	v<span class="token punctuation">.</span>next <span class="token operator">=</span> f<span class="token punctuation">.</span>list
	f<span class="token punctuation">.</span>list <span class="token operator">=</span> v
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="内存组件" tabindex="-1"><a class="header-anchor" href="#内存组件" aria-hidden="true">#</a> 内存组件</h2><p>go中的内存分配器主要由<code>msapn</code>，<code>heaparena</code>，<code>mcache</code>，<code>mcentral</code>，<code>mheap</code>这几个组件构成，它们之间层层作用，管理着整个go的堆内存。</p><h3 id="mspan" tabindex="-1"><a class="header-anchor" href="#mspan" aria-hidden="true">#</a> mspan</h3><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202401171636976.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><code>runtime.mspan</code>是go内存分配中基本的单位，其结构如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> mspan <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    next <span class="token operator">*</span>mspan     <span class="token comment">// next span in list, or nil if none</span>
    prev <span class="token operator">*</span>mspan     <span class="token comment">// previous span in list, or nil if none</span>

    startAddr <span class="token builtin">uintptr</span> <span class="token comment">// address of first byte of span aka s.base()</span>
    npages    <span class="token builtin">uintptr</span> <span class="token comment">// number of pages in span</span>
    freeindex <span class="token builtin">uintptr</span>

    spanclass             spanClass     <span class="token comment">// size class and noscan (uint8)</span>
    needzero              <span class="token builtin">uint8</span>         <span class="token comment">// needs to be zeroed before allocation</span>
    elemsize              <span class="token builtin">uintptr</span>       <span class="token comment">// computed from sizeclass or from npages</span>
    limit                 <span class="token builtin">uintptr</span>       <span class="token comment">// end of data in span</span>
    state                 mSpanStateBox <span class="token comment">// mSpanInUse etc; accessed atomically (get/set methods)</span>

    nelems <span class="token builtin">uintptr</span> <span class="token comment">// number of object in the span.</span>
    allocCache <span class="token builtin">uint64</span>
    allocCount            <span class="token builtin">uint16</span>        <span class="token comment">// number of allocated objects</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>mspan</code>与<code>mspan</code>之间以双向链表的形式通过<code>next</code>和<code>prev</code>进行链接，内存地址并不连续。每一个<code>msapn</code>管理着<code>mspan.npages</code>个<code>runtime.pageSize</code>大小的页内存，通常来说页的大小就是8KB，并且由<code>mspan.startAddr</code>记录着这些页的起始地址和<code>mspan.limit</code>记录着已使用内存的末端地址。每一个<code>mspan</code>所存放的元素大小<code>elemsize</code>是固定的，所以能容纳的元素数量也是固定的。由于数量固定，对象存放就像是数组一样分布在<code>mspan</code>中，范围为<code>[0, nelems]</code>，同时由<code>freeindex</code>记录着下一个可用于存放对象的索引。<code>mspan</code>总共有三种状态</p><ul><li>mSpanDead，内存已经被释放</li><li>mSpanInUse，被分配到了堆上</li><li>mSpanManual，被分配到了用于手动管理内存的部分，比如说栈。</li></ul><p>决定着<code>mspan</code>元素大小的是<code>spanClass</code>，<code>spanClass</code>自身是一个<code>uint8</code>类型的整数，高七位存放着表示<code>0-67</code>的class值，最后一位用于表示<code>noscan</code>即是否包含指针。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> spanClass <span class="token builtin">uint8</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>sc spanClass<span class="token punctuation">)</span> <span class="token function">sizeclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int8</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">int8</span><span class="token punctuation">(</span>sc <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>sc spanClass<span class="token punctuation">)</span> <span class="token function">noscan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> sc<span class="token operator">&amp;</span><span class="token number">1</span> <span class="token operator">!=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它总共有68种不同的值，所有值都以打表的形式存放于<code>runtime.sizeclasses.go</code>文件中，在运行时，使用<code>spanClass</code>通过<code>runtime.class_to_size</code>可获得<code>mspan</code>的对象大小，通过<code>class_to_allocnpages</code>可获得<code>mspan</code>的页数。</p><table><thead><tr><th>class</th><th>最大对象大小</th><th>span大小</th><th>对象数量</th><th>尾部浪费</th><th>最大内存浪费率</th><th>最小对齐</th></tr></thead><tbody><tr><td>1</td><td>8</td><td>8192</td><td>1024</td><td>0</td><td>87.50%</td><td>8</td></tr><tr><td>2</td><td>16</td><td>8192</td><td>512</td><td>0</td><td>43.75%</td><td>16</td></tr><tr><td>3</td><td>24</td><td>8192</td><td>341</td><td>8</td><td>29.24%</td><td>8</td></tr><tr><td>4</td><td>32</td><td>8192</td><td>256</td><td>0</td><td>21.88%</td><td>32</td></tr><tr><td>5</td><td>48</td><td>8192</td><td>170</td><td>32</td><td>31.52%</td><td>16</td></tr><tr><td>6</td><td>64</td><td>8192</td><td>128</td><td>0</td><td>23.44%</td><td>64</td></tr><tr><td>7</td><td>80</td><td>8192</td><td>102</td><td>32</td><td>19.07%</td><td>16</td></tr><tr><td>8</td><td>96</td><td>8192</td><td>85</td><td>32</td><td>15.95%</td><td>32</td></tr><tr><td>9</td><td>112</td><td>8192</td><td>73</td><td>16</td><td>13.56%</td><td>16</td></tr><tr><td>10</td><td>128</td><td>8192</td><td>64</td><td>0</td><td>11.72%</td><td>128</td></tr><tr><td>11</td><td>144</td><td>8192</td><td>56</td><td>128</td><td>11.82%</td><td>16</td></tr><tr><td>12</td><td>160</td><td>8192</td><td>51</td><td>32</td><td>9.73%</td><td>32</td></tr><tr><td>13</td><td>176</td><td>8192</td><td>46</td><td>96</td><td>9.59%</td><td>16</td></tr><tr><td>14</td><td>192</td><td>8192</td><td>42</td><td>128</td><td>9.25%</td><td>64</td></tr><tr><td>15</td><td>208</td><td>8192</td><td>39</td><td>80</td><td>8.12%</td><td>16</td></tr><tr><td>16</td><td>224</td><td>8192</td><td>36</td><td>128</td><td>8.15%</td><td>32</td></tr><tr><td>17</td><td>240</td><td>8192</td><td>34</td><td>32</td><td>6.62%</td><td>16</td></tr><tr><td>18</td><td>256</td><td>8192</td><td>32</td><td>0</td><td>5.86%</td><td>256</td></tr><tr><td>19</td><td>288</td><td>8192</td><td>28</td><td>128</td><td>12.16%</td><td>32</td></tr><tr><td>20</td><td>320</td><td>8192</td><td>25</td><td>192</td><td>11.80%</td><td>64</td></tr><tr><td>21</td><td>352</td><td>8192</td><td>23</td><td>96</td><td>9.88%</td><td>32</td></tr><tr><td>22</td><td>384</td><td>8192</td><td>21</td><td>128</td><td>9.51%</td><td>128</td></tr><tr><td>23</td><td>416</td><td>8192</td><td>19</td><td>288</td><td>10.71%</td><td>32</td></tr><tr><td>24</td><td>448</td><td>8192</td><td>18</td><td>128</td><td>8.37%</td><td>64</td></tr><tr><td>25</td><td>480</td><td>8192</td><td>17</td><td>32</td><td>6.82%</td><td>32</td></tr><tr><td>26</td><td>512</td><td>8192</td><td>16</td><td>0</td><td>6.05%</td><td>512</td></tr><tr><td>27</td><td>576</td><td>8192</td><td>14</td><td>128</td><td>12.33%</td><td>64</td></tr><tr><td>28</td><td>640</td><td>8192</td><td>12</td><td>512</td><td>15.48%</td><td>128</td></tr><tr><td>29</td><td>704</td><td>8192</td><td>11</td><td>448</td><td>13.93%</td><td>64</td></tr><tr><td>30</td><td>768</td><td>8192</td><td>10</td><td>512</td><td>13.94%</td><td>256</td></tr><tr><td>31</td><td>896</td><td>8192</td><td>9</td><td>128</td><td>15.52%</td><td>128</td></tr><tr><td>32</td><td>1024</td><td>8192</td><td>8</td><td>0</td><td>12.40%</td><td>1024</td></tr><tr><td>33</td><td>1152</td><td>8192</td><td>7</td><td>128</td><td>12.41%</td><td>128</td></tr><tr><td>34</td><td>1280</td><td>8192</td><td>6</td><td>512</td><td>15.55%</td><td>256</td></tr><tr><td>35</td><td>1408</td><td>16384</td><td>11</td><td>896</td><td>14.00%</td><td>128</td></tr><tr><td>36</td><td>1536</td><td>8192</td><td>5</td><td>512</td><td>14.00%</td><td>512</td></tr><tr><td>37</td><td>1792</td><td>16384</td><td>9</td><td>256</td><td>15.57%</td><td>256</td></tr><tr><td>38</td><td>2048</td><td>8192</td><td>4</td><td>0</td><td>12.45%</td><td>2048</td></tr><tr><td>39</td><td>2304</td><td>16384</td><td>7</td><td>256</td><td>12.46%</td><td>256</td></tr><tr><td>40</td><td>2688</td><td>8192</td><td>3</td><td>128</td><td>15.59%</td><td>128</td></tr><tr><td>41</td><td>3072</td><td>24576</td><td>8</td><td>0</td><td>12.47%</td><td>1024</td></tr><tr><td>42</td><td>3200</td><td>16384</td><td>5</td><td>384</td><td>6.22%</td><td>128</td></tr><tr><td>43</td><td>3456</td><td>24576</td><td>7</td><td>384</td><td>8.83%</td><td>128</td></tr><tr><td>44</td><td>4096</td><td>8192</td><td>2</td><td>0</td><td>15.60%</td><td>4096</td></tr><tr><td>45</td><td>4864</td><td>24576</td><td>5</td><td>256</td><td>16.65%</td><td>256</td></tr><tr><td>46</td><td>5376</td><td>16384</td><td>3</td><td>256</td><td>10.92%</td><td>256</td></tr><tr><td>47</td><td>6144</td><td>24576</td><td>4</td><td>0</td><td>12.48%</td><td>2048</td></tr><tr><td>48</td><td>6528</td><td>32768</td><td>5</td><td>128</td><td>6.23%</td><td>128</td></tr><tr><td>49</td><td>6784</td><td>40960</td><td>6</td><td>256</td><td>4.36%</td><td>128</td></tr><tr><td>50</td><td>6912</td><td>49152</td><td>7</td><td>768</td><td>3.37%</td><td>256</td></tr><tr><td>51</td><td>8192</td><td>8192</td><td>1</td><td>0</td><td>15.61%</td><td>8192</td></tr><tr><td>52</td><td>9472</td><td>57344</td><td>6</td><td>512</td><td>14.28%</td><td>256</td></tr><tr><td>53</td><td>9728</td><td>49152</td><td>5</td><td>512</td><td>3.64%</td><td>512</td></tr><tr><td>54</td><td>10240</td><td>40960</td><td>4</td><td>0</td><td>4.99%</td><td>2048</td></tr><tr><td>55</td><td>10880</td><td>32768</td><td>3</td><td>128</td><td>6.24%</td><td>128</td></tr><tr><td>56</td><td>12288</td><td>24576</td><td>2</td><td>0</td><td>11.45%</td><td>4096</td></tr><tr><td>57</td><td>13568</td><td>40960</td><td>3</td><td>256</td><td>9.99%</td><td>256</td></tr><tr><td>58</td><td>14336</td><td>57344</td><td>4</td><td>0</td><td>5.35%</td><td>2048</td></tr><tr><td>59</td><td>16384</td><td>16384</td><td>1</td><td>0</td><td>12.49%</td><td>8192</td></tr><tr><td>60</td><td>18432</td><td>73728</td><td>4</td><td>0</td><td>11.11%</td><td>2048</td></tr><tr><td>61</td><td>19072</td><td>57344</td><td>3</td><td>128</td><td>3.57%</td><td>128</td></tr><tr><td>62</td><td>20480</td><td>40960</td><td>2</td><td>0</td><td>6.87%</td><td>4096</td></tr><tr><td>63</td><td>21760</td><td>65536</td><td>3</td><td>256</td><td>6.25%</td><td>256</td></tr><tr><td>64</td><td>24576</td><td>24576</td><td>1</td><td>0</td><td>11.45%</td><td>8192</td></tr><tr><td>65</td><td>27264</td><td>81920</td><td>3</td><td>128</td><td>10.00%</td><td>128</td></tr><tr><td>66</td><td>28672</td><td>57344</td><td>2</td><td>0</td><td>4.91%</td><td>4096</td></tr><tr><td>67</td><td>32768</td><td>32768</td><td>1</td><td>0</td><td>12.50%</td><td>8192</td></tr></tbody></table><p>关于这些值的计算逻辑可以在<code>runtime.mksizeclasses.go</code>的<code>printComment</code>函数中找到，其中的最大内存浪费率的计算公式为</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token function">float64</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size<span class="token operator">-</span>prevSize<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>objects<span class="token operator">+</span>tailWaste<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">float64</span><span class="token punctuation">(</span>spanSize<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>例如，当<code>class</code>为2，其最大内存浪费率为</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>((16-8-1)*512+0)/8192 = 0.4375
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>当<code>class</code>值为0时，就是专用于分配大于32KB以上的大对象所使用的<code>spanClass</code>，基本上一个大对象就会占用一个<code>mspan</code>。所以，go的堆内存实际上是由若干个不同固定大小的<code>mspan</code>组成。</p><h3 id="heaparena" tabindex="-1"><a class="header-anchor" href="#heaparena" aria-hidden="true">#</a> heaparena</h3><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202401171728032.png" style="zoom:67%;"><p>前面提到了<code>mspan</code>是由若干个页组成，但<code>mspan</code>只是持有页的地址引用，并不负责管理这些页，真正负责管理这些页内存的是<code>runtime.heaparena</code>。每一个<code>heaparena</code>管理着若干个页，<code>heaparena</code>的大小由<code>runtime.heapArenaBytes</code>决定，通常是64MB。<code>bitmap</code>用于标识页中对应的地址是否存放了对象，<code>zeroedBase</code>就是该<code>heaparena</code>所管理的页内存的起始地址，并且由<code>spans</code>记录着每一个页由哪个<code>mspan</code>使用。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> heapArena <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token boolean">_</span> sys<span class="token punctuation">.</span>NotInHeap
	bitmap <span class="token punctuation">[</span>heapArenaBitmapWords<span class="token punctuation">]</span><span class="token builtin">uintptr</span>
	noMorePtrs <span class="token punctuation">[</span>heapArenaBitmapWords <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token builtin">uint8</span>
	spans <span class="token punctuation">[</span>pagesPerArena<span class="token punctuation">]</span><span class="token operator">*</span>mspan
	pageInUse <span class="token punctuation">[</span>pagesPerArena <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token builtin">uint8</span>
	pageMarks <span class="token punctuation">[</span>pagesPerArena <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token builtin">uint8</span>
	pageSpecials <span class="token punctuation">[</span>pagesPerArena <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token builtin">uint8</span>
	checkmarks <span class="token operator">*</span>checkmarksMap
	zeroedBase <span class="token builtin">uintptr</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有关于页与<code>mspan</code>记录的逻辑可以在<code>mheap.setSpans</code>方法中找到，如下所示</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>mheap<span class="token punctuation">)</span> <span class="token function">setSpans</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> npage <span class="token builtin">uintptr</span><span class="token punctuation">,</span> s <span class="token operator">*</span>mspan<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p <span class="token operator">:=</span> base <span class="token operator">/</span> pageSize
	ai <span class="token operator">:=</span> <span class="token function">arenaIndex</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
	ha <span class="token operator">:=</span> h<span class="token punctuation">.</span>arenas<span class="token punctuation">[</span>ai<span class="token punctuation">.</span><span class="token function">l1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>ai<span class="token punctuation">.</span><span class="token function">l2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> npage<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
		i <span class="token operator">:=</span> <span class="token punctuation">(</span>p <span class="token operator">+</span> n<span class="token punctuation">)</span> <span class="token operator">%</span> pagesPerArena
		<span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			ai <span class="token operator">=</span> <span class="token function">arenaIndex</span><span class="token punctuation">(</span>base <span class="token operator">+</span> n<span class="token operator">*</span>pageSize<span class="token punctuation">)</span>
			ha <span class="token operator">=</span> h<span class="token punctuation">.</span>arenas<span class="token punctuation">[</span>ai<span class="token punctuation">.</span><span class="token function">l1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>ai<span class="token punctuation">.</span><span class="token function">l2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
		ha<span class="token punctuation">.</span>spans<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> s
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在go堆中，是由一个二维的<code>heaparena</code>数组来管理所有的页内存，参见<code>mheap.arenas</code>字段。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> mheap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	arenas <span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> arenaL1Bits<span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> arenaL2Bits<span class="token punctuation">]</span><span class="token operator">*</span>heapArena
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在64位windows平台上，数组的一维是<code>1 &lt;&lt; 6</code>，二维是<code>1 &lt;&lt; 16</code>，在64位linux平台上，一维则是1，二维就是<code>1 &lt;&lt; 22</code>。这个由所有<code>heaparena</code>组成的二维数组就构成了go运行时的虚拟内存空间，总体来看就如下图所示。</p><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202401172000568.png" style="zoom:50%;"><p>尽管<code>heaparena</code>之间是相邻的，但它们所管理的页内存之间是不连续的。</p><h3 id="mcache" tabindex="-1"><a class="header-anchor" href="#mcache" aria-hidden="true">#</a> mcache</h3>`,56),r=s("code",null,"mcache",-1),k=s("code",null,"runtime.mcache",-1),v=s("code",null,"mcache",-1),m=s("code",null,"mcache",-1),b=s("code",null,"mspan",-1),g=s("code",null,"alloc",-1),h=s("code",null,"136",-1),f=s("code",null,"spanClass",-1),y=s("code",null,"tiny",-1),w=s("code",null,"tiny",-1),x=s("code",null,"tinyoffset",-1),z=s("code",null,"tinyAllocs",-1),S=s("code",null,"stackcached",-1),_=a(`<div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> mcache <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token boolean">_</span> sys<span class="token punctuation">.</span>NotInHeap

    nextSample <span class="token builtin">uintptr</span> <span class="token comment">// trigger heap sample after allocating this many bytes</span>
    scanAlloc  <span class="token builtin">uintptr</span> <span class="token comment">// bytes of scannable heap allocated</span>
    tiny       <span class="token builtin">uintptr</span>
    tinyoffset <span class="token builtin">uintptr</span>
    tinyAllocs <span class="token builtin">uintptr</span>

    alloc <span class="token punctuation">[</span>numSpanClasses<span class="token punctuation">]</span><span class="token operator">*</span>mspan
    stackcache <span class="token punctuation">[</span>_NumStackOrders<span class="token punctuation">]</span>stackfreelist
    flushGen atomic<span class="token punctuation">.</span>Uint32
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在刚初始化时，<code>mcache</code>中的<code>alloc</code>中的链表都只包含一个空的头结点<code>runtime.emptymspan</code>，也就是没有可用内存的<code>mspan</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">allocmcache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>mcache <span class="token punctuation">{</span>
	<span class="token keyword">var</span> c <span class="token operator">*</span>mcache
	<span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mheap_<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>mcache<span class="token punctuation">)</span><span class="token punctuation">(</span>mheap_<span class="token punctuation">.</span>cachealloc<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>flushGen<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>mheap_<span class="token punctuation">.</span>sweepgen<span class="token punctuation">)</span>
		<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mheap_<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>alloc <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>emptymspan
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>nextSample <span class="token operator">=</span> <span class="token function">nextSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>仅当在需要进行内存分配时，才会向<code>mcentral</code>申请一个新的<code>mspan</code>来替换原来的空span，这部分的工作由<code>mcache.refill</code>方法完成，它唯一的调用入口就是<code>runtime.mallocgc</code>函数，下面是简化后的代码。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>mcache<span class="token punctuation">)</span> <span class="token function">refill</span><span class="token punctuation">(</span>spc spanClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Return the current cached span to the central lists.</span>
	s <span class="token operator">:=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span>

	<span class="token comment">// Get a new cached span from the central lists.</span>
	s <span class="token operator">=</span> mheap_<span class="token punctuation">.</span>central<span class="token punctuation">[</span>spc<span class="token punctuation">]</span><span class="token punctuation">.</span>mcentral<span class="token punctuation">.</span><span class="token function">cacheSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;out of memory&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	c<span class="token punctuation">.</span>scanAlloc <span class="token operator">=</span> <span class="token number">0</span>

	c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span> <span class="token operator">=</span> s
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用<code>mcache</code>的好处在于内存分配时不需要全局锁，不过当其内存不足时需要访问<code>mcentral</code>，这时仍然需要加锁。</p><h3 id="mcentral" tabindex="-1"><a class="header-anchor" href="#mcentral" aria-hidden="true">#</a> mcentral</h3><p><code>runtime.mcentral</code>管理着堆中所有存放着小对象的<code>mspan</code>，在<code>mcache</code>申请内存时也是由<code>mcentral</code>进行分配。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> mcentral <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token boolean">_</span>         sys<span class="token punctuation">.</span>NotInHeap
    spanclass spanClass
    partial <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>spanSet
    full    <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>spanSet
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>mcentral</code>的字段很少，<code>spanClass</code>表示所存储的<code>mspan</code>类型，<code>partial</code>和<code>full</code>是两个<code>spanSet</code>，前者存放有空闲内存的<code>mspan</code>，后者存放无空闲内存的<code>mspan</code>。<code>mcentral</code>由<code>mheap</code>堆直接进行管理，在运行时总共有136个<code>mcentral</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> mheap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    central <span class="token punctuation">[</span>numSpanClasses<span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        mcentral mcentral
        pad      <span class="token punctuation">[</span><span class="token punctuation">(</span>cpu<span class="token punctuation">.</span>CacheLinePadSize <span class="token operator">-</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>mcentral<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">%</span>cpu<span class="token punctuation">.</span>CacheLinePadSize<span class="token punctuation">)</span> <span class="token operator">%</span> cpu<span class="token punctuation">.</span>CacheLinePadSize<span class="token punctuation">]</span><span class="token builtin">byte</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>mcentral</code>主要负责两个工作，当内存足够时向<code>mcache</code>分配可用的<code>mspan</code>，当内存不足时向<code>mheap</code>申请分配一个新的<code>mspan</code>。向<code>mcache</code>分配<code>mspan</code>的工作由<code>mcentral.cacheSpan</code>方法来完成。首先会在空闲列表的已清扫集合中寻找可用的<code>mspan</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Try partial swept spans first.</span>
sg <span class="token operator">:=</span> mheap_<span class="token punctuation">.</span>sweepgen
<span class="token keyword">if</span> s <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">partialSwept</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> s <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">goto</span> havespan
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果没找到，就在空闲列表的未清扫集合中寻找可用的<code>mspan</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token punctuation">;</span> spanBudget <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> spanBudget<span class="token operator">--</span> <span class="token punctuation">{</span>
    s <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">partialUnswept</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> s<span class="token punctuation">,</span> ok <span class="token operator">:=</span> sl<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        s<span class="token punctuation">.</span><span class="token function">sweep</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        sweep<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> havespan
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果仍然没有找到，就到非空闲列表的未清扫集合去寻找</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token punctuation">;</span> spanBudget <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> spanBudget<span class="token operator">--</span> <span class="token punctuation">{</span>
    s <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">fullUnswept</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> s<span class="token punctuation">,</span> ok <span class="token operator">:=</span> sl<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        s<span class="token punctuation">.</span><span class="token function">sweep</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        freeIndex <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">nextFreeIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> freeIndex <span class="token operator">!=</span> s<span class="token punctuation">.</span>nelems <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>freeindex <span class="token operator">=</span> freeIndex
            sweep<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> havespan
        <span class="token punctuation">}</span>
        c<span class="token punctuation">.</span><span class="token function">fullSwept</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>mspan<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果最终还是没有找到，那么就会由<code>mcentral.grow</code>方法向<code>mheap</code>申请分配一个新的<code>mspan</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>s <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">grow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在正常情况下，无论如何都会返回一个可用的<code>mspan</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>havespan<span class="token punctuation">:</span>
	freeByteBase <span class="token operator">:=</span> s<span class="token punctuation">.</span>freeindex <span class="token operator">&amp;^</span> <span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
	whichByte <span class="token operator">:=</span> freeByteBase <span class="token operator">/</span> <span class="token number">8</span>
	<span class="token comment">// Init alloc bits cache.</span>
	s<span class="token punctuation">.</span><span class="token function">refillAllocCache</span><span class="token punctuation">(</span>whichByte<span class="token punctuation">)</span>
	s<span class="token punctuation">.</span>allocCache <span class="token operator">&gt;&gt;=</span> s<span class="token punctuation">.</span>freeindex <span class="token operator">%</span> <span class="token number">64</span>

	<span class="token keyword">return</span> s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于向<code>mheap</code>申请<code>mspan</code>的过程，实则是调用了<code>mheap.alloc</code>方法，该方法会返回一个新的<code>mspan</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>mcentral<span class="token punctuation">)</span> <span class="token function">grow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>mspan <span class="token punctuation">{</span>
	npages <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>class_to_allocnpages<span class="token punctuation">[</span>c<span class="token punctuation">.</span>spanclass<span class="token punctuation">.</span><span class="token function">sizeclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	size <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>class_to_size<span class="token punctuation">[</span>c<span class="token punctuation">.</span>spanclass<span class="token punctuation">.</span><span class="token function">sizeclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

	s <span class="token operator">:=</span> mheap_<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>npages<span class="token punctuation">,</span> c<span class="token punctuation">.</span>spanclass<span class="token punctuation">)</span>
	<span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
    
	n <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">divideByElemSize</span><span class="token punctuation">(</span>npages <span class="token operator">&lt;&lt;</span> _PageShift<span class="token punctuation">)</span>
	s<span class="token punctuation">.</span>limit <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> size<span class="token operator">*</span>n
	s<span class="token punctuation">.</span><span class="token function">initHeapBits</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将其初始化好后就可以分配给<code>mcache</code>使用。</p><h3 id="mheap" tabindex="-1"><a class="header-anchor" href="#mheap" aria-hidden="true">#</a> mheap</h3><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202401172225849.png" style="zoom:50%;"><p><code>runtimme.mheap</code>是go语言堆内存的管理者，在运行时它作为全局变量<code>runtime.mheap_</code>而存在。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> mheap_ mheap
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>它管理着所有被创建的<code>mspan</code>，所有的<code>mcentral</code>，以及所有的<code>heaparena</code>，还有许多其它的各式各样的分配器，其简化后的结构如下所示</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> mheap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token boolean">_</span> sys<span class="token punctuation">.</span>NotInHeap

    lock mutex

    allspans <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>mspan <span class="token comment">// all spans out there</span>

    pagesInUse         atomic<span class="token punctuation">.</span>Uintptr <span class="token comment">// pages of spans in stats mSpanInUse</span>
    pagesSwept         atomic<span class="token punctuation">.</span>Uint64  <span class="token comment">// pages swept this cycle</span>
    pagesSweptBasis    atomic<span class="token punctuation">.</span>Uint64  <span class="token comment">// pagesSwept to use as the origin of the sweep ratio</span>

    arenas <span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> arenaL1Bits<span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> arenaL2Bits<span class="token punctuation">]</span><span class="token operator">*</span>heapArena
    allArenas <span class="token punctuation">[</span><span class="token punctuation">]</span>arenaIdx
    sweepArenas <span class="token punctuation">[</span><span class="token punctuation">]</span>arenaIdx
    central <span class="token punctuation">[</span>numSpanClasses<span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        mcentral mcentral
        pad      <span class="token punctuation">[</span><span class="token punctuation">(</span>cpu<span class="token punctuation">.</span>CacheLinePadSize <span class="token operator">-</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>mcentral<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">%</span>cpu<span class="token punctuation">.</span>CacheLinePadSize<span class="token punctuation">)</span> <span class="token operator">%</span> cpu<span class="token punctuation">.</span>CacheLinePadSize<span class="token punctuation">]</span><span class="token builtin">byte</span>
    <span class="token punctuation">}</span>

    pages 				   pageAlloc <span class="token comment">// page allocation data structure</span>
    spanalloc              fixalloc <span class="token comment">// allocator for span*</span>
    cachealloc             fixalloc <span class="token comment">// allocator for mcache*</span>
    specialfinalizeralloc  fixalloc <span class="token comment">// allocator for specialfinalizer*</span>
    specialprofilealloc    fixalloc <span class="token comment">// allocator for specialprofile*</span>
    specialReachableAlloc  fixalloc <span class="token comment">// allocator for specialReachable</span>
    specialPinCounterAlloc fixalloc <span class="token comment">// allocator for specialPinCounter</span>
    arenaHintAlloc         fixalloc <span class="token comment">// allocator for arenaHints</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于<code>mheap</code>而言，在运行时主要有以下四个工作要做</p><ul><li>初始化堆</li><li>分配<code>mspan</code></li><li>释放<code>mspan</code></li><li>堆扩容</li></ul><p>下面按照顺序来讲讲这四件事。</p><h4 id="初始化" tabindex="-1"><a class="header-anchor" href="#初始化" aria-hidden="true">#</a> 初始化</h4><p>堆的初始化时期位于程序的引导阶段，同时也是调度器的初始化阶段，其调用顺序为</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token function">schedinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">mallocinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> mheap_<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在初始化时期，它主要是负责执行各个分配器的初始化工作</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>mheap<span class="token punctuation">)</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	h<span class="token punctuation">.</span>spanalloc<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>mspan<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> recordspan<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>mspan_sys<span class="token punctuation">)</span>
	h<span class="token punctuation">.</span>cachealloc<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>mcache<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>mcache_sys<span class="token punctuation">)</span>
	h<span class="token punctuation">.</span>specialfinalizeralloc<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>specialfinalizer<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>other_sys<span class="token punctuation">)</span>
	h<span class="token punctuation">.</span>specialprofilealloc<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>specialprofile<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>other_sys<span class="token punctuation">)</span>
	h<span class="token punctuation">.</span>specialReachableAlloc<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>specialReachable<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>other_sys<span class="token punctuation">)</span>
	h<span class="token punctuation">.</span>specialPinCounterAlloc<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>specialPinCounter<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>other_sys<span class="token punctuation">)</span>
	h<span class="token punctuation">.</span>arenaHintAlloc<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>arenaHint<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>other_sys<span class="token punctuation">)</span>

	h<span class="token punctuation">.</span>spanalloc<span class="token punctuation">.</span>zero <span class="token operator">=</span> <span class="token boolean">false</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> h<span class="token punctuation">.</span>central <span class="token punctuation">{</span>
		h<span class="token punctuation">.</span>central<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mcentral<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token function">spanClass</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	h<span class="token punctuation">.</span>pages<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>gcMiscSys<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中就包括了负责分配<code>mspan</code>的分配器<code>mheap.spanalloc</code>和负责页分配的分配器<code>mheap.pages</code>，以及所有<code>mcentral</code>的初始化。</p><h4 id="分配" tabindex="-1"><a class="header-anchor" href="#分配" aria-hidden="true">#</a> 分配</h4><p>在<code>mheap</code>中，<code>mspan</code>的分配都由<code>mheap.allocSpan</code>方法来完成</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>mheap<span class="token punctuation">)</span> <span class="token function">allocSpan</span><span class="token punctuation">(</span>npages <span class="token builtin">uintptr</span><span class="token punctuation">,</span> typ spanAllocType<span class="token punctuation">,</span> spanclass spanClass<span class="token punctuation">)</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>mspan<span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果申请分配的内存足够小，即满足<code>npages &lt; pageCachePages/4</code>，那么就会尝试不加锁在本地的P中的<code>mspan</code>缓存中去获取一个可用的<code>mspan</code>，倘若P的缓存是空的话，还会先进行初始化</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// If the cache is empty, refill it.</span>
<span class="token keyword">if</span> c<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
    <span class="token operator">*</span>c <span class="token operator">=</span> h<span class="token punctuation">.</span>pages<span class="token punctuation">.</span><span class="token function">allocToCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后再从P缓存中获取，由<code>mheap.tryAllocMSpan</code>方法完成。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>pp <span class="token operator">:=</span> gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token operator">!</span>needPhysPageAlign <span class="token operator">&amp;&amp;</span> pp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> npages <span class="token operator">&lt;</span> pageCachePages<span class="token operator">/</span><span class="token number">4</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>pcache
    base<span class="token punctuation">,</span> scav <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>npages<span class="token punctuation">)</span>
    <span class="token keyword">if</span> base <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        s <span class="token operator">=</span> h<span class="token punctuation">.</span><span class="token function">tryAllocMSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> s <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">goto</span> HaveSpan
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从P缓存中获取<code>mspan</code>的代码如下，它会尝试获取缓存中最后一个<code>mspan</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>mheap<span class="token punctuation">)</span> <span class="token function">tryAllocMSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>mspan <span class="token punctuation">{</span>
	pp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// If we don&#39;t have a p or the cache is empty, we can&#39;t do</span>
	<span class="token comment">// anything here.</span>
	<span class="token keyword">if</span> pp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span><span class="token builtin">len</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Pull off the last entry in the cache.</span>
	s <span class="token operator">:=</span> pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span>buf<span class="token punctuation">[</span>pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span><span class="token builtin">len</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span><span class="token builtin">len</span><span class="token operator">--</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果申请的内存比较大的话，就会在堆上分配内存，这个过程中需要持有锁</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>	
<span class="token keyword">if</span> base <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token comment">// Try to acquire a base address.</span>
    base<span class="token punctuation">,</span> scav <span class="token operator">=</span> h<span class="token punctuation">.</span>pages<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>npages<span class="token punctuation">)</span>
    <span class="token keyword">if</span> base <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> ok <span class="token builtin">bool</span>
        growth<span class="token punctuation">,</span> ok <span class="token operator">=</span> h<span class="token punctuation">.</span><span class="token function">grow</span><span class="token punctuation">(</span>npages<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        base<span class="token punctuation">,</span> scav <span class="token operator">=</span> h<span class="token punctuation">.</span>pages<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>npages<span class="token punctuation">)</span>
        <span class="token keyword">if</span> base <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;grew heap, but no adequate free space found&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token comment">// We failed to get an mspan earlier, so grab</span>
    <span class="token comment">// one now that we have the heap lock.</span>
    s <span class="token operator">=</span> h<span class="token punctuation">.</span><span class="token function">allocMSpanLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先会使用<code>pageAlloc.alloc</code>来为其分配足够的页内存，如果堆内存不够的会就由<code>mheap.grow</code>来进行扩容。页内存分配完成后，就会由链式分配<code>mheap.spanalloc</code>分配64个<code>mspan</code>到P本地的缓存中，64正好是缓存数组长度的一半，然后再从P缓存中返回一个可用的<code>mspan</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>mheap<span class="token punctuation">)</span> <span class="token function">allocMSpanLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>mspan <span class="token punctuation">{</span>
	<span class="token function">assertLockHeld</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>

	pp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> pp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// We don&#39;t have a p so just do the normal thing.</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>mspan<span class="token punctuation">)</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>spanalloc<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Refill the cache if necessary.</span>
	<span class="token keyword">if</span> pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span><span class="token builtin">len</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> refillCount <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span>buf<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> refillCount<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>mspan<span class="token punctuation">)</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>spanalloc<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span><span class="token builtin">len</span> <span class="token operator">=</span> refillCount
	<span class="token punctuation">}</span>
	<span class="token comment">// Pull off the last entry in the cache.</span>
	s <span class="token operator">:=</span> pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span>buf<span class="token punctuation">[</span>pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span><span class="token builtin">len</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span><span class="token builtin">len</span><span class="token operator">--</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据上面两种情况，最终都能得到一个可用的<code>mspan</code>，最后将<code>mspan</code>初始化完毕后就可以返回了</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>HaveSpan<span class="token punctuation">:</span>
	h<span class="token punctuation">.</span><span class="token function">initSpan</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> typ<span class="token punctuation">,</span> spanclass<span class="token punctuation">,</span> base<span class="token punctuation">,</span> npages<span class="token punctuation">)</span>
	<span class="token keyword">return</span> s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="释放" tabindex="-1"><a class="header-anchor" href="#释放" aria-hidden="true">#</a> 释放</h4><p>既然<code>mspan</code>是由链式分配器的，自然释放内存的时候也由它来进行释放。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>mheap<span class="token punctuation">)</span> <span class="token function">freeSpanLocked</span><span class="token punctuation">(</span>s <span class="token operator">*</span>mspan<span class="token punctuation">,</span> typ spanAllocType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">assertLockHeld</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	<span class="token comment">// Mark the space as free.</span>
	h<span class="token punctuation">.</span>pages<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>npages<span class="token punctuation">)</span>
	s<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mSpanDead<span class="token punctuation">)</span>
	h<span class="token punctuation">.</span><span class="token function">freeMSpanLocked</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先会通过页分配器<code>mheap.pages</code>标记指定的页内存被释放，然后将<code>mspan</code>的状态设置为<code>mSpanDead</code>，最后由<code>mheap.spanalloc</code>分配器释放<code>mspan</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>mheap<span class="token punctuation">)</span> <span class="token function">freeMSpanLocked</span><span class="token punctuation">(</span>s <span class="token operator">*</span>mspan<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">assertLockHeld</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>

	pp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// First try to free the mspan directly to the cache.</span>
	<span class="token keyword">if</span> pp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span><span class="token builtin">len</span> <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span>buf<span class="token punctuation">[</span>pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span><span class="token builtin">len</span><span class="token punctuation">]</span> <span class="token operator">=</span> s
		pp<span class="token punctuation">.</span>mspancache<span class="token punctuation">.</span><span class="token builtin">len</span><span class="token operator">++</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Failing that (or if we don&#39;t have a p), just free it to</span>
	<span class="token comment">// the heap.</span>
	h<span class="token punctuation">.</span>spanalloc<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果P缓存未满的话，会将其放入P本地的缓存中继续使用，否则的话它会被释放回堆内存。</p><h4 id="扩容" tabindex="-1"><a class="header-anchor" href="#扩容" aria-hidden="true">#</a> 扩容</h4><p><code>heaparena</code>所管理的页内存空间并非在初期就已经全部申请好了，只有需要用到内存的时候才会去分配。负责给堆内存扩容的是<code>mheap.grow</code>方法，下面是简化后的代码。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>mheap<span class="token punctuation">)</span> <span class="token function">grow</span><span class="token punctuation">(</span>npage <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">uintptr</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">assertLockHeld</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	ask <span class="token operator">:=</span> <span class="token function">alignUp</span><span class="token punctuation">(</span>npage<span class="token punctuation">,</span> pallocChunkPages<span class="token punctuation">)</span> <span class="token operator">*</span> pageSize
	totalGrowth <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	end <span class="token operator">:=</span> h<span class="token punctuation">.</span>curArena<span class="token punctuation">.</span>base <span class="token operator">+</span> ask
	nBase <span class="token operator">:=</span> <span class="token function">alignUp</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> physPageSize<span class="token punctuation">)</span>
    
	<span class="token keyword">if</span> nBase <span class="token operator">&gt;</span> h<span class="token punctuation">.</span>curArena<span class="token punctuation">.</span>end <span class="token operator">||</span> end <span class="token operator">&lt;</span> h<span class="token punctuation">.</span>curArena<span class="token punctuation">.</span>base <span class="token punctuation">{</span>
		av<span class="token punctuation">,</span> asize <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">sysAlloc</span><span class="token punctuation">(</span>ask<span class="token punctuation">,</span> <span class="token operator">&amp;</span>h<span class="token punctuation">.</span>arenaHints<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">==</span> h<span class="token punctuation">.</span>curArena<span class="token punctuation">.</span>end <span class="token punctuation">{</span>
			h<span class="token punctuation">.</span>curArena<span class="token punctuation">.</span>end <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">+</span> asize
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// Switch to the new space.</span>
			h<span class="token punctuation">.</span>curArena<span class="token punctuation">.</span>base <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span>
			h<span class="token punctuation">.</span>curArena<span class="token punctuation">.</span>end <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">+</span> asize
		<span class="token punctuation">}</span>
		nBase <span class="token operator">=</span> <span class="token function">alignUp</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>curArena<span class="token punctuation">.</span>base<span class="token operator">+</span>ask<span class="token punctuation">,</span> physPageSize<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它首先会根据<code>npage</code>计算所需内存并进行对齐， 然后判断当前<code>heaparena</code>是否有足够的内存，如果不够的话就会由<code>mheap.sysAlloc</code>为当前<code>heaparena</code>申请更多内存或者分配一个新的<code>heaparena</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>mheap<span class="token punctuation">)</span> <span class="token function">sysAlloc</span><span class="token punctuation">(</span>n <span class="token builtin">uintptr</span><span class="token punctuation">,</span> hintList <span class="token operator">*</span><span class="token operator">*</span>arenaHint<span class="token punctuation">,</span> register <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>v unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> size <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	n <span class="token operator">=</span> <span class="token function">alignUp</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> heapArenaBytes<span class="token punctuation">)</span>
	<span class="token keyword">if</span> hintList <span class="token operator">==</span> <span class="token operator">&amp;</span>h<span class="token punctuation">.</span>arenaHints <span class="token punctuation">{</span>
		v <span class="token operator">=</span> h<span class="token punctuation">.</span>arena<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> heapArenaBytes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>heapReleased<span class="token punctuation">)</span>
		<span class="token keyword">if</span> v <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			size <span class="token operator">=</span> n
			<span class="token keyword">goto</span> mapped
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先会尝试使用线性分配器<code>mheap.arena</code>在预分配的内存空间中申请一块内存，如果失败就根据<code>hintList</code>来进行扩容，<code>hintList</code>的类型为<code>runtime.arenaHint</code>，它专门记录了用于<code>heaparena</code>扩容相关的地址信息。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token operator">*</span>hintList <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    hint <span class="token operator">:=</span> <span class="token operator">*</span>hintList
    p <span class="token operator">:=</span> hint<span class="token punctuation">.</span>addr
	v <span class="token operator">=</span> <span class="token function">sysReserve</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
    <span class="token keyword">if</span> p <span class="token operator">==</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hint<span class="token punctuation">.</span>addr <span class="token operator">=</span> p
        size <span class="token operator">=</span> n
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> v <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">sysFreeOS</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>hintList <span class="token operator">=</span> hint<span class="token punctuation">.</span>next
    h<span class="token punctuation">.</span>arenaHintAlloc<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>hint<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>内存申请完毕后，再将其更新到<code>arenas</code>二维数组中</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> ri <span class="token operator">:=</span> <span class="token function">arenaIndex</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ri <span class="token operator">&lt;=</span> <span class="token function">arenaIndex</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token operator">+</span>size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ri<span class="token operator">++</span> <span class="token punctuation">{</span>
    l2 <span class="token operator">:=</span> h<span class="token punctuation">.</span>arenas<span class="token punctuation">[</span>ri<span class="token punctuation">.</span><span class="token function">l1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">var</span> r <span class="token operator">*</span>heapArena
    r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>heapArena<span class="token punctuation">)</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>heapArenaAlloc<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> goarch<span class="token punctuation">.</span>PtrSize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>gcMiscSys<span class="token punctuation">)</span><span class="token punctuation">)</span>
    atomic<span class="token punctuation">.</span><span class="token function">StorepNoWB</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l2<span class="token punctuation">[</span>ri<span class="token punctuation">.</span><span class="token function">l2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后再由页分配器将这片内存标记为就绪状态。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Update the page allocator&#39;s structures to make this</span>
<span class="token comment">// space ready for allocation.</span>
h<span class="token punctuation">.</span>pages<span class="token punctuation">.</span><span class="token function">grow</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> nBase<span class="token operator">-</span>v<span class="token punctuation">)</span>
totalGrowth <span class="token operator">+=</span> nBase <span class="token operator">-</span> v
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="对象分配" tabindex="-1"><a class="header-anchor" href="#对象分配" aria-hidden="true">#</a> 对象分配</h2><p>go在为对象分配内存的时候，根据大小划分为了三个不同的类型：</p><ul><li>微对象 - tiny，小于16B</li><li>小对象 - small，小于32KB</li><li>大对象 - large，大于32KB</li></ul><p>根据三种不同的类型，在分配内存的时候会执行不同的逻辑。负责为对象分配内存的函数是<code>runtime.mallocgc</code>，其函数签名如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span>size <span class="token builtin">uintptr</span><span class="token punctuation">,</span> typ <span class="token operator">*</span>_type<span class="token punctuation">,</span> needzero <span class="token builtin">bool</span><span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>它只有三个参数，内存大小，类型，以及一个布尔值用于表示是否需要清空内存。它是所有go对象内存分配的入口函数，平时在使用<code>new</code>函数创建指针时同样也会走入该函数，当内存分配成功后，它返回的指针就是该对象的地址。在<a href="mspan">mpan</a>部分中提到过，每一个<code>mspan</code>都拥有一个<code>spanClass</code>，<code>spanClass</code>决定了<code>mspan</code>的固定大小，并且go将对象从[0, 32KB]的范围分成了68种不同的大小，所以go内存由若干个不同的大小固定的<code>mspan</code>链表组成。在分配对象内存时，只需按照对象大小计算出对应的<code>spanClass</code>，然后再根据<code>spanClass</code>找到对应的<code>mspan</code>链表，最后再从链表中寻找可用的<code>mspan</code>，这种分级的做法能较为有效的解决内存碎片的问题。</p><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202401182151386.png" style="zoom:67%;"><h3 id="微对象" tabindex="-1"><a class="header-anchor" href="#微对象" aria-hidden="true">#</a> 微对象</h3><p>所有小于16B的非指针微对象会由P中的微分配器被分配到同一片连续内存中，在<code>runitme.mcache</code>，由<code>tiny</code>字段记录了这片内存的基地址。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> mcache <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	tiny       <span class="token builtin">uintptr</span>
	tinyoffset <span class="token builtin">uintptr</span>
	tinyAllocs <span class="token builtin">uintptr</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>微对象的大小由<code>runtime.maxTinySize</code>常量来决定，都是16B，用于存储微对象的内存块同样也是这个大小，一般来说这里存储的对象都是一些小字符串，负责分配微对象的部分代码如下所示。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> size <span class="token operator">&lt;=</span> maxSmallSize <span class="token punctuation">{</span>
		<span class="token keyword">if</span> noscan <span class="token operator">&amp;&amp;</span> size <span class="token operator">&lt;</span> maxTinySize <span class="token punctuation">{</span>
			off <span class="token operator">:=</span> c<span class="token punctuation">.</span>tinyoffset
			<span class="token keyword">if</span> off<span class="token operator">+</span>size <span class="token operator">&lt;=</span> maxTinySize <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>tiny <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				x <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>tiny <span class="token operator">+</span> off<span class="token punctuation">)</span>
				c<span class="token punctuation">.</span>tinyoffset <span class="token operator">=</span> off <span class="token operator">+</span> size
				c<span class="token punctuation">.</span>tinyAllocs<span class="token operator">++</span>
				mp<span class="token punctuation">.</span>mallocing <span class="token operator">=</span> <span class="token number">0</span>
				<span class="token function">releasem</span><span class="token punctuation">(</span>mp<span class="token punctuation">)</span>
				<span class="token keyword">return</span> x
			<span class="token punctuation">}</span>
            
			<span class="token comment">// Allocate a new maxTinySize block.</span>
			span <span class="token operator">=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>tinySpanClass<span class="token punctuation">]</span>
			v <span class="token operator">:=</span> <span class="token function">nextFreeFast</span><span class="token punctuation">(</span>span<span class="token punctuation">)</span>
			<span class="token keyword">if</span> v <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				v<span class="token punctuation">,</span> span<span class="token punctuation">,</span> shouldhelpgc <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">nextFree</span><span class="token punctuation">(</span>tinySpanClass<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			x <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
			<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">uint64</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
			<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">uint64</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> c<span class="token punctuation">.</span>tinyoffset <span class="token operator">||</span> c<span class="token punctuation">.</span>tiny <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				c<span class="token punctuation">.</span>tiny <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
				c<span class="token punctuation">.</span>tinyoffset <span class="token operator">=</span> size
			<span class="token punctuation">}</span>
			size <span class="token operator">=</span> maxTinySize
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果当前的微内存块还有足够的空间来容纳，就直接使用当前内存块，即<code>off+size &lt;= maxTinySize</code>。如果不够的话，就会先尝试从<code>mcache</code>的span缓存中寻找可用的空间，如果也不行的话就会向<code>mcentral</code>申请一个<code>mspan</code>，不管如何最终都会得到一个可用的地址，最后再用新的微对象内存块替换掉旧的。</p><h3 id="小对象" tabindex="-1"><a class="header-anchor" href="#小对象" aria-hidden="true">#</a> 小对象</h3><p>go语言运行时大部分对象都是位于[16B, 32KB]这个范围内的小对象，小对象的分配过程最麻烦，但代码却是最少，负责小对象分配的部分代码如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> sizeclass <span class="token builtin">uint8</span>
<span class="token keyword">if</span> size <span class="token operator">&lt;=</span> smallSizeMax<span class="token operator">-</span><span class="token number">8</span> <span class="token punctuation">{</span>
    sizeclass <span class="token operator">=</span> size_to_class8<span class="token punctuation">[</span><span class="token function">divRoundUp</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> smallSizeDiv<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    sizeclass <span class="token operator">=</span> size_to_class128<span class="token punctuation">[</span><span class="token function">divRoundUp</span><span class="token punctuation">(</span>size<span class="token operator">-</span>smallSizeMax<span class="token punctuation">,</span> largeSizeDiv<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
size <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>class_to_size<span class="token punctuation">[</span>sizeclass<span class="token punctuation">]</span><span class="token punctuation">)</span>
spc <span class="token operator">:=</span> <span class="token function">makeSpanClass</span><span class="token punctuation">(</span>sizeclass<span class="token punctuation">,</span> noscan<span class="token punctuation">)</span>
span <span class="token operator">=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span>
v <span class="token operator">:=</span> <span class="token function">nextFreeFast</span><span class="token punctuation">(</span>span<span class="token punctuation">)</span>
<span class="token keyword">if</span> v <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    v<span class="token punctuation">,</span> span<span class="token punctuation">,</span> shouldhelpgc <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">nextFree</span><span class="token punctuation">(</span>spc<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
x <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
<span class="token keyword">if</span> needzero <span class="token operator">&amp;&amp;</span> span<span class="token punctuation">.</span>needzero <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token function">memclrNoHeapPointers</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先会根据对象的大小计算出应该使用哪一类的<code>spanClass</code>，然后由<code>runtime.nextFreeFast</code>根据<code>spanClass</code>尝试去<code>mcache</code>中对应的缓存<code>mspan</code>获取可用的内存空间。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">nextFreeFast</span><span class="token punctuation">(</span>s <span class="token operator">*</span>mspan<span class="token punctuation">)</span> gclinkptr <span class="token punctuation">{</span>
	theBit <span class="token operator">:=</span> sys<span class="token punctuation">.</span><span class="token function">TrailingZeros64</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>allocCache<span class="token punctuation">)</span> <span class="token comment">// Is there a free object in the allocCache?</span>
	<span class="token keyword">if</span> theBit <span class="token operator">&lt;</span> <span class="token number">64</span> <span class="token punctuation">{</span>
		result <span class="token operator">:=</span> s<span class="token punctuation">.</span>freeindex <span class="token operator">+</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>theBit<span class="token punctuation">)</span>
		<span class="token keyword">if</span> result <span class="token operator">&lt;</span> s<span class="token punctuation">.</span>nelems <span class="token punctuation">{</span>
			freeidx <span class="token operator">:=</span> result <span class="token operator">+</span> <span class="token number">1</span>
			<span class="token keyword">if</span> freeidx<span class="token operator">%</span><span class="token number">64</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> freeidx <span class="token operator">!=</span> s<span class="token punctuation">.</span>nelems <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token number">0</span>
			<span class="token punctuation">}</span>
			s<span class="token punctuation">.</span>allocCache <span class="token operator">&gt;&gt;=</span> <span class="token function">uint</span><span class="token punctuation">(</span>theBit <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
			s<span class="token punctuation">.</span>freeindex <span class="token operator">=</span> freeidx
			s<span class="token punctuation">.</span>allocCount<span class="token operator">++</span>
			<span class="token keyword">return</span> <span class="token function">gclinkptr</span><span class="token punctuation">(</span>result<span class="token operator">*</span>s<span class="token punctuation">.</span>elemsize <span class="token operator">+</span> s<span class="token punctuation">.</span><span class="token function">base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>mspan.allocCache</code>的作用是记录内存空间是否有对象使用，并且它是按照对象数量来将内存一个个划分而非按照空间大小来划分，这相当于是把<code>mspan</code>看了一个对象数组，如下图所示。</p><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202401181650805.png" style="zoom:67%;"><p><code>allocCache</code>是一个64位数字，每一位对应着一片内存空间，如果某一位为0表示有对象使用，如果是1的话表示这片内存是空闲的。<code>sys.TrailingZeros64(s.allocCache)</code>的目的就是计算尾随零的数量，如果结果是64的话则表明没有空闲的内存可以使用，如果有的话再计算得到空闲内存的偏移量加上<code>mspan</code>的基地址然后返回。</p><p>当<code>mcache</code>中没有足够的空间时，就会再去<code>mcentral</code>中去申请，这部分工作由<code>mcache.nextFree</code>方法来完成</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>mcache<span class="token punctuation">)</span> <span class="token function">nextFree</span><span class="token punctuation">(</span>spc spanClass<span class="token punctuation">)</span> <span class="token punctuation">(</span>v gclinkptr<span class="token punctuation">,</span> s <span class="token operator">*</span>mspan<span class="token punctuation">,</span> shouldhelpgc <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s <span class="token operator">=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span>
	shouldhelpgc <span class="token operator">=</span> <span class="token boolean">false</span>
	freeIndex <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">nextFreeIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> freeIndex <span class="token operator">==</span> s<span class="token punctuation">.</span>nelems <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">refill</span><span class="token punctuation">(</span>spc<span class="token punctuation">)</span>
		shouldhelpgc <span class="token operator">=</span> <span class="token boolean">true</span>
		s <span class="token operator">=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span>

		freeIndex <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">nextFreeIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	v <span class="token operator">=</span> <span class="token function">gclinkptr</span><span class="token punctuation">(</span>freeIndex<span class="token operator">*</span>s<span class="token punctuation">.</span>elemsize <span class="token operator">+</span> s<span class="token punctuation">.</span><span class="token function">base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	s<span class="token punctuation">.</span>allocCount<span class="token operator">++</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中的<code>mcache.refill</code>会负责向<code>mcentral</code>申请一个可用的<code>mspan</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>mcache<span class="token punctuation">)</span> <span class="token function">refill</span><span class="token punctuation">(</span>spc spanClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	s <span class="token operator">=</span> mheap_<span class="token punctuation">.</span>central<span class="token punctuation">[</span>spc<span class="token punctuation">]</span><span class="token punctuation">.</span>mcentral<span class="token punctuation">.</span><span class="token function">cacheSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而<code>mcentral.cacheSpan</code>方法会在内存不足时由<code>mcentral.grow</code>来进行扩容，扩容则又会向<code>mheap</code>去申请新的<code>mspan</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>mcentral<span class="token punctuation">)</span> <span class="token function">grow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>mspan <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	s <span class="token operator">:=</span> mheap_<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>npages<span class="token punctuation">,</span> c<span class="token punctuation">.</span>spanclass<span class="token punctuation">)</span>
	<span class="token operator">...</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所以最后看来，小对象的内存分配是一级一级往下走的，先是<code>mcache</code>，然后是<code>mcentral</code>，最后是<code>mheap</code>。<code>mcache</code>分配的成本最低，因为它是P本地的缓存，分配内存时不需要持有锁，<code>mcentral</code>其次，直接向<code>mheap</code>申请内存成本最高，因为<code>mheap.alloc</code>方法会竞争整个堆的全局锁。</p><h3 id="大对象" tabindex="-1"><a class="header-anchor" href="#大对象" aria-hidden="true">#</a> 大对象</h3><p>大对象分配最为简单，如果对象的大小超过了32KB，就会直接向<code>mheap</code>申请分配一个新的<code>mspan</code>来容纳，负责分配大对象的部分代码如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>shouldhelpgc <span class="token operator">=</span> <span class="token boolean">true</span>
span <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">allocLarge</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> noscan<span class="token punctuation">)</span>
span<span class="token punctuation">.</span>freeindex <span class="token operator">=</span> <span class="token number">1</span>
span<span class="token punctuation">.</span>allocCount <span class="token operator">=</span> <span class="token number">1</span>
size <span class="token operator">=</span> span<span class="token punctuation">.</span>elemsize
x <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>span<span class="token punctuation">.</span><span class="token function">base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> needzero <span class="token operator">&amp;&amp;</span> span<span class="token punctuation">.</span>needzero <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> noscan <span class="token punctuation">{</span>
        delayedZeroing <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">memclrNoHeapPointers</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中<code>mcache.allocLarge</code>负责向<code>mheap</code>申请大对象的内存空间</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>mcache<span class="token punctuation">)</span> <span class="token function">allocLarge</span><span class="token punctuation">(</span>size <span class="token builtin">uintptr</span><span class="token punctuation">,</span> noscan <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>mspan <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	spc <span class="token operator">:=</span> <span class="token function">makeSpanClass</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> noscan<span class="token punctuation">)</span>
	s <span class="token operator">:=</span> mheap_<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>npages<span class="token punctuation">,</span> spc<span class="token punctuation">)</span>
	<span class="token operator">...</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从代码中可以看到的是大对象使用的<code>spanClass</code>值为0，大对象基本上都是一个对象占用一个<code>mpan</code>。</p><h2 id="其它" tabindex="-1"><a class="header-anchor" href="#其它" aria-hidden="true">#</a> 其它</h2><h3 id="内存统计" tabindex="-1"><a class="header-anchor" href="#内存统计" aria-hidden="true">#</a> 内存统计</h3><p>go运行时对用户暴露了一个函数<code>ReadMemStats</code>，可以用于统计运行时的内存情况。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ReadMemStats</span><span class="token punctuation">(</span>m <span class="token operator">*</span>MemStats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>Alloc <span class="token comment">// nil check test before we switch stacks, see issue 61158</span>
	<span class="token function">stopTheWorld</span><span class="token punctuation">(</span>stwReadMemStats<span class="token punctuation">)</span>

	<span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">readmemstats_m</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token function">startTheWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是使用它的代价非常大，从代码中可以看到分析内存情况前需要STW，而STW的时长可能是几毫秒到几百毫秒不等，一般只有在调试和问题排查的时候才会使用。<code>runtime.MemStats</code>结构体记录了有关堆内存，栈内存，和GC相关的信息</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> MemStats <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">//  总体统计</span>
    Alloc <span class="token builtin">uint64</span>
    TotalAlloc <span class="token builtin">uint64</span>
    Sys <span class="token builtin">uint64</span>
    Lookups <span class="token builtin">uint64</span>
    Mallocs <span class="token builtin">uint64</span>
    Frees <span class="token builtin">uint64</span>

    <span class="token comment">// 堆内存统计</span>
    HeapAlloc <span class="token builtin">uint64</span>
    HeapSys <span class="token builtin">uint64</span>
    HeapIdle <span class="token builtin">uint64</span>
    HeapInuse <span class="token builtin">uint64</span>
    HeapReleased <span class="token builtin">uint64</span>
    HeapObjects <span class="token builtin">uint64</span>

    <span class="token comment">// 栈内存统计</span>
    StackInuse <span class="token builtin">uint64</span>
    StackSys <span class="token builtin">uint64</span>

    <span class="token comment">// 内存组件统计</span>
    MSpanInuse <span class="token builtin">uint64</span>
    MSpanSys <span class="token builtin">uint64</span>
    MCacheInuse <span class="token builtin">uint64</span>
    MCacheSys <span class="token builtin">uint64</span>
    BuckHashSys <span class="token builtin">uint64</span>

    <span class="token comment">// gc相关的统计</span>
    GCSys <span class="token builtin">uint64</span>
    OtherSys <span class="token builtin">uint64</span>
    NextGC <span class="token builtin">uint64</span>
    LastGC <span class="token builtin">uint64</span>
    PauseTotalNs <span class="token builtin">uint64</span>
    PauseNs <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token builtin">uint64</span>
    PauseEnd <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token builtin">uint64</span>
    NumGC <span class="token builtin">uint32</span>
    NumForcedGC <span class="token builtin">uint32</span>
    GCCPUFraction <span class="token builtin">float64</span>
    EnableGC <span class="token builtin">bool</span>
    DebugGC <span class="token builtin">bool</span>

    BySize <span class="token punctuation">[</span><span class="token number">61</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        Size <span class="token builtin">uint32</span>
        Mallocs <span class="token builtin">uint64</span>
        Frees <span class="token builtin">uint64</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="notinheap" tabindex="-1"><a class="header-anchor" href="#notinheap" aria-hidden="true">#</a> NotInHeap</h3><p>内存分配器显然用来分配堆内存的，但堆又被分为了两部分，一部分是go运行时自身所需要的堆内存，另一部分是开放给用户使用的堆内存。所以在一些结构中可以看到这样的嵌入字段</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token boolean">_</span> sys<span class="token punctuation">.</span>NotInHeap
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>表示该类型的内存不会分配在用户堆上，这种嵌入字段在内存分配组件中尤为常见，比如表示用户堆的结构体<code>runtime.mheap</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> mheap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token boolean">_</span> sys<span class="token punctuation">.</span>NotInHeap
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sys.NotInHeap</code>的真正作用是为了避免内存屏障以提高运行时效率，而用户堆需要运行GC所以需要内存屏障。</p>`,117);function C(A,P){const t=i("RouterLink");return e(),o("div",null,[d,s("p",null,[r,n("对应着"),k,n("结构体，在并发调度一文中就已经出现过，尽管它的名字叫"),v,n("但它实际上是与处理器P绑定的。"),m,n("是每一个处理器P上的内存缓存，其中包含了"),b,n("链表数组"),g,n("，数组的大小固定为"),h,n("，刚好是"),f,n("数量的两倍，还有微对象缓存"),y,n("，其中"),w,n("指向微对象内存的起始地址，"),x,n("则是空闲内存相对于起始地址的偏移量，"),z,n("表示分配了多少个微对象。关于栈缓存"),S,n("，可以前往"),c(t,{to:"/essential/impl/runtime/7.gmp.html#%E5%88%86%E9%85%8D"},{default:l(()=>[n("栈内存分配")]),_:1}),n("进行了解。")]),_])}const I=p(u,[["render",C],["__file","8.mem.html.vue"]]);export{I as default};
