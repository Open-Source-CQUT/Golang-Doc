---
date: 2022-09-04
---
# æµ‹è¯•

å¯¹äºå¼€å‘è€…è€Œè¨€ï¼Œè‰¯å¥½çš„æµ‹è¯•å¯ä»¥æå‰å‘ç°ç¨‹åºçš„ä¸­é”™è¯¯ï¼Œé¿å…åç»­å› ç»´æŠ¤ä¸åŠæ—¶äº§ç”ŸBugè€Œé€ æˆçš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œæ‰€ä»¥å†™å¥½æµ‹è¯•éå¸¸æœ‰å¿…è¦ã€‚Goåœ¨æµ‹è¯•è¿™ä¸€æ–¹é¢æä¾›äº†éå¸¸ç®€ä¾¿å®ç”¨çš„å‘½ä»¤è¡Œå·¥å…·`go test`ï¼Œåœ¨æ ‡å‡†åº“å’Œè®¸å¤šå¼€æºæ¡†æ¶éƒ½èƒ½çœ‹åˆ°æµ‹è¯•çš„èº«å½±ï¼Œè¯¥å·¥å…·ä½¿ç”¨èµ·æ¥ååˆ†æ–¹ä¾¿ï¼Œç›®å‰æ”¯æŒä»¥ä¸‹å‡ ç§æµ‹è¯•ï¼š

- ç¤ºä¾‹æµ‹è¯•
- å•å…ƒæµ‹è¯•
- åŸºå‡†æµ‹è¯•
- æ¨¡ç³Šæµ‹è¯•

åœ¨Goä¸­å¤§éƒ¨åˆ†çš„APIéƒ½æ˜¯ç”±æ ‡å‡†åº“`testing`æä¾›ã€‚

::: tip

åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ`go help testfunc`å‘½ä»¤ï¼Œå¯çœ‹Goå®˜æ–¹å¯¹äºä¸Šé¢å››ç§æµ‹è¯•ç±»å‹çš„è§£é‡Šã€‚

:::

<br>

## ç¼–å†™è§„èŒƒ

åœ¨å¼€å§‹ç¼–å†™æµ‹è¯•ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦æ³¨æ„å‡ ç‚¹è§„èŒƒï¼Œè¿™æ ·åœ¨åç»­çš„å­¦ä¹ ä¸­ä¼šæ›´åŠ æ–¹ä¾¿ã€‚

- æµ‹è¯•åŒ…ï¼šæµ‹è¯•æ–‡ä»¶æœ€å¥½å•ç‹¬æ”¾åœ¨ä¸€ä¸ªåŒ…ä¸­ï¼Œè¿™ä¸ªåŒ…é€šå¸¸å‘½åä¸º`test`ã€‚
- æµ‹è¯•æ–‡ä»¶ï¼šæµ‹è¯•æ–‡ä»¶é€šå¸¸ä»¥`_test.go`ç»“å°¾ï¼Œä¾‹å¦‚è¦æµ‹è¯•æŸä¸€ä¸ªåŠŸèƒ½ï¼Œå°±å°†å…¶å‘½åä¸º`function_test.go`ï¼Œå¦‚æœæƒ³æ ¹æ®æµ‹è¯•ç±»å‹å†åˆ’åˆ†çš„æ›´ç»†ä¸€äº›ä¹Ÿå¯ä»¥å°†æµ‹è¯•ç±»å‹ä¸ºä½œä¸ºæ–‡ä»¶å‰ç¼€ï¼Œä¾‹å¦‚`benchmark_marshaling_test.go`ï¼Œæˆ–è€…`example_marshaling_test.go`ã€‚
- æµ‹è¯•å‡½æ•°ï¼šæ¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ä¸­éƒ½ä¼šæœ‰è‹¥å¹²ä¸ªæµ‹è¯•å‡½æ•°ç”¨äºä¸åŒçš„æµ‹è¯•ã€‚å¯¹äºä¸åŒçš„æµ‹è¯•ç±»å‹ï¼Œæµ‹è¯•å‡½æ•°çš„å‘½åçš„é£æ ¼ä¹Ÿä¸åŒã€‚ä¾‹å¦‚ç¤ºä¾‹æµ‹è¯•æ˜¯`ExampleXXXX`ï¼Œå•å…ƒæµ‹è¯•æ˜¯`TestXXXX`ï¼ŒåŸºå‡†æµ‹è¯•æ˜¯`BenchmarkXXXX`ï¼Œæ¨¡ç³Šæµ‹è¯•æ˜¯`FuzzXXXX`ï¼Œè¿™æ ·ä¸€æ¥å³ä¾¿ä¸éœ€è¦æ³¨é‡Šä¹Ÿå¯ä»¥çŸ¥æ™“è¿™æ˜¯ä»€ä¹ˆç±»å‹çš„æµ‹è¯•ã€‚

::: tip

å½“åŒ…åä¸º`testdata`æ—¶ï¼Œè¯¥åŒ…é€šå¸¸æ˜¯ä¸ºäº†å­˜å‚¨ç”¨äºæµ‹è¯•çš„è¾…åŠ©æ•°æ®ï¼Œåœ¨æ‰§è¡Œæµ‹è¯•æ—¶ï¼ŒGoä¼šå¿½ç•¥åä¸º`testdata`çš„åŒ…ã€‚

:::

éµå¾ªä¸Šè¿°çš„è§„èŒƒï¼Œå…»æˆè‰¯å¥½çš„æµ‹è¯•é£æ ¼ï¼Œå¯ä»¥ä¸ºæ—¥åçš„ç»´æŠ¤çœå»ä¸å°‘çš„éº»çƒ¦ã€‚

<br>

## æ‰§è¡Œæµ‹è¯•

æ‰§è¡Œæµ‹è¯•ä¸»è¦ä¼šç”¨åˆ°`go test`å‘½ä»¤ï¼Œä¸‹é¢æ‹¿å®é™…çš„ä»£ç ä¸¾ä¾‹ï¼Œç°åœ¨æœ‰å¾…æµ‹è¯•æ–‡ä»¶`/say/hello.go`ä»£ç å¦‚ä¸‹

```go
package say

import "fmt"

func Hello() {
	fmt.Println("hello")
}

func GoodBye() {
	fmt.Println("bye")
}

```

å’Œæµ‹è¯•æ–‡ä»¶`/test/example_test.go`ä»£ç å¦‚ä¸‹

```go
package test

import (
	"golearn/say"
)

func ExampleHello() {
	say.Hello()
	// Output:
	// hello
}

func ExampleGoodBye() {
	say.GoodBye()
	// Output:
	// bye
}

func ExampleSay() {
	say.Hello()
	say.GoodBye()
	// Output:
	// hello
	// bye
}

```

æ‰§è¡Œè¿™äº›æµ‹è¯•æœ‰å¤šç§æ–¹æ³•ï¼Œæ¯”å¦‚æƒ³è¦æ‰§è¡Œ`test`åŒ…ä¸‹æ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå°±å¯ä»¥ç›´æ¥åœ¨`test`ç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤

```sh
$ go test ./
PASS
ok      golearn/test    0.422s
```

`./`è¡¨ç¤ºå½“å‰ç›®å½•ï¼ŒGoä¼šå°†`test`ç›®å½•ä¸‹çš„æ‰€æœ‰æµ‹è¯•æ–‡ä»¶é‡æ–°ç¼–è¯‘åï¼Œç„¶åå†å°†æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å…¨éƒ½æ‰§è¡Œï¼Œä»ç»“æœå¯ä»¥çœ‹å‡ºæ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹éƒ½é€šè¿‡äº†ã€‚å…¶åçš„å‚æ•°ä¹Ÿå¯ä»¥è·Ÿå¤šä¸ªç›®å½•ï¼Œä¾‹å¦‚ä¸‹æ–¹çš„å‘½ä»¤ï¼Œæ˜¾ç„¶é¡¹ç›®çš„ä¸»ç›®å½•å¹¶æ²¡æœ‰æµ‹è¯•æ–‡ä»¶å¯ä¾›æ‰§è¡Œã€‚

```sh
$ go test ./ ../
ok      golearn/test
?       golearn [no test files]
```

::: tip

å½“æ‰§è¡Œçš„å‚æ•°æœ‰å¤šä¸ªåŒ…æ—¶ï¼ŒGoå¹¶ä¸ä¼šå†æ¬¡æ‰§è¡Œå·²ç»æˆåŠŸé€šè¿‡çš„æµ‹è¯•ç”¨ä¾‹ï¼Œåœ¨æ‰§è¡Œæ—¶ä¼šè¡Œå°¾æ·»åŠ `(cached)`ä»¥è¡¨ç¤ºè¾“å‡ºç»“æœæ˜¯ä¸Šä¸€æ¬¡çš„ç¼“å­˜ã€‚å½“æµ‹è¯•çš„æ ‡å¿—å‚æ•°ä½äºä»¥ä¸‹é›†åˆä¸­æ—¶ï¼ŒGoå°±ä¼šç¼“å­˜æµ‹è¯•ç»“æœï¼Œå¦åˆ™å°±ä¸ä¼šã€‚

```
-benchtime, -cpu,-list, -parallel, -run, -short, -timeout, -failfast, -v
```

å¦‚æœæƒ³è¦ç¦ç”¨ç¼“å­˜ï¼Œå¯ä»¥åŠ ä¸Šå‚æ•°` -count=1`ã€‚

:::

å½“ç„¶ä¹Ÿå¯ä»¥å•ç‹¬æŒ‡å®šæŸä¸€ä¸ªæµ‹è¯•æ–‡ä»¶æ¥æ‰§è¡Œã€‚

```sh
$ go test example_test.go
ok      command-line-arguments  0.457s
```

æˆ–è€…å¯ä»¥å•ç‹¬æŒ‡å®šæŸä¸€ä¸ªæµ‹è¯•æ–‡ä»¶çš„æŸä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œä¾‹å¦‚

```sh
$ go test -run ExampleSay
PASS
ok      golearn/test    0.038s
```

ä¸Šé¢ä¸‰ç§æƒ…å†µè™½ç„¶éƒ½å®Œæˆäº†æµ‹è¯•ï¼Œä½†æ˜¯è¾“å‡ºç»“æœå¤ªç®€ä»‹äº†ï¼Œè¿™æ—¶å¯ä»¥åŠ ä¸Šå‚æ•°`-v`ï¼Œæ¥ä½¿è¾“å‡ºç»“æœæ›´åŠ è¯¦ç»†ä¸€ç‚¹ï¼Œä¾‹å¦‚

```sh
$ go test ./ -v
=== RUN   ExampleHello
--- PASS: ExampleHello (0.00s)
=== RUN   ExampleGoodBye
--- PASS: ExampleGoodBye (0.00s)
=== RUN   ExampleSay
--- PASS: ExampleSay (0.00s)
PASS
ok      golearn/test    0.040s
```

è¿™ä¸‹å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°æ¯ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹çš„æ‰§è¡Œé¡ºåºï¼Œè€—æ—¶ï¼Œæ‰§è¡Œæƒ…å†µï¼Œä»¥åŠæ€»ä½“çš„è€—æ—¶ã€‚

::: tip

`go test`å‘½ä»¤é»˜è®¤è¿è¡Œæ‰€æœ‰çš„å•å…ƒæµ‹è¯•ï¼Œç¤ºä¾‹æµ‹è¯•ï¼Œæ¨¡ç³Šæµ‹è¯•ï¼Œå¦‚æœåŠ ä¸Šäº†`-bench`å‚æ•°åˆ™ä¼šè¿è¡Œæ‰€æœ‰ç±»å‹çš„æµ‹è¯•ï¼Œä¾‹å¦‚ä¸‹æ–¹çš„å‘½ä»¤

```sh
$ go test -bench .
```

æ‰€ä»¥éœ€è¦ä½¿ç”¨`-run`å‚æ•°æ¥æŒ‡å®šï¼Œä¾‹å¦‚åªè¿è¡Œæ‰€æœ‰çš„åŸºå‡†æµ‹è¯•çš„å‘½ä»¤å¦‚ä¸‹

```sh
$ go test -bench . -run ^$
```

:::

<br>

### å¸¸ç”¨å‚æ•°

Go æµ‹è¯•æœ‰ç€éå¸¸å¤šçš„æ ‡å¿—å‚æ•°ï¼Œä¸‹é¢åªä¼šä»‹ç»å¸¸ç”¨çš„å‚æ•°ï¼Œæƒ³è¦äº†è§£æ›´å¤šç»†èŠ‚å»ºè®®ä½¿ç”¨`go help testflag`å‘½ä»¤è‡ªè¡ŒæŸ¥é˜…ã€‚

| å‚æ•°                          | é‡Šä¹‰                                                         |
| ----------------------------- | ------------------------------------------------------------ |
| `-o file`                     | æŒ‡å®šç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶åç§°                                   |
| `-c`                          | åªç¼–è¯‘æµ‹è¯•æ–‡ä»¶ï¼Œä½†ä¸è¿è¡Œ                                     |
| `-json`                       | ä»¥jsonæ ¼å¼è¾“å‡ºæµ‹è¯•æ—¥å¿—                                       |
| `-exec xprog`                 | ä½¿ç”¨`xprog`è¿è¡Œæµ‹è¯•ï¼Œç­‰ä»·äº`go run`                          |
| `-bench regexp`               | é€‰ä¸­`regexp`åŒ¹é…çš„åŸºå‡†æµ‹è¯•                                   |
| `-fuzz regexp`                | é€‰ä¸­`regexp`åŒ¹é…çš„æ¨¡ç³Šæµ‹è¯•                                   |
| `-fuzztime t`                 | æ¨¡ç³Šæµ‹è¯•è‡ªåŠ¨ç»“æŸçš„æ—¶é—´ï¼Œ`t`ä¸ºæ—¶é—´é—´éš”ï¼Œå½“å•ä½ä¸º`x`æ—¶ï¼Œè¡¨ç¤ºæ¬¡æ•°ï¼Œä¾‹å¦‚`200x` |
| `-fuzzminimizetime t`         | æ¨¡å¼æµ‹è¯•è¿è¡Œçš„æœ€å°æ—¶é—´ï¼Œè§„åˆ™åŒä¸Š                             |
| `-count n`                    | è¿è¡Œæµ‹è¯•næ¬¡ï¼Œé»˜è®¤1æ¬¡                                         |
| `-cover`                      | å¼€å¯æµ‹è¯•è¦†ç›–ç‡åˆ†æ                                           |
| `-covermode set,count,atomic` | è®¾ç½®è¦†ç›–ç‡åˆ†æçš„æ¨¡å¼                                         |
| `-cpu`                        | ä¸ºæµ‹è¯•æ‰§è¡Œ`GOMAXPROCS`                                       |
| `-failfast`                   | ç¬¬ä¸€æ¬¡æµ‹è¯•å¤±è´¥åï¼Œä¸ä¼šå¼€å§‹æ–°çš„æµ‹è¯•                           |
| `-list regexp`                | åˆ—å‡º`regexp`åŒ¹é…çš„æµ‹è¯•ç”¨ä¾‹                                   |
| `-parallel n`                 | å…è®¸è°ƒç”¨äº†`t.Parallel`çš„æµ‹è¯•ç”¨ä¾‹å¹¶è¡Œè¿è¡Œï¼Œ`n`å€¼ä¸ºå¹¶è¡Œçš„æœ€å¤§æ•°é‡ |
| `-run regexp`                 | åªè¿è¡Œ`regexp`åŒ¹é…çš„æµ‹è¯•ç”¨ä¾‹                                 |
| `-skip regexp`                | è·³è¿‡`regexp`åŒ¹é…çš„æµ‹è¯•ç”¨ä¾‹                                   |
| `-timeout d`                  | å¦‚æœå•æ¬¡æµ‹è¯•æ‰§è¡Œæ—¶é—´è¶…è¿‡äº†æ—¶é—´é—´éš”`d`ï¼Œå°±ä¼š`panic`ã€‚`d`ä¸ºæ—¶é—´é—´éš”ï¼Œä¾‹1s,1ms,1nsç­‰ |
| `-shuffle off,on,N`           | æ‰“ä¹±æµ‹è¯•çš„æ‰§è¡Œé¡ºåºï¼Œ`N`ä¸ºéšæœºç§å­ï¼Œé»˜è®¤ç§å­ä¸ºç³»ç»Ÿæ—¶é—´        |
| `-v`                          | è¾“å‡ºæ›´è¯¦ç»†çš„æµ‹è¯•æ—¥å¿—                                         |
| `-benchmem`                   | ç»Ÿè®¡åŸºå‡†æµ‹è¯•çš„å†…å­˜åˆ†é…                                       |
| `-blockprofile block.out`     | ç»Ÿè®¡æµ‹è¯•ä¸­åç¨‹é˜»å¡æƒ…å†µå¹¶å†™å…¥æ–‡ä»¶                             |
| `-blockprofilerate n`         | æ§åˆ¶åç¨‹é˜»å¡ç»Ÿè®¡é¢‘ç‡ï¼Œé€šè¿‡å‘½ä»¤`go doc runtime.SetBlockProfileRate`æŸ¥çœ‹æ›´å¤šç»†èŠ‚ |
| `-coverprofile cover.out`     | ç»Ÿè®¡è¦†ç›–ç‡æµ‹è¯•çš„æƒ…å†µå¹¶å†™å…¥æ–‡ä»¶                               |
| `-cpuprofile cpu.out`         | ç»Ÿè®¡cpuæƒ…å†µå¹¶å†™å…¥æ–‡ä»¶                                        |
| `-memprofile mem.out`         | ç»Ÿè®¡å†…å­˜åˆ†é…æƒ…å†µå¹¶å†™å…¥æ–‡ä»¶                                   |
| `-memprofilerate n`           | æ§åˆ¶å†…å­˜åˆ†é…ç»Ÿè®¡çš„é¢‘ç‡ï¼Œé€šè¿‡å‘½ä»¤`go doc runtime.MemProfileRate`æŸ¥çœ‹æ›´å¤šç»†èŠ‚ |
| `-mutexprofile mutex.out`     | ç»Ÿè®¡é”ç«äº‰æƒ…å†µå¹¶å†™å…¥æ–‡ä»¶                                     |
| ` -mutexprofilefraction n`    | è®¾ç½®ç»Ÿè®¡`n`ä¸ªåç¨‹ç«äº‰ä¸€ä¸ªäº’æ–¥é”çš„æƒ…å†µ                        |
| `-trace trace.out`            | å°†æ‰§è¡Œè¿½è¸ªæƒ…å†µå†™å…¥æ–‡ä»¶                                       |
| `-outputdir directory`        | æŒ‡å®šä¸Šè¿°çš„ç»Ÿè®¡æ–‡ä»¶çš„è¾“å‡ºç›®å½•ï¼Œé»˜è®¤ä¸º`go test`çš„è¿è¡Œç›®å½•      |

<br>

## ç¤ºä¾‹æµ‹è¯•

ç¤ºä¾‹æµ‹è¯•å¹¶ä¸åƒå…¶ä»–ä¸‰ç§æµ‹è¯•ä¸€æ ·æ˜¯ä¸ºäº†å‘ç°ç¨‹åºçš„é—®é¢˜æ‰€åœ¨ï¼Œå®ƒæ›´å¤šçš„æ˜¯ä¸ºäº†å±•ç¤ºæŸä¸€ä¸ªåŠŸèƒ½çš„ä½¿ç”¨æ–¹æ³•ï¼Œèµ·åˆ°æ–‡æ¡£ä½œç”¨ã€‚ç¤ºä¾‹æµ‹è¯•å¹¶ä¸æ˜¯ä¸€ä¸ªå®˜æ–¹å®šä¹‰çš„æ¦‚å¿µï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸ªç¡¬æ€§çš„è§„èŒƒï¼Œæ›´åƒæ˜¯ä¸€ç§å·¥ç¨‹ä¸Šçš„çº¦å®šä¿—æˆï¼Œæ˜¯å¦éµå®ˆåªå–å†³äºå¼€å‘è€…ã€‚ç¤ºä¾‹æµ‹è¯•åœ¨æ ‡å‡†åº“ä¸­å‡ºç°çš„éå¸¸å¤šï¼Œé€šå¸¸æ˜¯å®˜æ–¹æ‰€ç¼–å†™çš„æ ‡å‡†åº“ä»£ç ç¤ºä¾‹ï¼Œä¾‹å¦‚æ ‡å‡†åº“`context/example_test.go`ä¸­çš„`ExampleWithDeadline`æµ‹è¯•å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸­å±•ç°äº†`DeadlineContext`çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼š

```go
// This example passes a context with an arbitrary deadline to tell a blocking
// function that it should abandon its work as soon as it gets to it.
func ExampleWithDeadline() {
   d := time.Now().Add(shortDuration)
   ctx, cancel := context.WithDeadline(context.Background(), d)

   // Even though ctx will be expired, it is good practice to call its
   // cancellation function in any case. Failure to do so may keep the
   // context and its parent alive longer than necessary.
   defer cancel()

   select {
   case <-time.After(1 * time.Second):
      fmt.Println("overslept")
   case <-ctx.Done():
      fmt.Println(ctx.Err())
   }

   // Output:
   // context deadline exceeded
}
```

è¡¨é¢ä¸Šçœ‹è¯¥æµ‹è¯•å‡½æ•°å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œä¸è¿‡ç¤ºä¾‹æµ‹è¯•ä¸»è¦æ˜¯ç”±`Output`æ³¨é‡Šæ¥ä½“ç°çš„ï¼Œå¾…æµ‹è¯•å‡½æ•°åªæœ‰ä¸€è¡Œè¾“å‡ºæ—¶ï¼Œä½¿ç”¨`Output`æ³¨é‡Šæ¥æ£€æµ‹è¾“å‡ºã€‚é¦–å…ˆåˆ›å»ºä¸€ä¸ª`hello.go`çš„æ–‡åŒ–ï¼Œå†™å…¥å¦‚ä¸‹ä»£ç 

```go
package say

import "fmt"

func Hello() {
	fmt.Println("hello")
}

func GoodBye() {
	fmt.Println("bye")
}

```

`SayHello`å‡½æ•°å°±æ˜¯å¾…æµ‹å‡½æ•°ï¼Œç„¶ååˆ›å»ºæµ‹è¯•æ–‡ä»¶`example_test.go`ï¼Œå†™å…¥å¦‚ä¸‹ä»£ç 

```go
package test

import (
	"golearn/say"
)

func ExampleHello() {
	say.Hello()
	// Output:
	// hello
}

func ExampleGoodBye() {
	say.GoodBye()
	// Output:
	// bye
}

func ExampleSay() {
	say.Hello()
	say.GoodBye()
	// Output:
	// hello
	// bye
}
```

å‡½æ•°ä¸­`Output`æ³¨é‡Šè¡¨æ˜äº†æ£€æµ‹å‡½æ•°è¾“å‡ºæ˜¯å¦ä¸º`hello`ï¼Œæ¥ä¸‹æ¥æ‰§è¡Œæµ‹è¯•å‘½ä»¤çœ‹çœ‹ç»“æœã€‚

```sh
$ go test -v
=== RUN   ExampleHello
--- PASS: ExampleHello (0.00s)
=== RUN   ExampleGoodBye
--- PASS: ExampleGoodBye (0.00s)
=== RUN   ExampleSay
--- PASS: ExampleSay (0.00s)
PASS
ok      golearn/test    0.448s
```

ä»ç»“æœå¯ä»¥çœ‹å‡ºå…¨éƒ¨æµ‹è¯•éƒ½å·²ç»é€šè¿‡ï¼Œå…³äº`Output`æœ‰ä»¥ä¸‹å‡ ç§å†™æ³•ï¼Œç¬¬ä¸€ç§æ˜¯åªæœ‰ä¸€è¡Œè¾“å‡ºï¼Œæ„ä¸ºæ£€æµ‹è¯¥å‡½æ•°çš„è¾“å‡ºæ˜¯ä¸æ˜¯hello

```
// Output:
// hello
```

ç¬¬äºŒç§æ˜¯å¤šè¡Œè¾“å‡ºï¼Œå³æŒ‰é¡ºåºæ£€æµ‹è¾“å‡ºæ˜¯å¦åŒ¹é…

```
// Output:
// hello
// bye
```

ç¬¬ä¸‰ç§æ˜¯æ— åºè¾“å‡ºï¼Œå³ä¸æŒ‰ç…§é¡ºåºå¤šè¡Œè¾“å‡ºåŒ¹é…

```
// Unordered output:
// bye
// hello
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºæµ‹è¯•å‡½æ•°è€Œè¨€ï¼Œä»…å½“æœ€åå‡ è¡Œä¸º`Output`æ³¨é‡Šæ‰ä¼šè¢«è§†ä¸ºç¤ºä¾‹æµ‹è¯•ï¼Œå¦åˆ™å°±åªæ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œä¸ä¼šè¢«Goæ‰§è¡Œã€‚

<br>

## å•å…ƒæµ‹è¯•

å•å…ƒæµ‹è¯•å°±æ˜¯å¯¹è½¯ä»¶ä¸­çš„æœ€å°å¯æµ‹è¯•å•å…ƒè¿›è¡Œæµ‹è¯•ï¼Œå•å…ƒçš„å¤§å°å®šä¹‰å–å†³äºå¼€å‘è€…ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªåŒ…ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªç±»å‹ã€‚ä¸‹é¢ä¾æ—§é€šè¿‡ä¾‹å­æ¥æ¼”ç¤ºï¼Œé¦–å…ˆåˆ›å»º`/tool/math.go`æ–‡ä»¶ï¼Œå†™å…¥å¦‚ä¸‹ä»£ç 

```go
package tool

type Number interface {
	~int8 | ~int16 | ~int32 | ~int64 | ~int
}

func SumInt[T Number](a, b T) T {
	return a + b
}

func Equal[T Number](a, b T) bool {
	return a == b
}
```

ç„¶ååˆ›å»ºæµ‹è¯•æ–‡ä»¶`/tool_test/unit_test.go`ï¼Œå¯¹äºå•å…ƒæµ‹è¯•è€Œè¨€ï¼Œå‘½åå¯ä»¥ä¸º`unit_test`æˆ–è€…æ˜¯æƒ³è¦æµ‹è¯•çš„åŒ…æˆ–è€…åŠŸèƒ½ä½œä¸ºæ–‡ä»¶å‰ç¼€ã€‚

```go
package test_test

import (
	"golearn/tool"
	"testing"
)

func TestSum(t *testing.T) {
	a, b := 10, 101
	expected := 111

	actual := tool.SumInt(a, b)
	if actual != expected {
		t.Errorf("Sum(%d,%d) expected %d,actual is %d", a, b, expected, actual)
	}
}

func TestEqual(t *testing.T) {
	a, b := 10, 101
	expected := false

	actual := tool.Equal(a, b)
	if actual != expected {
		t.Errorf("Sum(%d,%d) expected %t,actual is %t", a, b, expected, actual)
	}
}
```

å¯¹äºå•å…ƒæµ‹è¯•è€Œè¨€ï¼Œæ¯ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹çš„å‘½åé£æ ¼ä¸º`TestXXXX`ï¼Œä¸”å‡½æ•°çš„å…¥å‚å¿…é¡»æ˜¯`t *testing.T`ï¼Œ`testing.T`æ˜¯`testing`åŒ…æä¾›çš„ç”¨äºæ–¹ä¾¿æµ‹è¯•çš„ç»“æ„ä½“ï¼Œæä¾›äº†è®¸å¤šå¯ç”¨çš„æ–¹æ³•ï¼Œä¾‹å­ä¸­çš„`t.Errorf`ç­‰åŒäº`t.Logf`ï¼Œç”¨äºæ ¼å¼åŒ–è¾“å‡ºæµ‹è¯•å¤±è´¥çš„æ—¥å¿—ä¿¡æ¯ï¼Œå…¶ä»–å¸¸ç”¨çš„è¿˜æœ‰`t.Fail`ç”¨äºå°†å½“å‰ç”¨ä¾‹æ ‡è®°ä¸ºæµ‹è¯•å¤±è´¥ï¼ŒåŠŸèƒ½ç±»ä¼¼çš„è¿˜æœ‰`t.FailNow`åŒæ ·ä¼šæ ‡è®°ä¸ºæµ‹è¯•å¤±è´¥ï¼Œä½†æ˜¯å‰è€…å¤±è´¥åè¿˜ä¼šç»§ç»­æ‰§è¡Œï¼Œåè€…åˆ™ä¼šç›´æ¥åœæ­¢æ‰§è¡Œï¼Œå¦‚ä¸‹æ–¹çš„ä¾‹å­ï¼Œå°†é¢„æœŸç»“æœä¿®æ”¹ä¸ºé”™è¯¯çš„ç»“æœï¼š

```go
package tool_test

import (
	"golearn/tool"
	"testing"
)

func TestSum(t *testing.T) {
	a, b := 10, 101
	expected := 110

	actual := tool.SumInt(a, b)
	if actual != expected {
        // Errorfå†…éƒ¨ä½¿ç”¨çš„æ˜¯t.Fail()
		t.Errorf("Sum(%d,%d) expected %d,actual is %d", a, b, expected, actual)
	}
	t.Log("test finished")
}

func TestEqual(t *testing.T) {
	a, b := 10, 101
	expected := true

	actual := tool.Equal(a, b)
	if actual != expected {
        // Fatalfå†…éƒ¨ä½¿ç”¨çš„æ˜¯t.FailNow()
		t.Fatalf("Sum(%d,%d) expected %t,actual is %t", a, b, expected, actual)
	}
	t.Log("test finished")
}

```

æ‰§è¡Œä¸Šè¿°æµ‹è¯•è¾“å‡ºå¦‚ä¸‹

```sh
$ go test tool_test.go -v
=== RUN   TestSum
    tool_test.go:14: Sum(10,101) expected 110,actual is 111
    tool_test.go:16: test finished
--- FAIL: TestSum (0.00s)
=== RUN   TestEqual
    tool_test.go:25: Sum(10,101) expected true,actual is false
--- FAIL: TestEqual (0.00s)
FAIL    command-line-arguments  0.037s
```

ä»æµ‹è¯•æ—¥å¿—ä¸­å¯ä»¥çœ‹å‡º`TestSum`ç”¨ä¾‹å°½ç®¡å¤±è´¥äº†è¿˜æ˜¯è¾“å‡ºäº†test finishedï¼Œè€Œ`TestEqual`åˆ™æ²¡æœ‰ï¼ŒåŒæ ·çš„è¿˜æœ‰`t.SkipNow`ï¼Œä¼šå°†å½“å‰ç”¨ä¾‹æ ‡è®°ä¸º`SKIP`ï¼Œç„¶ååœæ­¢æ‰§è¡Œï¼Œåœ¨ä¸‹ä¸€è½®æµ‹è¯•ä¸­ä¼šç»§ç»­æ‰§è¡Œã€‚

```go
package tool_test

import (
   "golearn/tool"
   "testing"
)

func TestSum(t *testing.T) {
   a, b := 10, 101
   expected := 110

   actual := tool.SumInt(a, b)
   if actual != expected {
      t.Skipf("Sum(%d,%d) expected %d,actual is %d", a, b, expected, actual)
   }
   t.Log("test finished")
}

func TestEqual(t *testing.T) {
   a, b := 10, 101
   expected := true

   actual := tool.Equal(a, b)
   if actual != expected {
      t.Fatalf("Sum(%d,%d) expected %t,actual is %t", a, b, expected, actual)
   }
   t.Log("test finished")
}
```

åœ¨æ‰§è¡Œæµ‹è¯•æ—¶ï¼Œä¿®æ”¹æµ‹è¯•æ¬¡æ•°ä¸º2

```go
$ go test tool_test.go -v -count=2
=== RUN   TestSum
    tool_test.go:14: Sum(10,101) expected 110,actual is 111
--- SKIP: TestSum (0.00s)
=== RUN   TestEqual
    tool_test.go:25: Sum(10,101) expected true,actual is false
--- FAIL: TestEqual (0.00s)
=== RUN   TestSum
    tool_test.go:14: Sum(10,101) expected 110,actual is 111
--- SKIP: TestSum (0.00s)
=== RUN   TestEqual
    tool_test.go:25: Sum(10,101) expected true,actual is false
--- FAIL: TestEqual (0.00s)
FAIL    command-line-arguments  0.468s
```

ä¸Šæ•°çš„ä¾‹å­ä¸­åœ¨æœ€åä¸€è¡Œè¾“å‡ºäº†test finishedï¼Œç”¨äºè¡¨ç¤ºæµ‹è¯•å®Œæ¯•ï¼Œå…¶å®å¯ä»¥ä½¿ç”¨`t.Cleanup`æ¥æ³¨å†Œä¸€ä¸ªæ”¶å°¾å‡½æ•°ä¸“é—¨åšæ­¤äº‹ï¼Œè¯¥å‡½æ•°ä¼šåœ¨æµ‹è¯•ç”¨ä¾‹ç»“æŸæ—¶æ‰§è¡Œï¼Œå¦‚ä¸‹ã€‚

```go
package tool_test

import (
	"golearn/tool"
	"testing"
)

func finished(t *testing.T) {
	t.Log("test finished")
}

func TestSum(t *testing.T) {
	t.Cleanup(func() {
		finished(t)
	})

	a, b := 10, 101
	expected := 111

	actual := tool.SumInt(a, b)
	if actual != expected {
		t.Skipf("Sum(%d,%d) expected %d,actual is %d", a, b, expected, actual)
	}

}

func TestEqual(t *testing.T) {
	t.Cleanup(func() {
		finished(t)
	})

	a, b := 10, 101
	expected := false

	actual := tool.Equal(a, b)
	if actual != expected {
		t.Fatalf("Sum(%d,%d) expected %t,actual is %t", a, b, expected, actual)
	}
}
```

æ‰§è¡Œæµ‹è¯•åè¾“å‡ºå¦‚ä¸‹

```
$ go test tool_test.go -v
=== RUN   TestSum
    tool_test.go:9: test finished
--- PASS: TestSum (0.00s)
=== RUN   TestEqual
    tool_test.go:9: test finished
--- PASS: TestEqual (0.00s)
PASS
ok      command-line-arguments  0.462s
```

### Helper

é€šè¿‡`t.Helper()`å¯ä»¥å°†å½“å‰å‡½æ•°æ ‡è®°ä¸ºå¸®åŠ©å‡½æ•°ï¼Œå¸®åŠ©å‡½æ•°ä¸ä¼šå•ç‹¬ä½œä¸ºä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ç”¨äºæ‰§è¡Œï¼Œåœ¨è®°å½•æ—¥å¿—æ—¶è¾“å‡ºçš„è¡Œå·ä¹Ÿæ˜¯å¸®åŠ©å‡½æ•°çš„è°ƒç”¨è€…çš„è¡Œå·ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—åˆ†ææ—¥å¿—æ—¶å®šä½æ›´å‡†ç¡®ï¼Œé¿å…çš„å†—æ‚çš„å…¶ä»–ä¿¡æ¯ã€‚æ¯”å¦‚å°†ä¸Šè¿°`t.Cleanup`çš„ä¾‹å­å°±å¯ä»¥ä¿®æ”¹ä¸ºå¸®åŠ©å‡½æ•°ï¼Œå¦‚ä¸‹ã€‚

```go
package tool_test

import (
   "golearn/tool"
   "testing"
)

func CleanupHelper(t *testing.T) {
   t.Helper()
   t.Log("test finished")
}

func TestSum(t *testing.T) {
   t.Cleanup(func() {
      CleanupHelper(t)
   })

   a, b := 10, 101
   expected := 111

   actual := tool.SumInt(a, b)
   if actual != expected {
      t.Skipf("Sum(%d,%d) expected %d,actual is %d", a, b, expected, actual)
   }

}

func TestEqual(t *testing.T) {
   t.Cleanup(func() {
      CleanupHelper(t)
   })

   a, b := 10, 101
   expected := false

   t.Helper()
   actual := tool.Equal(a, b)
   if actual != expected {
      t.Fatalf("Sum(%d,%d) expected %t,actual is %t", a, b, expected, actual)
   }
}
```

æ‰§è¡Œæµ‹è¯•åè¾“å‡ºä¿¡æ¯å¦‚ä¸‹ï¼Œä¸ä¹‹å‰çš„åŒºåˆ«åœ¨äºtest finishedçš„è¡Œå·å˜æˆäº†è°ƒç”¨è€…çš„è¡Œå·ã€‚

```
$ go test tool_test.go -v
=== RUN   TestSum
    tool_test.go:15: test finished
--- PASS: TestSum (0.00s)
=== RUN   TestEqual
    tool_test.go:30: test finished
--- PASS: TestEqual (0.00s)
PASS
ok      command-line-arguments  0.464s
```

::: tip

ä¸Šè¿°æ“ä½œéƒ½åªèƒ½åœ¨ä¸»æµ‹è¯•ä¸­è¿›è¡Œï¼Œå³ç›´æ¥æ‰§è¡Œçš„æµ‹è¯•ç”¨ä¾‹ï¼Œå¦‚æœæ˜¯å­æµ‹è¯•ä¸­ä½¿ç”¨å°†ä¼š`panic`ã€‚

:::

### å­æµ‹è¯•

åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œä¼šéœ€è¦ç”¨åˆ°åœ¨ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ä¸­æµ‹è¯•å¦å¤–æµ‹è¯•ç”¨ä¾‹ï¼Œè¿™ç§åµŒå¥—çš„æµ‹è¯•ç”¨ä¾‹ä¸€èˆ¬ç§°ä¸ºå­æµ‹è¯•ï¼Œé€šè¿‡`t.Run()`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç­¾åå¦‚ä¸‹

```go
// Runæ–¹æ³•ä¼šå¼€å¯ä¸€ä¸ªæ–°çš„åç¨‹ç”¨äºè¿è¡Œå­æµ‹è¯•ï¼Œé˜»å¡ç­‰å¾…å‡½æ•°fæ‰§è¡Œå®Œæ¯•åæ‰ä¼šè¿”å›
// è¿”å›å€¼ä¸ºæ˜¯å¦é€šè¿‡æµ‹è¯•
func (t *T) Run(name string, f func(t *T)) bool 
```

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­

```go
func TestTool(t *testing.T) {
	t.Run("tool.Sum(10,101)", TestSum)
	t.Run("tool.Equal(10,101)", TestEqual)
}
```

æ‰§è¡Œåç»“æœå¦‚ä¸‹

```sh
$ go test -run TestTool -v
=== RUN   TestTool
=== RUN   TestTool/tool.Sum(10,101)
    tool_test.go:15: test finished
=== RUN   TestTool/tool.Equal(10,101)
    tool_test.go:30: test finished
--- PASS: TestTool (0.00s)
    --- PASS: TestTool/tool.Sum(10,101) (0.00s)
    --- PASS: TestTool/tool.Equal(10,101) (0.00s)
PASS
ok      golearn/tool_test       0.449s
```

é€šè¿‡è¾“å‡ºå¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°çˆ¶å­çš„å±‚çº§ç»“æ„ï¼Œåœ¨ä¸Šè¿°çš„ä¾‹å­ä¸­ç¬¬ä¸€ä¸ªå­æµ‹è¯•æœªæ‰§è¡Œå®Œæ¯•ç¬¬äºŒä¸ªå­æµ‹è¯•æ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼Œå¯ä»¥ä½¿ç”¨`t.Parallel()`å°†æµ‹è¯•ç”¨ä¾‹æ ‡è®°ä¸ºå¯å¹¶è¡Œè¿è¡Œï¼Œå¦‚æ­¤ä¸€æ¥è¾“å‡ºçš„é¡ºåºå°†ä¼šæ— æ³•ç¡®å®šã€‚

```go
package tool_test

import (
	"golearn/tool"
	"testing"
)

func CleanupHelper(t *testing.T) {
	t.Helper()
	t.Log("test finished")
}

func TestSum(t *testing.T) {
	t.Parallel()
	t.Cleanup(func() {
		CleanupHelper(t)
	})

	a, b := 10, 101
	expected := 111

	actual := tool.SumInt(a, b)
	if actual != expected {
		t.Skipf("Sum(%d,%d) expected %d,actual is %d", a, b, expected, actual)
	}

}

func TestEqual(t *testing.T) {
	t.Parallel()
	t.Cleanup(func() {
		CleanupHelper(t)
	})

	a, b := 10, 101
	expected := false

	actual := tool.Equal(a, b)
	if actual != expected {
		t.Fatalf("Sum(%d,%d) expected %t,actual is %t", a, b, expected, actual)
	}
}

func TestToolParallel(t *testing.T) {
	t.Log("setup")
	t.Run("tool.Sum(10,101)", TestSum)
	t.Run("tool.Equal(10,101)", TestEqual)
	t.Log("teardown")
}

```

æ‰§è¡Œæµ‹è¯•åè¾“å‡ºå¦‚ä¸‹

```
$ go test -run TestTool -v
=== RUN   TestToolParallel
    tool_test.go:46: setup
=== RUN   TestToolParallel/tool.Sum(10,101)
=== PAUSE TestToolParallel/tool.Sum(10,101)
=== RUN   TestToolParallel/tool.Equal(10,101)
=== PAUSE TestToolParallel/tool.Equal(10,101)
=== NAME  TestToolParallel
    tool_test.go:49: teardown
=== CONT  TestToolParallel/tool.Sum(10,101)
=== CONT  TestToolParallel/tool.Equal(10,101)
=== NAME  TestToolParallel/tool.Sum(10,101)
    tool_test.go:16: test finished
=== NAME  TestToolParallel/tool.Equal(10,101)
    tool_test.go:32: test finished
--- PASS: TestToolParallel (0.00s)
    --- PASS: TestToolParallel/tool.Sum(10,101) (0.00s)
    --- PASS: TestToolParallel/tool.Equal(10,101) (0.00s)
PASS
ok      golearn/tool_test       0.444s
```

ä»æµ‹è¯•ç»“æœä¸­å°±å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæœ‰ä¸€ä¸ªé˜»å¡ç­‰å¾…çš„è¿‡ç¨‹ï¼Œåœ¨å¹¶å‘æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹æ—¶ï¼Œåƒä¸Šè¿°çš„ä¾‹å­è‚¯å®šæ˜¯æ— æ³•æ­£å¸¸è¿›è¡Œçš„ï¼Œå› ä¸ºåç»­çš„ä»£ç æ— æ³•ä¿è¯åŒæ­¥è¿è¡Œï¼Œè¿™æ—¶å¯ä»¥é€‰æ‹©å†åµŒå¥—ä¸€å±‚`t.Run()`ï¼Œå¦‚ä¸‹

```go
func TestToolParallel(t *testing.T) {
	t.Log("setup")
	t.Run("process", func(t *testing.T) {
		t.Run("tool.Sum(10,101)", TestSum)
		t.Run("tool.Equal(10,101)", TestEqual)
	})
	t.Log("teardown")
}
```

å†æ¬¡æ‰§è¡Œï¼Œå°±å¯ä»¥çœ‹åˆ°æ­£å¸¸çš„æ‰§è¡Œç»“æœäº†ã€‚

```
$ go test -run TestTool -v
=== RUN   TestToolParallel
    tool_test.go:46: setup
=== RUN   TestToolParallel/process
=== RUN   TestToolParallel/process/tool.Sum(10,101)
=== PAUSE TestToolParallel/process/tool.Sum(10,101)
=== RUN   TestToolParallel/process/tool.Equal(10,101)
=== PAUSE TestToolParallel/process/tool.Equal(10,101)
=== CONT  TestToolParallel/process/tool.Sum(10,101)
=== CONT  TestToolParallel/process/tool.Equal(10,101)
=== NAME  TestToolParallel/process/tool.Sum(10,101)
    tool_test.go:16: test finished
=== NAME  TestToolParallel/process/tool.Equal(10,101)
    tool_test.go:32: test finished
=== NAME  TestToolParallel
    tool_test.go:51: teardown
--- PASS: TestToolParallel (0.00s)
    --- PASS: TestToolParallel/process (0.00s)
        --- PASS: TestToolParallel/process/tool.Sum(10,101) (0.00s)
        --- PASS: TestToolParallel/process/tool.Equal(10,101) (0.00s)
PASS
ok      golearn/tool_test       0.450s
```

### è¡¨æ ¼é£æ ¼

åœ¨ä¸Šè¿°çš„å•å…ƒæµ‹è¯•ä¸­ï¼Œæµ‹è¯•çš„è¾“å…¥æ•°æ®éƒ½æ˜¯æ‰‹åŠ¨å£°æ˜çš„ä¸€ä¸ªä¸ªå˜é‡ï¼Œå½“æ•°æ®é‡å°çš„æ—¶å€™æ— ä¼¤å¤§é›…ï¼Œä½†å¦‚æœæƒ³è¦æµ‹è¯•å¤šç»„æ•°æ®æ—¶ï¼Œå°±ä¸å¤ªå¯èƒ½å†å»å£°æ˜å˜é‡æ¥åˆ›å»ºæµ‹è¯•æ•°æ®ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯å°½é‡é‡‡ç”¨ç»“æ„ä½“åˆ‡ç‰‡çš„å½¢å¼ï¼Œç»“æ„ä½“æ˜¯ä¸´æ—¶å£°æ˜çš„åŒ¿åç»“æ„ä½“ï¼Œå› ä¸ºè¿™æ ·çš„ç¼–ç é£æ ¼çœ‹èµ·æ¥å°±è·Ÿè¡¨æ ¼ä¸€æ ·ï¼Œæ‰€ä»¥ç§°ä¸º`table-driven`ï¼Œä¸‹é¢ä¸¾ä¸ªä¾‹å­ï¼Œè¿™æ˜¯ä¸€ä¸ªæ‰‹åŠ¨å£°æ˜å¤šä¸ªå˜é‡æ¥åˆ›å»ºæµ‹è¯•æ•°æ®çš„ä¾‹å­ï¼Œå¦‚æœæœ‰å¤šç»„æ•°æ®ç‹ èµ·æ¥å°±ä¸æ˜¯å¾ˆç›´è§‚ï¼Œæ‰€ä»¥å°†å…¶ä¿®æ”¹ä¸ºè¡¨æ ¼é£æ ¼

```go
func TestEqual(t *testing.T) {
	t.Cleanup(func() {
		CleanupHelper(t)
	})

	a, b := 10, 101
	expected := false
	actual := tool.Equal(a, b)
	if actual != expected {
		t.Fatalf("Sum(%d,%d) expected %t,actual is %t", a, b, expected, actual)
	}
}
```

ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹

```go
func TestEqual(t *testing.T) {
	t.Cleanup(func() {
		CleanupHelper(t)
	})

	// table driven style
	testData := []struct {
		a, b int
		exp  bool
	}{
		{10, 101, false},
		{5, 5, true},
		{30, 32, false},
		{100, 101, false},
		{2, 3, false},
		{4, 4, true},
	}

	for _, data := range testData {
		if actual := tool.Equal(data.a, data.b); actual != data.exp {
			t.Fatalf("Sum(%d,%d) expected %t,actual is %t", data.a, data.b, data.exp, actual)
		}
	}
}
```

è¿™æ ·çš„æµ‹è¯•æ•°æ®çœ‹èµ·æ¥å°±è¦ç›´è§‚å¾ˆå¤šã€‚



## åŸºå‡†æµ‹è¯•

åŸºå‡†æµ‹è¯•åˆç§°ä¸ºæ€§èƒ½æµ‹è¯•ï¼Œé€šå¸¸ç”¨äºæµ‹è¯•ç¨‹åºçš„å†…å­˜å ç”¨ï¼ŒCPUä½¿ç”¨æƒ…å†µï¼Œæ‰§è¡Œè€—æ—¶ç­‰ç­‰æ€§èƒ½æŒ‡æ ‡ã€‚å¯¹äºåŸºå‡†æµ‹è¯•è€Œè¨€ï¼Œæµ‹è¯•æ–‡ä»¶é€šå¸¸ä»¥`bench_test.go`ç»“å°¾ï¼Œè€Œæµ‹è¯•ç”¨ä¾‹çš„å‡½æ•°å¿…é¡»ä¸º`BenchmarkXXXX`æ ¼å¼ã€‚

ä¸‹é¢ä»¥ä¸€ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥çš„ä¾‹å­çš„æ€§èƒ½æ¯”è¾ƒæ¥å½“ä½œåŸºå‡†æµ‹è¯•çš„ä¾‹å­ã€‚é¦–å…ˆåˆ›å»ºæ–‡ä»¶`/tool/strConcat.go`æ–‡ä»¶ï¼Œä¼—æ‰€å‘¨çŸ¥ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²è¿›è¡Œ`+`æ‹¼æ¥æ€§èƒ½æ˜¯å¾ˆä½çš„ï¼Œè€Œä½¿ç”¨`strings.Builder`åˆ™è¦å¥½å¾ˆå¤šï¼Œåœ¨`/tool/strings.go`æ–‡ä»¶åˆ†åˆ«åˆ›å»ºä¸¤ä¸ªå‡½æ•°è¿›è¡Œä¸¤ç§æ–¹å¼çš„å­—ç¬¦ä¸²æ‹¼æ¥ã€‚

```go
package tool

import "strings"


func ConcatStringDirect(longString string) {
   res := ""
   for i := 0; i < 100_000.; i++ {
      res += longString
   }
}

func ConcatStringWithBuilder(longString string) {
   var res strings.Builder
   for i := 0; i < 100_000.; i++ {
      res.WriteString(longString)
   }
}
```

ç„¶ååˆ›å»ºæµ‹è¯•æ–‡ä»¶`/tool_test/bench_tool_test.go `ï¼Œä»£ç å¦‚ä¸‹

```go
package tool_test

import (
	"golearn/tool"
	"testing"
)

var longString = "longStringlongStringlongStringlongStringlongStringlongStringlongStringlongString"

func BenchmarkConcatDirect(b *testing.B) {
	for i := 0; i < b.N; i++ {
		tool.ConcatStringDirect(longString)
	}
}

func BenchmarkConcatBuilder(b *testing.B) {
	for i := 0; i < b.N; i++ {
		tool.ConcatStringWithBuilder(longString)
	}
}
```

æ‰§è¡Œæµ‹è¯•å‘½ä»¤ï¼Œå‘½ä»¤ä¸­å¼€å¯äº†è¯¦ç»†æ—¥å¿—å’Œå†…å­˜åˆ†æï¼ŒæŒ‡å®šäº†ä½¿ç”¨çš„CPUæ ¸æ•°åˆ—è¡¨ï¼Œä¸”æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œä¸¤è½®ï¼Œè¾“å‡ºå¦‚ä¸‹

```sh
$ go test -v -benchmem -bench . -run bench_tool_test.go -cpu=2,4,8 -count=2
goos: windows
goarch: amd64
pkg: golearn/tool_test
cpu: 11th Gen Intel(R) Core(TM) i7-11800H @ 2.30GHz
BenchmarkConcatDirect
BenchmarkConcatDirect-2                4         277771375 ns/op        4040056736 B/op    10000 allocs/op
BenchmarkConcatDirect-2                4         278500125 ns/op        4040056592 B/op     9999 allocs/op
BenchmarkConcatDirect-4                1        1153796000 ns/op        4040068784 B/op    10126 allocs/op
BenchmarkConcatDirect-4                1        1211017600 ns/op        4040073104 B/op    10171 allocs/op
BenchmarkConcatDirect-8                2         665460800 ns/op        4040077760 B/op    10219 allocs/op
BenchmarkConcatDirect-8                2         679774450 ns/op        4040080064 B/op    10243 allocs/op
BenchmarkConcatBuilder
BenchmarkConcatBuilder-2            3428            344530 ns/op         4128176 B/op         29 allocs/op
BenchmarkConcatBuilder-2            3579            351858 ns/op         4128176 B/op         29 allocs/op
BenchmarkConcatBuilder-4            2448            736177 ns/op         4128185 B/op         29 allocs/op
BenchmarkConcatBuilder-4            1688            662993 ns/op         4128185 B/op         29 allocs/op
BenchmarkConcatBuilder-8            1958            550333 ns/op         4128199 B/op         29 allocs/op
BenchmarkConcatBuilder-8            2174            552113 ns/op         4128196 B/op         29 allocs/op
PASS
ok      golearn/tool_test       21.381s
```

ä¸‹é¢è§£é‡Šä¸€ä¸‹åŸºå‡†æµ‹è¯•çš„è¾“å‡ºç»“æœï¼Œ`goos`ä»£è¡¨æ˜¯è¿è¡Œçš„æ“ä½œç³»ç»Ÿï¼Œ`goarh`ä»£è¡¨çš„æ˜¯CPUæ¶æ„ï¼Œ`pkg`ä¸ºæµ‹è¯•æ‰€åœ¨çš„åŒ…ï¼Œ`cpu`æ˜¯ä¸€äº›å…³äºCPUçš„ä¿¡æ¯ã€‚ä¸‹é¢çš„æ¯ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹çš„ç»“æœç”±æ¯ä¸€ä¸ªåŸºå‡†æµ‹è¯•çš„åç§°åˆ†éš”ï¼Œç¬¬ä¸€åˆ—`BenchmarkConcatDirect-2`ä¸­çš„2ä»£è¡¨äº†ä½¿ç”¨çš„CPUæ ¸æ•°ï¼Œç¬¬äºŒåˆ—çš„4ä»£è¡¨äº†ä»£ç ä¸­`b.N`çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯åŸºå‡†æµ‹è¯•ä¸­çš„å¾ªç¯æ¬¡æ•°ï¼Œç¬¬ä¸‰åˆ—`277771375 ns/op`ä»£è¡¨äº†æ¯ä¸€æ¬¡å¾ªç¯æ‰€æ¶ˆè€—çš„æ—¶é—´ï¼Œnsä¸ºçº³ç§’ï¼Œç¬¬å››åˆ—`4040056736 B/op`è¡¨ç¤ºæ¯ä¸€æ¬¡å¾ªç¯æ‰€åˆ†é…å†…å­˜çš„å­—èŠ‚å¤§å°ï¼Œç¬¬äº”åˆ—`10000 allocs/op`è¡¨ç¤ºæ¯ä¸€æ¬¡å¾ªç¯å†…å­˜åˆ†é…çš„æ¬¡æ•°ã€‚

å¾ˆæ˜¾ç„¶ï¼Œæ ¹æ®æµ‹è¯•çš„ç»“æœçœ‹æ¥ï¼Œä½¿ç”¨`strings.Builder`çš„æ€§èƒ½è¦è¿œè¿œé«˜äºä½¿ç”¨`+`æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œé€šè¿‡ç›´è§‚çš„æ•°æ®å¯¹æ¯”æ€§èƒ½æ­£æ˜¯åŸºå‡†æµ‹è¯•çš„ç›®çš„æ‰€åœ¨ã€‚

### benchstat

benchstatæ˜¯ä¸€ä¸ªå¼€æºçš„æ€§èƒ½æµ‹è¯•åˆ†æå·¥å…·ï¼Œä¸Šè¿°æ€§èƒ½æµ‹è¯•çš„æ ·æœ¬æ•°åªæœ‰ä¸¤ç»„ï¼Œä¸€æ—¦æ ·æœ¬å¤šäº†èµ·æ¥äººå·¥åˆ†æå°±ä¼šååˆ†çš„è´¹æ—¶è´¹åŠ›ï¼Œè¯¥å·¥å…·ä¾¿æ˜¯ä¸ºäº†è§£å†³æ€§èƒ½åˆ†æé—®é¢˜è€Œç”Ÿã€‚

é¦–å…ˆéœ€è¦ä¸‹è½½è¯¥å·¥å…·

```sh
$ go install golang.org/x/perf/benchstat
```

åˆ†ä¸¤æ¬¡æ‰§è¡ŒåŸºå‡†æµ‹è¯•ï¼Œè¿™æ¬¡å°†æ ·æœ¬æ•°ä¿®æ”¹ä¸º5ä¸ªï¼Œå¹¶ä¸”åˆ†åˆ«è¾“å‡ºåˆ°`old.txt`å’Œ`new.txt`æ–‡ä»¶ä»¥åšå¯¹æ¯”ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œç»“æœ

```sh
$ go test -v -benchmem -bench . -run bench_tool_test.go -cpu=2,4,8 -count=5 | tee -a old.txt
goos: windows
goarch: amd64
pkg: golearn/tool_test
cpu: 11th Gen Intel(R) Core(TM) i7-11800H @ 2.30GHz
BenchmarkConcatDirect
BenchmarkConcatDirect-2                4         290535650 ns/op        4040056592 B/op     9999 allocs/op
BenchmarkConcatDirect-2                4         298974625 ns/op        4040056592 B/op     9999 allocs/op
BenchmarkConcatDirect-2                4         299637800 ns/op        4040056592 B/op     9999 allocs/op
BenchmarkConcatDirect-2                4         276487000 ns/op        4040056784 B/op    10001 allocs/op
BenchmarkConcatDirect-2                4         356465275 ns/op        4040056592 B/op     9999 allocs/op
BenchmarkConcatDirect-4                2         894723200 ns/op        4040077424 B/op    10216 allocs/op
BenchmarkConcatDirect-4                2         785830400 ns/op        4040078288 B/op    10225 allocs/op
BenchmarkConcatDirect-4                2         743634000 ns/op        4040077568 B/op    10217 allocs/op
BenchmarkConcatDirect-4                2         953802700 ns/op        4040075408 B/op    10195 allocs/op
BenchmarkConcatDirect-4                2         953028750 ns/op        4040077520 B/op    10217 allocs/op
BenchmarkConcatDirect-8                2         684023150 ns/op        4040086784 B/op    10313 allocs/op
BenchmarkConcatDirect-8                2         634380250 ns/op        4040090528 B/op    10352 allocs/op
BenchmarkConcatDirect-8                2         685030600 ns/op        4040090768 B/op    10355 allocs/op
BenchmarkConcatDirect-8                2         817909650 ns/op        4040089808 B/op    10345 allocs/op
BenchmarkConcatDirect-8                2         600078100 ns/op        4040095664 B/op    10406 allocs/op
BenchmarkConcatBuilder
BenchmarkConcatBuilder-2            2925            419651 ns/op         4128176 B/op         29 allocs/op
BenchmarkConcatBuilder-2            2961            423899 ns/op         4128176 B/op         29 allocs/op
BenchmarkConcatBuilder-2            2714            422275 ns/op         4128176 B/op         29 allocs/op
BenchmarkConcatBuilder-2            2848            452255 ns/op         4128176 B/op         29 allocs/op
BenchmarkConcatBuilder-2            2612            454452 ns/op         4128176 B/op         29 allocs/op
BenchmarkConcatBuilder-4             974           1158000 ns/op         4128189 B/op         29 allocs/op
BenchmarkConcatBuilder-4            1098           1068682 ns/op         4128192 B/op         29 allocs/op
BenchmarkConcatBuilder-4            1042           1056570 ns/op         4128194 B/op         29 allocs/op
BenchmarkConcatBuilder-4            1280            978213 ns/op         4128191 B/op         29 allocs/op
BenchmarkConcatBuilder-4            1538           1162108 ns/op         4128190 B/op         29 allocs/op
BenchmarkConcatBuilder-8            1744            700824 ns/op         4128203 B/op         29 allocs/op
BenchmarkConcatBuilder-8            2235            759537 ns/op         4128201 B/op         29 allocs/op
BenchmarkConcatBuilder-8            1556            736455 ns/op         4128204 B/op         29 allocs/op
BenchmarkConcatBuilder-8            1592            825794 ns/op         4128201 B/op         29 allocs/op
BenchmarkConcatBuilder-8            2263            717285 ns/op         4128203 B/op         29 allocs/op
PASS
ok      golearn/tool_test       56.742s
```

ç¬¬äºŒæ¬¡æ‰§è¡Œç»“æœ

```sh
$ go test -v -benchmem -bench . -run bench_tool_test.go -cpu=2,4,8 -count=5 | tee -a new.txt
goos: windows
goarch: amd64
pkg: golearn/tool_test
cpu: 11th Gen Intel(R) Core(TM) i7-11800H @ 2.30GHz
BenchmarkConcatDirect
BenchmarkConcatDirect-2                4         285074900 ns/op        4040056592 B/op     9999 allocs/op
BenchmarkConcatDirect-2                4         291517150 ns/op        4040056592 B/op     9999 allocs/op
BenchmarkConcatDirect-2                4         281901975 ns/op        4040056592 B/op     9999 allocs/op
BenchmarkConcatDirect-2                4         292320625 ns/op        4040056592 B/op     9999 allocs/op
BenchmarkConcatDirect-2                4         286723000 ns/op        4040056952 B/op    10002 allocs/op
BenchmarkConcatDirect-4                1        1188983000 ns/op        4040071856 B/op    10158 allocs/op
BenchmarkConcatDirect-4                1        1080713900 ns/op        4040070800 B/op    10147 allocs/op
BenchmarkConcatDirect-4                1        1203622300 ns/op        4040067344 B/op    10111 allocs/op
BenchmarkConcatDirect-4                1        1045291300 ns/op        4040070224 B/op    10141 allocs/op
BenchmarkConcatDirect-4                1        1123163300 ns/op        4040070032 B/op    10139 allocs/op
BenchmarkConcatDirect-8                2         790421300 ns/op        4040076656 B/op    10208 allocs/op
BenchmarkConcatDirect-8                2         659047300 ns/op        4040079488 B/op    10237 allocs/op
BenchmarkConcatDirect-8                2         712991800 ns/op        4040077184 B/op    10213 allocs/op
BenchmarkConcatDirect-8                2         706605350 ns/op        4040078000 B/op    10222 allocs/op
BenchmarkConcatDirect-8                2         656195700 ns/op        4040085248 B/op    10297 allocs/op
BenchmarkConcatBuilder
BenchmarkConcatBuilder-2            2726            386412 ns/op         4128176 B/op         29 allocs/op
BenchmarkConcatBuilder-2            3439            335358 ns/op         4128176 B/op         29 allocs/op
BenchmarkConcatBuilder-2            3376            338957 ns/op         4128176 B/op         29 allocs/op
BenchmarkConcatBuilder-2            3870            326301 ns/op         4128176 B/op         29 allocs/op
BenchmarkConcatBuilder-2            4285            339596 ns/op         4128176 B/op         29 allocs/op
BenchmarkConcatBuilder-4            1663            671535 ns/op         4128187 B/op         29 allocs/op
BenchmarkConcatBuilder-4            1507            744885 ns/op         4128191 B/op         29 allocs/op
BenchmarkConcatBuilder-4            1353           1097800 ns/op         4128187 B/op         29 allocs/op
BenchmarkConcatBuilder-4            1388           1006019 ns/op         4128189 B/op         29 allocs/op
BenchmarkConcatBuilder-4            1635            993764 ns/op         4128189 B/op         29 allocs/op
BenchmarkConcatBuilder-8            1332            783599 ns/op         4128198 B/op         29 allocs/op
BenchmarkConcatBuilder-8            1818            729821 ns/op         4128202 B/op         29 allocs/op
BenchmarkConcatBuilder-8            1398            780614 ns/op         4128202 B/op         29 allocs/op
BenchmarkConcatBuilder-8            1526            750513 ns/op         4128204 B/op         29 allocs/op
BenchmarkConcatBuilder-8            2164            704798 ns/op         4128204 B/op         29 allocs/op
PASS
ok      golearn/tool_test       50.387s
```

å†ä½¿ç”¨benchstatè¿›è¡Œå¯¹æ¯”

```sh
$ benchstat old.txt new.txt
goos: windows
goarch: amd64
pkg: golearn/tool_test
cpu: 11th Gen Intel(R) Core(TM) i7-11800H @ 2.30GHz
                â”‚    old.txt    â”‚               new.txt                â”‚
                â”‚    sec/op     â”‚    sec/op      vs base               â”‚
ConcatDirect-2     299.0m Â± âˆ Â¹    286.7m Â± âˆ Â¹        ~ (p=0.310 n=5)
ConcatDirect-4     894.7m Â± âˆ Â¹   1123.2m Â± âˆ Â¹  +25.53% (p=0.008 n=5)
ConcatDirect-8     684.0m Â± âˆ Â¹    706.6m Â± âˆ Â¹        ~ (p=0.548 n=5)
ConcatBuilder-2    423.9Âµ Â± âˆ Â¹    339.0Âµ Â± âˆ Â¹  -20.04% (p=0.008 n=5)
ConcatBuilder-4   1068.7Âµ Â± âˆ Â¹    993.8Âµ Â± âˆ Â¹        ~ (p=0.151 n=5)
ConcatBuilder-8    736.5Âµ Â± âˆ Â¹    750.5Âµ Â± âˆ Â¹        ~ (p=0.841 n=5)
geomean            19.84m          19.65m         -0.98%
Â¹ need >= 6 samples for confidence interval at level 0.95

                â”‚    old.txt    â”‚                new.txt                â”‚
                â”‚     B/op      â”‚     B/op       vs base                â”‚
ConcatDirect-2    3.763Gi Â± âˆ Â¹   3.763Gi Â± âˆ Â¹       ~ (p=1.000 n=5)
ConcatDirect-4    3.763Gi Â± âˆ Â¹   3.763Gi Â± âˆ Â¹  -0.00% (p=0.008 n=5)
ConcatDirect-8    3.763Gi Â± âˆ Â¹   3.763Gi Â± âˆ Â¹  -0.00% (p=0.008 n=5)
ConcatBuilder-2   3.937Mi Â± âˆ Â¹   3.937Mi Â± âˆ Â¹       ~ (p=1.000 n=5) Â²
ConcatBuilder-4   3.937Mi Â± âˆ Â¹   3.937Mi Â± âˆ Â¹       ~ (p=0.079 n=5)
ConcatBuilder-8   3.937Mi Â± âˆ Â¹   3.937Mi Â± âˆ Â¹       ~ (p=0.952 n=5)
geomean           123.2Mi         123.2Mi        -0.00%
Â¹ need >= 6 samples for confidence interval at level 0.95
Â² all samples are equal

                â”‚   old.txt    â”‚               new.txt                â”‚
                â”‚  allocs/op   â”‚  allocs/op    vs base                â”‚
ConcatDirect-2    9.999k Â± âˆ Â¹   9.999k Â± âˆ Â¹       ~ (p=1.000 n=5)
ConcatDirect-4    10.22k Â± âˆ Â¹   10.14k Â± âˆ Â¹  -0.74% (p=0.008 n=5)
ConcatDirect-8    10.35k Â± âˆ Â¹   10.22k Â± âˆ Â¹  -1.26% (p=0.008 n=5)
ConcatBuilder-2    29.00 Â± âˆ Â¹    29.00 Â± âˆ Â¹       ~ (p=1.000 n=5) Â²
ConcatBuilder-4    29.00 Â± âˆ Â¹    29.00 Â± âˆ Â¹       ~ (p=1.000 n=5) Â²
ConcatBuilder-8    29.00 Â± âˆ Â¹    29.00 Â± âˆ Â¹       ~ (p=1.000 n=5) Â²
geomean            543.6          541.7        -0.33%
Â¹ need >= 6 samples for confidence interval at level 0.95
Â² all samples are equal
```

ä»ç»“æœä¸­å¯ä»¥çœ‹å‡ºbenchstatå°†å…¶åˆ†ä¸ºäº†ä¸‰ç»„ï¼Œåˆ†åˆ«æ˜¯è€—æ—¶ï¼Œå†…å­˜å ç”¨å’Œå†…å­˜åˆ†é…æ¬¡æ•°ï¼Œå…¶ä¸­`geomoean`ä¸ºå¹³å‡å€¼ï¼Œ`p`ä¸º æ ·æœ¬çš„æ˜¾è‘—æ€§æ°´å¹³ï¼Œä¸´ç•ŒåŒºé—´é€šå¸¸ä¸º0.05ï¼Œé«˜äº0.05å°±ä¸å¤ªå¯ä¿¡ï¼Œå–å…¶ä¸­ä¸€æ¡æ•°æ®å¦‚ä¸‹ï¼š

```
					â”‚    sec/op     â”‚    sec/op      vs base               â”‚
ConcatDirect-4     894.7m Â± âˆ Â¹   1123.2m Â± âˆ Â¹  +25.53% (p=0.008 n=5)
```

å¯ä»¥çœ‹åˆ°`old`æ‰§è¡Œè€—æ—¶ä¸º894.7msï¼Œ`new`æ‰§è¡Œè€—æ—¶1123.2msï¼Œç›¸æ¯”ä¹‹ä¸‹è¿˜å¢åŠ äº†25.53%çš„è€—æ—¶ã€‚

## æ¨¡ç³Šæµ‹è¯•

æ¨¡ç³Šæµ‹è¯•æ˜¯GO1.18æ¨å‡ºçš„ä¸€ä¸ªæ–°åŠŸèƒ½ï¼Œå±äºæ˜¯å•å…ƒæµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•çš„ä¸€ç§å¢å¼ºï¼ŒåŒºåˆ«åœ¨äºå‰ä¸¤è€…çš„æµ‹è¯•æ•°æ®éƒ½éœ€è¦å¼€å‘è€…æ‰‹åŠ¨ç¼–å†™ï¼Œè€Œæ¨¡ç³Šæµ‹è¯•å¯ä»¥é€šè¿‡è¯­æ–™åº“æ¥ç”Ÿæˆéšæœºçš„æµ‹è¯•æ•°æ®ï¼Œå…³äºGoä¸­çš„æ¨¡ç³Šæµ‹è¯•å¯ä»¥å‰å¾€[Go Fuzzing](https://go.dev/security/fuzz/)æ¥äº†è§£æ›´å¤šæ¦‚å¿µã€‚æ¨¡ç³Šæµ‹è¯•çš„å¥½å¤„åœ¨äºï¼Œç›¸æ¯”äºå›ºå®šçš„æµ‹è¯•æ•°æ®ï¼Œéšæœºæ•°æ®å¯ä»¥æ›´å¥½çš„æµ‹è¯•ç¨‹åºçš„è¾¹ç•Œæ¡ä»¶ã€‚ä¸‹é¢æ‹¿å®˜æ–¹æ•™ç¨‹çš„ä¾‹å­æ¥è®²è§£ï¼Œè¿™æ¬¡éœ€è¦æµ‹è¯•çš„æ˜¯ä¸€ä¸ªåè½¬å­—ç¬¦ä¸²çš„å‡½æ•°ï¼Œé¦–å…ˆåˆ›å»ºæ–‡ä»¶`/tool/strings.go`ï¼Œå†™å…¥å¦‚ä¸‹ä»£ç 

```go
package tool

func Reverse(s string) string {
	b := []byte(s)
	for i, j := 0, len(b)-1; i < len(b)/2; i, j = i+1, j-1 {
		b[i], b[j] = b[j], b[i]
	}
	return string(b)
}
```

åˆ›å»ºæ¨¡ç³Šæµ‹è¯•æ–‡ä»¶`/tool_test/fuzz_tool_test.go`ï¼Œå†™å…¥å¦‚ä¸‹ä»£ç 

```go
package tool

import (
	"golearn/tool"
	"testing"
	"unicode/utf8"
)

func FuzzReverse(f *testing.F) {
	testdata := []string{"hello world!", "nice to meet you", "good bye!"}
	for _, data := range testdata {
		f.Add(data)
	}

	f.Fuzz(func(t *testing.T, str string) {
		first := tool.Reverse(str)
		second := tool.Reverse(first)
		t.Logf("str:%q,first:%q,second:%q", str, first, second)
		if str != second {
			t.Errorf("before: %q, after: %q", str, second)
		}
		if utf8.ValidString(str) && !utf8.ValidString(first) {
			t.Errorf("Reverse produced invalid UTF-8 string %q %q", str, first)
		}
	})
}

```

åœ¨æ¨¡ç³Šæµ‹è¯•ä¸­ï¼Œé¦–å…ˆéœ€è¦ç»™è¯­æ–™ç§å­åº“æ·»åŠ æ•°æ®ï¼Œç¤ºä¾‹ä¸­ä½¿ç”¨`f.Add()`æ¥æ·»åŠ ï¼Œæœ‰åŠ©äºåç»­ç”Ÿæˆéšæœºçš„æµ‹è¯•æ•°æ®ã€‚ç„¶åä½¿ç”¨`f.Fuzz(fn)`æ¥è¿›è¡Œæµ‹è¯•ï¼Œå‡½æ•°ç­¾åå¦‚ä¸‹ï¼š

```go
func (f *F) Fuzz(ff any)

func (f *F) Add(args ...any)
```

`fn`å°±ç±»ä¼¼äºä¸€ä¸ªå•å…ƒæµ‹è¯•å‡½æ•°çš„é€»è¾‘ï¼Œå‡½æ•°çš„ç¬¬ä¸€ä¸ªå…¥å‚å¿…é¡»æ˜¯`t *testing.T`ï¼Œå…¶åè·Ÿæƒ³è¦ç”Ÿæˆçš„å‚æ•°ã€‚ç”±äºä¼ å…¥çš„å­—ç¬¦ä¸²æ˜¯ä¸å¯é¢„çŸ¥çš„ï¼Œè¿™é‡Œé‡‡ç”¨åè½¬ä¸¤æ¬¡çš„æ–¹æ³•æ¥è¿›è¡ŒéªŒè¯ã€‚æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤

```sh
$ go test -run Fuzz -v
=== RUN   FuzzReverse
=== RUN   FuzzReverse/seed#0
    fuzz_tool_test.go:18: str:"hello world!",first:"!dlrow olleh",second:"hello world!"
=== RUN   FuzzReverse/seed#1
    fuzz_tool_test.go:18: str:"nice to meet you",first:"uoy teem ot ecin",second:"nice to meet you"
=== RUN   FuzzReverse/seed#2
    fuzz_tool_test.go:18: str:"good bye!",first:"!eyb doog",second:"good bye!"
--- PASS: FuzzReverse (0.00s)
    --- PASS: FuzzReverse/seed#0 (0.00s)
    --- PASS: FuzzReverse/seed#1 (0.00s)
    --- PASS: FuzzReverse/seed#2 (0.00s)
PASS
ok      golearn/tool_test       0.539s
```

å½“å‚æ•°ä¸å¸¦`-fuzz`æ—¶ï¼Œå°†ä¸ä¼šç”Ÿæˆéšæœºçš„æµ‹è¯•æ•°æ®ï¼Œåªä¼šç»™æµ‹è¯•å‡½æ•°ä¼ å…¥è¯­æ–™åº“ä¸­çš„æ•°æ®ï¼Œå¯ä»¥ä»ç»“æœä¸­çœ‹åˆ°æµ‹è¯•å…¨éƒ¨é€šè¿‡äº†ï¼Œè¿™æ ·ä½¿ç”¨å°±ç­‰åŒäºå•å…ƒæµ‹è¯•ï¼Œä½†å…¶å®æ˜¯æœ‰é—®é¢˜çš„ï¼Œä¸‹é¢åŠ ä¸Š`-fuzz`å‚æ•°å†æ¬¡æ‰§è¡Œã€‚

```sh
$ go test -fuzz . -fuzztime 30s -run Fuzz -v
=== RUN   FuzzReverse
fuzz: elapsed: 0s, gathering baseline coverage: 0/217 completed
fuzz: minimizing 91-byte failing input file
fuzz: elapsed: 0s, gathering baseline coverage: 15/217 completed
--- FAIL: FuzzReverse (0.13s)
    --- FAIL: FuzzReverse (0.00s)
        fuzz_tool_test.go:18: str:"ğ‘„",first:"\x84\x91\x90\xf0",second:"ğ‘„"
        fuzz_tool_test.go:23: Reverse produced invalid UTF-8 string "ğ‘„" "\x84\x91\x90\xf0"

    Failing input written to testdata\fuzz\FuzzReverse\d856c981b6266ba2
    To re-run:
    go test -run=FuzzReverse/d856c981b6266ba2
=== NAME
FAIL
exit status 1
FAIL    golearn/tool_test       0.697s
```

::: tip

æ¨¡ç³Šæµ‹è¯•ä¸­å¤±è´¥çš„ç”¨ä¾‹ä¼šè¾“å‡ºåˆ°å½“å‰æµ‹è¯•æ–‡ä»¶å¤¹ä¸‹çš„`testdata`ç›®å½•ä¸‹çš„æŸä¸ªè¯­æ–™æ–‡ä»¶ä¸­ï¼Œä¾‹å¦‚ä¸Šè¿°ä¾‹å­ä¸­çš„

```
Failing input written to testdata\fuzz\FuzzReverse\d856c981b6266ba2
To re-run:
go test -run=FuzzReverse/d856c981b6266ba2
```

`testdata\fuzz\FuzzReverse\d856c981b6266ba2`ä¾¿æ˜¯è¾“å‡ºçš„è¯­æ–™æ–‡ä»¶è·¯å¾„ï¼Œæ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹

```
go test fuzz v1
string("ğ‘„")
```

:::

å¯ä»¥çœ‹åˆ°è¿™ä¸€æ¬¡å¹¶æ²¡æœ‰é€šè¿‡ï¼ŒåŸå› æ˜¯å­—ç¬¦ä¸²åè½¬åå˜æˆäº†é`utf8`æ ¼å¼ï¼Œæ‰€ä»¥é€šè¿‡æ¨¡ç³Šæµ‹è¯•å°±å‘ç°äº†è¿™ä¸ªé—®é¢˜æ‰€åœ¨ã€‚ç”±äºä¸€äº›å­—ç¬¦å ç”¨å¹¶ä¸æ­¢ä¸€ä¸ªå­—èŠ‚ï¼Œå¦‚æœå°†å…¶ä»¥å­—èŠ‚ä¸ºå•ä½åè½¬åè‚¯å®šæ˜¯ä¹±ç ï¼Œæ‰€ä»¥å°†å¾…æµ‹è¯•çš„æºä»£ç ä¿®æ”¹ä¸ºå¦‚ä¸‹ï¼Œå°†å­—ç¬¦ä¸²è½¬æ¢ä¸º`[]rune`ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…å‡ºç°ä¸Šè¿°é—®é¢˜ã€‚

```go
func Reverse(s string) string {
    r := []rune(s)
    for i, j := 0, len(r)-1; i < len(r)/2; i, j = i+1, j-1 {
        r[i], r[j] = r[j], r[i]
    }
    return string(r)
}
```

æ¥ä¸‹æ¥ç›´æ¥è¿è¡Œæ ¹æ®ä¸Šæ¬¡æ¨¡ç³Šæµ‹è¯•å¤±è´¥çš„ç”¨ä¾‹

```sh
$ go test -run=FuzzReverse/d856c981b6266ba2 -v
=== RUN   FuzzReverse
=== RUN   FuzzReverse/d856c981b6266ba2
    fuzz_tool_test.go:18: str:"ğ‘„",first:"ğ‘„",second:"ğ‘„"
--- PASS: FuzzReverse (0.00s)
    --- PASS: FuzzReverse/d856c981b6266ba2 (0.00s)
PASS
ok      golearn/tool_test       0.033s
```

å¯ä»¥çœ‹åˆ°è¿™ä¸€æ¬¡é€šè¿‡äº†æµ‹è¯•ï¼Œå†æ¬¡æ‰§è¡Œæ¨¡ç³Šæµ‹è¯•çœ‹çœ‹è¿˜æœ‰æ²¡æœ‰é—®é¢˜

```sh
$ go test -fuzz . -fuzztime 30s -run Fuzz -v
=== RUN   FuzzReverse
fuzz: elapsed: 0s, gathering baseline coverage: 0/219 completed
fuzz: minimizing 70-byte failing input file
failure while testing seed corpus entry: FuzzReverse/d97214ce235bfcf5
fuzz: elapsed: 0s, gathering baseline coverage: 2/219 completed
--- FAIL: FuzzReverse (0.15s)
    --- FAIL: FuzzReverse (0.00s)
        fuzz_tool_test.go:18: str:"\xe4",first:"ï¿½",second:"ï¿½"
        fuzz_tool_test.go:20: before: "\xe4", after: "ï¿½"

=== NAME
FAIL
exit status 1
FAIL    golearn/tool_test       0.184s
```

å¯ä»¥å‘ç°åˆå‡ºé”™äº†ï¼Œè¿™æ¬¡çš„é—®é¢˜æ˜¯å¯¹å­—ç¬¦ä¸²åšäº†ä¸¤æ¬¡åè½¬åä¸ç›¸ç­‰ï¼ŒåŸå­—ç¬¦ä¸º`\xe4`ï¼ŒæœŸæœ›çš„ç»“æœæ˜¯`4ex\` ï¼Œä½†ç»“æœæ˜¯ä¹±ç ï¼Œå¦‚ä¸‹

```go
func main() {
	fmt.Println("\xe4")
	fmt.Println([]byte("\xe4"))
	fmt.Println([]rune("\xe4"))
	fmt.Printf("%q\n", "\xe4")
	fmt.Printf("%x\n", "\xe4")
}
```

å®ƒçš„æ‰§è¡Œç»“æœæ˜¯

```
ï¿½
[65533]
"\xe4" 
e4   
```

ç©¶å…¶åŸå› åœ¨äºGoåœ¨å­—ç¬¦ä¸²å•ä½æ˜¯å­—èŠ‚ï¼Œè€Œä¸æ˜¯å­—ç¬¦ã€‚æ‰€ä»¥å†æ¬¡ä¿®æ”¹å¾…æµ‹æºä»£ç ï¼Œå¦‚æœä¼ å…¥çš„æ˜¯éutf8å­—ç¬¦ä¸²ï¼Œç›´æ¥è¿”å›é”™è¯¯ã€‚

```go
func Reverse(s string) (string, error) {
    if !utf8.ValidString(s) {
        return s, errors.New("input is not valid UTF-8")
    }
    r := []rune(s)
    for i, j := 0, len(r)-1; i < len(r)/2; i, j = i+1, j-1 {
        r[i], r[j] = r[j], r[i]
    }
    return string(r), nil
}
```

æµ‹è¯•ä»£ç ä¹Ÿéœ€è¦ç¨ä½œä¿®æ”¹

```go
func FuzzReverse(f *testing.F) {
	testdata := []string{"hello world!", "nice to meet you", "good bye!"}
	for _, data := range testdata {
		f.Add(data)
	}

	f.Fuzz(func(t *testing.T, str string) {
		first, err := tool.Reverse(str)
		if err != nil {
			t.Skip()
		}
		second, err := tool.Reverse(first)
		if err != nil {
			t.Skip()
		}
		t.Logf("str:%q,first:%q,second:%q", str, first, second)
		if str != second {
			t.Errorf("before: %q, after: %q", str, second)
		}
		if utf8.ValidString(str) && !utf8.ValidString(first) {
			t.Errorf("Reverse produced invalid UTF-8 string %q %q", str, first)
		}
	})
}
```

å½“åè½¬å‡½æ•°è¿”å›`error`æ—¶ï¼Œå°±è·³è¿‡æµ‹è¯•ï¼Œå†æ¥è¿›è¡Œæ¨¡ç³Šæµ‹è¯•

```sh
$ go test -fuzz . -fuzztime 30s -run Fuzz -v
=== RUN   FuzzReverse
fuzz: elapsed: 0s, gathering baseline coverage: 0/219 completed
fuzz: elapsed: 0s, gathering baseline coverage: 219/219 completed, now fuzzing with 16 workers
fuzz: elapsed: 3s, execs: 895571 (297796/sec), new interesting: 32 (total: 251)
fuzz: elapsed: 6s, execs: 1985543 (363120/sec), new interesting: 37 (total: 256)
fuzz: elapsed: 9s, execs: 3087837 (367225/sec), new interesting: 38 (total: 257)
fuzz: elapsed: 12s, execs: 4090817 (335167/sec), new interesting: 40 (total: 259)
fuzz: elapsed: 15s, execs: 5132580 (346408/sec), new interesting: 44 (total: 263)
fuzz: elapsed: 18s, execs: 6248486 (372185/sec), new interesting: 45 (total: 264)
fuzz: elapsed: 21s, execs: 7366827 (373305/sec), new interesting: 46 (total: 265)
fuzz: elapsed: 24s, execs: 8439803 (358059/sec), new interesting: 47 (total: 266)
fuzz: elapsed: 27s, execs: 9527671 (361408/sec), new interesting: 47 (total: 266)
fuzz: elapsed: 30s, execs: 10569473 (348056/sec), new interesting: 48 (total: 267)
fuzz: elapsed: 30s, execs: 10569473 (0/sec), new interesting: 48 (total: 267)
--- PASS: FuzzReverse (30.16s)
=== NAME
PASS
ok      golearn/tool_test       30.789s
```

ç„¶åè¿™æ¬¡å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„æ¨¡ç³Šæµ‹è¯•è¾“å‡ºæ—¥å¿—ï¼Œå…¶ä¸­ä¸€äº›æ¦‚å¿µçš„è§£é‡Šå¦‚ä¸‹ï¼š

- elapsed: ä¸€ä¸ªè½®æ¬¡å®Œæˆåå·²ç»æµé€çš„æ—¶é—´
- execs: è¿è¡Œçš„è¾“å…¥æ€»æ•°ï¼Œ297796/secè¡¨ç¤ºå¤šå°‘ä¸ªè¾“å…¥æ¯ç§’
- new interesting: åœ¨æµ‹è¯•ä¸­ï¼Œå·²ç»æ·»åŠ è¯­æ–™åº“ä¸­çš„â€æœ‰è¶£â€œè¾“å…¥çš„æ€»æ•°ã€‚ï¼ˆæœ‰è¶£çš„è¾“å…¥æŒ‡çš„æ˜¯è¯¥è¾“å…¥èƒ½å¤Ÿå°†ä»£ç è¦†ç›–ç‡æ‰©å¤§åˆ°ç°æœ‰è¯­æ–™åº“æ‰€èƒ½è¦†ç›–çš„èŒƒå›´ä¹‹å¤–ï¼Œéšç€è¦†ç›–èŒƒå›´çš„ä¸æ–­æ‰©å¤§ï¼Œå®ƒçš„å¢é•¿è¶‹åŠ¿æ€»ä½“ä¸Šè€Œè¨€ä¼šæŒç»­å˜ç¼“ï¼‰

::: tip

å¦‚æœæ²¡æœ‰`-fuzztime`å‚æ•°é™åˆ¶æ—¶é—´ï¼Œæ¨¡ç³Šæµ‹è¯•å°†ä¼šæ°¸è¿œçš„è¿è¡Œä¸‹å»ã€‚

:::

### ç±»å‹æ”¯æŒ

Go Fuzzä¸­çš„æ”¯æŒçš„ç±»å‹å¦‚ä¸‹ï¼š

- `string`, `[]byte`
- `int`, `int8`, `int16`, `int32`/`rune`, `int64`
- `uint`, `uint8`/`byte`, `uint16`, `uint32`, `uint64`
- `float32`, `float64`
- `bool`

