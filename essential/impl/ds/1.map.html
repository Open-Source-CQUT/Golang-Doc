<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://golang.halfiisland.com/essential/impl/ds/1.map.html"><meta property="og:site_name" content="Golang中文学习文档"><meta property="og:title" content="map"><meta property="og:description" content="go与其它语言不同的是，映射表的支持是由map关键字提供的，而非将其封装为标准库。映射表是一种使用场景非常多的数据结构，底层有着许多的实现方式，最常见的两种方式就是红黑树和哈希表，go采用的是哈希表实现方式。 map的实现中涉及到了大量的指针移动操作，所以阅读本文需要unsafe标准库的知识。 内部结构 runtime.hmap结构体就是代表着go中的..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-07-13T08:23:19.000Z"><meta property="article:published_time" content="2023-07-12T00:00:00.000Z"><meta property="article:modified_time" content="2024-07-13T08:23:19.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"map","image":[""],"datePublished":"2023-07-12T00:00:00.000Z","dateModified":"2024-07-13T08:23:19.000Z","author":[]}</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?87d678935e4b33455c0390543e7a759d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><title>map | Golang中文学习文档</title><meta name="description" content="go与其它语言不同的是，映射表的支持是由map关键字提供的，而非将其封装为标准库。映射表是一种使用场景非常多的数据结构，底层有着许多的实现方式，最常见的两种方式就是红黑树和哈希表，go采用的是哈希表实现方式。 map的实现中涉及到了大量的指针移动操作，所以阅读本文需要unsafe标准库的知识。 内部结构 runtime.hmap结构体就是代表着go中的...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-933124f9.css" as="style"><link rel="stylesheet" href="/assets/style-933124f9.css">
    <link rel="modulepreload" href="/assets/app-2cf283ae.js"><link rel="modulepreload" href="/assets/framework-f06be456.js"><link rel="modulepreload" href="/assets/1.map.html-93e7f9ae.js"><link rel="modulepreload" href="/assets/1.map.html-9b6204be.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.png" alt="Golang中文学习文档"><!----><span class="site-name hide-in-pad">Golang中文学习文档</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/guide.html" class="nav-link" aria-label="指南"><span class="font-icon icon iconfont icon-activity" style=""></span>指南<!----></a></div><div class="nav-item hide-in-mobile"><a href="/cmd.html" class="nav-link" aria-label="命令"><span class="font-icon icon iconfont icon-shell" style=""></span>命令<!----></a></div><div class="nav-item hide-in-mobile"><a href="/release.html" class="nav-link" aria-label="更新日志"><span class="font-icon icon iconfont icon-repo" style=""></span>更新日志<!----></a></div><div class="nav-item hide-in-mobile"><a href="/link.html" class="nav-link" aria-label="外部链接"><span class="font-icon icon iconfont icon-share" style=""></span>外部链接<!----></a></div><div class="nav-item hide-in-mobile"><a href="/deb.html" class="nav-link" aria-label="依赖导航"><span class="font-icon icon iconfont icon-discover" style=""></span>依赖导航<!----></a></div><div class="nav-item hide-in-mobile"><a href="/play.html" class="nav-link" aria-label="Playground"><span class="font-icon icon iconfont icon-back-stage" style=""></span>Playground<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://go.dev/ref/spec" rel="noopener noreferrer" target="_blank" aria-label="参考手册" class="nav-link"><span class="font-icon icon iconfont icon-article" style=""></span>参考手册<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="/about.html" class="nav-link" aria-label="关于作者"><span class="font-icon icon iconfont icon-alias" style=""></span>关于作者<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/Open-Source-CQUT/Golang-Doc" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg></button><!--]--><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><p class="sidebar-heading active"><span class="font-icon icon iconfont icon-activity" style=""></span><span class="title">语言入门</span><!----></p><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-bit" style=""></span><span class="title">语法基础</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-alias" style=""></span><span class="title">语法进阶</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-module" style=""></span><span class="title">标准库</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="font-icon icon iconfont icon-template" style=""></span><span class="title">实现原理</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><p class="sidebar-heading"><!----><span class="title">错误处理</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/essential/impl/err/3.nil.html" class="nav-link sidebar-link sidebar-page" aria-label="nil"><!---->nil<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/essential/impl/err/4.defer.html" class="nav-link sidebar-link sidebar-page" aria-label="defer"><!---->defer<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/essential/impl/err/5.panic.html" class="nav-link sidebar-link sidebar-page" aria-label="panic"><!---->panic<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading active"><!----><span class="title">数据结构</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/essential/impl/ds/0.slice.html" class="nav-link sidebar-link sidebar-page" aria-label="slice"><!---->slice<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/essential/impl/ds/1.map.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="map"><!---->map<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/essential/impl/ds/1.map.html#内部结构" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="内部结构"><!---->内部结构<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/essential/impl/ds/1.map.html#哈希" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="哈希"><!---->哈希<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/essential/impl/ds/1.map.html#冲突" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="冲突"><!---->冲突<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/essential/impl/ds/1.map.html#计算" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="计算"><!---->计算<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/essential/impl/ds/1.map.html#创建" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="创建"><!---->创建<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/essential/impl/ds/1.map.html#访问" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="访问"><!---->访问<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/essential/impl/ds/1.map.html#键值" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="键值"><!---->键值<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/essential/impl/ds/1.map.html#遍历" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="遍历"><!---->遍历<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/essential/impl/ds/1.map.html#修改" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="修改"><!---->修改<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/essential/impl/ds/1.map.html#删除" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="删除"><!---->删除<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/essential/impl/ds/1.map.html#清空" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="清空"><!---->清空<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/essential/impl/ds/1.map.html#扩容" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="扩容"><!---->扩容<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/essential/impl/ds/1.map.html#增量扩容" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="增量扩容"><!---->增量扩容<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/essential/impl/ds/1.map.html#等量扩容" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="等量扩容"><!---->等量扩容<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/essential/impl/ds/2.string.html" class="nav-link sidebar-link sidebar-page" aria-label="string"><!---->string<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/essential/impl/ds/6.channel.html" class="nav-link sidebar-link sidebar-page" aria-label="chan"><!---->chan<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/essential/impl/ds/6.select.html" class="nav-link sidebar-link sidebar-page" aria-label="select"><!---->select<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/essential/impl/ds/10.syncmap.html" class="nav-link sidebar-link sidebar-page" aria-label="syncmap"><!---->syncmap<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><!----><span class="title">运行时</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/essential/impl/runtime/7.gmp.html" class="nav-link sidebar-link sidebar-page" aria-label="gmp"><!---->gmp<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/essential/impl/runtime/8.mem.html" class="nav-link sidebar-link sidebar-page" aria-label="memory"><!---->memory<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/essential/impl/runtime/9.gc.html" class="nav-link sidebar-link sidebar-page" aria-label="gc"><!---->gc<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/essential/impl/runtime/15.sysmon.html" class="nav-link sidebar-link sidebar-page" aria-label="sysmon"><!---->sysmon<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><!----><span class="title">并发</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/essential/impl/sync/0.mutex.html" class="nav-link sidebar-link sidebar-page" aria-label="mutex"><!---->mutex<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/essential/impl/sync/5.wg.html" class="nav-link sidebar-link sidebar-page" aria-label="waitgroup"><!---->waitgroup<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/essential/impl/sync/10.context.html" class="nav-link sidebar-link sidebar-page" aria-label="context"><!---->context<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/essential/impl/sync/15.cond.html" class="nav-link sidebar-link sidebar-page" aria-label="cond"><!---->cond<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><!----><span class="title">网络</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/essential/impl/network/0.netpoll.html" class="nav-link sidebar-link sidebar-page" aria-label="netpoll"><!---->netpoll<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul></section></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-software" style=""></span><span class="title">社区生态</span><!----></p><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-mysql" style=""></span><span class="title">数据库</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-structure" style=""></span><span class="title">微服务</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-view" style=""></span><span class="title">第三方库</span><span class="arrow right"></span></button><!----></section></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->map</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://246859.github.io/" target="_blank" rel="noopener noreferrer">寒江蓑笠翁</a></span><span property="author" content="寒江蓑笠翁"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-07-12T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 76 分钟</span><meta property="timeRequired" content="PT76M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/essential/impl/ds/1.map.html#内部结构" class="router-link-active router-link-exact-active toc-link level2">内部结构</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/essential/impl/ds/1.map.html#哈希" class="router-link-active router-link-exact-active toc-link level2">哈希</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/essential/impl/ds/1.map.html#冲突" class="router-link-active router-link-exact-active toc-link level3">冲突</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/essential/impl/ds/1.map.html#计算" class="router-link-active router-link-exact-active toc-link level3">计算</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/essential/impl/ds/1.map.html#创建" class="router-link-active router-link-exact-active toc-link level2">创建</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/essential/impl/ds/1.map.html#访问" class="router-link-active router-link-exact-active toc-link level2">访问</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/essential/impl/ds/1.map.html#键值" class="router-link-active router-link-exact-active toc-link level3">键值</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/essential/impl/ds/1.map.html#遍历" class="router-link-active router-link-exact-active toc-link level3">遍历</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/essential/impl/ds/1.map.html#修改" class="router-link-active router-link-exact-active toc-link level2">修改</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/essential/impl/ds/1.map.html#删除" class="router-link-active router-link-exact-active toc-link level2">删除</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/essential/impl/ds/1.map.html#清空" class="router-link-active router-link-exact-active toc-link level2">清空</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/essential/impl/ds/1.map.html#扩容" class="router-link-active router-link-exact-active toc-link level2">扩容</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/essential/impl/ds/1.map.html#增量扩容" class="router-link-active router-link-exact-active toc-link level3">增量扩容</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/essential/impl/ds/1.map.html#等量扩容" class="router-link-active router-link-exact-active toc-link level3">等量扩容</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="map" tabindex="-1"><a class="header-anchor" href="#map" aria-hidden="true">#</a> map</h1><p>go与其它语言不同的是，映射表的支持是由<code>map</code>关键字提供的，而非将其封装为标准库。映射表是一种使用场景非常多的数据结构，底层有着许多的实现方式，最常见的两种方式就是红黑树和哈希表，go采用的是哈希表实现方式。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>map的实现中涉及到了大量的指针移动操作，所以阅读本文需要<code>unsafe</code>标准库的知识。</p></div><h2 id="内部结构" tabindex="-1"><a class="header-anchor" href="#内部结构" aria-hidden="true">#</a> 内部结构</h2><p><code>runtime.hmap</code>结构体就是代表着go中的<code>map</code>，与切片一样<code>map</code>的内部实现也是结构体。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// A header for a Go map.</span>
<span class="token keyword">type</span> hmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// Note: the format of the hmap is also encoded in cmd/compile/internal/reflectdata/reflect.go.</span>
	<span class="token comment">// Make sure this stays in sync with the compiler&#39;s definition.</span>
	count     <span class="token builtin">int</span> <span class="token comment">// # live cells == size of map.  Must be first (used by len() builtin)</span>
	flags     <span class="token builtin">uint8</span>
	B         <span class="token builtin">uint8</span>  <span class="token comment">// log_2 of # of buckets (can hold up to loadFactor * 2^B items)</span>
	noverflow <span class="token builtin">uint16</span> <span class="token comment">// approximate number of overflow buckets; see incrnoverflow for details</span>
	hash0     <span class="token builtin">uint32</span> <span class="token comment">// hash seed</span>

	buckets    unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// array of 2^B Buckets. may be nil if count==0.</span>
	oldbuckets unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// previous bucket array of half the size, non-nil only when growing</span>
	nevacuate  <span class="token builtin">uintptr</span>        <span class="token comment">// progress counter for evacuation (buckets less than this have been evacuated)</span>

	extra <span class="token operator">*</span>mapextra <span class="token comment">// optional fields</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>英文注释已经说明的很清晰了，下面对比较重要的字段进行一些简单的解释</p><ul><li><p><code>count</code>，表示hamp中的元素数量，结果等同于<code>len(map)</code>。</p></li><li><p><code>flags</code>，hmap的标志位，用于表示hmap处于什么状态，有以下几种可能。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
    iterator     <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// 迭代器正在使用桶</span>
    oldIterator  <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// 迭代器正在使用旧桶</span>
    hashWriting  <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment">// 一个协程正在写入hmap</span>
    sameSizeGrow <span class="token operator">=</span> <span class="token number">8</span> <span class="token comment">// 正在等量扩容</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>B</code>，hmap中的哈希桶的数量为<code>1 &lt;&lt; B</code>。</p></li><li><p><code>noverflow</code>，hmap中溢出桶的大致数量。</p></li><li><p><code>hash0</code>，哈希种子，在hmap被创建时指定，用于计算哈希值。</p></li><li><p><code>buckets</code>，存放哈希桶数组的指针。</p></li><li><p><code>oldbuckets</code>，存放hmap在扩容前哈希桶数组的指针。</p></li><li><p><code>extra</code>，存放着hmap中的溢出桶，溢出桶指的是就是当前桶已经满了，创建新的桶来存放元素，新创建的桶就是溢出桶。</p></li></ul><p>hamp中的<code>buckets</code>也就是桶切片指针，在go中对应的结构为<code>runtime.bmap</code>，如下所示</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// A bucket for a Go map.</span>
<span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	tophash <span class="token punctuation">[</span>bucketCnt<span class="token punctuation">]</span><span class="token builtin">uint8</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上面可以看到它只有一个<code>tophash</code>的字段，该字段是用于存放每个键的高八位，不过实际上来说，<code>bmap</code>的字段不止这些，这是因为<code>map</code>可以存储各种类型的键值对，所以需要在编译时根据类型来推导占用的内存空间，在<code>cmd/compile/internal/reflectdata/reflect.go</code>中的<code>MapBucketType</code>函数的功能就是在编译时构造bmap，它会进行一系列检查工作，比如key的类型是否<code>comparable</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// MapBucketType makes the map bucket type given the type of the map.</span>
<span class="token keyword">func</span> <span class="token function">MapBucketType</span><span class="token punctuation">(</span>t <span class="token operator">*</span>types<span class="token punctuation">.</span>Type<span class="token punctuation">)</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>Type
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>所以实际上，<code>bmap</code>的结构如下，不过这些字段对我们是不可见的，go在实际操作中是通过移动unsafe指针来进行访问</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	tophash <span class="token punctuation">[</span>BUCKETSIZE<span class="token punctuation">]</span><span class="token builtin">uint8</span>
	keys <span class="token punctuation">[</span>BUCKETSIZE<span class="token punctuation">]</span>keyType
	elems <span class="token punctuation">[</span>BUCKETSIZE<span class="token punctuation">]</span>elemType
	overflow <span class="token operator">*</span>bucket
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中的一些解释如下</p><ul><li><p><code>tophash</code>，存放每一个键的高八位值，对于一个tophash的元素而言，有下面几种特殊的值</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
    emptyRest      <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 当前元素是空的，并且该元素后面也没有可用的键值了</span>
    emptyOne       <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// 当前元素是空的，但是该元素后面有可用的键值。</span>
    evacuatedX     <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// 扩容时出现，只能出现在oldbuckets中，表示当前元素被搬迁到了新哈希桶数组的上半区</span>
    evacuatedY     <span class="token operator">=</span> <span class="token number">3</span> <span class="token comment">// 扩容时出现只能出现在oldbuckets中，表示当前元素被搬迁到了新哈希桶数组的下半区</span>
    evacuatedEmpty <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment">// 扩容时出现，元素本身就是空的，在搬迁时被标记</span>
    minTopHash     <span class="token operator">=</span> <span class="token number">5</span> <span class="token comment">// 对于一个正常的键值来说tophash的最小值</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>只要是<code>tophash[i]</code>的值大于<code>minTophash</code>的值，就说明对应下标存在正常的键值。</p></li><li><p><code>keys</code>，存放指定类型键的数组。</p></li><li><p><code>elems</code>，存放指定类型值的数组。</p></li><li><p><code>overflow</code>，指向溢出桶的指针。</p></li></ul><p>既然键值无法通过结构体字段来直接访问，为此go事先声明了一个常量<code>dataoffset</code>，它代表的是数据在<code>bmap</code>中的内存偏移量。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> dataOffset <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Offsetof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
    b bmap
    v <span class="token builtin">int64</span>
<span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span>v<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实际上，键值是存放在一个连续的内存地址中，类似于下面这种结构，这样做是为了避免内存对齐带来的空间浪费。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>k1,k2,k3,k4,k5,k6...v1,v2,v3,v4,v5,v6...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>所以对于一个bmap而言，指针移动<code>dataoffset</code>后，移动<code>i*sizeof(keyType)</code>就是第i个key的地址</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>获取第i个value的地址也是同理</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>e <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>hamp</code>中的<code>buckets</code>指针，就是指向的第一个哈希桶的地址，如果想要获取第i个哈希桶的地址，偏移量就是<code>i*sizeof(bucket)</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>b <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在后续的内容中，这些操作会非常频繁的出现。</p><h2 id="哈希" tabindex="-1"><a class="header-anchor" href="#哈希" aria-hidden="true">#</a> 哈希</h2><h3 id="冲突" tabindex="-1"><a class="header-anchor" href="#冲突" aria-hidden="true">#</a> 冲突</h3><p>在hmap中，有一个字段<code>extra</code>专门用来存放溢出桶的信息，它会指向存放溢出桶的切片，其结构如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> mapextra <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// 溢出桶的指针切片</span>
	overflow    <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>bmap
	<span class="token comment">// 扩容前旧的溢出桶的指针切片</span>
	oldoverflow <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>bmap
	<span class="token comment">// 指向下一个空闲的溢出桶的指针</span>
	nextOverflow <span class="token operator">*</span>bmap
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202310061929859.png" style="zoom:33%;"><div class="hint-container tip"><p class="hint-container-title">提示</p><p>在上图中，蓝色部分是哈希桶数组，橙色部分是溢出哈希桶数组，溢出哈希桶下面统称为溢出桶。</p></div><p>上图就可以比较好的展示hmap的大致结构，<code>buckets</code>指向哈希桶数组，<code>extra</code>指向溢出桶数组，桶<code>bucket0</code>指向溢出桶<code>overflow0</code>，两种不同的桶分别存放在两个切片中，两种桶的内存都是连续的。当两个键通过哈希后被分配到了同一个bucket，这种情况就是发生了哈希冲突。go中解决哈希冲突的方式就是拉链法，当发生冲突的键的数量大于桶的容量后，一般是8个，其值取决于<code>internal/abi.MapBucketCount</code>。然后就会创建一个新的桶来存放这些键，而这个桶就叫溢出桶，意为原来的桶装不下了，元素溢出到这个新桶里来了，创建完毕后，哈希桶会有一个指针指向新的溢出桶，这些桶的指针连起来就形成了一个<code>bmap</code>链表。</p><p>对于拉链法而言，使用负载因子用于衡量哈希表的冲突情况，其计算公式如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>loadfactor <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>elems<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">len</span><span class="token punctuation">(</span>buckets<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>当负载因子越大时，说明哈希冲突越多，也就是溢出桶的数量越多，那么在读写哈希表时，就需要遍历更多的溢出桶链表，才能找到指定的位置，所以性能就越差。为了改善这种情况，应该增加<code>buckets</code>桶的数量，也就是扩容，对于hmap而言，有两种情况会触发扩容</p><ul><li>负载因子超过阈值<code>bucketCnt*13/16</code>，其值至少是6.5。</li><li>溢出桶数量过多</li></ul><p>当负载因子越小时，说明hmap的内存利用率低，占用的内存就越大。go中用于计算负载因子的函数是<code>runtime.overLoadFactor</code>，代码如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">overLoadFactor</span><span class="token punctuation">(</span>count <span class="token builtin">int</span><span class="token punctuation">,</span> B <span class="token builtin">uint8</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> count <span class="token operator">&gt;</span> bucketCnt <span class="token operator">&amp;&amp;</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">&gt;</span> loadFactorNum<span class="token operator">*</span><span class="token punctuation">(</span><span class="token function">bucketShift</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token operator">/</span>loadFactorDen<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中<code>loadFactorNum</code>和<code>loadFactorDen</code>都是一个常数，<code>bucketshift</code>是计算<code>1 &lt;&lt; B</code>，并且已知</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>loadFactorNum <span class="token operator">=</span> <span class="token punctuation">(</span>bucketCnt <span class="token operator">*</span> <span class="token number">13</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">*</span> loadFactorDen
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>所以化简一下就能得到</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>count <span class="token operator">&gt;</span> bucketCnt <span class="token operator">&amp;&amp;</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> B <span class="token operator">&gt;</span> <span class="token punctuation">(</span>bucketCnt <span class="token operator">*</span> <span class="token number">13</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其中<code>(bucketCnt * 13 / 16)</code>值为6.5，<code>1 &lt;&lt; B</code>就是哈希桶的数量，所以该函数的作用就是计算元素数量除以桶的数量值是否大于负载因子6.5。</p><h3 id="计算" tabindex="-1"><a class="header-anchor" href="#计算" aria-hidden="true">#</a> 计算</h3><p>go内部计算哈希的函数位于<code>runtime/alg.go</code>文件中的<code>f32hash</code>，如下所示，包含了对NaN和0两种情况的处理。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">f32hash</span><span class="token punctuation">(</span>p unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> h <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token builtin">uintptr</span> <span class="token punctuation">{</span>
	f <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">float32</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
	<span class="token keyword">switch</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> f <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> c1 <span class="token operator">*</span> <span class="token punctuation">(</span>c0 <span class="token operator">^</span> h<span class="token punctuation">)</span> <span class="token comment">// +0, -0</span>
	<span class="token keyword">case</span> f <span class="token operator">!=</span> f<span class="token punctuation">:</span>
		<span class="token keyword">return</span> c1 <span class="token operator">*</span> <span class="token punctuation">(</span>c0 <span class="token operator">^</span> h <span class="token operator">^</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// any kind of NaN</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">memhash</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> h<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到的是，map哈希计算方法并不是基于类型，而是基于内存，最终会走到<code>memhash</code>函数，该函数由汇编实现，逻辑位于<code>runtime/asm*.s</code>中。基于内存的哈希值不应该被持久化保存，因为它应该只在运行时被使用，不可能保证每一次运行内存分布都完全一致。</p><p>在该文件中还有一个名为<code>typehash</code>的函数，该函数会根据不同类型来计算哈希值，不过map并不会使用这个函数来计算哈希。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>func typehash(t *_type, p unsafe.Pointer, h uintptr) uintptr
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这种实现相比上面那种更慢，但是更通用些，主要用于反射以及编译时的函数生成，比如下面这个函数。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//go:linkname reflect_typehash reflect.typehash</span>
<span class="token keyword">func</span> <span class="token function">reflect_typehash</span><span class="token punctuation">(</span>t <span class="token operator">*</span>_type<span class="token punctuation">,</span> p unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> h <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token builtin">uintptr</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">typehash</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> p<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="创建" tabindex="-1"><a class="header-anchor" href="#创建" aria-hidden="true">#</a> 创建</h2><p>map的初始化有两种方式，这一点已经在语言入门中阐述过了，一种是使用关键字<code>map</code>直接创建，另一种是使用<code>make</code>函数，不管用何种方式初始化，最后都是由<code>runtime.makemap</code>来创建map，该函数签名如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">makemap</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> hint <span class="token builtin">int</span><span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">)</span> <span class="token operator">*</span>hmap
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其中的参数</p><ul><li><code>t</code>，指的是map的类型，不同的类型所需的内存占用不同</li><li><code>hint</code>，指的是<code>make</code>函数的第二个参数，map预计元素的容量。</li><li><code>h</code>，指的是<code>hmap</code>的指针，可以为<code>nil</code>。</li></ul><p>返回值就是初始化完毕的<code>hmap</code>指针。该函数在初始化过程中有几个主要的工作。首先就是计算预计分配的内存是否会超出最大分配内存，对应如下代码</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 将预计容量与桶类型的内存大小相乘</span>
mem<span class="token punctuation">,</span> overflow <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">MulUintptr</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>hint<span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Bucket<span class="token punctuation">.</span>Size_<span class="token punctuation">)</span>
<span class="token comment">// 数值溢出或者超出了最大分配内存</span>
<span class="token keyword">if</span> overflow <span class="token operator">||</span> mem <span class="token operator">&gt;</span> maxAlloc <span class="token punctuation">{</span>
    hint <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在先前的内部结构中已经提到过，hmap内部是由桶组成的，在内存利用率最低的情况下，一个桶只有一个元素，占用的内存最多，所以预计的最大内存占用就是元素数量乘以对应类型的内存占用大小。当计算结果数值溢出了，或者超出了最大能分配的内存，就将hint置为0，因为后续需要用hint来计算桶数组的容量。</p><p>第二步初始化hmap，并计算出一个随机的哈希种子，对应如下代码</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 初始化</span>
<span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    h <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>hmap<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取一个随机的哈希种子</span>
h<span class="token punctuation">.</span>hash0 <span class="token operator">=</span> <span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再根据hint的值计算出哈希桶的容量，对应的代码如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>B <span class="token operator">:=</span> <span class="token function">uint8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">// 不断循环直到 hint / 1 &lt;&lt; B &lt; 6.5</span>
<span class="token keyword">for</span> <span class="token function">overLoadFactor</span><span class="token punctuation">(</span>hint<span class="token punctuation">,</span> B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    B<span class="token operator">++</span>
<span class="token punctuation">}</span>
<span class="token comment">// 赋值给hmap</span>
h<span class="token punctuation">.</span>B <span class="token operator">=</span> B
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过不断循环找到第一个满足<code>(hint / 1 &lt;&lt; B) &lt; 6.5</code>的B值，将其赋值给hmap，在知晓了哈希桶的容量后，最后就是为哈希桶分配内存</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> h<span class="token punctuation">.</span>B <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> nextOverflow <span class="token operator">*</span>bmap
    <span class="token comment">// 分配好的哈希桶，和预先分配的空闲溢出桶</span>
    h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> nextOverflow <span class="token operator">=</span> <span class="token function">makeBucketArray</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">.</span>B<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果预先分配了空闲溢出桶，就指向该溢出桶</span>
    <span class="token keyword">if</span> nextOverflow <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        h<span class="token punctuation">.</span>extra <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>mapextra<span class="token punctuation">)</span>
        h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>nextOverflow <span class="token operator">=</span> nextOverflow
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>makeBucketArray</code>函数会根据B的值，为哈希桶分配对应大小的内存，以及预先分配空闲的溢出桶，当B小于4时，就不会创建溢出桶，如果大于4那么就会创建<code>2^B-4</code>个溢出桶。对应<code>runtime.makeBucketArray</code>函数中的如下代码</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>base <span class="token operator">:=</span> <span class="token function">bucketShift</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
nbuckets <span class="token operator">:=</span> base
<span class="token comment">// 小于4就不会创建溢出桶</span>
<span class="token keyword">if</span> b <span class="token operator">&gt;=</span> <span class="token number">4</span> <span class="token punctuation">{</span>
    <span class="token comment">// 预计桶的数量加上1 &lt;&lt; (b-4)</span>
    nbuckets <span class="token operator">+=</span> <span class="token function">bucketShift</span><span class="token punctuation">(</span>b <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token comment">// 溢出桶所需的内存</span>
    sz <span class="token operator">:=</span> t<span class="token punctuation">.</span>Bucket<span class="token punctuation">.</span>Size_ <span class="token operator">*</span> nbuckets
    <span class="token comment">// 将内存空间向上取整</span>
    up <span class="token operator">:=</span> <span class="token function">roundupsize</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span>
    <span class="token keyword">if</span> up <span class="token operator">!=</span> sz <span class="token punctuation">{</span>
        <span class="token comment">// 不相等就采用up重新计算</span>
        nbuckets <span class="token operator">=</span> up <span class="token operator">/</span> t<span class="token punctuation">.</span>Bucket<span class="token punctuation">.</span>Size_
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>base</code>指的是预计分配桶的数量，<code>nbuckets</code>指的是实际分配桶的数量，它加上了溢出桶的数量。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> base <span class="token operator">!=</span> nbuckets <span class="token punctuation">{</span>
    <span class="token comment">// 第一个可用的溢出桶</span>
    nextOverflow <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>buckets<span class="token punctuation">,</span> base<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 为了减少跟踪溢出桶的开销，将最后一个可用溢出桶的溢出指针指向哈希桶的头部</span>
    last <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>buckets<span class="token punctuation">,</span> <span class="token punctuation">(</span>nbuckets<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 最后一个溢出桶指向哈希桶</span>
    last<span class="token punctuation">.</span><span class="token function">setoverflow</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span>buckets<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当两者不相等时，就说明分配了额外的溢出桶，<code>nextoverflow</code>指针就是指向的第一个可用的溢出桶。由此可见，哈希桶与溢出桶其实是在同一块连续的内存中，这也是为什么在图中哈希桶数组与溢出桶数组是相邻的。</p><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202310061929859.png" style="zoom:33%;"><h2 id="访问" tabindex="-1"><a class="header-anchor" href="#访问" aria-hidden="true">#</a> 访问</h2><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202310062003736.png" style="zoom:33%;"><p>在语法入门当中讲到过，访问map总共有三种方式，如下所示</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code># 直接访问值
val <span class="token operator">:=</span> dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
# 访问值以及该键是否存在
val<span class="token punctuation">,</span> exist <span class="token operator">:=</span> dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
# 遍历<span class="token keyword">map</span>
<span class="token keyword">for</span> key<span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> dict<span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这三种方式所用到的函数都不相同，其中<code>for range</code>遍历map最为复杂。</p><h3 id="键值" tabindex="-1"><a class="header-anchor" href="#键值" aria-hidden="true">#</a> 键值</h3><p>对于前两种方式而言，对应着两个函数，分别是<code>runtime.mapaccess1</code>和<code>runtime.mapaccess2</code>，函数签名如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapaccess1</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer

<span class="token keyword">func</span> <span class="token function">mapaccess2</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中的key是指向访问map的键的指针，返回的时候也只会返回指针。在访问时，首先需要计算key的哈希值，定位key在哪个哈希桶，对应代码如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 边界处理</span>
<span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> h<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">HashMightPanic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Hasher</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// see issue 23734</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zeroVal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 防止并发读写</span>
<span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>hashWriting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">&quot;concurrent map read and map write&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 使用指定类型的hasher计算哈希值</span>
hash <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Hasher</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hash0<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// (1 &lt;&lt; B) - 1</span>
m <span class="token operator">:=</span> <span class="token function">bucketMask</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>B<span class="token punctuation">)</span>
<span class="token comment">// 通过移动指针定位key所在的哈希桶</span>
b <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> <span class="token punctuation">(</span>hash<span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在访问的一开始先进行边界情况处理，并防止map并发读写，当map处于并发读写状态时，就会发生panic。再然后计算哈希值，<code>bucketMask</code>函数所干的事就是计算<code>(1 &lt;&lt; B) - 1 </code>，<code>hash &amp; m</code>就等于<code>hash &amp; (1 &lt;&lt; B) - 1 </code>，这是二进制取余操作，等价于<code>hash % (1 &lt;&lt; B)</code>，使用位运算的好处就是更快。最后三行代码干的事就是将key计算得到的哈希值与当前map中的桶的数量取余，得到哈希桶的序号，然后根据序号移动指针获取key所在的哈希桶指针。</p><p>在知晓了key在哪个哈希桶后，就可以展开查找了，这部分对应代码如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>	<span class="token comment">// 获取哈希值的高八位</span>
	top <span class="token operator">:=</span> <span class="token function">tophash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
bucketloop<span class="token punctuation">:</span>
	<span class="token comment">// 遍历bmap链表</span>
	<span class="token keyword">for</span> <span class="token punctuation">;</span> b <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// bmap中的元素</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            <span class="token comment">//  将计算得出的top与tophash中的元素进行对比</span>
			<span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> top <span class="token punctuation">{</span>
                <span class="token comment">// 后续都是空的，没有了。</span>
				<span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> emptyRest <span class="token punctuation">{</span>
					<span class="token keyword">break</span> bucketloop
				<span class="token punctuation">}</span>
                <span class="token comment">// 不相等就继续遍历溢出桶</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
            <span class="token comment">// 根据i移动指针获取对应下标的键</span>
			k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 处理下指针</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				k <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
            <span class="token comment">// 比对两个键是否相等</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果相等的话，就移动指针返回k对应下标的元素</span>
                <span class="token comment">// 从这行代码就能看出来键值的内存地址是连续的</span>
				e <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					e <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
                
				<span class="token keyword">return</span> e
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token comment">// 没找到，返回零值。</span>
<span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zeroVal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在定位哈希桶时，是通过取余来定位的，所以key在哪个哈希桶取决于哈希值的低位，至于到底是低几位这取决于B的大小，而找到了哈希桶后，其中的tophash存放的是哈希值的高八位，因为低位取余值都是相同的，这样就不需要去一个个对比key是否相等，只对比哈希值高八位就够了。根据先前计算得到的哈希值获取其高八位，在bmap中的tophash数组一个个对比，如果高八位相等的话，再对比键是否相等，如果键也相等的话就说明找到了元素，不相等就继续遍历tophash数组，还找不到就继续遍历溢出桶bmap链表，直到bmap的<code>tophash[i]</code>为<code>emptyRest</code>退出循环，最后返回对应类型的零值。</p><p><code>mapaccess2</code> 函数与<code>mapaccess1</code>函数逻辑完全一致，仅仅多了一个布尔返回值，用于表示元素是否存在。</p><h3 id="遍历" tabindex="-1"><a class="header-anchor" href="#遍历" aria-hidden="true">#</a> 遍历</h3><p>遍历map的语法如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> key<span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> dict <span class="token punctuation">{</span>
	<span class="token comment">// do somthing...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在实际进行遍历时，go使用了<code>hiter</code>结构体来存放遍历信息，<code>hiter</code>就是<code>hmap interator</code>的简写，意为哈希表迭代器，结构如下所示。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// A hash iteration structure.</span>
<span class="token comment">// If you modify hiter, also change cmd/compile/internal/reflectdata/reflect.go</span>
<span class="token comment">// and reflect/value.go to match the layout of this structure.</span>
<span class="token keyword">type</span> hiter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	key         unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// Must be in first position.  Write nil to indicate iteration end (see cmd/compile/internal/walk/range.go).</span>
	elem        unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// Must be in second position (see cmd/compile/internal/walk/range.go).</span>
	t           <span class="token operator">*</span>maptype
	h           <span class="token operator">*</span>hmap
	buckets     unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// bucket ptr at hash_iter initialization time</span>
	bptr        <span class="token operator">*</span>bmap          <span class="token comment">// current bucket</span>
	overflow    <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>bmap       <span class="token comment">// keeps overflow buckets of hmap.buckets alive</span>
	oldoverflow <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>bmap       <span class="token comment">// keeps overflow buckets of hmap.oldbuckets alive</span>
	startBucket <span class="token builtin">uintptr</span>        <span class="token comment">// bucket iteration started at</span>
	offset      <span class="token builtin">uint8</span>          <span class="token comment">// intra-bucket offset to start from during iteration (should be big enough to hold bucketCnt-1)</span>
	wrapped     <span class="token builtin">bool</span>           <span class="token comment">// already wrapped around from end of bucket array to beginning</span>
	B           <span class="token builtin">uint8</span>
	i           <span class="token builtin">uint8</span>
	bucket      <span class="token builtin">uintptr</span>
	checkBucket <span class="token builtin">uintptr</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面对它的一些字段做一些简单的解释</p><ul><li><code>key</code>，<code>elem</code>就是<code>for range</code>遍历时获取到的键值</li><li><code>buckets</code>，在初始化迭代器时指定，指向哈希桶的头部</li><li><code>bptr</code>，当前正在遍历的bmap</li><li><code>startBucket</code>，迭代开始时的起始桶序号</li><li><code>offset</code>，桶内偏移量，范围<code>[0, bucketCnt-1]</code></li><li><code>B</code>，就是hmap的B值，</li><li><code>i</code>，桶内元素下标</li><li><code>wrapped</code>，是否从哈希桶数组末尾回到了头部</li></ul><p>在遍历开始前，go通过<code>runtime.mapiterinit</code>函数来初始化遍历器，然后再通过函数<code>runtime.mapinternext</code>对map进行遍历，两者都需要用到<code>hiter</code>结构体，两个函数签名如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapiterinit</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> it <span class="token operator">*</span>hiter<span class="token punctuation">)</span> 

<span class="token keyword">func</span> <span class="token function">mapiternext</span><span class="token punctuation">(</span>it <span class="token operator">*</span>hiter<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于迭代器初始化而言，首先要获取map当前的一个快照，对应如下的代码。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>it<span class="token punctuation">.</span>t <span class="token operator">=</span> t
it<span class="token punctuation">.</span>h <span class="token operator">=</span> h
<span class="token comment">// 记录hmap当前状态的快照，只需要保存B值。</span>
it<span class="token punctuation">.</span>B <span class="token operator">=</span> h<span class="token punctuation">.</span>B
it<span class="token punctuation">.</span>buckets <span class="token operator">=</span> h<span class="token punctuation">.</span>buckets
<span class="token keyword">if</span> t<span class="token punctuation">.</span>Bucket<span class="token punctuation">.</span>PtrBytes <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    h<span class="token punctuation">.</span><span class="token function">createOverflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    it<span class="token punctuation">.</span>overflow <span class="token operator">=</span> h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>overflow
    it<span class="token punctuation">.</span>oldoverflow <span class="token operator">=</span> h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>oldoverflow
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>后续在迭代时，实际上遍历的是map的一个快照，而非实际的map，所以在遍历过程中添加的元素和桶都不会被遍历到，并且同时并发遍历写入元素，有可能触发<code>fatal</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>hashWriting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">&quot;concurrent map iteration and map write&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第二步再决定遍历的两个起始位置，第一个是起始桶的位置，第二个桶内的起始位置，这两个都是随机选的，对应如下代码</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// r是一个随机数</span>
<span class="token keyword">var</span> r <span class="token builtin">uintptr</span>
<span class="token keyword">if</span> h<span class="token punctuation">.</span>B <span class="token operator">&gt;</span> <span class="token number">31</span><span class="token operator">-</span>bucketCntBits <span class="token punctuation">{</span>
    r <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">fastrand64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    r <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// r % (1 &lt;&lt; B) 得到起始桶的位置</span>
it<span class="token punctuation">.</span>startBucket <span class="token operator">=</span> r <span class="token operator">&amp;</span> <span class="token function">bucketMask</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>B<span class="token punctuation">)</span>
<span class="token comment">// r &gt;&gt; B % 8 得到起始桶内的元素起始位置</span>
it<span class="token punctuation">.</span>offset <span class="token operator">=</span> <span class="token function">uint8</span><span class="token punctuation">(</span>r <span class="token operator">&gt;&gt;</span> h<span class="token punctuation">.</span>B <span class="token operator">&amp;</span> <span class="token punctuation">(</span>bucketCnt <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 记录当前正在遍历的桶序号</span>
it<span class="token punctuation">.</span>bucket <span class="token operator">=</span> it<span class="token punctuation">.</span>startBucket
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过<code>fastrand()</code>或<code>fastrand64()</code>获取一个随机数，两次取模运算得到桶起始位置和桶内起始位置。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>map虽然不允许同时并发读写，但是允许同时并发遍历。</p></div><p>接下来才真正开始迭代map，如何对桶进行遍历，以及退出的策略，这部分对应下面的代码</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// hmap</span>
h <span class="token operator">:=</span> it<span class="token punctuation">.</span>h
<span class="token comment">// maptype</span>
t <span class="token operator">:=</span> it<span class="token punctuation">.</span>t
<span class="token comment">// 待遍历的桶的位置</span>
bucket <span class="token operator">:=</span> it<span class="token punctuation">.</span>bucket
<span class="token comment">// 待遍历的bmap</span>
b <span class="token operator">:=</span> it<span class="token punctuation">.</span>bptr
<span class="token comment">// 桶内序号i</span>
i <span class="token operator">:=</span> it<span class="token punctuation">.</span>i

next<span class="token punctuation">:</span>
	<span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果当前桶的位置与起始位置相等，说明是绕了一圈回来，后面的已经遍历过了</span>
        <span class="token comment">// 遍历结束，可以退出了</span>
		<span class="token keyword">if</span> bucket <span class="token operator">==</span> it<span class="token punctuation">.</span>startBucket <span class="token operator">&amp;&amp;</span> it<span class="token punctuation">.</span>wrapped <span class="token punctuation">{</span>
			it<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token boolean">nil</span>
			it<span class="token punctuation">.</span>elem <span class="token operator">=</span> <span class="token boolean">nil</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// 桶下标后移</span>
		bucket<span class="token operator">++</span>
        <span class="token comment">// bucket == 1 &lt;&lt; B，就是走到哈希桶数组的末尾了</span>
		<span class="token keyword">if</span> bucket <span class="token operator">==</span> <span class="token function">bucketShift</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 从头开始</span>
			bucket <span class="token operator">=</span> <span class="token number">0</span>
			it<span class="token punctuation">.</span>wrapped <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
		i <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>哈希桶的起始位置选取是随机的，在遍历时，从起始位置向桶切片的末尾逐个迭代，走到<code>1 &lt;&lt; B</code>时，然后再从头开始，当再次回到起始位置时，说明已经遍历完毕，然后退出。上面的代码是关于如何在map中遍历桶，而下面的代码描述的就是如何在桶内进行遍历。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token comment">// (i + offset) % 8</span>
		offi <span class="token operator">:=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> it<span class="token punctuation">.</span>offset<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>bucketCnt <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token comment">// 如果当前元素是空的就跳过</span>
		<span class="token keyword">if</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>offi<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>offi<span class="token punctuation">]</span> <span class="token operator">==</span> evacuatedEmpty <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 移动指针获取键</span>
		k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span><span class="token function">uintptr</span><span class="token punctuation">(</span>offi<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			k <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
    	<span class="token comment">// 移动指针获取值</span>
		e <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">uintptr</span><span class="token punctuation">(</span>offi<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
    	
		<span class="token comment">// 处理等量扩容的情况，当键值被疏散到了其它位置后，需要重新去寻找键值。</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>offi<span class="token punctuation">]</span> <span class="token operator">!=</span> evacuatedX <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>offi<span class="token punctuation">]</span> <span class="token operator">!=</span> evacuatedY<span class="token punctuation">)</span> <span class="token operator">||</span>
			<span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">ReflexiveKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			it<span class="token punctuation">.</span>key <span class="token operator">=</span> k
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			it<span class="token punctuation">.</span>elem <span class="token operator">=</span> e
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
			rk<span class="token punctuation">,</span> re <span class="token operator">:=</span> <span class="token function">mapaccessK</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
			<span class="token keyword">if</span> rk <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			it<span class="token punctuation">.</span>key <span class="token operator">=</span> rk
			it<span class="token punctuation">.</span>elem <span class="token operator">=</span> re
		<span class="token punctuation">}</span>
		it<span class="token punctuation">.</span>bucket <span class="token operator">=</span> bucket
		it<span class="token punctuation">.</span>i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 没找到就去溢出桶里面找</span>
	b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	i <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token keyword">goto</span> next
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>在上面的扩容判断条件中，有一个表达式可能会让人感到困惑，如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>之所以要去判断<code>k</code>是否与自身相等，是为了过滤键为<code>Nan</code>的情况，如果一个元素的键是<code>Nan</code>，那么就会无法正常访问该元素，无论是遍历还是直接访问，或者是删除都无法正常进行，因为<code>Nan != Nan</code>永远成立，也就永远无法找到这个键。</p></div><p>首先根据<code>i</code>值和<code>offset</code>值取模运算得到待遍历的桶内下标，通过移动指针获取键值，由于在map遍历期间，会有其它的写入操作触发了map的扩容，所以实际的键值可能已经不在原来的位置了，在这种情况下就需要使用<code>mapaccessK</code>函数去重新获取实际的键值，该函数签名如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapaccessK</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>它的功能与<code>mapaccess1</code>函数完全一致，区别在于<code>mapaccessK</code>函数会同时返回key值和value值。最终获取到了键值以后，将其赋值给迭代器的<code>key</code>，<code>elem</code>，然后更新迭代器的下标，这样就完成了一次迭代，代码执行就回到了<code>for range</code>的代码块中。如果在桶内没有找到，就再去溢出桶里面找，继续重复上面的步骤，直到溢出桶链表遍历完毕后，再继续迭代下一个哈希桶。</p><h2 id="修改" tabindex="-1"><a class="header-anchor" href="#修改" aria-hidden="true">#</a> 修改</h2><p>修改map的语法如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在go中，对于修改map的操作，由<code>runtime.mapassign</code>函数来完成，该函数签名如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapassign</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其访问过程的逻辑与<code>mapaccess1</code>相同，不过key不存在时会为其分配一个位置，如果存在就更新，最后返回元素的指针。在开始时，需要做一些准备工作，这部分对应的代码如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 不允许写入为nil的map</span>
<span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token function">plainError</span><span class="token punctuation">(</span><span class="token string">&quot;assignment to entry in nil map&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 禁止同时并发写</span>
<span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>hashWriting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">&quot;concurrent map writes&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 计算key哈希值</span>
hash <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Hasher</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hash0<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 修改hmap状态</span>
h<span class="token punctuation">.</span>flags <span class="token operator">^=</span> hashWriting

<span class="token comment">// 初始化哈希桶</span>
<span class="token keyword">if</span> h<span class="token punctuation">.</span>buckets <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    h<span class="token punctuation">.</span>buckets <span class="token operator">=</span> <span class="token function">newobject</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Bucket<span class="token punctuation">)</span> <span class="token comment">// newarray(t.Bucket, 1)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码主要做了以下几件事</p><ul><li>hmap状态检查</li><li>计算key的哈希值</li><li>检查哈希桶是否需要初始化</li></ul><p>再之后通过哈希值取模运算得到哈希桶位置，以及key的tophash，代码对应如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>again<span class="token punctuation">:</span>
	<span class="token comment">// hash % (1 &lt;&lt; B)</span>
	bucket <span class="token operator">:=</span> hash <span class="token operator">&amp;</span> <span class="token function">bucketMask</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>B<span class="token punctuation">)</span>
	<span class="token comment">// 移动指针获取指定位置的bmap</span>
	b <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> bucket<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// 计算tophash</span>
	top <span class="token operator">:=</span> <span class="token function">tophash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在确定了桶的位置，bmap，tophash，就可以开始查找元素了，这部分代码对应如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 待插入的tophash</span>
<span class="token keyword">var</span> inserti <span class="token operator">*</span><span class="token builtin">uint8</span>
<span class="token comment">// 待插入的key值指针</span>
<span class="token keyword">var</span> insertk unsafe<span class="token punctuation">.</span>Pointer
<span class="token comment">// 待插入的value值指针</span>
<span class="token keyword">var</span> elem unsafe<span class="token punctuation">.</span>Pointer

bucketloop<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token comment">// 遍历桶内的tophash数组</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            <span class="token comment">// tophash不相等</span>
			<span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> top <span class="token punctuation">{</span>
                <span class="token comment">// 如果当前桶内下标是空的，且还没有插入元素，就选取该位置插入</span>
				<span class="token keyword">if</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> inserti <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 找到了一个合适的位置分配给key</span>
					inserti <span class="token operator">=</span> <span class="token operator">&amp;</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
					insertk <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
					elem <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
                <span class="token comment">// 遍历完了就退出循环</span>
				<span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> emptyRest <span class="token punctuation">{</span>
					<span class="token keyword">break</span> bucketloop
				<span class="token punctuation">}</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
            <span class="token comment">// 如果tophash相等的话，则说明key可能已经存在了</span>
			k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				k <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
            <span class="token comment">// 判断key是否相等</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 如果需要更新key值的话，就将key的内存直接复制到k处</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">NeedKeyUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> k<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
            <span class="token comment">// 得到了元素的指针</span>
			elem <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 更新完毕，返回元素指针</span>
			<span class="token keyword">goto</span> done
		<span class="token punctuation">}</span>
        <span class="token comment">// 执行到这里说明没找到key，遍历溢出桶链表，继续找</span>
		ovf <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
		<span class="token keyword">if</span> ovf <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		b <span class="token operator">=</span> ovf
	<span class="token punctuation">}</span>

	<span class="token comment">// 执行到这里说明key没有存在于map中，但可能已经找到了一个合适的位置分配给key，也可能没有</span>
	
	<span class="token comment">// 没有找到一个合适的位置分配给key</span>
	<span class="token keyword">if</span> inserti <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// 说明当前的哈希桶以及它的溢出桶都满了，那就再分配一个溢出桶</span>
		newb <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">newoverflow</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
        <span class="token comment">// 在溢出桶中分配一个位置给key</span>
		inserti <span class="token operator">=</span> <span class="token operator">&amp;</span>newb<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
		insertk <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>newb<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token punctuation">)</span>
		elem <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>insertk<span class="token punctuation">,</span> bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 如果存放的是key指针的话</span>
	<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 新分配内存，返回的是一个unsafe指针</span>
		kmem <span class="token operator">:=</span> <span class="token function">newobject</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>insertk<span class="token punctuation">)</span> <span class="token operator">=</span> kmem
        <span class="token comment">// 赋值给insertk，方便后面进行key的内存复制</span>
		insertk <span class="token operator">=</span> kmem
	<span class="token punctuation">}</span>
	
	<span class="token comment">// 如果存放的是元素指针</span>
	<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 分配内存</span>
		vmem <span class="token operator">:=</span> <span class="token function">newobject</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Elem<span class="token punctuation">)</span>
        <span class="token comment">// 让指针指向vmem</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token operator">=</span> vmem
	<span class="token punctuation">}</span>
	<span class="token comment">// 将key的内存直接复制到insertk的位置</span>
	<span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> insertk<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token operator">*</span>inserti <span class="token operator">=</span> top
	<span class="token comment">// 数量加一</span>
	h<span class="token punctuation">.</span>count<span class="token operator">++</span>

done<span class="token punctuation">:</span>
	<span class="token comment">// 执行到这里说明修改过程已经完成了</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>hashWriting <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">&quot;concurrent map writes&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	h<span class="token punctuation">.</span>flags <span class="token operator">&amp;^=</span> hashWriting
	<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		elem <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 返回元素指针</span>
	<span class="token keyword">return</span> elem
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在上述一大段代码中，首先进入for循环尝试在哈希桶和溢出桶中去查找，查找的逻辑与<code>mapaccess</code>完全一致，此时有三种可能</p><ul><li>第一种，在map中找到了已经存在的key，直接跳到<code>done</code>代码块，返回元素指针</li><li>第二种，在map中找到了一个位置分配给key使用，将key复制到指定位置，并返回元素指针</li><li>第三种，所有桶都找完了，没有在map中找到可以分配给key的位置，创建一个新的溢出桶，并将key分配到桶中，然后将key复制到指定位置，并返回元素指针</li></ul><p>最终得到了元素指针后，就可以赋值了，不过这部分操作并不由<code>mapassign</code>函数来完成，它只负责返回元素指针，赋值操作是在编译器期间插入的，在代码里面看不见，但是编译后的代码可以看见，假设有下面的代码</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	dict <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
	dict<span class="token punctuation">[</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;world&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过命令如下命令得到汇编代码</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>go tool compile -S -N -l main.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>关键的地方就在这部分</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>0x004e 00078     LEAQ    type:map[string]string(SB), AX
0x0055 00085     CALL    runtime.mapassign_faststr(SB)
0x005a 00090     MOVQ    AX, main..autotmp_2+40(SP)
0x0083 00131     LEAQ    go:string.&quot;world&quot;(SB), CX
0x008a 00138     MOVQ    CX, (AX)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到调用了<code>runtime.mapassign_faststr</code>，其逻辑与<code>mapassign</code>完全相似，<code>LEAQ go:string.&quot;world&quot;(SB), CX</code>就是将字符串的地址存储到<code>CX</code>上，<code>MOVQ CX, (AX)</code>再将其存储到了<code>AX</code>上，于是就完成了元素的赋值。</p><h2 id="删除" tabindex="-1"><a class="header-anchor" href="#删除" aria-hidden="true">#</a> 删除</h2><p>在go中，要想删除一个map的元素，只能使用内置函数<code>delete</code>，如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token function">delete</span><span class="token punctuation">(</span>dict<span class="token punctuation">,</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其内部调用的是<code>runtime.mapdelete</code>函数，该函数签名如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapdelete</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>它会删除map中指定key的元素，不管元素是否存在于map中，它都不会有任何反应。函数开头做准备工作的逻辑都是类似的，无非就是下面几件事</p><ul><li>hmap状态检查</li><li>计算key的哈希值</li><li>定位哈希桶</li><li>计算tophash</li></ul><p>前面有很多重复的内容，就不再赘述了，这里只关注它删除的逻辑，对应的部分代码如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>bOrig <span class="token operator">:=</span> b
search<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">;</span> b <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> top <span class="token punctuation">{</span>
				<span class="token comment">// 没找到就退出循环</span>
				<span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> emptyRest <span class="token punctuation">{</span>
					<span class="token keyword">break</span> search
				<span class="token punctuation">}</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 移动指针找到key的位置</span>
			k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
			k2 <span class="token operator">:=</span> k
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				k2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k2<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> k2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			
			<span class="token comment">// 删除key</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span>PtrBytes <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token function">memclrHasPointers</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span>Size_<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			 <span class="token comment">// 移动指针找到元素的位置</span>
			e <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
            
			<span class="token comment">// 删除元素</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> t<span class="token punctuation">.</span>Elem<span class="token punctuation">.</span>PtrBytes <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token function">memclrHasPointers</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">.</span>Elem<span class="token punctuation">.</span>Size_<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">memclrNoHeapPointers</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">.</span>Elem<span class="token punctuation">.</span>Size_<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
            
		notLast<span class="token punctuation">:</span>
			<span class="token comment">// 数量减一</span>
			h<span class="token punctuation">.</span>count<span class="token operator">--</span>
			<span class="token comment">// 重置哈希种子，减小冲突发生概率</span>
			<span class="token keyword">if</span> h<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				h<span class="token punctuation">.</span>hash0 <span class="token operator">=</span> <span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span> search
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过上面的代码可以看到，查找的逻辑跟前面的操作是几乎完全一致的，找到元素，然后删除，hmap记录的数量减一，当数量减为0时，就重置哈希种子。</p><p>另一个要注意的点就是，在删除完元素后，需要修改当前下标的tophash状态，这部分对应的代码如下。当i在桶末尾时，判断根据下一个溢出桶来判断当前元素是否是最后一个可用元素，否则的话就直接查看相邻元素的哈希状态。如果当前元素不是最后一个可用的，就将状态置为<code>emptyOne</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 将当前tophash标记为空</span>
b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> emptyOne

<span class="token comment">// 如果在tophash末尾</span>
<span class="token keyword">if</span> i <span class="token operator">==</span> bucketCnt<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
    <span class="token comment">// 溢出桶不为空，且溢出桶内有元素，说明当前元素不是最后一个</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>tophash<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> emptyRest <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> notLast
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 相邻元素不为空</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> emptyRest <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> notLast
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果元素确实是最后一个元素的话，就需要修正一下桶链表中部分桶的tophash数组的值，否则的话后续遍历时会导致无法在正确的位置退出。在map创建溢出桶的时候讲述过，go为了减少追踪溢出桶的成本，最后一个溢出桶的<code>overflow</code>指针就是指向头部的哈希桶，所以它实际上是一个单向环形链表，链表的“头部”就是哈希桶。而这里的<code>b</code>是查找过后的<code>b</code>，很可能是链表中间的某一个溢出桶，逆序遍历环形链表查找最后一个存在的元素。尽管代码写的是正序遍历，由于链表是一个环，它不断正序遍历直到当前溢出桶的前一个为止，从结果上来说确实是逆序的。再然后逆序遍历桶中的tophash数组，将状态为<code>emptyOne</code>的元素更新为<code>emptyRest</code>，直到找到最后一个存在的元素。为避免无限陷入在环中，当回到了最开始的桶时，也就是<code>bOrig</code>，说明此时链表内已经没有可用的元素了，就可以退出循环了。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 执行到这里说明当前元素后面没有元素了</span>
<span class="token comment">// 不断的倒序遍历bmap链表，倒序遍历桶内的tophash</span>
<span class="token comment">// 将状态为emptyOne的更新为emptyRest</span>
<span class="token keyword">for</span> <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> emptyRest
    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> b <span class="token operator">==</span> bOrig <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        
        c <span class="token operator">:=</span> b
		<span class="token comment">// 找到当前bmap链表的前一个</span>
        <span class="token keyword">for</span> b <span class="token operator">=</span> bOrig<span class="token punctuation">;</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">!=</span> c<span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        i <span class="token operator">=</span> bucketCnt <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> emptyOne <span class="token punctuation">{</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="清空" tabindex="-1"><a class="header-anchor" href="#清空" aria-hidden="true">#</a> 清空</h2><p>在<code>go1.21</code>版本中，新增了内置函数<code>clear</code>，可以用于清空map中的所有元素，语法如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token function">clear</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其内部调用了<code>runtime.mapclear</code>函数，它负责删除map中的所有元素，其函数签名如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapclear</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>该函数的逻辑并不复杂，首先需要将整个map标记为空，对应的代码如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 遍历每一个桶以及溢出桶，将所有的tophash元素置为emptyRest</span>
markBucketsEmpty <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>bucket unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> mask <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> mask<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        b <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">;</span> b <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> emptyRest
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">markBucketsEmpty</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> <span class="token function">bucketMask</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>B<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面代码做的事情就是遍历每一个桶，将桶中的tophash数组的元素都置为<code>emptyRest</code>，将map标记为空，这样就能阻止迭代器继续迭代，然后再清空map，对应的代码如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 重置哈希种子</span>
h<span class="token punctuation">.</span>hash0 <span class="token operator">=</span> <span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 重置extra结构体</span>
<span class="token keyword">if</span> h<span class="token punctuation">.</span>extra <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>h<span class="token punctuation">.</span>extra <span class="token operator">=</span> mapextra<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 这个操作会清除原来buckets的内存，并重新分配新的桶</span>
<span class="token boolean">_</span><span class="token punctuation">,</span> nextOverflow <span class="token operator">:=</span> <span class="token function">makeBucketArray</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">.</span>B<span class="token punctuation">,</span> h<span class="token punctuation">.</span>buckets<span class="token punctuation">)</span>
<span class="token keyword">if</span> nextOverflow <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token comment">// 分配新的空闲溢出桶</span>
    h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>nextOverflow <span class="token operator">=</span> nextOverflow
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过<code>makeBucketArray</code>清除之前的桶的内存，然后新分配一个，这样一来就完成了桶的清除，除此之外还有一些细节，比如说将<code>count</code>置0，还有其它的一些操作就不过多赘述。</p><h2 id="扩容" tabindex="-1"><a class="header-anchor" href="#扩容" aria-hidden="true">#</a> 扩容</h2><p>在之前的所有操作中，为了更关注其本身的逻辑，所以屏蔽了很多跟扩容有关内容，这样会简单很多。扩容的逻辑其实比较复杂，放在最后就是不希望产生干扰，那么现在就来看看go是如何对map进行扩容的，前面已经提到过，触发扩容有两个条件：</p><ul><li>负载因子超过6.5</li><li>溢出桶的数量过多</li></ul><p>判断负载因子是否超过阈值的函数是<code>runtime.overLoadFactor</code>函数，在哈希冲突部分已经阐述过，而判断溢出桶的数量是否过多的函数是<code>runtime.tooManyOverflowBuckets</code>，其工作原理也很简单，代码如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">tooManyOverflowBuckets</span><span class="token punctuation">(</span>noverflow <span class="token builtin">uint16</span><span class="token punctuation">,</span> B <span class="token builtin">uint8</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> B <span class="token operator">&gt;</span> <span class="token number">15</span> <span class="token punctuation">{</span>
		B <span class="token operator">=</span> <span class="token number">15</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> noverflow <span class="token operator">&gt;=</span> <span class="token function">uint16</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>B<span class="token operator">&amp;</span><span class="token number">15</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码可以简化成如下表达式，一眼就能看懂。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>overflow &gt;= 1 &lt;&lt; (min(15,B) % 16)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在这里，go对于too many的定义是：溢出桶的数量跟哈希桶的数量差不多，如果阈值低了，就会做多余的工作，如果阈值高了，那么在扩容的时候就会占用大量的内存。在修改和删除元素时就有可能触发扩容，判断是否需要扩容的代码如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">growing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">overLoadFactor</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>count<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> h<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">tooManyOverflowBuckets</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>noverflow<span class="token punctuation">,</span> h<span class="token punctuation">.</span>B<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">hashGrow</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> again <span class="token comment">// Growing the table invalidates everything, so try again</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到的就是这三个条件限制</p><ol><li>当前不能正在扩容</li><li>负载因子小于6.5</li><li>溢出桶数量不能过多</li></ol><p>负责扩容的函数自然就是<code>runtime.hashGrow</code>，其函数签名如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">hashGrow</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>实际上，扩容也分种类，根据不同条件触发的扩容其类型也不同，分为以下两种</p><ul><li>增量扩容</li><li>等量扩容</li></ul><h3 id="增量扩容" tabindex="-1"><a class="header-anchor" href="#增量扩容" aria-hidden="true">#</a> 增量扩容</h3><p>当负载因子过大时，即元素数量较大于哈希桶的数量，当哈希冲突比较严重的时候，会形成很多溢出桶链表，这样会导致map读写性能下降，因为需要查找一个元素遍历更多的溢出桶链表，而遍历的时间复杂度是O(n)，哈希表查找的时间复杂度主要取决于哈希值的计算时间和遍历的时间，当遍历的时间远小于计算哈希的时间时，查找的时间复杂度才能称为O(1)。倘若哈希冲突比较频繁，过多key都被分配到了同一个哈希桶，溢出桶链表过长导致遍历时间增大，就会导致查找时间增大，而增删改操作都需要先进行查找操作，这样一来的话就会导致整个map的性能严重下降。</p><figure><img src="/images/essential/impl_map_1.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>像图中这种比较极端的情况，查找的时间复杂度基本上跟O(n)没啥区别了。面对这种情况，解决办法就是新增更多的哈希桶，避免形成过长的溢出桶链表，这种方法也被称为增量扩容。</p><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202310080936033.png" style="zoom:50%;"><p>在go中，增量扩容每次都会将B加一，也就是哈希桶的规模每次扩大一倍。扩容后，需要将旧数据搬迁到新的map中，倘若map中的元素数量以千万甚至亿计，一次性全部搬迁完的话耗时会很久，所以go采用的是逐步搬迁的策略，为此，go会将hamp中的<code>oldBuckets</code>指向原来的哈希桶数组，表示这是旧数据，然后创建更大容量的哈希桶数组，让<code>hmap</code>中的<code>buckets</code>指向新的哈希桶数组，然后在每一次修改和删除元素时，将部分元素搬迁从旧桶搬到新桶，直到搬迁完毕，旧桶的内存才会被释放掉。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">hashGrow</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 差值</span>
	bigger <span class="token operator">:=</span> <span class="token function">uint8</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token comment">// 旧桶</span>
	oldbuckets <span class="token operator">:=</span> h<span class="token punctuation">.</span>buckets
	<span class="token comment">// 新的哈希桶</span>
	newbuckets<span class="token punctuation">,</span> nextOverflow <span class="token operator">:=</span> <span class="token function">makeBucketArray</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">.</span>B<span class="token operator">+</span>bigger<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>

	flags <span class="token operator">:=</span> h<span class="token punctuation">.</span>flags <span class="token operator">&amp;^</span> <span class="token punctuation">(</span>iterator <span class="token operator">|</span> oldIterator<span class="token punctuation">)</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>iterator <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		flags <span class="token operator">|=</span> oldIterator
	<span class="token punctuation">}</span>
	<span class="token comment">// B+bigger</span>
	h<span class="token punctuation">.</span>B <span class="token operator">+=</span> bigger
	h<span class="token punctuation">.</span>flags <span class="token operator">=</span> flags
	h<span class="token punctuation">.</span>oldbuckets <span class="token operator">=</span> oldbuckets
	h<span class="token punctuation">.</span>buckets <span class="token operator">=</span> newbuckets
	h<span class="token punctuation">.</span>nevacuate <span class="token operator">=</span> <span class="token number">0</span>
	h<span class="token punctuation">.</span>noverflow <span class="token operator">=</span> <span class="token number">0</span>
	
	<span class="token comment">// 溢出桶也要指定旧桶和新桶</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span>extra <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>overflow <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>oldoverflow <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;oldoverflow is not nil&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>oldoverflow <span class="token operator">=</span> h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>overflow
		h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>overflow <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> nextOverflow <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> h<span class="token punctuation">.</span>extra <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			h<span class="token punctuation">.</span>extra <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>mapextra<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>nextOverflow <span class="token operator">=</span> nextOverflow
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码做的事情就是创建大一倍容量的新哈希桶，然后指定哈希新旧桶的引用，以及溢出新旧桶的引用，而实际的搬迁工作并不由<code>hashGrow</code>函数来完成，它只负责指定新旧桶，并更新<code>hmap</code>的一些状态。这些工作实际上是由<code>runtime.growWork</code>函数完成的，其函数签名如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">growWork</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> bucket <span class="token builtin">uintptr</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>它会在<code>mapassign</code>函数和<code>mapdelete</code>函数中，以如下的形式被调用，其作用就是如果当前map正在扩容中，就进行一次部分搬迁工作。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> h<span class="token punctuation">.</span><span class="token function">growing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">growWork</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">,</span> bucket<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在进行修改和删除操作时，需要判断当前是否处于扩容中，这主要由<code>hmap.growing</code>方法来完成，内容很简单，就是判断<code>oldbuckets</code>是否为不为空，对应代码如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>hmap<span class="token punctuation">)</span> <span class="token function">growing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> h<span class="token punctuation">.</span>oldbuckets <span class="token operator">!=</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>来看看<code>growWork</code>函数都干了些什么。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">growWork</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> bucket <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// bucket % 1 &lt;&lt; (B-1)</span>
	<span class="token function">evacuate</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">,</span> bucket<span class="token operator">&amp;</span>h<span class="token punctuation">.</span><span class="token function">oldbucketmask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span><span class="token function">growing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">evacuate</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">,</span> h<span class="token punctuation">.</span>nevacuate<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中<code>bucket&amp;h.oldbucketmask()</code>操作是计算得到旧桶的位置，确保将要搬迁的是当前桶的旧桶。从函数中可以看到真正负责搬迁工作的是<code>runtime.evacuate</code>函数，其中用到了<code>evaDst</code>结构体用来表示搬迁目的地，主要作用是在搬迁的过程中迭代新桶，它的结构如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> evacDst <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	b <span class="token operator">*</span>bmap          <span class="token comment">// 搬迁目的地的新桶</span>
	i <span class="token builtin">int</span>            <span class="token comment">// 桶内下标</span>
	k unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// 指向新键目的地的指针</span>
	e unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// 指向新值目的地的指针</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在搬迁开始之前，go会分配两个<code>evacDst</code>结构体，一个指向新哈希桶的上半区，另一个指向新哈希桶的下半区，对应的代码如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 定位旧桶中指定的哈希桶</span>
b <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>oldbuckets<span class="token punctuation">,</span> oldbucket<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 旧桶的长度 = 1 &lt;&lt; (B - 1)</span>
newbit <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">noldbuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> xy <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>evacDst
x <span class="token operator">:=</span> <span class="token operator">&amp;</span>xy<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token comment">// 指向新桶的上半区</span>
x<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> oldbucket<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
x<span class="token punctuation">.</span>k <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token punctuation">)</span>
x<span class="token punctuation">.</span>e <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>k<span class="token punctuation">,</span> bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 判断是不是等量扩容</span>
<span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">sameSizeGrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    y <span class="token operator">:=</span> <span class="token operator">&amp;</span>xy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment">// 指向新桶的下半区</span>
    y<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> <span class="token punctuation">(</span>oldbucket<span class="token operator">+</span>newbit<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    y<span class="token punctuation">.</span>k <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token punctuation">)</span>
    y<span class="token punctuation">.</span>e <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>k<span class="token punctuation">,</span> bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>旧桶的搬迁目的地是两个新桶，搬迁后，桶中的部分数据会在上半区，另一部分的数据会在下半区，这样做是希望扩容后的数据能够更加均匀的分布，分布的越均匀，map的查找性能就会越好。go如何将数据搬迁到两个新桶中，对应着下面的代码。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 遍历溢出桶链表</span>
<span class="token keyword">for</span> <span class="token punctuation">;</span> b <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 拿到每个桶的第一键值对</span>
    k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token punctuation">)</span>
    e <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 遍历桶中的每一个键值对</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token punctuation">,</span> k<span class="token punctuation">,</span> e <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        top <span class="token operator">:=</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token comment">// 如果是空的就跳过</span>
        <span class="token keyword">if</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span>top<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> evacuatedEmpty
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 新哈希桶不应该处于搬迁状态</span>
        <span class="token comment">// 否则的话肯定是出问题了</span>
        <span class="token keyword">if</span> top <span class="token operator">&lt;</span> minTopHash <span class="token punctuation">{</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;bad map state&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        k2 <span class="token operator">:=</span> k
        <span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            k2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k2<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 该变量决定了当前键值对被搬迁到上半区还是下半区</span>
        <span class="token comment">// 它的值只能是0或1</span>
        <span class="token keyword">var</span> useY <span class="token builtin">uint8</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">sameSizeGrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 重新计算哈希值</span>
            hash <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Hasher</span><span class="token punctuation">(</span>k2<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hash0<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 处理k2 != k2的特殊情况，</span>
            <span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>iterator <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">ReflexiveKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>k2<span class="token punctuation">,</span> k2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                useY <span class="token operator">=</span> top <span class="token operator">&amp;</span> <span class="token number">1</span>
                top <span class="token operator">=</span> <span class="token function">tophash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// hash % 1 &lt;&lt; (B - 1)</span>
                <span class="token keyword">if</span> hash<span class="token operator">&amp;</span>newbit <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                    useY <span class="token operator">=</span> <span class="token number">1</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 检查常量的值</span>
        <span class="token keyword">if</span> evacuatedX<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">!=</span> evacuatedY <span class="token operator">||</span> evacuatedX<span class="token operator">^</span><span class="token number">1</span> <span class="token operator">!=</span> evacuatedY <span class="token punctuation">{</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;bad evacuatedN&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
		
        <span class="token comment">// 更新旧桶的tophash，表示当前元素已被搬迁</span>
        b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> evacuatedX <span class="token operator">+</span> useY <span class="token comment">// evacuatedX + 1 == evacuatedY</span>
        <span class="token comment">// 指定搬迁目的地</span>
        dst <span class="token operator">:=</span> <span class="token operator">&amp;</span>xy<span class="token punctuation">[</span>useY<span class="token punctuation">]</span>                 <span class="token comment">// evacuation destination</span>
		
        <span class="token comment">// 新桶容量不够用了建个溢出桶</span>
        <span class="token keyword">if</span> dst<span class="token punctuation">.</span>i <span class="token operator">==</span> bucketCnt <span class="token punctuation">{</span>
            dst<span class="token punctuation">.</span>b <span class="token operator">=</span> h<span class="token punctuation">.</span><span class="token function">newoverflow</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>b<span class="token punctuation">)</span>
            dst<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token number">0</span>
            dst<span class="token punctuation">.</span>k <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>dst<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token punctuation">)</span>
            dst<span class="token punctuation">.</span>e <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>dst<span class="token punctuation">.</span>k<span class="token punctuation">,</span> bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        dst<span class="token punctuation">.</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>dst<span class="token punctuation">.</span>i<span class="token operator">&amp;</span><span class="token punctuation">(</span>bucketCnt<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> top <span class="token comment">// mask dst.i as an optimization, to avoid a bounds check</span>
        <span class="token comment">// 复制键</span>
        <span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>dst<span class="token punctuation">.</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> k2 <span class="token comment">// copy pointer</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>k<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token comment">// copy elem</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 复制值</span>
        <span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>dst<span class="token punctuation">.</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Elem<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>e<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 后移新桶目的指针，为下一个键值做准备</span>
        dst<span class="token punctuation">.</span>i<span class="token operator">++</span>
        dst<span class="token punctuation">.</span>k <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>dst<span class="token punctuation">.</span>k<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
        dst<span class="token punctuation">.</span>e <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>dst<span class="token punctuation">.</span>e<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上面的代码可以看到，go会遍历旧桶链表中的每一个桶中的每一个元素，将其中的数据搬到新桶中，决定数据到底是去上半区还是下半区取决于重新计算后的哈希值</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// hash % 1 &lt;&lt; (B - 1)</span>
<span class="token keyword">if</span> hash<span class="token operator">&amp;</span>newbit <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    useY <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在搬迁后，会将当前元素的tophash置为<code>evacuatedX</code>或<code>evacuated</code>，如果在扩容的过程中尝试查找数据，通过此状态就可以得知数据已经被搬迁，就知道要去新桶里面找对应的数据。这部分逻辑对应<code>runtime.mapaccess1</code>函数中的如下代码。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> c <span class="token operator">:=</span> h<span class="token punctuation">.</span>oldbuckets<span class="token punctuation">;</span> c <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">sameSizeGrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// There used to be half as many buckets; mask down one more power of two.</span>
        m <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    oldb <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token punctuation">(</span>hash<span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果旧桶已经被搬迁了就不找了</span>
    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">evacuated</span><span class="token punctuation">(</span>oldb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        b <span class="token operator">=</span> oldb
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在访问元素时，如果当前正处于扩容状态，会先去尝试去旧桶里面查找，如果旧桶已经被搬迁了就不去旧桶里面找。回到搬迁这块，此时已经确定了搬迁的目的地，接下来要做就是将数据复制到新桶中，然后让<code>evacDst</code>结构体指向下一个目的地。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>dst <span class="token operator">:=</span> <span class="token operator">&amp;</span>xy<span class="token punctuation">[</span>useY<span class="token punctuation">]</span> 
dst<span class="token punctuation">.</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>dst<span class="token punctuation">.</span>i<span class="token operator">&amp;</span><span class="token punctuation">(</span>bucketCnt<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> top
<span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>k<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
<span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Elem<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>e<span class="token punctuation">,</span> e<span class="token punctuation">)</span>

<span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>oldIterator <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span>Bucket<span class="token punctuation">.</span>PtrBytes <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    b <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>oldbuckets<span class="token punctuation">,</span> oldbucket<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
    ptr <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> dataOffset<span class="token punctuation">)</span>
    n <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span> <span class="token operator">-</span> dataOffset
    <span class="token function">memclrHasPointers</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样操作直到当前桶全部搬迁完毕，然后go就会将当前旧桶键值数据全部内存清除，只留下一个哈希桶tophash数组（留下是因为后续要靠tophash数组判断搬迁状态），旧桶中的溢出桶内存由于不再被引用后续会被GC回收掉。<code>hmap</code>中有一个字段<code>nevacuate</code>用来记录搬迁进度，每搬完一个旧的哈希桶，就会加一，当它的值与旧桶的数量相等时，就说明整个map的扩容已经完成了，接下来就由<code>runtime.advanceEvacuationMark</code>函数进行扩容的收尾工作。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">advanceEvacuationMark</span><span class="token punctuation">(</span>h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> newbit <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	h<span class="token punctuation">.</span>nevacuate<span class="token operator">++</span>
	stop <span class="token operator">:=</span> h<span class="token punctuation">.</span>nevacuate <span class="token operator">+</span> <span class="token number">1024</span>
	<span class="token keyword">if</span> stop <span class="token operator">&gt;</span> newbit <span class="token punctuation">{</span>
		stop <span class="token operator">=</span> newbit
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> h<span class="token punctuation">.</span>nevacuate <span class="token operator">!=</span> stop <span class="token operator">&amp;&amp;</span> <span class="token function">bucketEvacuated</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">,</span> h<span class="token punctuation">.</span>nevacuate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		h<span class="token punctuation">.</span>nevacuate<span class="token operator">++</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">if</span> h<span class="token punctuation">.</span>nevacuate <span class="token operator">==</span> newbit <span class="token punctuation">{</span> <span class="token comment">// newbit = len(oldbuckets)</span>
		h<span class="token punctuation">.</span>oldbuckets <span class="token operator">=</span> <span class="token boolean">nil</span>
		<span class="token keyword">if</span> h<span class="token punctuation">.</span>extra <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>oldoverflow <span class="token operator">=</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		h<span class="token punctuation">.</span>flags <span class="token operator">&amp;^=</span> sameSizeGrow
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它会统计已搬迁数量并确认是否与旧桶数量相等，相等的话就清除对于所有旧桶和旧溢出桶的引用，至此扩容完毕。</p><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202310081152771.png" style="zoom:50%;"><p>在<code>growWork</code>函数中，总共调用了两次<code>evacuate</code>函数，第一次是搬当前正在访问桶的旧桶，第二次是搬<code>h.nevacuate</code>所指向的旧桶，总共搬了两次，说明逐步搬迁时，每一次都会搬两个桶。</p><h3 id="等量扩容" tabindex="-1"><a class="header-anchor" href="#等量扩容" aria-hidden="true">#</a> 等量扩容</h3><figure><img src="/images/essential/impl_map_2.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>前面提到过，等量扩容的触发条件是溢出桶数量过多，假如map先是添加了大量的元素，然后又大量删除元素，这样一来可能很多桶都是空的，可能有些桶有很多的元素，数据分布十分不均匀，有相当多的溢出桶都是空的，占用了不少的内存。为了解决这类问题，就需要创建一个同等容量的新map，重新分配一次哈希桶，这个过程就叫等量扩容。所以其实并不是扩容操作，只是将所有元素二次分配使数据分布更加均匀，等量扩容操作是糅合在增量扩容操作中的，其逻辑与增量扩容完全一致，新旧map容量完全相等。</p><p>在<code>hashGrow</code>函数中，如果负载因子没有超过阈值，进行的就是等量扩容，go更新<code>h.flags</code>的状态为<code>sameSizeGrow</code>，<code>h.B</code>也不会加一，所以新创建的哈希桶容量也不会有变化，对应代码如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>bigger <span class="token operator">:=</span> <span class="token function">uint8</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">overLoadFactor</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>count<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> h<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bigger <span class="token operator">=</span> <span class="token number">0</span>
    h<span class="token punctuation">.</span>flags <span class="token operator">|=</span> sameSizeGrow
<span class="token punctuation">}</span>
oldbuckets <span class="token operator">:=</span> h<span class="token punctuation">.</span>buckets
newbuckets<span class="token punctuation">,</span> nextOverflow <span class="token operator">:=</span> <span class="token function">makeBucketArray</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">.</span>B<span class="token operator">+</span>bigger<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>evacuate</code>函数中，刚开始创建<code>eavcDst</code>结构体时，如果是等量扩容的话就只会创建一个结构体指向新桶，对应代码如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">sameSizeGrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    y <span class="token operator">:=</span> <span class="token operator">&amp;</span>xy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    y<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> <span class="token punctuation">(</span>oldbucket<span class="token operator">+</span>newbit<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    y<span class="token punctuation">.</span>k <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token punctuation">)</span>
    y<span class="token punctuation">.</span>e <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>k<span class="token punctuation">,</span> bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>并且在搬迁元素的时候，等量扩容不会重新计算哈希值，也没有上下半区的选择</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">sameSizeGrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 重新计算哈希值</span>
    hash <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Hasher</span><span class="token punctuation">(</span>k2<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hash0<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 处理k2 != k2的特殊情况，</span>
    <span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>iterator <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">ReflexiveKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>k2<span class="token punctuation">,</span> k2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        useY <span class="token operator">=</span> top <span class="token operator">&amp;</span> <span class="token number">1</span>
        top <span class="token operator">=</span> <span class="token function">tophash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// hash % 1 &lt;&lt; (B - 1)</span>
        <span class="token keyword">if</span> hash<span class="token operator">&amp;</span>newbit <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            useY <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>除了这些，其它的逻辑与增量扩容完全一致。经过等量扩容哈希桶重新分配过后，溢出桶的数量就会减少，旧的溢出桶都会被GC回收掉。</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/Open-Source-CQUT/Golang-Doc/edit/main/src/essential/impl/ds/1.map.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 2633565580@qq.com">yihhao wang</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/essential/impl/ds/0.slice.html" class="nav-link prev" aria-label="slice"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->slice</div></a><a href="/essential/impl/ds/2.string.html" class="nav-link next" aria-label="string"><div class="hint">下一页<span class="arrow right"></span></div><div class="link">string<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-2cf283ae.js" defer></script>
  </body>
</html>
