<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.19" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.64" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://golang.halfiisland.com/essential/impl/runtime/9.gc.html"><meta property="og:site_name" content="Golang ä¸­æ–‡å­¦ä¹ æ–‡æ¡£"><meta property="og:title" content="gc"><meta property="og:description" content="gc åƒåœ¾å›æ”¶è¦å¹²çš„äº‹å°±æ˜¯å°†ä¸å†ä½¿ç”¨çš„å¯¹è±¡å†…å­˜é‡Šæ”¾ï¼Œè…¾å‡ºç©ºé—´ç»™å…¶å®ƒå¯¹è±¡ä½¿ç”¨ã€‚å°±è¿™ä¹ˆç®€å•çš„ä¸€å¥æè¿°ä½†å®ƒå®ç°èµ·æ¥å´éå¸¸ä¸ç®€å•ï¼Œåƒåœ¾å›æ”¶çš„å‘å±•å†å²å·²ç»æœ‰äº†å‡ åå¹´ï¼Œæœ€æ—©åœ¨ä¸Šä¸–çºª 60 å¹´ä»£çš„ Lisp è¯­è¨€å°±é¦–æ¬¡é‡‡ç”¨äº†åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œæˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„ Pythonï¼ŒObjective-Cï¼Œå…¶ä¸»è¦çš„ GC æœºåˆ¶å°±æ˜¯å¼•ç”¨è®¡æ•°ï¼ŒJavaï¼ŒC#é‡‡ç”¨çš„æ˜¯åˆ†ä»£å›æ”¶ã€‚åœ¨ä»Šå¤©æ¥çœ‹åƒ..."><meta property="og:type" content="article"><meta property="og:image" content="https://golang.halfiisland.com/images/essential/impl_gc_1.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-12-15T16:58:36.000Z"><meta property="article:published_time" content="2024-06-06T00:00:00.000Z"><meta property="article:modified_time" content="2024-12-15T16:58:36.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"gc","image":["https://golang.halfiisland.com/images/essential/impl_gc_1.png","https://golang.halfiisland.com/images/essential/impl_gc_2.png","https://golang.halfiisland.com/images/essential/impl_gc_3.png","https://golang.halfiisland.com/images/essential/impl_gc_4.png","https://golang.halfiisland.com/images/essential/impl_gc_5.png","https://golang.halfiisland.com/images/essential/impl_gc_6.png","https://golang.halfiisland.com/images/essential/impl_gc_7.png","https://golang.halfiisland.com/images/essential/impl_gc_8.png","https://golang.halfiisland.com/images/essential/impl_gc_9.png","https://golang.halfiisland.com/images/essential/impl_gc_10.png","https://golang.halfiisland.com/images/essential/impl_gc_11.png"],"datePublished":"2024-06-06T00:00:00.000Z","dateModified":"2024-12-15T16:58:36.000Z","author":[{"@type":"Person","name":"å¯’æ±Ÿè“‘ç¬ ç¿","url":"https://246859.github.io/","email":"2633565580@qq.com"}]}</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?87d678935e4b33455c0390543e7a759d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-6K9H75LPZG"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6K9H75LPZG');</script><title>gc | Golang ä¸­æ–‡å­¦ä¹ æ–‡æ¡£</title><meta name="description" content="gc åƒåœ¾å›æ”¶è¦å¹²çš„äº‹å°±æ˜¯å°†ä¸å†ä½¿ç”¨çš„å¯¹è±¡å†…å­˜é‡Šæ”¾ï¼Œè…¾å‡ºç©ºé—´ç»™å…¶å®ƒå¯¹è±¡ä½¿ç”¨ã€‚å°±è¿™ä¹ˆç®€å•çš„ä¸€å¥æè¿°ä½†å®ƒå®ç°èµ·æ¥å´éå¸¸ä¸ç®€å•ï¼Œåƒåœ¾å›æ”¶çš„å‘å±•å†å²å·²ç»æœ‰äº†å‡ åå¹´ï¼Œæœ€æ—©åœ¨ä¸Šä¸–çºª 60 å¹´ä»£çš„ Lisp è¯­è¨€å°±é¦–æ¬¡é‡‡ç”¨äº†åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œæˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„ Pythonï¼ŒObjective-Cï¼Œå…¶ä¸»è¦çš„ GC æœºåˆ¶å°±æ˜¯å¼•ç”¨è®¡æ•°ï¼ŒJavaï¼ŒC#é‡‡ç”¨çš„æ˜¯åˆ†ä»£å›æ”¶ã€‚åœ¨ä»Šå¤©æ¥çœ‹åƒ...">
    <link rel="preload" href="/assets/style-B_RgHYMe.css" as="style"><link rel="stylesheet" href="/assets/style-B_RgHYMe.css">
    <link rel="modulepreload" href="/assets/app--QUN711U.js"><link rel="modulepreload" href="/assets/9.gc.html-BTmutHVh.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/" aria-label="å¸¦æˆ‘å›å®¶"><img class="vp-nav-logo" src="/logo.png" alt><!----><span class="vp-site-name hide-in-pad">Golang ä¸­æ–‡å­¦ä¹ æ–‡æ¡£</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/guide.html" aria-label="æŒ‡å—"><!--[--><span class="font-icon icon iconfont icon-activity" style=""></span><!--]-->æŒ‡å—<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/cmd.html" aria-label="å‘½ä»¤"><!--[--><span class="font-icon icon iconfont icon-shell" style=""></span><!--]-->å‘½ä»¤<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/release.html" aria-label="æ›´æ–°æ—¥å¿—"><!--[--><span class="font-icon icon iconfont icon-repo" style=""></span><!--]-->æ›´æ–°æ—¥å¿—<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/link.html" aria-label="å¤–éƒ¨é“¾æ¥"><!--[--><span class="font-icon icon iconfont icon-share" style=""></span><!--]-->å¤–éƒ¨é“¾æ¥<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/deb.html" aria-label="ä¾èµ–å¯¼èˆª"><!--[--><span class="font-icon icon iconfont icon-discover" style=""></span><!--]-->ä¾èµ–å¯¼èˆª<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/play.html" aria-label="Playground"><!--[--><span class="font-icon icon iconfont icon-back-stage" style=""></span><!--]-->Playground<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="auto-link external-link" href="https://go.dev/ref/spec" aria-label="å‚è€ƒæ‰‹å†Œ" rel="noopener noreferrer" target="_blank"><!--[--><span class="font-icon icon iconfont icon-article" style=""></span><!--]-->å‚è€ƒæ‰‹å†Œ<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/about.html" aria-label="å…³äºä½œè€…"><!--[--><span class="font-icon icon iconfont icon-alias" style=""></span><!--]-->å…³äºä½œè€…<!----></a></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/Open-Source-CQUT/Golang-Doc" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="slimsearch-button" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="slimsearch-placeholder">æœç´¢</div><div class="slimsearch-key-hints"><kbd class="slimsearch-key">Ctrl</kbd><kbd class="slimsearch-key">K</kbd></div></button><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><span class="font-icon icon iconfont icon-activity" style=""></span><span class="vp-sidebar-title">è¯­è¨€å…¥é—¨</span><!----></p><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-bit" style=""></span><span class="vp-sidebar-title">è¯­æ³•åŸºç¡€</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-alias" style=""></span><span class="vp-sidebar-title">è¯­æ³•è¿›é˜¶</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-module" style=""></span><span class="vp-sidebar-title">æ ‡å‡†åº“</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><span class="font-icon icon iconfont icon-template" style=""></span><span class="vp-sidebar-title">å®ç°åŸç†</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><!----><span class="vp-sidebar-title">é”™è¯¯å¤„ç†</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/err/3.nil.html" aria-label="nil"><!---->nil<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/err/4.defer.html" aria-label="defer"><!---->defer<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/err/5.panic.html" aria-label="panic"><!---->panic<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><!----><span class="vp-sidebar-title">æ•°æ®ç»“æ„</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/ds/0.slice.html" aria-label="slice"><!---->slice<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/ds/1.map.html" aria-label="map"><!---->map<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/ds/2.string.html" aria-label="string"><!---->string<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/ds/6.channel.html" aria-label="chan"><!---->chan<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/ds/6.select.html" aria-label="select"><!---->select<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/ds/10.syncmap.html" aria-label="syncmap"><!---->syncmap<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><!----><span class="vp-sidebar-title">è¿è¡Œæ—¶</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/runtime/7.gmp.html" aria-label="gmp"><!---->gmp<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/runtime/8.mem.html" aria-label="memory"><!---->memory<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/essential/impl/runtime/9.gc.html" aria-label="gc"><!---->gc<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/runtime/15.sysmon.html" aria-label="sysmon"><!---->sysmon<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><!----><span class="vp-sidebar-title">å¹¶å‘</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/sync/0.mutex.html" aria-label="mutex"><!---->mutex<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/sync/2.once.html" aria-label="once"><!---->once<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/sync/5.wg.html" aria-label="waitgroup"><!---->waitgroup<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/sync/15.cond.html" aria-label="cond"><!---->cond<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/sync/20.context.html" aria-label="context"><!---->context<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><!----><span class="vp-sidebar-title">ç½‘ç»œ</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/essential/impl/network/0.netpoll.html" aria-label="netpoll"><!---->netpoll<!----></a></li></ul></section></li></ul></section></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><span class="font-icon icon iconfont icon-software" style=""></span><span class="vp-sidebar-title">ç¤¾åŒºç”Ÿæ€</span><!----></p><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-mysql" style=""></span><span class="vp-sidebar-title">æ•°æ®åº“</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-structure" style=""></span><span class="vp-sidebar-title">å¾®æœåŠ¡</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-view" style=""></span><span class="vp-sidebar-title">ç¬¬ä¸‰æ–¹åº“</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->gc</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://246859.github.io/" target="_blank" rel="noopener noreferrer">å¯’æ±Ÿè“‘ç¬ ç¿</a></span><span property="author" content="å¯’æ±Ÿè“‘ç¬ ç¿"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">2024å¹´6æœˆ6æ—¥</span><meta property="datePublished" content="2024-06-06T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 54 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT54M"></span><!----><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc" vp-toc><!----><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#æ¦‚å¿µ">æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#è§¦å‘">è§¦å‘</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#æ ‡è®°">æ ‡è®°</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ ‡è®°-æ¸…é™¤">æ ‡è®°-æ¸…é™¤</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¸‰è‰²æ ‡è®°">ä¸‰è‰²æ ‡è®°</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¸å˜æ€§">ä¸å˜æ€§</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ ‡è®°å·¥ä½œ">æ ‡è®°å·¥ä½œ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åå°æ ‡è®°">åå°æ ‡è®°</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ ‡è®°è¾…åŠ©">æ ‡è®°è¾…åŠ©</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ ‡è®°ç»ˆæ­¢">æ ‡è®°ç»ˆæ­¢</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å±éšœ">å±éšœ</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ’å…¥å†™å±éšœ">æ’å…¥å†™å±éšœ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åˆ é™¤å†™å±éšœ">åˆ é™¤å†™å±éšœ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ··åˆå†™å±éšœ">æ··åˆå†™å±éšœ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç€è‰²ç¼“å­˜">ç€è‰²ç¼“å­˜</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å›æ”¶">å›æ”¶</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¯¹è±¡å›æ”¶">å¯¹è±¡å›æ”¶</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å•å…ƒå›æ”¶">å•å…ƒå›æ”¶</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content" vp-content><h1 id="gc" tabindex="-1"><a class="header-anchor" href="#gc"><span>gc</span></a></h1><p>åƒåœ¾å›æ”¶è¦å¹²çš„äº‹å°±æ˜¯å°†ä¸å†ä½¿ç”¨çš„å¯¹è±¡å†…å­˜é‡Šæ”¾ï¼Œè…¾å‡ºç©ºé—´ç»™å…¶å®ƒå¯¹è±¡ä½¿ç”¨ã€‚å°±è¿™ä¹ˆç®€å•çš„ä¸€å¥æè¿°ä½†å®ƒå®ç°èµ·æ¥å´éå¸¸ä¸ç®€å•ï¼Œåƒåœ¾å›æ”¶çš„å‘å±•å†å²å·²ç»æœ‰äº†å‡ åå¹´ï¼Œæœ€æ—©åœ¨ä¸Šä¸–çºª 60 å¹´ä»£çš„ Lisp è¯­è¨€å°±é¦–æ¬¡é‡‡ç”¨äº†åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œæˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„ Pythonï¼ŒObjective-Cï¼Œå…¶ä¸»è¦çš„ GC æœºåˆ¶å°±æ˜¯å¼•ç”¨è®¡æ•°ï¼ŒJavaï¼ŒC#é‡‡ç”¨çš„æ˜¯åˆ†ä»£å›æ”¶ã€‚åœ¨ä»Šå¤©æ¥çœ‹åƒåœ¾å›æ”¶ï¼Œä»å›æ”¶ç®—æ³•æ¥çœ‹ï¼Œå¯ä»¥å¤§è‡´åˆ†ä¸ºä¸‹é¢å‡ ä¸ªå¤§ç±»ï¼š</p><ul><li>å¼•ç”¨è®¡æ•°ï¼šè®©æ¯ä¸€ä¸ªå¯¹è±¡è®°å½•è‡ªèº«è¢«å¼•ç”¨äº†å¤šå°‘æ¬¡ï¼Œå½“è®¡æ•°ä¸º 0 æ—¶ï¼Œå°±å°†å…¶å›æ”¶</li><li>æ ‡è®°æ¸…é™¤ï¼šå°†æ´»åŠ¨çš„å¯¹è±¡åšæ ‡è®°ï¼Œå°†æœªæ ‡è®°çš„å¯¹è±¡è¿›è¡Œå›æ”¶</li><li>å¤åˆ¶ç®—æ³•ï¼šå°†æ´»åŠ¨å¯¹è±¡å¤åˆ¶åˆ°æ–°çš„å†…å­˜ä¸­ï¼Œå°†æ—§å†…å­˜ä¸­çš„æ‰€æœ‰å¯¹è±¡å…¨éƒ¨å›æ”¶ï¼Œè¾¾åˆ°å›æ”¶åƒåœ¾ç›®çš„</li><li>æ ‡è®°å‹ç¼©ï¼šæ ‡è®°æ¸…é™¤çš„å‡çº§ç‰ˆï¼Œå›æ”¶æ—¶å°†æ´»åŠ¨å¯¹è±¡ç§»åŠ¨åˆ°å †çš„å¤´éƒ¨ï¼Œæ–¹ä¾¿ç®¡ç†</li></ul><p>ä»åº”ç”¨æ–¹å¼æ¥çœ‹ï¼Œå¯ä»¥åˆ†ä¸ºä¸‹é¢å‡ ä¸ªå¤§ç±»ï¼š</p><ul><li>å…¨å±€å›æ”¶ï¼šä¸€æ¬¡ç›´æ¥å›æ”¶æ‰€æœ‰çš„åƒåœ¾</li><li>åˆ†ä»£å›æ”¶ï¼šæ ¹æ®å¯¹è±¡çš„å­˜æ´»æ—¶é—´åˆ†æˆä¸åŒçš„ä»£ï¼Œç„¶åé‡‡ç”¨ä¸åŒçš„å›æ”¶ç®—æ³•</li><li>å¢é‡å›æ”¶ï¼šæ¯ä¸€æ¬¡åªè¿›è¡Œå±€éƒ¨çš„åƒåœ¾å›æ”¶</li></ul><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>å‰å¾€<a href="https://go.dev/blog/ismmkeynote" target="_blank" rel="noopener noreferrer">The Journey of Go&#39;s Garbage Collector</a>é˜…è¯»è‹±æ–‡åŸæ–‡ï¼Œäº†è§£æ›´å¤šæœ‰å…³ Go åƒåœ¾å›æ”¶çš„å†å²</p></div><p>åœ¨åˆšå‘å¸ƒæ—¶ï¼ŒGo çš„åƒåœ¾å›æ”¶æœºåˆ¶ååˆ†ç®€é™‹ï¼Œåªæœ‰ç®€å•çš„æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œåƒåœ¾å›æ”¶æ‰€é€ æˆçš„ STWï¼ˆStop The Worldï¼ŒæŒ‡å› åƒåœ¾å›æ”¶æš‚åœæ•´ä¸ªç¨‹åºï¼‰é«˜è¾¾å‡ ç§’ç”šè‡³æ›´ä¹…ã€‚æ„è¯†åˆ°è¿™ä¸€é—®é¢˜çš„ Go å›¢é˜Ÿå˜å¼€å§‹ç€æ‰‹æ”¹è¿›åƒåœ¾å›æ”¶ç®—æ³•ï¼Œåœ¨ go1.0 åˆ° go1.8 ç‰ˆæœ¬ä¹‹é—´ï¼Œä»–ä»¬å…ˆåå°è¯•è¿‡å¾ˆå¤šè®¾æƒ³</p><ol><li>è¯»å±éšœå¹¶å‘å¤åˆ¶ GCï¼šè¯»å±éšœçš„å¼€é”€æœ‰å¾ˆå¤šä¸ç¡®å®šæ€§ï¼Œè¿™ç§æ–¹æ¡ˆè¢«å–æ¶ˆäº†</li><li>é¢å‘è¯·æ±‚çš„æ”¶é›†å™¨ï¼ˆROCï¼‰ï¼šéœ€è¦æ—¶åˆ»å¼€å¯å†™å±éšœï¼Œæ‹–ç´¯è¿è¡Œé€Ÿåº¦ï¼Œæ‹‰ä½äº†ç¼–è¯‘æ—¶é—´</li><li>åˆ†ä»£å›æ”¶ï¼šåˆ†ä»£å›æ”¶åœ¨ go ä¸­çš„æ•ˆç‡å¹¶ä¸é«˜ï¼Œå› ä¸º go çš„ç¼–è¯‘å™¨ä¼šå€¾å‘äºå°†æ–°å¯¹è±¡åˆ†é…åˆ°æ ˆä¸Šï¼Œé•¿æœŸå­˜åœ¨çš„å¯¹è±¡åˆ†é…åˆ°å †ä¸Šï¼Œæ‰€ä»¥æ–°ç”Ÿä»£å¯¹è±¡å¤§å¤šæ•°ä¼šè¢«æ ˆç›´æ¥å›æ”¶ã€‚</li><li>æ— å†™å±éšœçš„å¡ç‰‡æ ‡è®°ï¼šé€šè¿‡å“ˆå¸Œæ•£åˆ—æˆæœ¬æ¥æ›¿ä»£å†™å±éšœçš„æˆæœ¬ï¼Œéœ€è¦ç¡¬ä»¶é…åˆ</li></ol><p>æœ€å Go å›¢é˜Ÿè¿˜æ˜¯é€‰æ‹©äº†ä¸‰è‰²å¹¶å‘æ ‡è®°+å†™å±éšœçš„ç»„åˆï¼Œå¹¶ä¸”åœ¨åç»­çš„ç‰ˆæœ¬ä¸­ä¸æ–­çš„æ”¹è¿›å’Œä¼˜åŒ–ï¼Œè¿™ç§åšæ³•ä¹Ÿä¸€ç›´æ²¿ç”¨åˆ°ç°åœ¨ï¼Œä¸‹é¢ä¸€ç»„å›¾å±•ç¤ºäº†ä» go1.4 è‡³ go1.9 çš„ GC å»¶æ—¶å˜åŒ–ã€‚</p><figure><img src="/images/essential/impl_gc_1.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="/images/essential/impl_gc_2.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="/images/essential/impl_gc_3.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="/images/essential/impl_gc_4.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>åœ¨å†™ä¸‹æœ¬æ–‡æ—¶ï¼Œgo çš„æœ€æ–°ç‰ˆæœ¬å·²ç»å¿«è¦æ¥åˆ°äº† go1.23ï¼Œå¯¹äºå¦‚ä»Šçš„ go æ¥è®²ï¼ŒGC æ€§èƒ½æ—©å·²ä¸ç®—é—®é¢˜äº†ï¼Œç°åœ¨çš„ GC å»¶æ—¶å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½ä½äº 100 å¾®ç§’ï¼Œæ»¡è¶³ç»å¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯çš„éœ€è¦ã€‚</p><p>æ€»çš„æ¥è¯´ï¼ŒGo ä¸­çš„åƒåœ¾å›æ”¶å¯ä»¥åˆ†ä¸ºä¸‹é¢å‡ ä¸ªé˜¶æ®µ</p><ul><li>æ‰«æé˜¶æ®µï¼šä»æ ˆå’Œå…¨å±€å˜é‡ä¸­æ”¶é›†æ ¹å¯¹è±¡</li><li>æ ‡è®°é˜¶æ®µï¼šå°†å¯¹è±¡ç€è‰²</li><li>æ ‡è®°ç»ˆæ­¢é˜¶æ®µï¼šå¤„ç†å–„åå·¥ä½œï¼Œå…³é—­å±éšœ</li><li>å›æ”¶é˜¶æ®µï¼šé‡Šæ”¾å’Œå›æ”¶åƒåœ¾å¯¹è±¡çš„å†…å­˜</li></ul><h2 id="æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#æ¦‚å¿µ"><span>æ¦‚å¿µ</span></a></h2><p>åœ¨å®˜æ–¹æ–‡æ¡£å’Œæ–‡ç« ä¸­å¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹çš„ä¸€äº›æ¦‚å¿µï¼Œä¸‹é¢ç®€å•çš„è§£é‡Šè¯´æ˜ä¸€ä¸‹</p><ul><li>èµ‹å€¼å™¨ï¼ˆmutatorï¼‰ï¼šä¸€ç§æœ¯è¯­åŒ–çš„è¡¨è¾¾æ–¹å¼ï¼ŒæŒ‡çš„æ˜¯ç”¨æˆ·ç¨‹åºï¼Œåœ¨ go ä¸­æŒ‡çš„æ˜¯ç”¨æˆ·ä»£ç </li><li>æ”¶é›†å™¨ï¼ˆcollectorï¼‰ï¼šæŒ‡çš„å°±æ˜¯è´Ÿè´£åƒåœ¾å›æ”¶çš„ç¨‹åºï¼Œåœ¨ go ä¸­è´Ÿè´£åƒåœ¾å›æ”¶çš„å°±æ˜¯è¿è¡Œæ—¶</li><li>ç»ˆç»“å™¨ï¼ˆfinalizerï¼‰ï¼šæŒ‡çš„æ˜¯åœ¨æ ‡è®°æ‰«æå·¥ä½œå®Œæˆåï¼Œè´Ÿè´£å›æ”¶é‡Šæ”¾æ¸…ç†å¯¹è±¡å†…å­˜çš„ä»£ç </li><li>æ§åˆ¶å™¨ï¼šæŒ‡çš„æ˜¯<code>runtime.gcController</code>å…¨å±€å˜é‡ï¼Œå®ƒçš„ç±»å‹ä¸º<code>gcControllerState</code>ï¼Œåè€…å®ç°äº†è°ƒæ­¥ç®—æ³•ï¼Œè´Ÿè´£ç¡®è®¤ä½•æ—¶è¿›è¡Œåƒåœ¾å›æ”¶å’Œæ‰§è¡Œå¤šå°‘å·¥ä½œé‡ã€‚</li><li>é™åˆ¶å™¨ï¼šæŒ‡çš„æ˜¯<code>runtime.gcCPULimiter</code>ï¼Œå®ƒè´Ÿè´£åœ¨åƒåœ¾å›æ”¶æ—¶é˜²æ­¢ CPU å ç”¨ç‡è¿‡é«˜è€Œå½±å“åˆ°ç”¨æˆ·ç¨‹åº</li></ul><h2 id="è§¦å‘" tabindex="-1"><a class="header-anchor" href="#è§¦å‘"><span>è§¦å‘</span></a></h2><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> gcStart</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">trigger</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> gcTrigger</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>åƒåœ¾å›æ”¶ç”±<code>runtime.gcStart</code>å‡½æ•°æ¥å¼€å¯ï¼Œå®ƒåªæ¥æ”¶å‚æ•°<code>runtime.gcTrigger</code>ç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«äº† GC è§¦å‘çš„åŸå› ï¼Œå½“å‰æ—¶é—´ï¼Œä»¥åŠè¿™æ˜¯ç¬¬å‡ è½® GCã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">type</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> gcTrigger</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    kind</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> gcTriggerKind</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    now</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  int64</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // gcTriggerTime: current time</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    n</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    uint32</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // gcTriggerCycle: cycle number to start</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­<code>gcTriggerKind</code>æœ‰ä»¥ä¸‹å‡ ç§å¯é€‰å€¼</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // gcTriggerHeap indicates that a cycle should be started when</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // the heap size reaches the trigger heap size computed by the</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // controller.</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  gcTriggerHeap</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> gcTriggerKind</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> iota</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // gcTriggerTime indicates that a cycle should be started when</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // it&#39;s been more than forcegcperiod nanoseconds since the</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // previous GC cycle.</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  gcTriggerTime</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // gcTriggerCycle indicates that a cycle should be started if</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // we have not yet started cycle number gcTrigger.n (relative</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // to work.cycles).</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  gcTriggerCycle</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ€»çš„æ¥è¯´åƒåœ¾å›æ”¶çš„è§¦å‘æ—¶æœºæœ‰ä¸‰ç§</p><ul><li><p>åˆ›å»ºæ–°å¯¹è±¡æ—¶ï¼šåœ¨è°ƒç”¨<code>runtime.mallocgc</code>åˆ†é…å†…å­˜æ—¶ï¼Œå¦‚æœç›‘æµ‹åˆ°å †å†…å­˜è¾¾åˆ°äº†é˜ˆå€¼ï¼ˆä¸€èˆ¬æ¥è¯´æ˜¯ä¸Šä¸€æ¬¡ GC æ—¶çš„ä¸¤å€ï¼Œè¯¥å€¼ä¹Ÿä¼šè¢«è°ƒæ­¥ç®—æ³•è¿›è¡Œè°ƒæ•´ï¼‰ï¼Œä¾¿ä¼šå¼€å¯åƒåœ¾å›æ”¶</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> mallocgc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">size</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uintptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">typ</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">_type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">needzero</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Pointer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> shouldhelpgc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gcTrigger</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcTriggerHeap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}); </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">test</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">      gcStart</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>å®šæ—¶å¼ºåˆ¶è§¦å‘ï¼šgo åœ¨è¿è¡Œæ—¶ä¼šå¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„åç¨‹æ¥è¿è¡Œ<code>runtime.forcegchelper</code>å‡½æ•°ï¼Œå¦‚æœé•¿æ—¶é—´æ²¡æœ‰è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå®ƒä¾¿ä¼šå¼ºåˆ¶å¼€å¯ GCï¼Œè¿™ä¸ªæ—¶é—´ç”±<code>runtime.forcegcperiod</code>å¸¸é‡å†³å®šï¼Œå…¶å€¼ä¸º 2 åˆ†é’Ÿï¼ŒåŒæ—¶åœ¨ç³»ç»Ÿç›‘æ§åç¨‹ä¸­ä¹Ÿä¼šå®šæ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶ GC</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> forcegchelper</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        ...</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    gcStart</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gcTrigger</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcTriggerTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nanotime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()})</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> sysmon</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        ...</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // check if we need to force a GC</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gcTrigger</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcTriggerTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}); </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">test</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> forcegc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">idle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">      lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">forcegc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      forcegc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">idle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Store</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      var</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> list</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> gList</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      list</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">forcegc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">g</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">      injectglist</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">list</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">      unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">forcegc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æ‰‹åŠ¨è§¦å‘ï¼šé€šè¿‡<code>runtime.GC</code>å‡½æ•°ï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è§¦å‘åƒåœ¾å›æ”¶ã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> GC</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  n</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cycles</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  gcStart</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gcTrigger</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcTriggerCycle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">n</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">n</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">})</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>æ„Ÿå…´è¶£å¯ä»¥å‰å¾€<a href="https://github.com/golang/proposal/blob/master/design/44167-gc-pacer-redesign.md" target="_blank" rel="noopener noreferrer">Go Gc Pacer Re-Design</a>é˜…è¯»è‹±æ–‡åŸæ–‡ï¼Œé‡Œé¢è®²è§£äº†æœ‰å…³äºè§¦å‘ GC çš„è°ƒæ­¥ç®—æ³•(pacing algorithm)çš„è®¾è®¡ç†å¿µå’Œæ”¹è¿›ï¼Œå› å…¶å†…å®¹æ¯”è¾ƒå¤æ‚æ¶‰åŠè¿‡å¤šçš„æ•°å­¦å…¬å¼ï¼Œæ­£æ–‡ä¸­ä¸åšè¿‡å¤šé˜è¿°ã€‚</p></div><h2 id="æ ‡è®°" tabindex="-1"><a class="header-anchor" href="#æ ‡è®°"><span>æ ‡è®°</span></a></h2><p>ç°å¦‚ä»Š Go çš„ GC ç®—æ³•ä¾ç„¶æ˜¯å…ˆæ ‡è®°åæ¸…é™¤è¿™æ ·ä¸€ä¸ªæ­¥éª¤ï¼Œä½†å…¶å®ç°ä¸å†åƒä»¥å‰ä¸€æ ·ç®€å•ã€‚</p><h3 id="æ ‡è®°-æ¸…é™¤" tabindex="-1"><a class="header-anchor" href="#æ ‡è®°-æ¸…é™¤"><span>æ ‡è®°-æ¸…é™¤</span></a></h3><p>å…ˆä»æœ€ç®€å•çš„æ ‡è®°æ¸…é™¤ç®—æ³•å¼€å§‹è®²èµ·ï¼Œåœ¨å†…å­˜ä¸­ï¼Œå¯¹è±¡ä¸å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨å…³ç³»ä¼šæ„æˆä¸€ä¸ªå›¾ï¼Œåƒåœ¾å›æ”¶çš„å·¥ä½œå°±åœ¨è¿™ä¸ªå›¾ä¸Šè¿›è¡Œï¼Œå·¥ä½œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p><ul><li>æ ‡è®°é˜¶æ®µï¼šä»æ ¹èŠ‚ç‚¹ï¼ˆæ ¹èŠ‚ç‚¹é€šå¸¸æ˜¯æ ˆä¸Šçš„å˜é‡ï¼Œå…¨å±€å˜é‡ç­‰æ´»è·ƒå¯¹è±¡ï¼‰å¼€å§‹ï¼Œé€ä¸ªéå†æ¯ä¸€ä¸ªå¯ä»¥åˆ°è¾¾çš„èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶æ ‡è®°ä¸ºæ´»è·ƒå¯¹è±¡ï¼Œç›´åˆ°éå†å®Œæ‰€æœ‰å¯ä»¥åˆ°è¾¾çš„èŠ‚ç‚¹ï¼Œ</li><li>æ¸…é™¤é˜¶æ®µï¼šéå†å †ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼Œå°†æœªæ ‡è®°çš„å¯¹è±¡å›æ”¶ï¼Œå°†å…¶å†…å­˜ç©ºé—´é‡Šæ”¾æˆ–æ˜¯å¤ç”¨ã€‚</li></ul><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406051711875.png" style="zoom:67%;"><p>åœ¨å›æ”¶çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹è±¡å›¾çš„ç»“æ„ä¸èƒ½è¢«æ”¹å˜ï¼Œæ‰€ä»¥è¦å°†æ•´ä¸ªç¨‹åºåœæ­¢ï¼Œä¹Ÿå°±æ˜¯ STWï¼Œå›æ”¶å®Œæ¯•ä»¥åæ‰èƒ½ç»§ç»­è¿è¡Œï¼Œè¿™ç§ç®—æ³•çš„ç¼ºç‚¹å°±åœ¨äºè€—æ—¶è¾ƒé•¿ï¼Œæ¯”è¾ƒå½±å“ç¨‹åºçš„è¿è¡Œæ•ˆç‡ï¼Œè¿™æ˜¯æ—©æœŸç‰ˆæœ¬ Go ä½¿ç”¨çš„æ ‡è®°ç®—æ³•ï¼Œå®ƒçš„ç¼ºç‚¹æ¯”è¾ƒæ˜æ˜¾</p><ul><li>ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼ˆç”±äº Go TCMalloc å¼çš„å†…å­˜ç®¡ç†æ–¹å¼ï¼Œç¢ç‰‡é—®é¢˜çš„å½±å“å¹¶ä¸å¤§ï¼‰</li><li>åœ¨æ ‡è®°é˜¶æ®µä¼šæ‰«æå †çš„æ‰€æœ‰å¯¹è±¡</li><li>ä¼šå¯¼è‡´ STWï¼Œæš‚åœæ•´ä¸ªç¨‹åºï¼Œä¸”æ—¶é—´ä¸çŸ­</li></ul><h3 id="ä¸‰è‰²æ ‡è®°" tabindex="-1"><a class="header-anchor" href="#ä¸‰è‰²æ ‡è®°"><span>ä¸‰è‰²æ ‡è®°</span></a></h3><p>ä¸ºäº†æ”¹è¿›æ•ˆç‡ï¼ŒGo é‡‡ç”¨äº†ç»å…¸çš„ä¸‰è‰²æ ‡è®°ç®—æ³•ï¼Œæ‰€è°“ä¸‰è‰²ï¼ŒæŒ‡çš„æ˜¯é»‘ç°ç™½ä¸‰è‰²ï¼š</p><ul><li>é»‘è‰²ï¼šåœ¨æ ‡è®°è¿‡ç¨‹ä¸­å¯¹è±¡å·²è®¿é—®è¿‡ï¼Œå¹¶ä¸”å®ƒæ‰€ç›´æ¥å¼•ç”¨çš„å¯¹è±¡ä¹Ÿéƒ½å·²ç»è®¿é—®è¿‡ï¼Œè¡¨ç¤ºæ´»è·ƒçš„å¯¹è±¡</li><li>ç°è‰²ï¼šåœ¨æ ‡è®°è¿‡ç¨‹ä¸­å¯¹è±¡å·²è®¿é—®è¿‡ï¼Œä½†å®ƒæ‰€ç›´æ¥å¼•ç”¨çš„å¯¹è±¡å¹¶æœªå…¨éƒ¨è®¿é—®ï¼Œå½“å…¨éƒ¨è®¿é—®å®Œåä¼šè½¬å˜ä¸ºé»‘è‰²ï¼Œè¡¨ç¤ºæ´»è·ƒçš„å¯¹è±¡</li><li>ç™½è‰²ï¼šåœ¨æ ‡è®°è¿‡ç¨‹ä¸­ä»æœªè¢«è®¿é—®è¿‡ï¼Œåœ¨è®¿é—®è¿‡åä¼šå˜ä¸ºç°è‰²ï¼Œè¡¨ç¤ºå¯èƒ½ä¸ºåƒåœ¾å¯¹è±¡ï¼Œ</li></ul><p>åœ¨ä¸‰è‰²æ ‡è®°å·¥ä½œå¼€å§‹æ—¶ï¼Œåœºä¸Šåªæœ‰ç°è‰²å’Œç™½è‰²å¯¹è±¡ï¼Œæ‰€æœ‰æ ¹å¯¹è±¡éƒ½æ˜¯ç°è‰²ï¼Œå…¶å®ƒå¯¹è±¡éƒ½æ˜¯ç™½è‰²ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><figure><img src="/images/essential/impl_gc_5.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æ¯ä¸€è½®æ ‡è®°å¼€å§‹æ—¶ï¼Œå…ˆä»ç°è‰²å¯¹è±¡å¼€å§‹ï¼Œå°†ç°è‰²å¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²ï¼Œè¡¨ç¤ºå…¶ä¸ºæ´»è·ƒå¯¹è±¡ï¼Œç„¶åå†å°†é»‘è‰²å¯¹è±¡æ‰€æœ‰ç›´æ¥å¼•ç”¨çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼Œå‰©ä¸‹çš„å°±æ˜¯ç™½è‰²ï¼Œæ­¤æ—¶åœºä¸Šå°±æœ‰äº†é»‘ç™½ç°ä¸‰ç§é¢œè‰²ã€‚</p><figure><img src="/images/essential/impl_gc_6.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ä¸æ–­é‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œç›´åˆ°åœºä¸Šåªå‰©ä¸‹é»‘è‰²å’Œç™½è‰²å¯¹è±¡ï¼Œå½“ç°è‰²å¯¹è±¡é›†åˆä¸ºç©ºæ—¶ï¼Œå°±ä»£è¡¨ç€æ ‡è®°ç»“æŸï¼Œå¦‚ä¸‹å›¾</p><figure><img src="/images/essential/impl_gc_7.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>åœ¨æ ‡è®°ç»“æŸåï¼Œåœ¨æ¸…é™¤é˜¶æ®µåªéœ€å°†ç™½è‰²é›†åˆä¸­å¯¹è±¡çš„å†…å­˜é‡Šæ”¾å³å¯ã€‚</p><h3 id="ä¸å˜æ€§" tabindex="-1"><a class="header-anchor" href="#ä¸å˜æ€§"><span>ä¸å˜æ€§</span></a></h3><p>ä¸‰è‰²æ ‡è®°æ³•æœ¬èº«æ²¡æ³•è¿›è¡Œå¹¶å‘æ ‡è®°ï¼ˆæŒ‡ç¨‹åºä¸€è¾¹è¿è¡Œä¸€è¾¹æ ‡è®°ï¼‰ï¼Œå¦‚æœåœ¨æ ‡è®°æ—¶å¯¹è±¡å›¾ç»“æ„å‘ç”Ÿäº†æ”¹å˜ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ä¸¤ç§æƒ…å†µ</p><ul><li>å¤šæ ‡ï¼šåœ¨å¯¹è±¡è¢«æ ‡è®°ä¸ºé»‘è‰²å¯¹è±¡åï¼Œç”¨æˆ·ç¨‹åºåˆ é™¤äº†å¯¹äºè¯¥å¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥æ˜¯ç™½è‰²å¯¹è±¡éœ€è¦è¢«æ¸…é™¤</li><li>æ¼æ ‡ï¼šåœ¨å¯¹è±¡è¢«æ ‡è®°ä¸ºç™½è‰²å¯¹è±¡åï¼Œç”¨æˆ·ç¨‹åºä¸­æœ‰å…¶å®ƒå¯¹è±¡å¼•ç”¨äº†è¯¥å¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥æ˜¯é»‘è‰²å¯¹è±¡ä¸åº”è¯¥è¢«æ¸…é™¤</li></ul><p>å¯¹äºç¬¬ä¸€ç§æƒ…å†µå…¶å®å¯ä»¥æ¥å—ï¼Œå› ä¸ºæœªè¢«æ¸…ç†çš„å¯¹è±¡å¯ä»¥åœ¨ä¸‹ä¸€è½®å›æ”¶ä¸­è¢«å¤„ç†æ‰ã€‚ä½†ç¬¬äºŒç§æƒ…å†µå°±æ²¡æ³•æ¥å—äº†ï¼Œæ­£åœ¨ä½¿ç”¨ä¸­çš„å¯¹è±¡å†…å­˜è¢«é”™è¯¯çš„é‡Šæ”¾ï¼Œä¼šé€ æˆä¸¥é‡çš„ç¨‹åºé”™è¯¯ï¼Œè¿™æ˜¯å¿…é¡»è¦é¿å…çš„é—®é¢˜ã€‚</p><p>ä¸‰è‰²ä¸å˜æ€§è¿™ä¸€æ¦‚å¿µæ¥è‡ªäº Pekka P. Pirinen äº 1998 å¹´å‘è¡¨çš„è®ºæ–‡<a href="https://dl.acm.org/doi/epdf/10.1145/301589.286863" target="_blank" rel="noopener noreferrer">ã€ŠBarrier techniques for incremental tracingã€‹</a>ï¼Œå®ƒæŒ‡åœ¨å¹¶å‘æ ‡è®°æ—¶çš„å¯¹è±¡é¢œè‰²çš„ä¸¤ä¸ªä¸å˜æ€§ï¼š</p><ul><li><p>å¼ºä¸‰è‰²ä¸å˜æ€§ï¼šé»‘è‰²å¯¹è±¡ä¸å¯ä»¥ç›´æ¥å¼•ç”¨ç™½è‰²å¯¹è±¡</p></li><li><p>å¼±ä¸‰è‰²ä¸å˜æ€§ï¼šå½“é»‘è‰²å¯¹è±¡ç›´æ¥å¼•ç”¨ç™½è‰²å¯¹è±¡æ—¶ï¼Œå¿…é¡»æœ‰å¦ä¸€ä¸ªç°è‰²å¯¹è±¡å¯ä»¥ç›´æ¥æˆ–é—´æ¥è®¿é—®åˆ°è¯¥ç°è‰²å¯¹è±¡ï¼Œç§°ä½œå—åˆ°ç°è‰²å¯¹è±¡çš„ä¿æŠ¤</p></li></ul><p>å¯¹äºå¼ºä¸‰è‰²ä¸å˜æ€§è€Œè¨€ï¼Œå·²çŸ¥é»‘è‰²å¯¹è±¡ 3 æ˜¯å·²ç»è®¿é—®è¿‡çš„å¯¹è±¡ï¼Œä¸”å…¶å­å¯¹è±¡ä¹Ÿå…¨éƒ½è®¿é—®è¿‡å¹¶æ ‡è®°ä¸ºç°è‰²å¯¹è±¡ï¼Œå¦‚æœæ­¤æ—¶ç”¨æˆ·ç¨‹åºå¹¶å‘çš„ç»™é»‘è‰²å¯¹è±¡ 3 æ·»åŠ ç™½è‰²å¯¹è±¡ 7 çš„æ–°å¼•ç”¨ï¼Œæ­£å¸¸æ¥è¯´ç™½è‰²å¯¹è±¡ 7 åº”è¯¥è¢«æ ‡è®°ä¸ºç°è‰²ï¼Œä½†ç”±äºé»‘è‰²å¯¹è±¡ 3 å·²ç»è¢«è®¿é—®è¿‡äº†ï¼Œå¯¹è±¡ 7 ä¸ä¼šè¢«è®¿é—®ï¼Œæ‰€ä»¥å®ƒå§‹ç»ˆéƒ½æ˜¯ç™½è‰²å¯¹è±¡ï¼Œå¹¶æœ€ç»ˆè¢«é”™è¯¯çš„æ¸…ç†æ‰ã€‚</p><figure><img src="/images/essential/impl_gc_8.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å¯¹äºå¼±ä¸‰è‰²ä¸å˜æ€§è€Œè¨€ï¼Œå®ƒå…¶å®è·Ÿå¼ºä¸‰è‰²ä¸å˜æ€§åŒç†ï¼Œå› ä¸ºç°è‰²å¯¹è±¡èƒ½å¤Ÿç›´æ¥æˆ–é—´æ¥çš„è®¿é—®åˆ°è¯¥ç™½è‰²å¯¹è±¡ï¼Œåç»­æ ‡è®°è¿‡ç¨‹ä¸­å®ƒæœ€ç»ˆä¼šè¢«æ ‡è®°ä¸ºç°è‰²å¯¹è±¡ï¼Œä»è€Œé¿å…è¢«è¯¯æ¸…ç†ã€‚</p><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406052237769.png" style="zoom:50%;"><p>é€šè¿‡ä¸å˜æ€§ï¼Œå¯ä»¥ç¡®ä¿åœ¨æ ‡è®°è¿‡ç¨‹ä¸­ä¸ä¼šæœ‰å¯¹è±¡è¢«è¯¯æ¸…ç†ï¼Œä¹Ÿå°±èƒ½ä¿è¯å¹¶å‘æ¡ä»¶ä¸‹çš„æ ‡è®°å·¥ä½œçš„æ­£ç¡®æ€§ï¼Œä»è€Œå¯ä»¥ä½¿å¾—ä¸‰è‰²æ ‡è®°å¹¶å‘çš„å·¥ä½œï¼Œè¿™æ ·ä¸€æ¥å…¶æ ‡è®°æ•ˆç‡ç›¸æ¯”äºæ ‡è®°-æ¸…é™¤ç®—æ³•ä¼šæå‡ç›¸å½“å¤šã€‚è¦åœ¨å¹¶å‘æƒ…å†µä¸‹ä¿è¯ä¸‰è‰²ä¸å˜æ€§ï¼Œå…³é”®å°±åœ¨äºå±éšœæŠ€æœ¯ã€‚</p><h3 id="æ ‡è®°å·¥ä½œ" tabindex="-1"><a class="header-anchor" href="#æ ‡è®°å·¥ä½œ"><span>æ ‡è®°å·¥ä½œ</span></a></h3><p>åœ¨ GC æ‰«æé˜¶æ®µæ—¶ï¼Œæœ‰ä¸€ä¸ªå…¨å±€å˜é‡<code>runtime.gcphase</code>ç”¨äºè¡¨ç¤º GC çš„çŠ¶æ€ï¼Œæœ‰å¦‚ä¸‹å¯é€‰å€¼ï¼š</p><ul><li><code>_GCoff</code>ï¼šæ ‡è®°å·¥ä½œæœªå¼€å§‹</li><li><code>_GCmark</code>ï¼šæ ‡è®°å·¥ä½œå·²å¼€å§‹</li><li><code>_GCmarktermination</code>ï¼šæ ‡è®°å·¥ä½œå°†è¦ç»ˆæ­¢</li></ul><p>å½“æ ‡è®°å·¥ä½œå¼€å§‹æ—¶ï¼Œ<code>runtime.gcphase</code>çš„çŠ¶æ€ä¸º<code>_GCmark</code>ï¼Œæ‰§è¡Œæ ‡è®°å·¥ä½œçš„æ˜¯<code>runtime.gcDrain</code>å‡½æ•°ï¼Œå…¶ä¸­<code>runtime.gcWork</code>å‚æ•°æ˜¯ä¸€ä¸ªç¼“å†²æ± ï¼Œå®ƒå­˜æ”¾ç€è¦è¿½è¸ªçš„å¯¹è±¡æŒ‡é’ˆã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> gcDrain</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gcWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">flags</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> gcDrainFlags</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>åœ¨å·¥ä½œæ—¶ï¼Œå®ƒä¼šå°è¯•ä»ç¼“å†²æ± å»è·å–å¯è¿½è¸ªçš„æŒ‡é’ˆï¼Œå¦‚æœæœ‰çš„è¯åˆ™ä¼šè°ƒç”¨<code>runtime.scanobject</code>å‡½æ•°ç»§ç»­æ‰§è¡Œæ‰«æä»»åŠ¡ï¼Œå®ƒçš„ä½œç”¨æ˜¯ä¸æ–­çš„æ‰«æç¼“å†²åŒºä¸­çš„å¯¹è±¡ï¼Œå°†å®ƒä»¬æŸ“é»‘ã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">full</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">balance</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">b</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryGetFast</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    b</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryGet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // Flush the write barrier</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // buffer; this may create</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // more work.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        wbBufFlush</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        b</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryGet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // Unable to get work.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    break</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">scanobject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ P è¢«æŠ¢å æˆ–å°†å‘ç”Ÿ STW æ—¶ï¼Œæ‰«æå·¥ä½œæ‰ä¼šåœæ­¢</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">preempt</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">preemptible</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> sched</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcwaiting</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">||</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> pp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">runSafePointFn</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  scanobject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>runtime.gcwork</code>æ˜¯ä¸€ä¸ªé‡‡ç”¨äº†ç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å‹çš„é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—è´Ÿè´£å­˜æ”¾å¾…æ‰«æçš„ç°è‰²å¯¹è±¡ï¼Œæ¯ä¸€ä¸ªå¤„ç†å™¨ P æœ¬åœ°éƒ½æœ‰è¿™æ ·ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¯¹åº”``runtime.p.gcw`å­—æ®µã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> scanobject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">b</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uintptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gcWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    var</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> addr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uintptr</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> hbits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">addr</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> hbits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nextFast</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(); </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">addr</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> hbits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">addr</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> hbits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(); </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">addr</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                break</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    scanSize</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> addr</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> goarch</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PtrSize</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    obj</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">uintptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Pointer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">addr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> obj</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> obj</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">b</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> n</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">span</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">objIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> findObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">addr</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">); </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">obj</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        greyobject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">addr</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">span</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">objIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">bytesMarked</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> +=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uint64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">n</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">heapScanWork</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> +=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">scanSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>runitme.scanobject</code>å‡½æ•°åœ¨æ‰«ææ—¶ä¼šä¸æ–­çš„å°†å¯è¾¾çš„ç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼Œç„¶åé€šè¿‡è°ƒç”¨<code>gcw.put</code>æ”¾å…¥æœ¬åœ°çš„é˜Ÿåˆ—ä¸­ï¼ŒåŒæ—¶<code>gcDrain</code>å‡½æ•°ä¹Ÿä¼šä¸æ–­çš„é€šè¿‡<code>gcw.tryget</code>æ¥å°è¯•è·å–ç°è‰²å¯¹è±¡ä»¥ç»§ç»­æ‰«æã€‚æ ‡è®°æ‰«æçš„è¿‡ç¨‹æ˜¯å¢é‡å¼çš„ï¼Œä¸éœ€è¦ä¸€å£æ°”å®Œæˆæ‰€æœ‰çš„æ ‡è®°å·¥ä½œï¼Œæ ‡è®°ä»»åŠ¡å› ä¸€äº›åŸå› è¢«æŠ¢å æ—¶å°±ä¼šä¸­æ–­ï¼Œç­‰åˆ°æ¢å¤åå¯ä»¥æ ¹æ®é˜Ÿåˆ—ä¸­å‰©ä½™çš„ç°è‰²å¯¹è±¡ç»§ç»­å®Œæˆæ ‡è®°å·¥ä½œã€‚</p><h3 id="åå°æ ‡è®°" tabindex="-1"><a class="header-anchor" href="#åå°æ ‡è®°"><span>åå°æ ‡è®°</span></a></h3><p>æ ‡è®°å·¥ä½œå¹¶ä¸ä¼šåœ¨ GC å¼€å§‹æ—¶ç«‹å³æ‰§è¡Œï¼Œåœ¨åˆšè§¦å‘ GC æ—¶ï¼Œgo ä¼šåˆ›å»ºä¸å½“å‰å¤„ç†å™¨ P æ€»æ•°é‡ç›¸åŒçš„æ ‡è®°ä»»åŠ¡ï¼Œå®ƒä»¬ä¼šè¢«æ·»åŠ åˆ°å…¨å±€ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç„¶åè¿›å…¥ä¼‘çœ ç›´åˆ°åœ¨æ ‡è®°é˜¶æ®µè¢«å”¤é†’ã€‚åœ¨è¿è¡Œæ—¶ï¼Œç”±<code>runtime.gcBgMarkStartWorkers</code>æ¥è¿›è¡Œä»»åŠ¡çš„åˆ†é…ï¼Œæ ‡è®°ä»»åŠ¡å®é™…ä¸ŠæŒ‡çš„å°±æ˜¯<code>runtime.gcBgMarkWorker</code>å‡½æ•°ï¼Œå…¶ä¸­<code>gcBgMarkWorkerCount</code>å’Œ<code>gomaxprocs</code>ä¸¤ä¸ªè¿è¡Œæ—¶å…¨å±€å˜é‡åˆ†åˆ«è¡¨ç¤ºå½“å‰ worker çš„æ•°é‡å’Œå¤„ç†å™¨ P çš„æ•°é‡ã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> gcBgMarkStartWorkers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Background marking is performed by per-P G&#39;s. Ensure that each P has</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // a background GC G.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  //</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Worker Gs don&#39;t exit if gomaxprocs is reduced. If it is raised</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // again, we can reuse the old workers; no need to create new workers.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcBgMarkWorkerCount</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gomaxprocs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    go</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> gcBgMarkWorker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    notetsleepg</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">bgMarkReady</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    noteclear</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">bgMarkReady</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // The worker is now guaranteed to be added to the pool before</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // its P&#39;s next findRunnableGCWorker.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    gcBgMarkWorkerCount</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">++</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ worker å¯åŠ¨åï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ª<code>runtime.gcBgMarkWorkerNode</code>ç»“æ„ä½“ï¼Œå°†å…¶åŠ å…¥å…¨å±€çš„ worker æ± <code>runitme.gcBgMarkWorkerPool</code>ï¼Œç„¶åè°ƒç”¨<code>runtime.gopark</code>å‡½æ•°è®©åç¨‹å…¶é™·å…¥ä¼‘çœ </p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> gcBgMarkWorker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  node</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> new</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gcBgMarkWorkerNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  notewakeup</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">bgMarkReady</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // Go to sleep until woken by</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // gcController.findRunnableGCWorker.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    gopark</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">g</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">g</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">nodep</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Pointer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      node</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gcBgMarkWorkerNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nodep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // Release this G to the pool.</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      gcBgMarkWorkerPool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // Note that at this point, the G may immediately be</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // rescheduled and may be running.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Pointer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">), </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">waitReasonGCWorkerIdle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">traceBlockSystemGoroutine</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ‰ä¸¤ç§æƒ…å†µå¯ä»¥å”¤é†’ worker</p><ul><li>å¤„äºæ ‡è®°é˜¶æ®µæ—¶ï¼Œè°ƒåº¦å¾ªç¯ä¼šé€šè¿‡<code>runtime.runtime.gcController.findRunnableGCWorker</code>å‡½æ•°æ¥å”¤é†’ä¼‘çœ çš„ worker</li><li>å¤„äºæ ‡è®°é˜¶æ®µæ—¶ï¼Œå¦‚æœå¤„ç†å™¨ P å½“å‰ä¸ºç©ºé—²çŠ¶æ€ï¼Œè°ƒåº¦å¾ªç¯ä¼šå°è¯•ç›´æ¥ä»å…¨å±€ worker æ± <code>gcBgMarkWorkerPool</code>ä¸­è·å–å¯ç”¨çš„ worker</li></ul><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> findRunnable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">gp</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">g</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">inheritTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">tryWakeP</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">top</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // Try to schedule a GC worker.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcBlackenEnabled</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">tnow</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">findRunnableGCWorker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">pp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gp</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    now</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> tnow</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // We have nothing to do.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  //</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // If we&#39;re in the GC mark phase, can safely scan and blacken objects,</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // and have work to do, run idle-time marking rather than give up the P.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcBlackenEnabled</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> gcMarkWorkAvailable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">pp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">addIdleMarkWorker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    node</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gcBgMarkWorkerNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcBgMarkWorkerPool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">pop</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">())</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      pp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcMarkWorkerMode</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcMarkWorkerIdleMode</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      gp</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      trace</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> traceAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">      casgstatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">_Gwaiting</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">_Grunnable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> trace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ok</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        trace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GoUnpark</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        traceRelease</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">trace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">false</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">removeIdleMarkWorker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¤„ç†å™¨ P æœ‰ç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ªå­—æ®µ<code>gcMarkWorkerMode</code>æ¥è¡¨ç¤ºæ ‡è®°ä»»åŠ¡çš„æ‰§è¡Œæ¨¡å¼ï¼Œå®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªå¯é€‰å€¼ï¼š</p><ul><li><p><code>gcMarkWorkerNotWorker</code>ï¼šè¡¨ç¤ºå½“å‰å¤„ç†å™¨ P æ²¡æœ‰æ­£åœ¨æ‰§è¡Œæ ‡è®°ä»»åŠ¡</p></li><li><p><code>gcMarkWorkerDedicatedMode</code>ï¼šè¡¨ç¤ºå½“å‰å¤„ç†å™¨ P ä¸“é—¨ç”¨äºæ‰§è¡Œæ ‡è®°ä»»åŠ¡ï¼Œä¸”æœŸé—´ä¸ä¼šè¢«æŠ¢å ã€‚</p></li><li><p><code>gcMarkWorkerFractionalMode</code>ï¼šè¡¨ç¤ºå½“å‰å¤„ç†å™¨æ˜¯å› ä¸º GC åˆ©ç”¨ç‡ä¸è¾¾æ ‡ï¼ˆ25%è¾¾æ ‡ï¼‰æ‰æ‰§è¡Œçš„æ ‡è®°ä»»åŠ¡ï¼Œæ‰§è¡ŒæœŸé—´å¯ä»¥è¢«æŠ¢å ã€‚å‡è®¾å½“å‰å¤„ç†å™¨ P æ•°é‡ä¸º 5ï¼Œæ ¹æ®è®¡ç®—å…¬å¼æ­¤æ—¶éœ€è¦ä¸€ä¸ªä¸“ç”¨å¤„ç†æ ‡è®°ä»»åŠ¡çš„å¤„ç†å™¨ Pï¼Œåˆ©ç”¨ç‡åªè¾¾åˆ°äº† 20%ï¼Œå‰©ä¸‹ 5%çš„åˆ©ç”¨ç‡å°±éœ€è¦å¼€å¯ä¸€ä¸ª<code>FractionalMode</code>çš„å¤„ç†å™¨ P æ¥å¼¥è¡¥ã€‚å…·ä½“çš„è®¡ç®—ä»£ç å¦‚ä¸‹æ‰€ç¤º</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">c </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gcControllerState</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">startCycle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">markStartTime</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">procs</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">trigger</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> gcTrigger</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  totalUtilizationGoal</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> float64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">procs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcBackgroundUtilization</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  dedicatedMarkWorkersNeeded</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">totalUtilizationGoal</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> float64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dedicatedMarkWorkersNeeded</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> totalUtilizationGoal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // Too many dedicated workers.</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        dedicatedMarkWorkersNeeded</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">--</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">fractionalUtilizationGoal</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">totalUtilizationGoal</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> float64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dedicatedMarkWorkersNeeded</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)) </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> float64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">procs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>gcMarkWorkerIdleMode</code>ï¼šè¡¨ç¤ºå½“å‰å¤„ç†å™¨æ˜¯å› ä¸ºç©ºé—²æ‰æ‰§è¡Œæ ‡è®°ä»»åŠ¡ï¼Œæ‰§è¡ŒæœŸé—´å¯ä»¥è¢«æŠ¢å ã€‚</p></li></ul><p>Go å›¢é˜Ÿä¸å¸Œæœ› GC å ç”¨è¿‡å¤šçš„æ€§èƒ½ä»è€Œå½±å“ç”¨æˆ·ç¨‹åºçš„æ­£å¸¸è¿è¡Œï¼Œæ ¹æ®è¿™äº›ä¸åŒçš„æ¨¡å¼è¿›è¡Œæ ‡è®°å·¥ä½œï¼Œå¯ä»¥åœ¨ä¸æµªè´¹æ€§èƒ½ä¹Ÿä¸å½±å“ç”¨æˆ·ç¨‹åºçš„æƒ…å†µä¸‹å®Œæˆ GCã€‚å¯ä»¥æ³¨æ„åˆ°çš„æ˜¯æ ‡è®°ä»»åŠ¡çš„åŸºæœ¬åˆ†é…å•ä½æ˜¯å¤„ç†å™¨ Pï¼Œæ‰€ä»¥æ ‡è®°å·¥ä½œæ˜¯å¹¶å‘è¿›è¡Œçš„ï¼Œå¤šä¸ªæ ‡è®°ä»»åŠ¡å’Œç”¨æˆ·ç¨‹åºä¹‹é—´å¹¶å‘çš„æ‰§è¡Œï¼Œäº’ä¸å½±å“ã€‚</p><h3 id="æ ‡è®°è¾…åŠ©" tabindex="-1"><a class="header-anchor" href="#æ ‡è®°è¾…åŠ©"><span>æ ‡è®°è¾…åŠ©</span></a></h3><p>åç¨‹ G åœ¨è¿è¡Œæ—¶æœ‰ä¸€ä¸ªå­—æ®µ<code>gcAssistBytes</code>ï¼Œè¿™é‡Œå°†å…¶ç§°ä¸º GC è¾…åŠ©ç§¯åˆ†ã€‚å¤„äº GC æ ‡è®°çŠ¶æ€æ—¶ï¼Œå½“ä¸€ä¸ªåç¨‹å°è¯•ç”³è¯·è‹¥å¹²å¤§å°çš„å†…å­˜ï¼Œå®ƒä¼šè¢«æ‰£é™¤ä¸ç”³è¯·å†…å­˜å¤§å°ç›¸åŒçš„ç§¯åˆ†ã€‚å¦‚æœæ­¤æ—¶ç§¯åˆ†ä¸ºè´Ÿæ•°ï¼Œé‚£ä¹ˆè¯¥åç¨‹å¿…é¡»è¾…åŠ©å®Œæˆå®šé‡çš„ GC æ‰«æä»»åŠ¡æ¥å¿è¿˜ç§¯åˆ†ï¼Œå½“ç§¯åˆ†ä¸ºæ­£æ•°æ—¶ï¼Œåç¨‹å°±å¯ä»¥ä¸éœ€è¦å»å®Œæˆè¾…åŠ©æ ‡è®°ä»»åŠ¡äº†ã€‚</p><p>æ‰£é™¤ç§¯åˆ†çš„å‡½æ•°ä¸º<code>runtime.deductAssistCredit</code>ï¼Œå®ƒä¼šåœ¨<code>runtime.mallocgc</code>å‡½æ•°åˆ†é…å†…å­˜å‰è¢«è°ƒç”¨ã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> deductAssistCredit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">size</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uintptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">g</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    var</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> assistG</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">g</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcBlackenEnabled</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // Charge the current user G for this allocation.</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">       assistG</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getg</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">       if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> assistG</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">m</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">curg</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">          assistG</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> assistG</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">m</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">curg</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       }</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // Charge the allocation against the G. We&#39;ll account</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // for internal fragmentation at the end of mallocgc.</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">       assistG</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcAssistBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> -=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">       if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> assistG</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcAssistBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // This G is in debt. Assist the GC to correct</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // this before allocating. This must happen</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // before disabling preemption.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">          gcAssistAlloc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistG</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> assistG</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶è€Œå½“åç¨‹å®Œæˆå®šé‡çš„è¾…åŠ©æ‰«æå·¥ä½œåï¼Œå°±ä¼šå¿è¿˜å®šé‡çš„ç§¯åˆ†ç»™å½“å‰åç¨‹ï¼Œå®é™…è´Ÿè´£è¾…åŠ©æ ‡è®°çš„å‡½æ•°æ˜¯<code>runtime.gcDrainN</code>ã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> gcAssistAlloc1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">gp</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">g</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">scanWork</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> &amp;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getg</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">m</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcw</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // å®Œæˆå·¥ä½œäº†</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  workDone</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> gcDrainN</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">scanWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  assistBytesPerWork</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistBytesPerWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcAssistBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> +=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistBytesPerWork</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">workDone</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”±äºæ‰«ææ˜¯å¹¶å‘çš„ï¼Œè®°å½•ä¸‹æ¥çš„å·¥ä½œé‡ä¸­åªæœ‰ä¸€éƒ¨åˆ†æ˜¯å½“å‰åç¨‹çš„ï¼Œä½™ä¸‹çš„å·¥ä½œé‡ä¼šæ ¹æ®è¾…åŠ©é˜Ÿåˆ—çš„é¡ºåºæ¥é€ä¸ªå¿è¿˜ç»™å…¶å®ƒåç¨‹ï¼Œå¦‚æœè¿˜æœ‰å‰©ä½™çš„è¯ï¼Œå°±ä¼šæ·»åŠ åˆ°å…¨å±€ç§¯åˆ†<code>gcController.assistBytesPerWork</code>ä¸­ã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> gcFlushBgCredit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">scanWork</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºåˆ™ç›´æ¥æ·»åŠ åˆ°å…¨å±€ç§¯åˆ†ä¸­</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistQueue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">q</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">empty</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">bgScanCredit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">scanWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  assistBytesPerWork</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistBytesPerWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  scanBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">scanWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> assistBytesPerWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistQueue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistQueue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">q</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">empty</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> scanBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    gp</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistQueue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">q</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">pop</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> scanBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcAssistBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      scanBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> +=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcAssistBytes</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcAssistBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">      ready</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcAssistBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> +=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> scanBytes</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      scanBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistQueue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">q</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">pushBack</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      break</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // è¿˜æœ‰å‰©ä½™</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> scanBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    assistWorkPerByte</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistWorkPerByte</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    scanWork</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">scanBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> assistWorkPerByte</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">bgScanCredit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">scanWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistQueue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç›¸åº”çš„ï¼Œå½“éœ€è¦å¿è¿˜çš„ç§¯åˆ†è¿‡å¤šæ—¶ï¼ˆç”³è¯·çš„å†…å­˜è¿‡å¤§ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¨å±€ç§¯åˆ†æ¥æŠµæ¶ˆéƒ¨åˆ†è‡ªå·±çš„å€Ÿå€º</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> gcAssistAlloc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">gp</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">g</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  assistWorkPerByte</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistWorkPerByte</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  assistBytesPerWork</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistBytesPerWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  debtBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcAssistBytes</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  scanWork</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistWorkPerByte</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> float64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">debtBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> scanWork</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcOverAssistWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    scanWork</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcOverAssistWork</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    debtBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistBytesPerWork</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> float64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">scanWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ç”¨å…¨å±€ç§¯åˆ†æŠµæŠ¼</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  bgScanCredit</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">bgScanCredit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  stolen</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> bgScanCredit</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> bgScanCredit</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> scanWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      stolen</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> bgScanCredit</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcAssistBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> +=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">assistBytesPerWork</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stolen</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      stolen</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> scanWork</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcAssistBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> +=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> debtBytes</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">bgScanCredit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stolen</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    scanWork</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> -=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stolen</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> scanWork</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ ‡è®°è¾…åŠ©æ˜¯åœ¨é«˜è´Ÿè½½çš„æƒ…å†µä¸‹çš„ä¸€ç§å¹³è¡¡æ‰‹æ®µï¼Œç”¨æˆ·ç¨‹åºåˆ†é…å†…å­˜çš„é€Ÿåº¦è¿œé«˜äºæ ‡è®°çš„é€Ÿåº¦ï¼Œåˆ†é…å¤šå°‘å†…å­˜å°±è¿›è¡Œå¤šå°‘æ ‡è®°å·¥ä½œã€‚</p><h3 id="æ ‡è®°ç»ˆæ­¢" tabindex="-1"><a class="header-anchor" href="#æ ‡è®°ç»ˆæ­¢"><span>æ ‡è®°ç»ˆæ­¢</span></a></h3><p>å½“æ‰€æœ‰å¯è¾¾çš„ç°è‰²å¯¹è±¡éƒ½è¢«æŸ“é»‘äº†è¿‡åï¼Œæ­¤æ—¶å°±ç”±<code>_GCmark</code>çŠ¶æ€è¿‡æ¸¡åˆ°<code>_GCmarktermination</code>çŠ¶æ€ï¼Œè¿™ä¸ªè¿‡ç¨‹ç”±<code>runtime.gcMarkDone</code>å‡½æ•°æ¥å®Œæˆã€‚åœ¨å¼€å§‹æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥æ˜¯å¦ä»æœ‰ä»»åŠ¡è¦æ‰§è¡Œï¼Œ</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">top</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcphase</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> _GCmark</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nwait</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nproc</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gcMarkWorkAvailable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">nil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  gcMarkDoneFlushed</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // å°†æ‰€æœ‰å› å†™å±éšœæ‹¦æˆªçš„æ ‡è®°æ“ä½œå…¨éƒ¨æ‰¹é‡çš„æ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  forEachP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">waitReasonGCMarkTermination</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">pp</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    wbBufFlush1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">pp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    pp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dispose</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> pp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">flushedWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      atomic</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Xadd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcMarkDoneFlushed</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      pp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">flushedWork</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  })</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcMarkDoneFlushed</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    goto</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> top</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“æ²¡æœ‰ä»»ä½•å…¨å±€ä»»åŠ¡å’Œæœ¬åœ°ä»»åŠ¡è¦æ‰§è¡Œåï¼Œè°ƒç”¨<code>runtime.stopTheWorldWithSema</code>è¿›è¡Œ STWï¼Œç„¶ååšä¸€äº›æ”¶å°¾çš„å·¥ä½œ</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// Disable assists and background workers. We must do</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// this before waking blocked assists.</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">atomic</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Store</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcBlackenEnabled</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// Notify the CPU limiter that GC assists will now cease.</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcCPULimiter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">startGCTransition</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// Wake all blocked assists. These will run when we</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// start the world again.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gcWakeAllAssists</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// In STW mode, re-enable user goroutines. These will be</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// queued to run after we start the world.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">schedEnableUser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// endCycle depends on all gcWork cache stats being flushed.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// The termination algorithm above ensured that up to</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// allocations since the ragged barrier.</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">endCycle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gomaxprocs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">), </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">userForced</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// Perform mark termination. This will restart the world.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gcMarkTermination</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é¦–å…ˆå°†<code>runtime.BlackenEnabled</code>ç½®ä¸º 0ï¼Œè¡¨ç¤ºæ ‡è®°å·¥ä½œå·²ç»ç»“æŸäº†ï¼Œé€šçŸ¥é™åˆ¶å™¨æ ‡è®°è¾…åŠ©å·²ç»ç»“æŸäº†ï¼Œå…³é—­å†…å­˜å±éšœï¼Œå”¤é†’æ‰€æœ‰å› è¾…åŠ©æ ‡è®°è€Œä¼‘çœ çš„åç¨‹ï¼Œç„¶åå†é‡æ–°å”¤é†’æ‰€æœ‰çš„ç”¨æˆ·åç¨‹ï¼Œè¿˜è¦æ”¶é›†æœ¬è½®æ‰«æå·¥ä½œçš„å„ç§æ•°æ®æ¥è°ƒæ•´è°ƒæ­¥ç®—æ³•æ¥ä¸ºä¸‹ä¸€è½®æ‰«æåšå‡†å¤‡ï¼Œæ”¶å°¾å·¥ä½œå®Œæˆåï¼Œè°ƒç”¨<code>runtime.gcSweep</code>å‡½æ•°æ¸…ç†åƒåœ¾å¯¹è±¡ï¼Œæœ€åå†è°ƒç”¨<code>runtime.startTheWorldWithSema</code>è®©ç¨‹åºæ¢å¤è¿è¡Œã€‚</p><h2 id="å±éšœ" tabindex="-1"><a class="header-anchor" href="#å±éšœ"><span>å±éšœ</span></a></h2><p>å†…å­˜å±éšœçš„ä½œç”¨å¯ä»¥ç†è§£ä¸º hook äº†å¯¹è±¡çš„èµ‹å€¼è¡Œä¸ºï¼Œåœ¨èµ‹å€¼å‰åšä¸€äº›æŒ‡å®šçš„æ“ä½œï¼Œè¿™ç§ hook ä»£ç é€šå¸¸åœ¨ç¼–è¯‘æœŸé—´ç”±ç¼–è¯‘å™¨æ’å…¥åˆ°ä»£ç ä¸­ã€‚å‰é¢æåˆ°è¿‡ï¼Œä¸‰è‰²æ ‡è®°åœ¨å¹¶å‘æƒ…å†µä¸‹æ·»åŠ å’Œåˆ é™¤å¯¹è±¡å¼•ç”¨éƒ½ä¼šå¯¼è‡´é—®é¢˜ï¼Œç”±äºè¿™ä¸¤ä¸ªéƒ½æ˜¯å†™æ“ä½œï¼ˆåˆ é™¤å°±æ˜¯èµ‹ç©ºå€¼ï¼‰ï¼Œæ‰€ä»¥æ‹¦æˆªå®ƒä»¬çš„å±éšœè¢«ç»Ÿç§°ä¸ºå†™å±éšœã€‚ä½†å±éšœæœºåˆ¶å¹¶éæ¯«æ— æˆæœ¬ï¼Œæ‹¦æˆªå†…å­˜å†™æ“ä½œä¼šé€ æˆé¢å¤–çš„å¼€é”€ï¼Œå› æ­¤å±éšœæœºåˆ¶åªåœ¨å †ä¸Šç”Ÿæ•ˆï¼Œè€ƒè™‘åˆ°å®ç°å¤æ‚åº¦å’Œæ€§èƒ½æŸè€—ï¼Œå¯¹äºæ ˆå’Œå¯„å­˜å™¨åˆ™ä¸èµ·ä½œç”¨èŒƒå›´å†…ã€‚</p><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>æƒ³è¦äº†è§£æ›´å¤š Go å¯¹äºå±éšœæŠ€æœ¯çš„åº”ç”¨ç»†èŠ‚ï¼Œå‰å¾€<a href="https://github.com/golang/proposal/blob/master/design/17503-eliminate-rescan.md" target="_blank" rel="noopener noreferrer">Eliminate STW stack rescan</a>é˜…è¯»è‹±æ–‡åŸæ–‡ï¼Œæœ¬æ–‡å‚è€ƒäº†è®¸å¤šå†…å®¹ã€‚</p></div><h3 id="æ’å…¥å†™å±éšœ" tabindex="-1"><a class="header-anchor" href="#æ’å…¥å†™å±éšœ"><span>æ’å…¥å†™å±éšœ</span></a></h3><p>æ’å…¥å†™å±éšœç”± Dijkstra æå‡ºçš„ï¼Œå®ƒæ»¡è¶³å¼ºä¸‰è‰²ä¸å˜å¼ã€‚å½“ç»™é»‘è‰²å¯¹è±¡æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ç™½è‰²å¯¹è±¡å¼•ç”¨æ—¶ï¼Œæ’å…¥å†™å±éšœä¼šæ‹¦æˆªæ­¤æ“ä½œï¼Œå°†è¯¥ç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼Œè¿™æ ·å¯ä»¥é¿å…é»‘è‰²å¯¹è±¡ç›´æ¥å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼Œä¿è¯äº†å¼ºä¸‰è‰²ä¸å˜æ€§ï¼Œè¿™ä¸ªç›¸å½“å¥½ç†è§£ã€‚</p><figure><img src="/images/essential/impl_gc_9.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å‰é¢æåˆ°è¿‡å†™å±éšœä¸ä¼šåº”ç”¨åœ¨æ ˆä¸Šï¼Œå¦‚æœåœ¨å¹¶å‘æ ‡è®°çš„è¿‡ç¨‹ä¸­æ ˆå¯¹è±¡çš„å¼•ç”¨å…³ç³»å‘ç”Ÿäº†å˜åŒ–ï¼Œæ¯”å¦‚æ ˆä¸­çš„é»‘è‰²å¯¹è±¡å¼•ç”¨äº†å †ä¸­çš„ç™½è‰²å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ºäº†ç¡®ä¿æ ˆå¯¹è±¡çš„æ­£ç¡®æ€§ï¼Œåªèƒ½åœ¨æ ‡è®°ç»“æŸåå†æ¬¡å°†æ ˆä¸­çš„æ‰€æœ‰å¯¹è±¡å…¨éƒ¨æ ‡è®°ä¸ºç°è‰²å¯¹è±¡ï¼Œç„¶åé‡æ–°æ‰«æä¸€éï¼Œç­‰äºæ˜¯ä¸€è½®æ ‡è®°è¦æ‰«æä¸¤æ¬¡æ ˆç©ºé—´ï¼Œå¹¶ä¸”ç¬¬äºŒæ¬¡æ‰«ææ—¶å¿…é¡»è¦ STWï¼Œå‡å¦‚ç¨‹åºä¸­åŒæ—¶å­˜åœ¨æˆç™¾ä¸Šåƒä¸ªåç¨‹æ ˆï¼Œé‚£ä¹ˆè¿™ä¸€æ‰«æè¿‡ç¨‹çš„è€—æ—¶å°†ä¸å®¹å¿½è§†ï¼Œæ ¹æ®å®˜æ–¹ç»Ÿè®¡çš„æ•°æ®ï¼Œé‡æ–°æ‰«æçš„è€—æ—¶å¤§æ¦‚åœ¨ 10-100 æ¯«ç§’å·¦å³ã€‚</p><p>ä¼˜ç‚¹ï¼šæ‰«ææ—¶ä¸éœ€è¦ STW</p><p>ç¼ºç‚¹ï¼šéœ€è¦äºŒæ¬¡æ‰«ææ ˆç©ºé—´ä¿è¯æ­£ç¡®æ€§ï¼Œéœ€è¦ STW</p><h3 id="åˆ é™¤å†™å±éšœ" tabindex="-1"><a class="header-anchor" href="#åˆ é™¤å†™å±éšœ"><span>åˆ é™¤å†™å±éšœ</span></a></h3><p>åˆ é™¤å†™å±éšœç”± Yuasa æå‡ºï¼Œåˆç§°åŸºäºèµ·å§‹å¿«ç…§çš„å±éšœï¼Œè¯¥æ–¹å¼åœ¨å¼€å§‹æ—¶éœ€è¦ STW æ¥å¯¹æ ¹å¯¹è±¡è¿›è¡Œå¿«ç…§è®°å½•ï¼Œå¹¶ä¸”å®ƒä¼šå°†æ‰€æœ‰æ ¹å¯¹è±¡æ ‡é»‘ï¼Œæ‰€æœ‰çš„ä¸€çº§å­å¯¹è±¡æ ‡ç°ï¼Œè¿™æ ·å…¶ä½™çš„ç™½è‰²å­å¯¹è±¡éƒ½ä¼šå¤„äºç°è‰²å¯¹è±¡çš„ä¿æŠ¤ä¹‹ä¸‹ã€‚Go å›¢é˜Ÿå¹¶æ²¡æœ‰ç›´æ¥åº”ç”¨åˆ é™¤å†™å±éšœï¼Œè€Œæ˜¯é€‰æ‹©äº†å°†å…¶ä¸æ’å…¥å†™å±éšœæ··åˆä½¿ç”¨ï¼Œæ‰€ä»¥ä¸ºäº†æ–¹ä¾¿åç»­çš„ç†è§£ï¼Œè¿™é‡Œè¿˜æ˜¯è¦è®²ä¸€ä¸‹ã€‚åˆ é™¤å†™å±éšœåœ¨å¹¶å‘æ¡ä»¶ä¸‹ä¿è¯æ­£ç¡®æ€§çš„è§„åˆ™æ˜¯ï¼šå½“ä»ç°è‰²æˆ–ç™½è‰²å¯¹è±¡åˆ é™¤å¯¹ç™½è‰²å¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œéƒ½ä¼šç›´æ¥å°†ç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²å¯¹è±¡ã€‚</p><p>åˆ†ä¸¤ç§æƒ…å†µæ¥è§£è¯»ï¼š</p><ul><li><p>åˆ é™¤ç°è‰²å¯¹è±¡å¯¹äºç™½è‰²å¯¹è±¡çš„å¼•ç”¨ï¼šç”±äºä¸çŸ¥é“ç™½è‰²å¯¹è±¡ä¸‹æ¸¸æ˜¯å¦è¢«é»‘è‰²å¯¹è±¡å¼•ç”¨ï¼Œæ­¤ä¸¾å¯èƒ½ä¼šåˆ‡æ–­ç°è‰²å¯¹è±¡å¯¹äºç™½è‰²å¯¹è±¡çš„ä¿æŠ¤</p></li><li><p>åˆ é™¤ç™½è‰²å¯¹è±¡å¯¹äºç™½è‰²å¯¹è±¡çš„å¼•ç”¨ï¼šç”±äºä¸çŸ¥é“ç™½è‰²å¯¹è±¡ä¸Šæ¸¸æ˜¯å¦è¢«ç°è‰²ä¿æŠ¤ï¼Œä¸‹æ¸¸æ˜¯å¦è¢«é»‘è‰²å¯¹è±¡å¼•ç”¨ï¼Œæ­¤ä¸¾ä¹Ÿå¯èƒ½ä¼šåˆ‡æ–­ç°è‰²å¯¹äºç™½è‰²å¯¹è±¡çš„ä¿æŠ¤</p></li></ul><p>ä¸ç®¡æ˜¯å“ªç§æƒ…å†µï¼Œåˆ é™¤å†™å±éšœéƒ½ä¼šå°†è¢«å¼•ç”¨çš„ç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼Œè¿™æ ·ä¸€æ¥å°±èƒ½æ»¡è¶³å¼±ä¸‰è‰²ä¸å˜å¼ã€‚è¿™æ˜¯ä¸€ç§ä¿å®ˆçš„åšæ³•ï¼Œå› ä¸ºä¸Šä¸‹æ¸¸æƒ…å†µæœªçŸ¥ï¼Œå°†å…¶æ ‡è®°ä¸ºç°è‰²å°±ç­‰äºä¸å†è§†å…¶ä¸ºåƒåœ¾å¯¹è±¡ï¼Œå°±ç®—åˆ é™¤å¼•ç”¨åä¼šå¯¼è‡´è¯¥å¯¹è±¡ä¸å¯è¾¾ä¹Ÿå°±æ˜¯æˆä¸ºåƒåœ¾å¯¹è±¡æ—¶ï¼Œä¹Ÿä»ç„¶ä¼šå°†å…¶æ ‡è®°ä¸ºç°è‰²ï¼Œå®ƒä¼šåœ¨ä¸‹è½®æ‰«æä¸­è¢«é‡Šæ”¾æ‰ï¼Œè¿™æ€»å¥½è¿‡å¯¹è±¡è¢«è¯¯æ¸…ç†è€Œå¯¼è‡´çš„å†…å­˜é”™è¯¯ã€‚</p><figure><img src="/images/essential/impl_gc_10.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ä¼˜ç‚¹ï¼šç”±äºæ ˆå¯¹è±¡å…¨é»‘ï¼Œæ‰€ä»¥ä¸éœ€è¦äºŒæ¬¡æ‰«ææ ˆç©ºé—´</p><p>ç¼ºç‚¹ï¼šåœ¨æ‰«æå¼€å§‹æ—¶éœ€è¦ STW æ¥å¯¹æ ˆç©ºé—´çš„æ ¹å¯¹è±¡è¿›è¡Œå¿«ç…§</p><h3 id="æ··åˆå†™å±éšœ" tabindex="-1"><a class="header-anchor" href="#æ··åˆå†™å±éšœ"><span>æ··åˆå†™å±éšœ</span></a></h3><p>go1.8 ç‰ˆæœ¬å¼•ç”¨äº†æ–°çš„å±éšœæœºåˆ¶ï¼šæ··åˆå†™å±éšœï¼Œå³æ’å…¥å†™å±éšœä¸åˆ é™¤å†™å±éšœçš„æ··åˆï¼Œç»“åˆäº†å®ƒä»¬ä¸¤ä¸ªçš„ä¼˜ç‚¹ï¼š</p><ul><li>æ’å…¥å†™å±éšœèµ·å§‹æ—¶ä¸éœ€è¦ STW æ¥è¿›è¡Œå¿«ç…§</li><li>åˆ é™¤å†™å±éšœä¸éœ€è¦ STW æ¥äºŒæ¬¡æ‰«ææ ˆç©ºé—´</li></ul><p>ä¸‹é¢æ˜¯å®˜æ–¹ç»™å‡ºçš„çš„ä¼ªä»£ç ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>writePointer(slot, ptr):</span></span>
<span class="line"><span>    shade(*slot)</span></span>
<span class="line"><span>    if current stack is grey:</span></span>
<span class="line"><span>        shade(ptr)</span></span>
<span class="line"><span>    *slot = ptr</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç®€å•è®²è§£ä¸‹é‡Œé¢çš„ä¸€äº›æ¦‚å¿µï¼Œå…¶ä¸­<code>slot</code>æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œè¡¨ç¤ºå¯¹å…¶å®ƒå¯¹è±¡çš„å¼•ç”¨ï¼Œ<code>*slot</code>æ˜¯åŸå¯¹è±¡ï¼Œ<code>ptr</code>æ˜¯æ–°å¯¹è±¡ï¼Œ<code>*slot=ptr</code>æ˜¯ä¸€æ¬¡èµ‹å€¼æ“ä½œï¼Œç­‰äºä¿®æ”¹å¯¹è±¡çš„å¼•ç”¨ï¼Œèµ‹ç©ºå€¼å°±æ˜¯åˆ é™¤å¼•ç”¨ï¼Œ<code>shade()</code>è¡¨ç¤ºå°†ä¸€ä¸ªå¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼Œ<code>shade(*slot)</code>å°±æ˜¯å°†åŸå¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼Œ<code>shade(ptr)</code>å°±æ˜¯å°†æ–°å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å›¾ï¼Œå‡è®¾å¯¹è±¡ 1 åŸæ¥å¼•ç”¨ç€å¯¹è±¡ 2ï¼Œç„¶åç”¨æˆ·ç¨‹åºä¿®æ”¹äº†å¼•ç”¨ï¼Œè®©å¯¹è±¡ 1 å¼•ç”¨äº†å¯¹è±¡ 3ï¼Œæ··åˆå†™å±éšœæ•æ‰åˆ°äº†è¿™ä¸€è¡Œä¸ºï¼Œå…¶ä¸­<code>*slot</code>ä»£è¡¨çš„å°±æ˜¯å¯¹è±¡ 2ï¼Œ<code>ptr</code>ä»£è¡¨çš„å°±æ˜¯å¯¹è±¡ 1ã€‚</p><figure><img src="/images/essential/impl_gc_11.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å®˜æ–¹ç”¨ä¸€å¥è¯æ¦‚æ‹¬äº†ä¸Šé¢ä¼ªä»£ç çš„ä½œç”¨</p><blockquote><p>the write barrier shades the object whose reference is being overwritten, and, if the current goroutine&#39;s stack has not yet been scanned, also shades the reference being installed.</p></blockquote><p>ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼Œå½“æ··åˆå†™å±éšœæ‹¦æˆªåˆ°å†™æ“ä½œæ—¶ï¼Œä¼šå°†åŸå¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼Œå¦‚æœå½“å‰åç¨‹æ ˆè¿˜æœªè¢«æ‰«æè¿‡æ—¶ï¼Œå°±å°†æ–°å¯¹è±¡ä¹Ÿæ ‡è®°ä¸ºç°è‰²ã€‚</p><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406062218312.png" style="zoom:33%;"><p>æ ‡è®°å·¥ä½œå¼€å§‹æ—¶ï¼Œéœ€è¦æ‰«ææ ˆç©ºé—´ä»¥æ”¶é›†æ ¹å¯¹è±¡ï¼Œè¿™æ—¶ä¼šç›´æ¥å°†å…¶å…¨éƒ¨æ ‡è®°ä¸ºé»‘è‰²ï¼Œåœ¨æ­¤æœŸé—´ä»»ä½•æ–°åˆ›å»ºå¯¹è±¡ä¹Ÿä¼šè¢«æ ‡è®°ä¸ºé»‘è‰²ï¼Œä¿è¯æ ˆä¸­çš„æ‰€æœ‰éƒ½æ˜¯é»‘è‰²å¯¹è±¡ï¼Œæ‰€ä»¥ä¼ªä»£ç ä¸­çš„<code>current stack is grey</code>è¡¨ç¤ºçš„å°±æ˜¯å½“å‰åç¨‹æ ˆè¿˜æœªè¢«æ‰«æè¿‡ï¼Œæ‰€ä»¥åç¨‹æ ˆåªæœ‰ä¸¤ç§çŠ¶æ€ï¼Œè¦ä¹ˆå…¨é»‘è¦ä¹ˆå…¨ç°ï¼Œåœ¨ç”±å…¨ç°å˜ä¸ºå…¨é»‘çš„è¿‡ç¨‹ä¸­æ˜¯éœ€è¦æš‚åœå½“å‰åç¨‹çš„ï¼Œæ‰€ä»¥åœ¨æ··åˆå†™å±éšœä¸‹ä¾ç„¶ä¼šæœ‰å±€éƒ¨çš„ STWã€‚å½“åç¨‹æ ˆå…¨é»‘æ—¶ï¼Œæ­¤æ—¶ä¸€å®šæ»¡è¶³å¼ºä¸‰è‰²ä¸å˜å¼ï¼Œå› ä¸ºæ‰«æåæ ˆä¸­çš„é»‘è‰²å¯¹è±¡åªä¼šå¼•ç”¨ç°è‰²å¯¹è±¡ï¼Œä¸ä¼šå­˜åœ¨é»‘è‰²å¯¹è±¡ç›´æ¥å¼•ç”¨ç™½è‰²å¯¹è±¡çš„æƒ…å†µï¼Œæ‰€ä»¥æ­¤æ—¶ä¸éœ€è¦æ’å…¥å†™å±éšœï¼Œå¯¹åº”ä¼ªä»£ç </p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>if current stack is grey:</span></span>
<span class="line"><span>        shade(ptr)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½†ä»ç„¶éœ€è¦åˆ é™¤å†™å±éšœæ¥æ»¡è¶³å¼±ä¸‰è‰²ä¸å˜å¼ï¼Œä¹Ÿå°±æ˜¯</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>shade(*slot)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>åœ¨æ‰«æå®Œæ¯•åï¼Œç”±äºæ ˆç©ºé—´çš„å¯¹è±¡å·²ç»æ˜¯å…¨é»‘çš„äº†ï¼Œå°±ä¸å†éœ€è¦å»äºŒæ¬¡æ‰«ææ ˆç©ºé—´äº†ï¼Œå¯ä»¥èŠ‚çœæ‰ STW çš„æ—¶é—´ã€‚</p><p>è‡³æ­¤ï¼Œä¹Ÿå°±æ˜¯ go1.8 ç‰ˆæœ¬å¾€åï¼ŒGo å¤§ä½“ä¸Šç¡®ç«‹äº†åƒåœ¾å›æ”¶çš„åŸºæœ¬æ¡†æ¶ï¼Œåç»­ç‰ˆæœ¬æœ‰å…³åƒåœ¾å›æ”¶çš„ä¼˜åŒ–ä¹Ÿéƒ½æ˜¯å»ºç«‹åœ¨æ··åˆå†™å±éšœçš„åŸºç¡€ä¹‹ä¸Šçš„ï¼Œç”±äºå·²ç»æ¶ˆé™¤äº†å¤§éƒ¨åˆ†çš„ STWï¼Œæ­¤æ—¶åƒåœ¾å›æ”¶çš„å¹³å‡å»¶æ—¶å·²ç»é™ä½åˆ°äº†å¾®ç§’çº§åˆ«ã€‚</p><h3 id="ç€è‰²ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#ç€è‰²ç¼“å­˜"><span>ç€è‰²ç¼“å­˜</span></a></h3><p>åœ¨ä¹‹å‰æåˆ°çš„å±éšœæœºåˆ¶ä¸­ï¼Œåœ¨æ‹¦æˆªåˆ°å†™æ“ä½œæ—¶éƒ½æ˜¯ç«‹å³æ ‡è®°å¯¹è±¡é¢œè‰²ï¼Œåœ¨é‡‡ç”¨æ··åˆå†™å±éšœåï¼Œç”±äºéœ€è¦å¯¹åŸå¯¹è±¡å’Œæ–°å¯¹è±¡éƒ½è¡Œè¿›è¡Œæ ‡è®°ï¼Œæ‰€ä»¥å·¥ä½œé‡ä¼šç¿»å€ï¼ŒåŒæ—¶ç¼–è¯‘å™¨æ’å…¥çš„ä»£ç ä¹Ÿä¼šå¢åŠ ã€‚ä¸ºäº†è¿›è¡Œä¼˜åŒ–ï¼Œåœ¨ go1.10 ç‰ˆæœ¬ä¸­ï¼Œå†™å±éšœåœ¨è¿›è¡Œç€è‰²æ—¶ä¸å†ä¼šç«‹å³æ ‡è®°å¯¹è±¡é¢œè‰²ï¼Œè€Œæ˜¯ä¼šå°†åŸå¯¹è±¡å’Œæ–°å¯¹è±¡å­˜å…¥ä¸€ä¸ªç¼“å­˜æ± ä¸­ï¼Œç­‰ç§¯æ”’åˆ°äº†ä¸€å®šæ•°é‡åï¼Œå†è¿›è¡Œæ‰¹é‡æ ‡è®°ï¼Œè¿™æ ·åšæ•ˆç‡æ›´é«˜ã€‚</p><p>è´Ÿè´£ç¼“å­˜çš„ç»“æ„æ˜¯<code>runtime.wbBuf</code>ï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¤§å°ä¸º 512ã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">type</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> wbBuf</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  next</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uintptr</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  end</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uintptr</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  buf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">wbBufEntries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">uintptr</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯ä¸€ä¸ª P æœ¬åœ°éƒ½æœ‰è¿™æ ·ä¸€ä¸ªç¼“å­˜</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">type</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  wbBuf</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> wbBuf</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æ ‡è®°å·¥ä½œè¿›è¡Œæ—¶ï¼Œå¦‚æœ<code>gcw</code>é˜Ÿåˆ—ä¸­æ²¡æœ‰å¯ç”¨çš„ç°è‰²å¯¹è±¡ï¼Œå°±ä¼šå°†ç¼“å­˜ä¸­çš„å¯¹è±¡æ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ä¸­ã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> gcDrain</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gcWork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">flags</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> gcDrainFlags</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">preempt</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">preemptible</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> sched</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcwaiting</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">||</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> pp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">runSafePointFn</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">full</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">balance</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    b</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryGetFast</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      b</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryGet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // åˆ·æ–°å†™å±éšœç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        wbBufFlush</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        b</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryGet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      break</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    scanobject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦å¤–ä¸€ç§æƒ…å†µæ˜¯ï¼Œå½“æ ‡è®°ç»ˆæ­¢æ—¶ï¼Œä¹Ÿä¼šæ£€æŸ¥æ¯ä¸€ä¸ª P æœ¬åœ°çš„<code>wbBuf</code>æ˜¯å¦æœ‰å‰©ä¸‹çš„ç°è‰²å¯¹è±¡</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> gcMarkDone</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  forEachP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">waitReasonGCMarkTermination</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">pp</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    wbBufFlush1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">pp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    pp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dispose</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  })</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å›æ”¶" tabindex="-1"><a class="header-anchor" href="#å›æ”¶"><span>å›æ”¶</span></a></h2><p>åœ¨åƒåœ¾å›æ”¶ä¸­ï¼Œæœ€é‡è¦çš„éƒ¨åˆ†åœ¨äºå¦‚ä½•æ‰¾å‡ºåƒåœ¾å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æ‰«ææ ‡è®°å·¥ä½œï¼Œè€Œåœ¨æ ‡è®°å·¥ä½œå®Œæˆåï¼Œå›æ”¶å·¥ä½œå°±ç›¸å¯¹æ²¡é‚£ä¹ˆå¤æ‚ï¼Œå®ƒåªéœ€è¦å°†æœªæ ‡è®°çš„å¯¹è±¡å›æ”¶é‡Šæ”¾å°±è¡Œã€‚è¿™éƒ¨åˆ†ä»£ç ä¸»è¦åœ¨<code>runtime/mgcsweep.go</code>æ–‡ä»¶ä¸­ï¼Œæ ¹æ®æ–‡ä»¶ä¸­æ³¨é‡Šå¯ä»¥å¾—çŸ¥ Go ä¸­çš„å›æ”¶ç®—æ³•åˆ†ä¸ºä¸¤ç§ã€‚</p><h3 id="å¯¹è±¡å›æ”¶" tabindex="-1"><a class="header-anchor" href="#å¯¹è±¡å›æ”¶"><span>å¯¹è±¡å›æ”¶</span></a></h3><p>å¯¹è±¡å›æ”¶çš„å·¥ä½œä¼šåœ¨æ ‡è®°ç»ˆæ­¢é˜¶æ®µï¼Œç”±<code>runtime.sweepone</code>æ¥å®Œæˆæ¸…ç†å·¥ä½œï¼Œè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ã€‚åœ¨æ¸…ç†æ—¶ï¼Œå®ƒä¼šå°è¯•åœ¨å†…å­˜å•å…ƒä¸­å¯»æ‰¾æœªæ ‡è®°çš„å¯¹è±¡ï¼Œç„¶åå›æ”¶æ‰ã€‚å€˜è‹¥æ•´ä¸ªå†…å­˜å•å…ƒéƒ½æœªè¢«æ ‡è®°ï¼Œé‚£ä¹ˆè¿™ä¸€ä¸ªå•å…ƒéƒ½ä¼šè¢«å›æ”¶æ‰ã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> sweepone</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">uintptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  sl</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> sweep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">active</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">begin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  npages</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ^</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">uintptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  var</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> noMoreWork</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> bool</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    s</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> mheap_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nextSpanForSweep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      noMoreWork</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> sweep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">active</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">markDrained</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      break</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> state</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">state</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(); </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">state</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> mSpanInUse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      continue</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // å°è¯•è·å–å›æ”¶å™¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ok</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> sl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">); </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ok</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      npages</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">npages</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // æ¸…ç†</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sweep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        mheap_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">reclaimCredit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">npages</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        npages</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      break</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  sweep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">active</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">end</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">sl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> npages</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºå¯¹è±¡å›æ”¶ç®—æ³•è€Œè¨€ï¼Œå›æ”¶æ•´ä¸ªå•å…ƒæ¯”è¾ƒçš„å›°éš¾ï¼Œæ‰€ä»¥å°±æœ‰äº†ç¬¬äºŒä¸ªå›æ”¶ç®—æ³•ã€‚</p><h3 id="å•å…ƒå›æ”¶" tabindex="-1"><a class="header-anchor" href="#å•å…ƒå›æ”¶"><span>å•å…ƒå›æ”¶</span></a></h3><p>å•å…ƒå›æ”¶çš„å·¥ä½œæ˜¯åœ¨å†…å­˜åˆ†é…å‰è¿›è¡Œçš„ï¼Œç”±<code>runtime.mheap.reclaim</code>æ–¹æ³•æ¥å®Œæˆï¼Œå®ƒä¼šåœ¨å †ä¸­å¯»æ‰¾æ‰€æœ‰å¯¹è±¡éƒ½æœªè¢«æ ‡è®°çš„å†…å­˜å•å…ƒï¼Œç„¶åå°†æ•´ä¸ªå•å…ƒå›æ”¶ã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">h </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">mheap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">reclaim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">npage</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uintptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  mp</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> acquirem</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  trace</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> traceAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> trace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ok</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    trace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GCSweepStart</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    traceRelease</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">trace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  arenas</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">sweepArenas</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  locked</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> npage</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> credit</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">reclaimCredit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(); </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">credit</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      take</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> credit</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> take</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> npage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        take</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> npage</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">reclaimCredit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">CompareAndSwap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">credit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">credit</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">take</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        npage</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> -=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> take</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      continue</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    idx</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uintptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">reclaimIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">pagesPerReclaimerChunk</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> pagesPerReclaimerChunk</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> idx</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">pagesPerArena</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uintptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">arenas</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">reclaimIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Store</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 63</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      break</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    nfound</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">reclaimChunk</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">arenas</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">idx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">pagesPerReclaimerChunk</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> nfound</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> npage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      npage</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> -=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> nfound</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">reclaimCredit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nfound</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> npage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      npage</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  trace</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> traceAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> trace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ok</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    trace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GCSweepDone</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    traceRelease</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">trace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  releasem</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºå†…å­˜å•å…ƒè€Œè¨€ï¼Œæœ‰ä¸€ä¸ª<code>sweepgen</code>å­—æ®µç”¨äºè¡¨æ˜å…¶å›æ”¶çŠ¶æ€</p><ul><li><code>mspan.sweepgen == mheap.sweepgen - 2</code>ï¼šè¯¥å†…å­˜å•å…ƒéœ€è¦å›æ”¶</li><li><code>mspan.sweepgen == mheap.sweepgen - 1</code>ï¼šè¯¥å†…å­˜å•å…ƒæ­£åœ¨è¢«å›æ”¶</li><li><code>mspan.sweepgen == mheap.sweepgen</code>ï¼šè¯¥å†…å­˜å•å…ƒå·²ç»è¢«å›æ”¶äº†ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨</li><li><code>mspan.sweepgen == mheap.sweepgen + 1</code>ï¼šå†…å­˜å•å…ƒåœ¨ç¼“å­˜ä¸­ï¼Œä¸”éœ€è¦å›æ”¶</li><li><code>mspan.sweepgen == mheap.sweepgen + 3</code>ï¼šå†…å­˜å•å…ƒå·²ç»è¢«å›æ”¶äº†ï¼Œä½†ä»ç„¶åœ¨ç¼“å­˜ä¸­</li></ul><p><code>mheap.sweepgen</code>ä¼šéšç€ GC è½®æ¬¡è€Œå¢åŠ ï¼Œå¹¶ä¸”æ¯ä¸€æ¬¡éƒ½ä¼š+2ã€‚</p></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/Open-Source-CQUT/Golang-Doc/edit/main/src/essential/impl/runtime/9.gc.md" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><span class="vp-meta-info" data-allow-mismatch="text">2024/12/15 16:58:36</span></div><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: mister-hope@outlook.com">Mister-Hope</span>,<!--]--><!--[--><span class="vp-meta-info" title="email: 2633565580@qq.com">yihhao wang</span>,<!--]--><!--[--><span class="vp-meta-info" title="email: 2633565580@qq.com">246859</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/essential/impl/runtime/8.mem.html" aria-label="memory"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->memory</div></a><a class="route-link auto-link next" href="/essential/impl/runtime/15.sysmon.html" aria-label="sysmon"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">sysmon<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!--[--><!----><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app--QUN711U.js" defer></script>
  </body>
</html>
