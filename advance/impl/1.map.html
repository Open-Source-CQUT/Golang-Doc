<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://golang.halfiisland.com/advance/impl/1.map.html"><meta property="og:site_name" content="Golangä¸­æ–‡å­¦ä¹ æ–‡æ¡£"><meta property="og:title" content="map"><meta property="og:description" content="goä¸å…¶å®ƒè¯­è¨€ä¸åŒçš„æ˜¯ï¼Œæ˜ å°„è¡¨çš„æ”¯æŒæ˜¯ç”±mapå…³é”®å­—æä¾›çš„ï¼Œè€Œéå°†å…¶å°è£…ä¸ºæ ‡å‡†åº“ã€‚æ˜ å°„è¡¨æ˜¯ä¸€ç§ä½¿ç”¨åœºæ™¯éå¸¸å¤šçš„æ•°æ®ç»“æ„ï¼Œåº•å±‚æœ‰ç€è®¸å¤šçš„å®ç°æ–¹å¼ï¼Œæœ€å¸¸è§çš„ä¸¤ç§æ–¹å¼å°±æ˜¯çº¢é»‘æ ‘å’Œå“ˆå¸Œè¡¨ï¼Œgoé‡‡ç”¨çš„æ˜¯å“ˆå¸Œè¡¨å®ç°æ–¹å¼ã€‚ mapçš„å®ç°ä¸­æ¶‰åŠåˆ°äº†å¤§é‡çš„æŒ‡é’ˆç§»åŠ¨æ“ä½œï¼Œæ‰€ä»¥é˜…è¯»æœ¬æ–‡éœ€è¦unsafeæ ‡å‡†åº“çš„çŸ¥è¯†ã€‚ å†…éƒ¨ç»“æ„ runtime.hmapç»“æ„ä½“å°±æ˜¯ä»£è¡¨ç€goä¸­çš„..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-10-08T10:35:36.000Z"><meta property="article:published_time" content="2023-07-12T00:00:00.000Z"><meta property="article:modified_time" content="2023-10-08T10:35:36.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"map","image":[""],"datePublished":"2023-07-12T00:00:00.000Z","dateModified":"2023-10-08T10:35:36.000Z","author":[]}</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?87d678935e4b33455c0390543e7a759d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><title>map | Golangä¸­æ–‡å­¦ä¹ æ–‡æ¡£</title><meta name="description" content="goä¸å…¶å®ƒè¯­è¨€ä¸åŒçš„æ˜¯ï¼Œæ˜ å°„è¡¨çš„æ”¯æŒæ˜¯ç”±mapå…³é”®å­—æä¾›çš„ï¼Œè€Œéå°†å…¶å°è£…ä¸ºæ ‡å‡†åº“ã€‚æ˜ å°„è¡¨æ˜¯ä¸€ç§ä½¿ç”¨åœºæ™¯éå¸¸å¤šçš„æ•°æ®ç»“æ„ï¼Œåº•å±‚æœ‰ç€è®¸å¤šçš„å®ç°æ–¹å¼ï¼Œæœ€å¸¸è§çš„ä¸¤ç§æ–¹å¼å°±æ˜¯çº¢é»‘æ ‘å’Œå“ˆå¸Œè¡¨ï¼Œgoé‡‡ç”¨çš„æ˜¯å“ˆå¸Œè¡¨å®ç°æ–¹å¼ã€‚ mapçš„å®ç°ä¸­æ¶‰åŠåˆ°äº†å¤§é‡çš„æŒ‡é’ˆç§»åŠ¨æ“ä½œï¼Œæ‰€ä»¥é˜…è¯»æœ¬æ–‡éœ€è¦unsafeæ ‡å‡†åº“çš„çŸ¥è¯†ã€‚ å†…éƒ¨ç»“æ„ runtime.hmapç»“æ„ä½“å°±æ˜¯ä»£è¡¨ç€goä¸­çš„...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-933124f9.css" as="style"><link rel="stylesheet" href="/assets/style-933124f9.css">
    <link rel="modulepreload" href="/assets/app-3f1254a1.js"><link rel="modulepreload" href="/assets/framework-44a66fc7.js"><link rel="modulepreload" href="/assets/1.map.html-73d81d8d.js"><link rel="modulepreload" href="/assets/1.map.html-f19006c1.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.png" alt="Golangä¸­æ–‡å­¦ä¹ æ–‡æ¡£"><!----><span class="site-name hide-in-pad">Golangä¸­æ–‡å­¦ä¹ æ–‡æ¡£</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/guide.html" class="nav-link" aria-label="æŒ‡å—"><span class="font-icon icon iconfont icon-activity" style=""></span>æŒ‡å—<!----></a></div><div class="nav-item hide-in-mobile"><a href="/cmd.html" class="nav-link" aria-label="å‘½ä»¤"><span class="font-icon icon iconfont icon-shell" style=""></span>å‘½ä»¤<!----></a></div><div class="nav-item hide-in-mobile"><a href="/release.html" class="nav-link" aria-label="æ›´æ–°æ—¥å¿—"><span class="font-icon icon iconfont icon-repo" style=""></span>æ›´æ–°æ—¥å¿—<!----></a></div><div class="nav-item hide-in-mobile"><a href="/link.html" class="nav-link" aria-label="å¤–éƒ¨é“¾æ¥"><span class="font-icon icon iconfont icon-share" style=""></span>å¤–éƒ¨é“¾æ¥<!----></a></div><div class="nav-item hide-in-mobile"><a href="/deb.html" class="nav-link" aria-label="ä¾èµ–å¯¼èˆª"><span class="font-icon icon iconfont icon-discover" style=""></span>ä¾èµ–å¯¼èˆª<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://go.dev/play/" rel="noopener noreferrer" target="_blank" aria-label="åœ¨çº¿è¿è¡Œ" class="nav-link"><span class="font-icon icon iconfont icon-back-stage" style=""></span>åœ¨çº¿è¿è¡Œ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="https://go.dev/ref/spec" rel="noopener noreferrer" target="_blank" aria-label="å‚è€ƒæ‰‹å†Œ" class="nav-link"><span class="font-icon icon iconfont icon-article" style=""></span>å‚è€ƒæ‰‹å†Œ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="/about.html" class="nav-link" aria-label="å…³äºä½œè€…"><span class="font-icon icon iconfont icon-alias" style=""></span>å…³äºä½œè€…<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/CQUT-Programmer/Golang-Doc" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg></button><!--]--><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-activity" style=""></span><span class="title">è¯­è¨€å…¥é—¨</span><!----></p><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-bit" style=""></span><span class="title">è¯­æ³•åŸºç¡€</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-alias" style=""></span><span class="title">è¯­æ³•è¿›é˜¶</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-module" style=""></span><span class="title">æ ‡å‡†åº“</span><span class="arrow right"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading active"><span class="font-icon icon iconfont icon-advance" style=""></span><span class="title">è¯­è¨€è¿›é˜¶</span><!----></p><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-mysql" style=""></span><span class="title">æ•°æ®åº“</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="font-icon icon iconfont icon-template" style=""></span><span class="title">å®ç°åŸç†</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/advance/impl/0.slice.html" class="nav-link sidebar-link sidebar-page" aria-label="slice"><!---->slice<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/advance/impl/1.map.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="map"><!---->map<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/advance/impl/1.map.html#å†…éƒ¨ç»“æ„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å†…éƒ¨ç»“æ„"><!---->å†…éƒ¨ç»“æ„<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/advance/impl/1.map.html#å“ˆå¸Œå†²çª" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å“ˆå¸Œå†²çª"><!---->å“ˆå¸Œå†²çª<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/advance/impl/1.map.html#åˆ›å»º" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="åˆ›å»º"><!---->åˆ›å»º<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/advance/impl/1.map.html#è®¿é—®" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="è®¿é—®"><!---->è®¿é—®<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/advance/impl/1.map.html#é”®å€¼" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="é”®å€¼"><!---->é”®å€¼<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/advance/impl/1.map.html#éå†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="éå†"><!---->éå†<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/advance/impl/1.map.html#ä¿®æ”¹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ä¿®æ”¹"><!---->ä¿®æ”¹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/advance/impl/1.map.html#åˆ é™¤" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="åˆ é™¤"><!---->åˆ é™¤<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/advance/impl/1.map.html#æ¸…ç©º" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æ¸…ç©º"><!---->æ¸…ç©º<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/advance/impl/1.map.html#æ‰©å®¹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æ‰©å®¹"><!---->æ‰©å®¹<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/advance/impl/1.map.html#å¢é‡æ‰©å®¹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å¢é‡æ‰©å®¹"><!---->å¢é‡æ‰©å®¹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/advance/impl/1.map.html#ç­‰é‡æ‰©å®¹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ç­‰é‡æ‰©å®¹"><!---->ç­‰é‡æ‰©å®¹<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/advance/impl/2.string.html" class="nav-link sidebar-link sidebar-page" aria-label="string"><!---->string<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/advance/impl/3.nil.html" class="nav-link sidebar-link sidebar-page" aria-label="nil"><!---->nil<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/advance/impl/4.context.html" class="nav-link sidebar-link sidebar-page" aria-label="Context"><!---->Context<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/advance/impl/5.gc.html" class="nav-link sidebar-link sidebar-page" aria-label="åƒåœ¾å›æ”¶"><!---->åƒåœ¾å›æ”¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/advance/impl/6.gmp.html" class="nav-link sidebar-link sidebar-page" aria-label="å¹¶å‘æ¨¡å‹"><!---->å¹¶å‘æ¨¡å‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/advance/impl/7.memory.html" class="nav-link sidebar-link sidebar-page" aria-label="å†…å­˜ç®¡ç†"><!---->å†…å­˜ç®¡ç†<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/advance/impl/8.main_init.html" class="nav-link sidebar-link sidebar-page" aria-label="å¯åŠ¨å‡½æ•°"><!---->å¯åŠ¨å‡½æ•°<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-plugin" style=""></span><span class="title">ä¸­é—´ä»¶</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-structure" style=""></span><span class="title">å¾®æœåŠ¡</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-view" style=""></span><span class="title">ç¬¬ä¸‰æ–¹åº“</span><span class="arrow right"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-study" style=""></span><span class="title">ç†è®ºæ€æƒ³</span><!----></p><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-superscript" style=""></span><span class="title">ç®—æ³•</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-news" style=""></span><span class="title">è®¾è®¡æ¨¡å¼</span><span class="arrow right"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-software" style=""></span><span class="title">å®ç”¨æŠ€æœ¯</span><!----></p><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-box" style=""></span><span class="title">Docker</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-repo" style=""></span><span class="title">æ¢ç´¢å‘ç°</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-git" style=""></span><span class="title">Git</span><span class="arrow right"></span></button><!----></section></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->map</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://246859.github.io/" target="_blank" rel="noopener noreferrer">å¯’æ±Ÿè“‘ç¬ ç¿</a></span><span property="author" content="å¯’æ±Ÿè“‘ç¬ ç¿"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-07-12T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 75 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT75M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/advance/impl/1.map.html#å†…éƒ¨ç»“æ„" class="router-link-active router-link-exact-active toc-link level2">å†…éƒ¨ç»“æ„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/advance/impl/1.map.html#å“ˆå¸Œå†²çª" class="router-link-active router-link-exact-active toc-link level2">å“ˆå¸Œå†²çª</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/advance/impl/1.map.html#åˆ›å»º" class="router-link-active router-link-exact-active toc-link level2">åˆ›å»º</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/advance/impl/1.map.html#è®¿é—®" class="router-link-active router-link-exact-active toc-link level2">è®¿é—®</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/advance/impl/1.map.html#é”®å€¼" class="router-link-active router-link-exact-active toc-link level3">é”®å€¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/advance/impl/1.map.html#éå†" class="router-link-active router-link-exact-active toc-link level3">éå†</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/advance/impl/1.map.html#ä¿®æ”¹" class="router-link-active router-link-exact-active toc-link level2">ä¿®æ”¹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/advance/impl/1.map.html#åˆ é™¤" class="router-link-active router-link-exact-active toc-link level2">åˆ é™¤</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/advance/impl/1.map.html#æ¸…ç©º" class="router-link-active router-link-exact-active toc-link level2">æ¸…ç©º</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/advance/impl/1.map.html#æ‰©å®¹" class="router-link-active router-link-exact-active toc-link level2">æ‰©å®¹</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/advance/impl/1.map.html#å¢é‡æ‰©å®¹" class="router-link-active router-link-exact-active toc-link level3">å¢é‡æ‰©å®¹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/advance/impl/1.map.html#ç­‰é‡æ‰©å®¹" class="router-link-active router-link-exact-active toc-link level3">ç­‰é‡æ‰©å®¹</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="map" tabindex="-1"><a class="header-anchor" href="#map" aria-hidden="true">#</a> map</h1><p>goä¸å…¶å®ƒè¯­è¨€ä¸åŒçš„æ˜¯ï¼Œæ˜ å°„è¡¨çš„æ”¯æŒæ˜¯ç”±<code>map</code>å…³é”®å­—æä¾›çš„ï¼Œè€Œéå°†å…¶å°è£…ä¸ºæ ‡å‡†åº“ã€‚æ˜ å°„è¡¨æ˜¯ä¸€ç§ä½¿ç”¨åœºæ™¯éå¸¸å¤šçš„æ•°æ®ç»“æ„ï¼Œåº•å±‚æœ‰ç€è®¸å¤šçš„å®ç°æ–¹å¼ï¼Œæœ€å¸¸è§çš„ä¸¤ç§æ–¹å¼å°±æ˜¯çº¢é»‘æ ‘å’Œå“ˆå¸Œè¡¨ï¼Œgoé‡‡ç”¨çš„æ˜¯å“ˆå¸Œè¡¨å®ç°æ–¹å¼ã€‚</p><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>mapçš„å®ç°ä¸­æ¶‰åŠåˆ°äº†å¤§é‡çš„æŒ‡é’ˆç§»åŠ¨æ“ä½œï¼Œæ‰€ä»¥é˜…è¯»æœ¬æ–‡éœ€è¦<code>unsafe</code>æ ‡å‡†åº“çš„çŸ¥è¯†ã€‚</p></div><h2 id="å†…éƒ¨ç»“æ„" tabindex="-1"><a class="header-anchor" href="#å†…éƒ¨ç»“æ„" aria-hidden="true">#</a> å†…éƒ¨ç»“æ„</h2><p><code>runtime.hmap</code>ç»“æ„ä½“å°±æ˜¯ä»£è¡¨ç€goä¸­çš„<code>map</code>ï¼Œä¸åˆ‡ç‰‡ä¸€æ ·<code>map</code>çš„å†…éƒ¨å®ç°ä¹Ÿæ˜¯ç»“æ„ä½“ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// A header for a Go map.</span>
<span class="token keyword">type</span> hmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// Note: the format of the hmap is also encoded in cmd/compile/internal/reflectdata/reflect.go.</span>
	<span class="token comment">// Make sure this stays in sync with the compiler&#39;s definition.</span>
	count     <span class="token builtin">int</span> <span class="token comment">// # live cells == size of map.  Must be first (used by len() builtin)</span>
	flags     <span class="token builtin">uint8</span>
	B         <span class="token builtin">uint8</span>  <span class="token comment">// log_2 of # of buckets (can hold up to loadFactor * 2^B items)</span>
	noverflow <span class="token builtin">uint16</span> <span class="token comment">// approximate number of overflow buckets; see incrnoverflow for details</span>
	hash0     <span class="token builtin">uint32</span> <span class="token comment">// hash seed</span>

	buckets    unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// array of 2^B Buckets. may be nil if count==0.</span>
	oldbuckets unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// previous bucket array of half the size, non-nil only when growing</span>
	nevacuate  <span class="token builtin">uintptr</span>        <span class="token comment">// progress counter for evacuation (buckets less than this have been evacuated)</span>

	extra <span class="token operator">*</span>mapextra <span class="token comment">// optional fields</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è‹±æ–‡æ³¨é‡Šå·²ç»è¯´æ˜çš„å¾ˆæ¸…æ™°äº†ï¼Œä¸‹é¢å¯¹æ¯”è¾ƒé‡è¦çš„å­—æ®µè¿›è¡Œä¸€äº›ç®€å•çš„è§£é‡Š</p><ul><li><p><code>count</code>ï¼Œè¡¨ç¤ºhampä¸­çš„å…ƒç´ æ•°é‡ï¼Œç»“æœç­‰åŒäº<code>len(map)</code>ã€‚</p></li><li><p><code>flags</code>ï¼Œhmapçš„æ ‡å¿—ä½ï¼Œç”¨äºè¡¨ç¤ºhmapå¤„äºä»€ä¹ˆçŠ¶æ€ï¼Œæœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
    iterator     <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// è¿­ä»£å™¨æ­£åœ¨ä½¿ç”¨æ¡¶</span>
    oldIterator  <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// è¿­ä»£å™¨æ­£åœ¨ä½¿ç”¨æ—§æ¡¶</span>
    hashWriting  <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment">// ä¸€ä¸ªåç¨‹æ­£åœ¨å†™å…¥hmap</span>
    sameSizeGrow <span class="token operator">=</span> <span class="token number">8</span> <span class="token comment">// æ­£åœ¨ç­‰é‡æ‰©å®¹</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>B</code>ï¼Œhmapä¸­çš„å“ˆå¸Œæ¡¶çš„æ•°é‡ä¸º<code>1 &lt;&lt; B</code>ã€‚</p></li><li><p><code>noverflow</code>ï¼Œhmapä¸­æº¢å‡ºæ¡¶çš„å¤§è‡´æ•°é‡ã€‚</p></li><li><p><code>hash0</code>ï¼Œå“ˆå¸Œç§å­ï¼Œåœ¨hmapè¢«åˆ›å»ºæ—¶æŒ‡å®šï¼Œç”¨äºè®¡ç®—å“ˆå¸Œå€¼ã€‚</p></li><li><p><code>buckets</code>ï¼Œå­˜æ”¾å“ˆå¸Œæ¡¶æ•°ç»„çš„æŒ‡é’ˆã€‚</p></li><li><p><code>oldbuckets</code>ï¼Œå­˜æ”¾hmapåœ¨æ‰©å®¹å‰å“ˆå¸Œæ¡¶æ•°ç»„çš„æŒ‡é’ˆã€‚</p></li><li><p><code>extra</code>ï¼Œå­˜æ”¾ç€hmapä¸­çš„æº¢å‡ºæ¡¶ï¼Œæº¢å‡ºæ¡¶æŒ‡çš„æ˜¯å°±æ˜¯å½“å‰æ¡¶å·²ç»æ»¡äº†ï¼Œåˆ›å»ºæ–°çš„æ¡¶æ¥å­˜æ”¾å…ƒç´ ï¼Œæ–°åˆ›å»ºçš„æ¡¶å°±æ˜¯æº¢å‡ºæ¡¶ã€‚</p></li></ul><p>hampä¸­çš„<code>buckets</code>ä¹Ÿå°±æ˜¯æ¡¶åˆ‡ç‰‡æŒ‡é’ˆï¼Œåœ¨goä¸­å¯¹åº”çš„ç»“æ„ä¸º<code>runtime.bmap</code>ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// A bucket for a Go map.</span>
<span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	tophash <span class="token punctuation">[</span>bucketCnt<span class="token punctuation">]</span><span class="token builtin">uint8</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°å®ƒåªæœ‰ä¸€ä¸ª<code>tophash</code>çš„å­—æ®µï¼Œè¯¥å­—æ®µæ˜¯ç”¨äºå­˜æ”¾æ¯ä¸ªé”®çš„é«˜å…«ä½ï¼Œä¸è¿‡å®é™…ä¸Šæ¥è¯´ï¼Œ<code>bmap</code>çš„å­—æ®µä¸æ­¢è¿™äº›ï¼Œè¿™æ˜¯å› ä¸º<code>map</code>å¯ä»¥å­˜å‚¨å„ç§ç±»å‹çš„é”®å€¼å¯¹ï¼Œæ‰€ä»¥éœ€è¦åœ¨ç¼–è¯‘æ—¶æ ¹æ®ç±»å‹æ¥æ¨å¯¼å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œåœ¨<code>cmd/compile/internal/reflectdata/reflect.go</code>ä¸­çš„<code>MapBucketType</code>å‡½æ•°çš„åŠŸèƒ½å°±æ˜¯åœ¨ç¼–è¯‘æ—¶æ„é€ bmapï¼Œå®ƒä¼šè¿›è¡Œä¸€ç³»åˆ—æ£€æŸ¥å·¥ä½œï¼Œæ¯”å¦‚keyçš„ç±»å‹æ˜¯å¦<code>comparable</code>ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// MapBucketType makes the map bucket type given the type of the map.</span>
<span class="token keyword">func</span> <span class="token function">MapBucketType</span><span class="token punctuation">(</span>t <span class="token operator">*</span>types<span class="token punctuation">.</span>Type<span class="token punctuation">)</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>Type
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰€ä»¥å®é™…ä¸Šï¼Œ<code>bmap</code>çš„ç»“æ„å¦‚ä¸‹ï¼Œä¸è¿‡è¿™äº›å­—æ®µå¯¹æˆ‘ä»¬æ˜¯ä¸å¯è§çš„ï¼Œgoåœ¨å®é™…æ“ä½œä¸­æ˜¯é€šè¿‡ç§»åŠ¨unsafeæŒ‡é’ˆæ¥è¿›è¡Œè®¿é—®</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	tophash <span class="token punctuation">[</span>BUCKETSIZE<span class="token punctuation">]</span><span class="token builtin">uint8</span>
	keys <span class="token punctuation">[</span>BUCKETSIZE<span class="token punctuation">]</span>keyType
	elems <span class="token punctuation">[</span>BUCKETSIZE<span class="token punctuation">]</span>elemType
	overflow <span class="token operator">*</span>bucket
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­çš„ä¸€äº›è§£é‡Šå¦‚ä¸‹</p><ul><li><p><code>tophash</code>ï¼Œå­˜æ”¾æ¯ä¸€ä¸ªé”®çš„é«˜å…«ä½å€¼ï¼Œå¯¹äºä¸€ä¸ªtophashçš„å…ƒç´ è€Œè¨€ï¼Œæœ‰ä¸‹é¢å‡ ç§ç‰¹æ®Šçš„å€¼</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
    emptyRest      <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// å½“å‰å…ƒç´ æ˜¯ç©ºçš„ï¼Œå¹¶ä¸”è¯¥å…ƒç´ åé¢ä¹Ÿæ²¡æœ‰å¯ç”¨çš„é”®å€¼äº†</span>
    emptyOne       <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// å½“å‰å…ƒç´ æ˜¯ç©ºçš„ï¼Œä½†æ˜¯è¯¥å…ƒç´ åé¢æœ‰å¯ç”¨çš„é”®å€¼ã€‚</span>
    evacuatedX     <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// æ‰©å®¹æ—¶å‡ºç°ï¼Œåªèƒ½å‡ºç°åœ¨oldbucketsä¸­ï¼Œè¡¨ç¤ºå½“å‰å…ƒç´ è¢«æ¬è¿åˆ°äº†æ–°å“ˆå¸Œæ¡¶æ•°ç»„çš„ä¸ŠåŠåŒº</span>
    evacuatedY     <span class="token operator">=</span> <span class="token number">3</span> <span class="token comment">// æ‰©å®¹æ—¶å‡ºç°åªèƒ½å‡ºç°åœ¨oldbucketsä¸­ï¼Œè¡¨ç¤ºå½“å‰å…ƒç´ è¢«æ¬è¿åˆ°äº†æ–°å“ˆå¸Œæ¡¶æ•°ç»„çš„ä¸‹åŠåŒº</span>
    evacuatedEmpty <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment">// æ‰©å®¹æ—¶å‡ºç°ï¼Œå…ƒç´ æœ¬èº«å°±æ˜¯ç©ºçš„ï¼Œåœ¨æ¬è¿æ—¶è¢«æ ‡è®°</span>
    minTopHash     <span class="token operator">=</span> <span class="token number">5</span> <span class="token comment">// å¯¹äºä¸€ä¸ªæ­£å¸¸çš„é”®å€¼æ¥è¯´tophashçš„æœ€å°å€¼</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åªè¦æ˜¯<code>tophash[i]</code>çš„å€¼å¤§äº<code>minTophash</code>çš„å€¼ï¼Œå°±è¯´æ˜å¯¹åº”ä¸‹æ ‡å­˜åœ¨æ­£å¸¸çš„é”®å€¼ã€‚</p></li><li><p><code>keys</code>ï¼Œå­˜æ”¾æŒ‡å®šç±»å‹é”®çš„æ•°ç»„ã€‚</p></li><li><p><code>elems</code>ï¼Œå­˜æ”¾æŒ‡å®šç±»å‹å€¼çš„æ•°ç»„ã€‚</p></li><li><p><code>overflow</code>ï¼ŒæŒ‡å‘æº¢å‡ºæ¡¶çš„æŒ‡é’ˆã€‚</p></li></ul><p>æ—¢ç„¶é”®å€¼æ— æ³•é€šè¿‡ç»“æ„ä½“å­—æ®µæ¥ç›´æ¥è®¿é—®ï¼Œä¸ºæ­¤goäº‹å…ˆå£°æ˜äº†ä¸€ä¸ªå¸¸é‡<code>dataoffset</code>ï¼Œå®ƒä»£è¡¨çš„æ˜¯æ•°æ®åœ¨<code>bmap</code>ä¸­çš„å†…å­˜åç§»é‡ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> dataOffset <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Offsetof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
    b bmap
    v <span class="token builtin">int64</span>
<span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span>v<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®é™…ä¸Šï¼Œé”®å€¼æ˜¯å­˜æ”¾åœ¨ä¸€ä¸ªè¿ç»­çš„å†…å­˜åœ°å€ä¸­ï¼Œç±»ä¼¼äºä¸‹é¢è¿™ç§ç»“æ„ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†é¿å…å†…å­˜å¯¹é½å¸¦æ¥çš„ç©ºé—´æµªè´¹ã€‚</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>k1,k2,k3,k4,k5,k6...v1,v2,v3,v4,v5,v6...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ‰€ä»¥å¯¹äºä¸€ä¸ªbmapè€Œè¨€ï¼ŒæŒ‡é’ˆç§»åŠ¨<code>dataoffset</code>åï¼Œç§»åŠ¨<code>i*sizeof(keyType)</code>å°±æ˜¯ç¬¬iä¸ªkeyçš„åœ°å€</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è·å–ç¬¬iä¸ªvalueçš„åœ°å€ä¹Ÿæ˜¯åŒç†</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>e <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>hamp</code>ä¸­çš„<code>buckets</code>æŒ‡é’ˆï¼Œå°±æ˜¯æŒ‡å‘çš„ç¬¬ä¸€ä¸ªå“ˆå¸Œæ¡¶çš„åœ°å€ï¼Œå¦‚æœæƒ³è¦è·å–ç¬¬iä¸ªå“ˆå¸Œæ¡¶çš„åœ°å€ï¼Œåç§»é‡å°±æ˜¯<code>i*sizeof(bucket)</code>ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>b <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åœ¨åç»­çš„å†…å®¹ä¸­ï¼Œè¿™äº›æ“ä½œä¼šéå¸¸é¢‘ç¹çš„å‡ºç°ã€‚</p><h2 id="å“ˆå¸Œå†²çª" tabindex="-1"><a class="header-anchor" href="#å“ˆå¸Œå†²çª" aria-hidden="true">#</a> å“ˆå¸Œå†²çª</h2><p>åœ¨hmapä¸­ï¼Œæœ‰ä¸€ä¸ªå­—æ®µ<code>extra</code>ä¸“é—¨ç”¨æ¥å­˜æ”¾æº¢å‡ºæ¡¶çš„ä¿¡æ¯ï¼Œå®ƒä¼šæŒ‡å‘å­˜æ”¾æº¢å‡ºæ¡¶çš„åˆ‡ç‰‡ï¼Œå…¶ç»“æ„å¦‚ä¸‹ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> mapextra <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// æº¢å‡ºæ¡¶çš„æŒ‡é’ˆåˆ‡ç‰‡</span>
	overflow    <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>bmap
	<span class="token comment">// æ‰©å®¹å‰æ—§çš„æº¢å‡ºæ¡¶çš„æŒ‡é’ˆåˆ‡ç‰‡</span>
	oldoverflow <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>bmap
	<span class="token comment">// æŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„æº¢å‡ºæ¡¶çš„æŒ‡é’ˆ</span>
	nextOverflow <span class="token operator">*</span>bmap
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202310061929859.png" style="zoom:33%;"><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>åœ¨ä¸Šå›¾ä¸­ï¼Œè“è‰²éƒ¨åˆ†æ˜¯å“ˆå¸Œæ¡¶æ•°ç»„ï¼Œæ©™è‰²éƒ¨åˆ†æ˜¯æº¢å‡ºå“ˆå¸Œæ¡¶æ•°ç»„ï¼Œæº¢å‡ºå“ˆå¸Œæ¡¶ä¸‹é¢ç»Ÿç§°ä¸ºæº¢å‡ºæ¡¶ã€‚</p></div><p>ä¸Šå›¾å°±å¯ä»¥æ¯”è¾ƒå¥½çš„å±•ç¤ºhmapçš„å¤§è‡´ç»“æ„ï¼Œ<code>buckets</code>æŒ‡å‘å“ˆå¸Œæ¡¶æ•°ç»„ï¼Œ<code>extra</code>æŒ‡å‘æº¢å‡ºæ¡¶æ•°ç»„ï¼Œæ¡¶<code>bucket0</code>æŒ‡å‘æº¢å‡ºæ¡¶<code>overflow0</code>ï¼Œä¸¤ç§ä¸åŒçš„æ¡¶åˆ†åˆ«å­˜æ”¾åœ¨ä¸¤ä¸ªåˆ‡ç‰‡ä¸­ï¼Œä¸¤ç§æ¡¶çš„å†…å­˜éƒ½æ˜¯è¿ç»­çš„ã€‚å½“ä¸¤ä¸ªé”®é€šè¿‡å“ˆå¸Œåè¢«åˆ†é…åˆ°äº†åŒä¸€ä¸ªbucketï¼Œè¿™ç§æƒ…å†µå°±æ˜¯å‘ç”Ÿäº†å“ˆå¸Œå†²çªã€‚goä¸­è§£å†³å“ˆå¸Œå†²çªçš„æ–¹å¼å°±æ˜¯æ‹‰é“¾æ³•ï¼Œå½“å‘ç”Ÿå†²çªçš„é”®çš„æ•°é‡å¤§äºæ¡¶çš„å®¹é‡åï¼Œä¸€èˆ¬æ˜¯8ä¸ªï¼Œå…¶å€¼å–å†³äº<code>internal/abi.MapBucketCount</code>ã€‚ç„¶åå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ¡¶æ¥å­˜æ”¾è¿™äº›é”®ï¼Œè€Œè¿™ä¸ªæ¡¶å°±å«æº¢å‡ºæ¡¶ï¼Œæ„ä¸ºåŸæ¥çš„æ¡¶è£…ä¸ä¸‹äº†ï¼Œå…ƒç´ æº¢å‡ºåˆ°è¿™ä¸ªæ–°æ¡¶é‡Œæ¥äº†ï¼Œåˆ›å»ºå®Œæ¯•åï¼Œå“ˆå¸Œæ¡¶ä¼šæœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ–°çš„æº¢å‡ºæ¡¶ï¼Œè¿™äº›æ¡¶çš„æŒ‡é’ˆè¿èµ·æ¥å°±å½¢æˆäº†ä¸€ä¸ª<code>bmap</code>é“¾è¡¨ã€‚</p><p>å¯¹äºæ‹‰é“¾æ³•è€Œè¨€ï¼Œä½¿ç”¨è´Ÿè½½å› å­ç”¨äºè¡¡é‡å“ˆå¸Œè¡¨çš„å†²çªæƒ…å†µï¼Œå…¶è®¡ç®—å…¬å¼å¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>loadfactor <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>elems<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">len</span><span class="token punctuation">(</span>buckets<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å½“è´Ÿè½½å› å­è¶Šå¤§æ—¶ï¼Œè¯´æ˜å“ˆå¸Œå†²çªè¶Šå¤šï¼Œä¹Ÿå°±æ˜¯æº¢å‡ºæ¡¶çš„æ•°é‡è¶Šå¤šï¼Œé‚£ä¹ˆåœ¨è¯»å†™å“ˆå¸Œè¡¨æ—¶ï¼Œå°±éœ€è¦éå†æ›´å¤šçš„æº¢å‡ºæ¡¶é“¾è¡¨ï¼Œæ‰èƒ½æ‰¾åˆ°æŒ‡å®šçš„ä½ç½®ï¼Œæ‰€ä»¥æ€§èƒ½å°±è¶Šå·®ã€‚ä¸ºäº†æ”¹å–„è¿™ç§æƒ…å†µï¼Œåº”è¯¥å¢åŠ <code>buckets</code>æ¡¶çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯æ‰©å®¹ï¼Œå¯¹äºhmapè€Œè¨€ï¼Œæœ‰ä¸¤ç§æƒ…å†µä¼šè§¦å‘æ‰©å®¹</p><ul><li>è´Ÿè½½å› å­è¶…è¿‡é˜ˆå€¼<code>bucketCnt*13/16</code>ï¼Œå…¶å€¼è‡³å°‘æ˜¯6.5ã€‚</li><li>æº¢å‡ºæ¡¶æ•°é‡è¿‡å¤š</li></ul><p>å½“è´Ÿè½½å› å­è¶Šå°æ—¶ï¼Œè¯´æ˜hmapçš„å†…å­˜åˆ©ç”¨ç‡ä½ï¼Œå ç”¨çš„å†…å­˜å°±è¶Šå¤§ã€‚goä¸­ç”¨äºè®¡ç®—è´Ÿè½½å› å­çš„å‡½æ•°æ˜¯<code>runtime.overLoadFactor</code>ï¼Œä»£ç å¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">overLoadFactor</span><span class="token punctuation">(</span>count <span class="token builtin">int</span><span class="token punctuation">,</span> B <span class="token builtin">uint8</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> count <span class="token operator">&gt;</span> bucketCnt <span class="token operator">&amp;&amp;</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">&gt;</span> loadFactorNum<span class="token operator">*</span><span class="token punctuation">(</span><span class="token function">bucketShift</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token operator">/</span>loadFactorDen<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­<code>loadFactorNum</code>å’Œ<code>loadFactorDen</code>éƒ½æ˜¯ä¸€ä¸ªå¸¸æ•°ï¼Œ<code>bucketshift</code>æ˜¯è®¡ç®—<code>1 &lt;&lt; B</code>ï¼Œå¹¶ä¸”å·²çŸ¥</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>loadFactorNum <span class="token operator">=</span> <span class="token punctuation">(</span>bucketCnt <span class="token operator">*</span> <span class="token number">13</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">*</span> loadFactorDen
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ‰€ä»¥åŒ–ç®€ä¸€ä¸‹å°±èƒ½å¾—åˆ°</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>count <span class="token operator">&gt;</span> bucketCnt <span class="token operator">&amp;&amp;</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> B <span class="token operator">&gt;</span> <span class="token punctuation">(</span>bucketCnt <span class="token operator">*</span> <span class="token number">13</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å…¶ä¸­<code>(bucketCnt * 13 / 16)</code>å€¼ä¸º6.5ï¼Œ<code>1 &lt;&lt; B</code>å°±æ˜¯å“ˆå¸Œæ¡¶çš„æ•°é‡ï¼Œæ‰€ä»¥è¯¥å‡½æ•°çš„ä½œç”¨å°±æ˜¯è®¡ç®—å…ƒç´ æ•°é‡é™¤ä»¥æ¡¶çš„æ•°é‡å€¼æ˜¯å¦å¤§äºè´Ÿè½½å› å­6.5ã€‚</p><h2 id="åˆ›å»º" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º" aria-hidden="true">#</a> åˆ›å»º</h2><p>mapçš„åˆå§‹åŒ–æœ‰ä¸¤ç§æ–¹å¼ï¼Œè¿™ä¸€ç‚¹å·²ç»åœ¨è¯­è¨€å…¥é—¨ä¸­é˜è¿°è¿‡äº†ï¼Œä¸€ç§æ˜¯ä½¿ç”¨å…³é”®å­—<code>map</code>ç›´æ¥åˆ›å»ºï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨<code>make</code>å‡½æ•°ï¼Œä¸ç®¡ç”¨ä½•ç§æ–¹å¼åˆå§‹åŒ–ï¼Œæœ€åéƒ½æ˜¯ç”±<code>runtime.makemap</code>æ¥åˆ›å»ºmapï¼Œè¯¥å‡½æ•°ç­¾åå¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">makemap</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> hint <span class="token builtin">int</span><span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">)</span> <span class="token operator">*</span>hmap
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å…¶ä¸­çš„å‚æ•°</p><ul><li><code>t</code>ï¼ŒæŒ‡çš„æ˜¯mapçš„ç±»å‹ï¼Œä¸åŒçš„ç±»å‹æ‰€éœ€çš„å†…å­˜å ç”¨ä¸åŒ</li><li><code>hint</code>ï¼ŒæŒ‡çš„æ˜¯<code>make</code>å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œmapé¢„è®¡å…ƒç´ çš„å®¹é‡ã€‚</li><li><code>h</code>ï¼ŒæŒ‡çš„æ˜¯<code>hmap</code>çš„æŒ‡é’ˆï¼Œå¯ä»¥ä¸º<code>nil</code>ã€‚</li></ul><p>è¿”å›å€¼å°±æ˜¯åˆå§‹åŒ–å®Œæ¯•çš„<code>hmap</code>æŒ‡é’ˆã€‚è¯¥å‡½æ•°åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­æœ‰å‡ ä¸ªä¸»è¦çš„å·¥ä½œã€‚é¦–å…ˆå°±æ˜¯è®¡ç®—é¢„è®¡åˆ†é…çš„å†…å­˜æ˜¯å¦ä¼šè¶…å‡ºæœ€å¤§åˆ†é…å†…å­˜ï¼Œå¯¹åº”å¦‚ä¸‹ä»£ç </p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// å°†é¢„è®¡å®¹é‡ä¸æ¡¶ç±»å‹çš„å†…å­˜å¤§å°ç›¸ä¹˜</span>
mem<span class="token punctuation">,</span> overflow <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">MulUintptr</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>hint<span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Bucket<span class="token punctuation">.</span>Size_<span class="token punctuation">)</span>
<span class="token comment">// æ•°å€¼æº¢å‡ºæˆ–è€…è¶…å‡ºäº†æœ€å¤§åˆ†é…å†…å­˜</span>
<span class="token keyword">if</span> overflow <span class="token operator">||</span> mem <span class="token operator">&gt;</span> maxAlloc <span class="token punctuation">{</span>
    hint <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨å…ˆå‰çš„å†…éƒ¨ç»“æ„ä¸­å·²ç»æåˆ°è¿‡ï¼Œhmapå†…éƒ¨æ˜¯ç”±æ¡¶ç»„æˆçš„ï¼Œåœ¨å†…å­˜åˆ©ç”¨ç‡æœ€ä½çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ¡¶åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå ç”¨çš„å†…å­˜æœ€å¤šï¼Œæ‰€ä»¥é¢„è®¡çš„æœ€å¤§å†…å­˜å ç”¨å°±æ˜¯å…ƒç´ æ•°é‡ä¹˜ä»¥å¯¹åº”ç±»å‹çš„å†…å­˜å ç”¨å¤§å°ã€‚å½“è®¡ç®—ç»“æœæ•°å€¼æº¢å‡ºäº†ï¼Œæˆ–è€…è¶…å‡ºäº†æœ€å¤§èƒ½åˆ†é…çš„å†…å­˜ï¼Œå°±å°†hintç½®ä¸º0ï¼Œå› ä¸ºåç»­éœ€è¦ç”¨hintæ¥è®¡ç®—æ¡¶æ•°ç»„çš„å®¹é‡ã€‚</p><p>ç¬¬äºŒæ­¥åˆå§‹åŒ–hmapï¼Œå¹¶è®¡ç®—å‡ºä¸€ä¸ªéšæœºçš„å“ˆå¸Œç§å­ï¼Œå¯¹åº”å¦‚ä¸‹ä»£ç </p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// åˆå§‹åŒ–</span>
<span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    h <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>hmap<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// è·å–ä¸€ä¸ªéšæœºçš„å“ˆå¸Œç§å­</span>
h<span class="token punctuation">.</span>hash0 <span class="token operator">=</span> <span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†æ ¹æ®hintçš„å€¼è®¡ç®—å‡ºå“ˆå¸Œæ¡¶çš„å®¹é‡ï¼Œå¯¹åº”çš„ä»£ç å¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>B <span class="token operator">:=</span> <span class="token function">uint8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">// ä¸æ–­å¾ªç¯ç›´åˆ° hint / 1 &lt;&lt; B &lt; 6.5</span>
<span class="token keyword">for</span> <span class="token function">overLoadFactor</span><span class="token punctuation">(</span>hint<span class="token punctuation">,</span> B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    B<span class="token operator">++</span>
<span class="token punctuation">}</span>
<span class="token comment">// èµ‹å€¼ç»™hmap</span>
h<span class="token punctuation">.</span>B <span class="token operator">=</span> B
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä¸æ–­å¾ªç¯æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³<code>(hint / 1 &lt;&lt; B) &lt; 6.5</code>çš„Bå€¼ï¼Œå°†å…¶èµ‹å€¼ç»™hmapï¼Œåœ¨çŸ¥æ™“äº†å“ˆå¸Œæ¡¶çš„å®¹é‡åï¼Œæœ€åå°±æ˜¯ä¸ºå“ˆå¸Œæ¡¶åˆ†é…å†…å­˜</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> h<span class="token punctuation">.</span>B <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> nextOverflow <span class="token operator">*</span>bmap
    <span class="token comment">// åˆ†é…å¥½çš„å“ˆå¸Œæ¡¶ï¼Œå’Œé¢„å…ˆåˆ†é…çš„ç©ºé—²æº¢å‡ºæ¡¶</span>
    h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> nextOverflow <span class="token operator">=</span> <span class="token function">makeBucketArray</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">.</span>B<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token comment">// å¦‚æœé¢„å…ˆåˆ†é…äº†ç©ºé—²æº¢å‡ºæ¡¶ï¼Œå°±æŒ‡å‘è¯¥æº¢å‡ºæ¡¶</span>
    <span class="token keyword">if</span> nextOverflow <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        h<span class="token punctuation">.</span>extra <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>mapextra<span class="token punctuation">)</span>
        h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>nextOverflow <span class="token operator">=</span> nextOverflow
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>makeBucketArray</code>å‡½æ•°ä¼šæ ¹æ®Bçš„å€¼ï¼Œä¸ºå“ˆå¸Œæ¡¶åˆ†é…å¯¹åº”å¤§å°çš„å†…å­˜ï¼Œä»¥åŠé¢„å…ˆåˆ†é…ç©ºé—²çš„æº¢å‡ºæ¡¶ï¼Œå½“Bå°äº4æ—¶ï¼Œå°±ä¸ä¼šåˆ›å»ºæº¢å‡ºæ¡¶ï¼Œå¦‚æœå¤§äº4é‚£ä¹ˆå°±ä¼šåˆ›å»º<code>2^B-4</code>ä¸ªæº¢å‡ºæ¡¶ã€‚å¯¹åº”<code>runtime.makeBucketArray</code>å‡½æ•°ä¸­çš„å¦‚ä¸‹ä»£ç </p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>base <span class="token operator">:=</span> <span class="token function">bucketShift</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
nbuckets <span class="token operator">:=</span> base
<span class="token comment">// å°äº4å°±ä¸ä¼šåˆ›å»ºæº¢å‡ºæ¡¶</span>
<span class="token keyword">if</span> b <span class="token operator">&gt;=</span> <span class="token number">4</span> <span class="token punctuation">{</span>
    <span class="token comment">// é¢„è®¡æ¡¶çš„æ•°é‡åŠ ä¸Š1 &lt;&lt; (b-4)</span>
    nbuckets <span class="token operator">+=</span> <span class="token function">bucketShift</span><span class="token punctuation">(</span>b <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token comment">// æº¢å‡ºæ¡¶æ‰€éœ€çš„å†…å­˜</span>
    sz <span class="token operator">:=</span> t<span class="token punctuation">.</span>Bucket<span class="token punctuation">.</span>Size_ <span class="token operator">*</span> nbuckets
    <span class="token comment">// å°†å†…å­˜ç©ºé—´å‘ä¸Šå–æ•´</span>
    up <span class="token operator">:=</span> <span class="token function">roundupsize</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span>
    <span class="token keyword">if</span> up <span class="token operator">!=</span> sz <span class="token punctuation">{</span>
        <span class="token comment">// ä¸ç›¸ç­‰å°±é‡‡ç”¨upé‡æ–°è®¡ç®—</span>
        nbuckets <span class="token operator">=</span> up <span class="token operator">/</span> t<span class="token punctuation">.</span>Bucket<span class="token punctuation">.</span>Size_
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>base</code>æŒ‡çš„æ˜¯é¢„è®¡åˆ†é…æ¡¶çš„æ•°é‡ï¼Œ<code>nbuckets</code>æŒ‡çš„æ˜¯å®é™…åˆ†é…æ¡¶çš„æ•°é‡ï¼Œå®ƒåŠ ä¸Šäº†æº¢å‡ºæ¡¶çš„æ•°é‡ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> base <span class="token operator">!=</span> nbuckets <span class="token punctuation">{</span>
    <span class="token comment">// ç¬¬ä¸€ä¸ªå¯ç”¨çš„æº¢å‡ºæ¡¶</span>
    nextOverflow <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>buckets<span class="token punctuation">,</span> base<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// ä¸ºäº†å‡å°‘è·Ÿè¸ªæº¢å‡ºæ¡¶çš„å¼€é”€ï¼Œå°†æœ€åä¸€ä¸ªå¯ç”¨æº¢å‡ºæ¡¶çš„æº¢å‡ºæŒ‡é’ˆæŒ‡å‘å“ˆå¸Œæ¡¶çš„å¤´éƒ¨</span>
    last <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>buckets<span class="token punctuation">,</span> <span class="token punctuation">(</span>nbuckets<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// æœ€åä¸€ä¸ªæº¢å‡ºæ¡¶æŒ‡å‘å“ˆå¸Œæ¡¶</span>
    last<span class="token punctuation">.</span><span class="token function">setoverflow</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span>buckets<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ä¸¤è€…ä¸ç›¸ç­‰æ—¶ï¼Œå°±è¯´æ˜åˆ†é…äº†é¢å¤–çš„æº¢å‡ºæ¡¶ï¼Œ<code>nextoverflow</code>æŒ‡é’ˆå°±æ˜¯æŒ‡å‘çš„ç¬¬ä¸€ä¸ªå¯ç”¨çš„æº¢å‡ºæ¡¶ã€‚ç”±æ­¤å¯è§ï¼Œå“ˆå¸Œæ¡¶ä¸æº¢å‡ºæ¡¶å…¶å®æ˜¯åœ¨åŒä¸€å—è¿ç»­çš„å†…å­˜ä¸­ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨å›¾ä¸­å“ˆå¸Œæ¡¶æ•°ç»„ä¸æº¢å‡ºæ¡¶æ•°ç»„æ˜¯ç›¸é‚»çš„ã€‚</p><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202310061929859.png" style="zoom:33%;"><h2 id="è®¿é—®" tabindex="-1"><a class="header-anchor" href="#è®¿é—®" aria-hidden="true">#</a> è®¿é—®</h2><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202310062003736.png" style="zoom:33%;"><p>åœ¨è¯­æ³•å…¥é—¨å½“ä¸­è®²åˆ°è¿‡ï¼Œè®¿é—®mapæ€»å…±æœ‰ä¸‰ç§æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code># ç›´æ¥è®¿é—®å€¼
val <span class="token operator">:=</span> dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
# è®¿é—®å€¼ä»¥åŠè¯¥é”®æ˜¯å¦å­˜åœ¨
val<span class="token punctuation">,</span> exist <span class="token operator">:=</span> dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
# éå†<span class="token keyword">map</span>
<span class="token keyword">for</span> key<span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> dict<span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸‰ç§æ–¹å¼æ‰€ç”¨åˆ°çš„å‡½æ•°éƒ½ä¸ç›¸åŒï¼Œå…¶ä¸­<code>for range</code>éå†mapæœ€ä¸ºå¤æ‚ã€‚</p><h3 id="é”®å€¼" tabindex="-1"><a class="header-anchor" href="#é”®å€¼" aria-hidden="true">#</a> é”®å€¼</h3><p>å¯¹äºå‰ä¸¤ç§æ–¹å¼è€Œè¨€ï¼Œå¯¹åº”ç€ä¸¤ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯<code>runtime.mapaccess1</code>å’Œ<code>runtime.mapaccess2</code>ï¼Œå‡½æ•°ç­¾åå¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapaccess1</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer

<span class="token keyword">func</span> <span class="token function">mapaccess2</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­çš„keyæ˜¯æŒ‡å‘è®¿é—®mapçš„é”®çš„æŒ‡é’ˆï¼Œè¿”å›çš„æ—¶å€™ä¹Ÿåªä¼šè¿”å›æŒ‡é’ˆã€‚åœ¨è®¿é—®æ—¶ï¼Œé¦–å…ˆéœ€è¦è®¡ç®—keyçš„å“ˆå¸Œå€¼ï¼Œå®šä½keyåœ¨å“ªä¸ªå“ˆå¸Œæ¡¶ï¼Œå¯¹åº”ä»£ç å¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// è¾¹ç•Œå¤„ç†</span>
<span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> h<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">HashMightPanic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Hasher</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// see issue 23734</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zeroVal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// é˜²æ­¢å¹¶å‘è¯»å†™</span>
<span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>hashWriting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">&quot;concurrent map read and map write&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// ä½¿ç”¨æŒ‡å®šç±»å‹çš„hasherè®¡ç®—å“ˆå¸Œå€¼</span>
hash <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Hasher</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hash0<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// (1 &lt;&lt; B) - 1</span>
m <span class="token operator">:=</span> <span class="token function">bucketMask</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>B<span class="token punctuation">)</span>
<span class="token comment">// é€šè¿‡ç§»åŠ¨æŒ‡é’ˆå®šä½keyæ‰€åœ¨çš„å“ˆå¸Œæ¡¶</span>
b <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> <span class="token punctuation">(</span>hash<span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è®¿é—®çš„ä¸€å¼€å§‹å…ˆè¿›è¡Œè¾¹ç•Œæƒ…å†µå¤„ç†ï¼Œå¹¶é˜²æ­¢mapå¹¶å‘è¯»å†™ï¼Œå½“mapå¤„äºå¹¶å‘è¯»å†™çŠ¶æ€æ—¶ï¼Œå°±ä¼šå‘ç”Ÿpanicã€‚å†ç„¶åè®¡ç®—å“ˆå¸Œå€¼ï¼Œ<code>bucketMask</code>å‡½æ•°æ‰€å¹²çš„äº‹å°±æ˜¯è®¡ç®—<code>(1 &lt;&lt; B) - 1 </code>ï¼Œ<code>hash &amp; m</code>å°±ç­‰äº<code>hash &amp; (1 &lt;&lt; B) - 1 </code>ï¼Œè¿™æ˜¯äºŒè¿›åˆ¶å–ä½™æ“ä½œï¼Œç­‰ä»·äº<code>hash % (1 &lt;&lt; B)</code>ï¼Œä½¿ç”¨ä½è¿ç®—çš„å¥½å¤„å°±æ˜¯æ›´å¿«ã€‚æœ€åä¸‰è¡Œä»£ç å¹²çš„äº‹å°±æ˜¯å°†keyè®¡ç®—å¾—åˆ°çš„å“ˆå¸Œå€¼ä¸å½“å‰mapä¸­çš„æ¡¶çš„æ•°é‡å–ä½™ï¼Œå¾—åˆ°å“ˆå¸Œæ¡¶çš„åºå·ï¼Œç„¶åæ ¹æ®åºå·ç§»åŠ¨æŒ‡é’ˆè·å–keyæ‰€åœ¨çš„å“ˆå¸Œæ¡¶æŒ‡é’ˆã€‚</p><p>åœ¨çŸ¥æ™“äº†keyåœ¨å“ªä¸ªå“ˆå¸Œæ¡¶åï¼Œå°±å¯ä»¥å±•å¼€æŸ¥æ‰¾äº†ï¼Œè¿™éƒ¨åˆ†å¯¹åº”ä»£ç å¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>	<span class="token comment">// è·å–å“ˆå¸Œå€¼çš„é«˜å…«ä½</span>
	top <span class="token operator">:=</span> <span class="token function">tophash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
bucketloop<span class="token punctuation">:</span>
	<span class="token comment">// éå†bmapé“¾è¡¨</span>
	<span class="token keyword">for</span> <span class="token punctuation">;</span> b <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// bmapä¸­çš„å…ƒç´ </span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            <span class="token comment">//  å°†è®¡ç®—å¾—å‡ºçš„topä¸tophashä¸­çš„å…ƒç´ è¿›è¡Œå¯¹æ¯”</span>
			<span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> top <span class="token punctuation">{</span>
                <span class="token comment">// åç»­éƒ½æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰äº†ã€‚</span>
				<span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> emptyRest <span class="token punctuation">{</span>
					<span class="token keyword">break</span> bucketloop
				<span class="token punctuation">}</span>
                <span class="token comment">// ä¸ç›¸ç­‰å°±ç»§ç»­éå†æº¢å‡ºæ¡¶</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
            <span class="token comment">// æ ¹æ®iç§»åŠ¨æŒ‡é’ˆè·å–å¯¹åº”ä¸‹æ ‡çš„é”®</span>
			k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// å¤„ç†ä¸‹æŒ‡é’ˆ</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				k <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
            <span class="token comment">// æ¯”å¯¹ä¸¤ä¸ªé”®æ˜¯å¦ç›¸ç­‰</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœç›¸ç­‰çš„è¯ï¼Œå°±ç§»åŠ¨æŒ‡é’ˆè¿”å›kå¯¹åº”ä¸‹æ ‡çš„å…ƒç´ </span>
                <span class="token comment">// ä»è¿™è¡Œä»£ç å°±èƒ½çœ‹å‡ºæ¥é”®å€¼çš„å†…å­˜åœ°å€æ˜¯è¿ç»­çš„</span>
				e <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					e <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
                
				<span class="token keyword">return</span> e
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token comment">// æ²¡æ‰¾åˆ°ï¼Œè¿”å›é›¶å€¼ã€‚</span>
<span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zeroVal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨å®šä½å“ˆå¸Œæ¡¶æ—¶ï¼Œæ˜¯é€šè¿‡å–ä½™æ¥å®šä½çš„ï¼Œæ‰€ä»¥keyåœ¨å“ªä¸ªå“ˆå¸Œæ¡¶å–å†³äºå“ˆå¸Œå€¼çš„ä½ä½ï¼Œè‡³äºåˆ°åº•æ˜¯ä½å‡ ä½è¿™å–å†³äºBçš„å¤§å°ï¼Œè€Œæ‰¾åˆ°äº†å“ˆå¸Œæ¡¶åï¼Œå…¶ä¸­çš„tophashå­˜æ”¾çš„æ˜¯å“ˆå¸Œå€¼çš„é«˜å…«ä½ï¼Œå› ä¸ºä½ä½å–ä½™å€¼éƒ½æ˜¯ç›¸åŒçš„ï¼Œè¿™æ ·å°±ä¸éœ€è¦å»ä¸€ä¸ªä¸ªå¯¹æ¯”keyæ˜¯å¦ç›¸ç­‰ï¼Œåªå¯¹æ¯”å“ˆå¸Œå€¼é«˜å…«ä½å°±å¤Ÿäº†ã€‚æ ¹æ®å…ˆå‰è®¡ç®—å¾—åˆ°çš„å“ˆå¸Œå€¼è·å–å…¶é«˜å…«ä½ï¼Œåœ¨bmapä¸­çš„tophashæ•°ç»„ä¸€ä¸ªä¸ªå¯¹æ¯”ï¼Œå¦‚æœé«˜å…«ä½ç›¸ç­‰çš„è¯ï¼Œå†å¯¹æ¯”é”®æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœé”®ä¹Ÿç›¸ç­‰çš„è¯å°±è¯´æ˜æ‰¾åˆ°äº†å…ƒç´ ï¼Œä¸ç›¸ç­‰å°±ç»§ç»­éå†tophashæ•°ç»„ï¼Œè¿˜æ‰¾ä¸åˆ°å°±ç»§ç»­éå†æº¢å‡ºæ¡¶bmapé“¾è¡¨ï¼Œç›´åˆ°bmapçš„<code>tophash[i]</code>ä¸º<code>emptyRest</code>é€€å‡ºå¾ªç¯ï¼Œæœ€åè¿”å›å¯¹åº”ç±»å‹çš„é›¶å€¼ã€‚</p><p><code>mapaccess2</code> å‡½æ•°ä¸<code>mapaccess1</code>å‡½æ•°é€»è¾‘å®Œå…¨ä¸€è‡´ï¼Œä»…ä»…å¤šäº†ä¸€ä¸ªå¸ƒå°”è¿”å›å€¼ï¼Œç”¨äºè¡¨ç¤ºå…ƒç´ æ˜¯å¦å­˜åœ¨ã€‚</p><h3 id="éå†" tabindex="-1"><a class="header-anchor" href="#éå†" aria-hidden="true">#</a> éå†</h3><p>éå†mapçš„è¯­æ³•å¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> key<span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> dict <span class="token punctuation">{</span>
	<span class="token comment">// do somthing...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨å®é™…è¿›è¡Œéå†æ—¶ï¼Œgoä½¿ç”¨äº†<code>hiter</code>ç»“æ„ä½“æ¥å­˜æ”¾éå†ä¿¡æ¯ï¼Œ<code>hiter</code>å°±æ˜¯<code>hmap interator</code>çš„ç®€å†™ï¼Œæ„ä¸ºå“ˆå¸Œè¡¨è¿­ä»£å™¨ï¼Œç»“æ„å¦‚ä¸‹æ‰€ç¤ºã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// A hash iteration structure.</span>
<span class="token comment">// If you modify hiter, also change cmd/compile/internal/reflectdata/reflect.go</span>
<span class="token comment">// and reflect/value.go to match the layout of this structure.</span>
<span class="token keyword">type</span> hiter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	key         unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// Must be in first position.  Write nil to indicate iteration end (see cmd/compile/internal/walk/range.go).</span>
	elem        unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// Must be in second position (see cmd/compile/internal/walk/range.go).</span>
	t           <span class="token operator">*</span>maptype
	h           <span class="token operator">*</span>hmap
	buckets     unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// bucket ptr at hash_iter initialization time</span>
	bptr        <span class="token operator">*</span>bmap          <span class="token comment">// current bucket</span>
	overflow    <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>bmap       <span class="token comment">// keeps overflow buckets of hmap.buckets alive</span>
	oldoverflow <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>bmap       <span class="token comment">// keeps overflow buckets of hmap.oldbuckets alive</span>
	startBucket <span class="token builtin">uintptr</span>        <span class="token comment">// bucket iteration started at</span>
	offset      <span class="token builtin">uint8</span>          <span class="token comment">// intra-bucket offset to start from during iteration (should be big enough to hold bucketCnt-1)</span>
	wrapped     <span class="token builtin">bool</span>           <span class="token comment">// already wrapped around from end of bucket array to beginning</span>
	B           <span class="token builtin">uint8</span>
	i           <span class="token builtin">uint8</span>
	bucket      <span class="token builtin">uintptr</span>
	checkBucket <span class="token builtin">uintptr</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢å¯¹å®ƒçš„ä¸€äº›å­—æ®µåšä¸€äº›ç®€å•çš„è§£é‡Š</p><ul><li><code>key</code>ï¼Œ<code>elem</code>å°±æ˜¯<code>for range</code>éå†æ—¶è·å–åˆ°çš„é”®å€¼</li><li><code>buckets</code>ï¼Œåœ¨åˆå§‹åŒ–è¿­ä»£å™¨æ—¶æŒ‡å®šï¼ŒæŒ‡å‘å“ˆå¸Œæ¡¶çš„å¤´éƒ¨</li><li><code>bptr</code>ï¼Œå½“å‰æ­£åœ¨éå†çš„bmap</li><li><code>startBucket</code>ï¼Œè¿­ä»£å¼€å§‹æ—¶çš„èµ·å§‹æ¡¶åºå·</li><li><code>offset</code>ï¼Œæ¡¶å†…åç§»é‡ï¼ŒèŒƒå›´<code>[0, bucketCnt-1]</code></li><li><code>B</code>ï¼Œå°±æ˜¯hmapçš„Bå€¼ï¼Œ</li><li><code>i</code>ï¼Œæ¡¶å†…å…ƒç´ ä¸‹æ ‡</li><li><code>wrapped</code>ï¼Œæ˜¯å¦ä»å“ˆå¸Œæ¡¶æ•°ç»„æœ«å°¾å›åˆ°äº†å¤´éƒ¨</li></ul><p>åœ¨éå†å¼€å§‹å‰ï¼Œgoé€šè¿‡<code>runtime.mapiterinit</code>å‡½æ•°æ¥åˆå§‹åŒ–éå†å™¨ï¼Œç„¶åå†é€šè¿‡å‡½æ•°<code>runtime.mapinternext</code>å¯¹mapè¿›è¡Œéå†ï¼Œä¸¤è€…éƒ½éœ€è¦ç”¨åˆ°<code>hiter</code>ç»“æ„ä½“ï¼Œä¸¤ä¸ªå‡½æ•°ç­¾åå¦‚ä¸‹ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapiterinit</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> it <span class="token operator">*</span>hiter<span class="token punctuation">)</span> 

<span class="token keyword">func</span> <span class="token function">mapiternext</span><span class="token punctuation">(</span>it <span class="token operator">*</span>hiter<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºè¿­ä»£å™¨åˆå§‹åŒ–è€Œè¨€ï¼Œé¦–å…ˆè¦è·å–mapå½“å‰çš„ä¸€ä¸ªå¿«ç…§ï¼Œå¯¹åº”å¦‚ä¸‹çš„ä»£ç ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>it<span class="token punctuation">.</span>t <span class="token operator">=</span> t
it<span class="token punctuation">.</span>h <span class="token operator">=</span> h
<span class="token comment">// è®°å½•hmapå½“å‰çŠ¶æ€çš„å¿«ç…§ï¼Œåªéœ€è¦ä¿å­˜Bå€¼ã€‚</span>
it<span class="token punctuation">.</span>B <span class="token operator">=</span> h<span class="token punctuation">.</span>B
it<span class="token punctuation">.</span>buckets <span class="token operator">=</span> h<span class="token punctuation">.</span>buckets
<span class="token keyword">if</span> t<span class="token punctuation">.</span>Bucket<span class="token punctuation">.</span>PtrBytes <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    h<span class="token punctuation">.</span><span class="token function">createOverflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    it<span class="token punctuation">.</span>overflow <span class="token operator">=</span> h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>overflow
    it<span class="token punctuation">.</span>oldoverflow <span class="token operator">=</span> h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>oldoverflow
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åç»­åœ¨è¿­ä»£æ—¶ï¼Œå®é™…ä¸Šéå†çš„æ˜¯mapçš„ä¸€ä¸ªå¿«ç…§ï¼Œè€Œéå®é™…çš„mapï¼Œæ‰€ä»¥åœ¨éå†è¿‡ç¨‹ä¸­æ·»åŠ çš„å…ƒç´ å’Œæ¡¶éƒ½ä¸ä¼šè¢«éå†åˆ°ï¼Œå¹¶ä¸”åŒæ—¶å¹¶å‘éå†å†™å…¥å…ƒç´ ï¼Œæœ‰å¯èƒ½è§¦å‘<code>fatal</code>ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>hashWriting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">&quot;concurrent map iteration and map write&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬äºŒæ­¥å†å†³å®šéå†çš„ä¸¤ä¸ªèµ·å§‹ä½ç½®ï¼Œç¬¬ä¸€ä¸ªæ˜¯èµ·å§‹æ¡¶çš„ä½ç½®ï¼Œç¬¬äºŒä¸ªæ¡¶å†…çš„èµ·å§‹ä½ç½®ï¼Œè¿™ä¸¤ä¸ªéƒ½æ˜¯éšæœºé€‰çš„ï¼Œå¯¹åº”å¦‚ä¸‹ä»£ç </p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// ræ˜¯ä¸€ä¸ªéšæœºæ•°</span>
<span class="token keyword">var</span> r <span class="token builtin">uintptr</span>
<span class="token keyword">if</span> h<span class="token punctuation">.</span>B <span class="token operator">&gt;</span> <span class="token number">31</span><span class="token operator">-</span>bucketCntBits <span class="token punctuation">{</span>
    r <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">fastrand64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    r <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// r % (1 &lt;&lt; B) å¾—åˆ°èµ·å§‹æ¡¶çš„ä½ç½®</span>
it<span class="token punctuation">.</span>startBucket <span class="token operator">=</span> r <span class="token operator">&amp;</span> <span class="token function">bucketMask</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>B<span class="token punctuation">)</span>
<span class="token comment">// r &gt;&gt; B % 8 å¾—åˆ°èµ·å§‹æ¡¶å†…çš„å…ƒç´ èµ·å§‹ä½ç½®</span>
it<span class="token punctuation">.</span>offset <span class="token operator">=</span> <span class="token function">uint8</span><span class="token punctuation">(</span>r <span class="token operator">&gt;&gt;</span> h<span class="token punctuation">.</span>B <span class="token operator">&amp;</span> <span class="token punctuation">(</span>bucketCnt <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// è®°å½•å½“å‰æ­£åœ¨éå†çš„æ¡¶åºå·</span>
it<span class="token punctuation">.</span>bucket <span class="token operator">=</span> it<span class="token punctuation">.</span>startBucket
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡<code>fastrand()</code>æˆ–<code>fastrand64()</code>è·å–ä¸€ä¸ªéšæœºæ•°ï¼Œä¸¤æ¬¡å–æ¨¡è¿ç®—å¾—åˆ°æ¡¶èµ·å§‹ä½ç½®å’Œæ¡¶å†…èµ·å§‹ä½ç½®ã€‚</p><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>mapè™½ç„¶ä¸å…è®¸åŒæ—¶å¹¶å‘è¯»å†™ï¼Œä½†æ˜¯å…è®¸åŒæ—¶å¹¶å‘éå†ã€‚</p></div><p>æ¥ä¸‹æ¥æ‰çœŸæ­£å¼€å§‹è¿­ä»£mapï¼Œå¦‚ä½•å¯¹æ¡¶è¿›è¡Œéå†ï¼Œä»¥åŠé€€å‡ºçš„ç­–ç•¥ï¼Œè¿™éƒ¨åˆ†å¯¹åº”ä¸‹é¢çš„ä»£ç </p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// hmap</span>
h <span class="token operator">:=</span> it<span class="token punctuation">.</span>h
<span class="token comment">// maptype</span>
t <span class="token operator">:=</span> it<span class="token punctuation">.</span>t
<span class="token comment">// å¾…éå†çš„æ¡¶çš„ä½ç½®</span>
bucket <span class="token operator">:=</span> it<span class="token punctuation">.</span>bucket
<span class="token comment">// å¾…éå†çš„bmap</span>
b <span class="token operator">:=</span> it<span class="token punctuation">.</span>bptr
<span class="token comment">// æ¡¶å†…åºå·i</span>
i <span class="token operator">:=</span> it<span class="token punctuation">.</span>i

next<span class="token punctuation">:</span>
	<span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœå½“å‰æ¡¶çš„ä½ç½®ä¸èµ·å§‹ä½ç½®ç›¸ç­‰ï¼Œè¯´æ˜æ˜¯ç»•äº†ä¸€åœˆå›æ¥ï¼Œåé¢çš„å·²ç»éå†è¿‡äº†</span>
        <span class="token comment">// éå†ç»“æŸï¼Œå¯ä»¥é€€å‡ºäº†</span>
		<span class="token keyword">if</span> bucket <span class="token operator">==</span> it<span class="token punctuation">.</span>startBucket <span class="token operator">&amp;&amp;</span> it<span class="token punctuation">.</span>wrapped <span class="token punctuation">{</span>
			it<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token boolean">nil</span>
			it<span class="token punctuation">.</span>elem <span class="token operator">=</span> <span class="token boolean">nil</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// æ¡¶ä¸‹æ ‡åç§»</span>
		bucket<span class="token operator">++</span>
        <span class="token comment">// bucket == 1 &lt;&lt; Bï¼Œå°±æ˜¯èµ°åˆ°å“ˆå¸Œæ¡¶æ•°ç»„çš„æœ«å°¾äº†</span>
		<span class="token keyword">if</span> bucket <span class="token operator">==</span> <span class="token function">bucketShift</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ä»å¤´å¼€å§‹</span>
			bucket <span class="token operator">=</span> <span class="token number">0</span>
			it<span class="token punctuation">.</span>wrapped <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
		i <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å“ˆå¸Œæ¡¶çš„èµ·å§‹ä½ç½®é€‰å–æ˜¯éšæœºçš„ï¼Œåœ¨éå†æ—¶ï¼Œä»èµ·å§‹ä½ç½®å‘æ¡¶åˆ‡ç‰‡çš„æœ«å°¾é€ä¸ªè¿­ä»£ï¼Œèµ°åˆ°<code>1 &lt;&lt; B</code>æ—¶ï¼Œç„¶åå†ä»å¤´å¼€å§‹ï¼Œå½“å†æ¬¡å›åˆ°èµ·å§‹ä½ç½®æ—¶ï¼Œè¯´æ˜å·²ç»éå†å®Œæ¯•ï¼Œç„¶åé€€å‡ºã€‚ä¸Šé¢çš„ä»£ç æ˜¯å…³äºå¦‚ä½•åœ¨mapä¸­éå†æ¡¶ï¼Œè€Œä¸‹é¢çš„ä»£ç æè¿°çš„å°±æ˜¯å¦‚ä½•åœ¨æ¡¶å†…è¿›è¡Œéå†ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token comment">// (i + offset) % 8</span>
		offi <span class="token operator">:=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> it<span class="token punctuation">.</span>offset<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>bucketCnt <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token comment">// å¦‚æœå½“å‰å…ƒç´ æ˜¯ç©ºçš„å°±è·³è¿‡</span>
		<span class="token keyword">if</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>offi<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>offi<span class="token punctuation">]</span> <span class="token operator">==</span> evacuatedEmpty <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// ç§»åŠ¨æŒ‡é’ˆè·å–é”®</span>
		k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span><span class="token function">uintptr</span><span class="token punctuation">(</span>offi<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			k <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
    	<span class="token comment">// ç§»åŠ¨æŒ‡é’ˆè·å–å€¼</span>
		e <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">uintptr</span><span class="token punctuation">(</span>offi<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
    	
		<span class="token comment">// å¤„ç†ç­‰é‡æ‰©å®¹çš„æƒ…å†µï¼Œå½“é”®å€¼è¢«ç–æ•£åˆ°äº†å…¶å®ƒä½ç½®åï¼Œéœ€è¦é‡æ–°å»å¯»æ‰¾é”®å€¼ã€‚</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>offi<span class="token punctuation">]</span> <span class="token operator">!=</span> evacuatedX <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>offi<span class="token punctuation">]</span> <span class="token operator">!=</span> evacuatedY<span class="token punctuation">)</span> <span class="token operator">||</span>
			<span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">ReflexiveKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			it<span class="token punctuation">.</span>key <span class="token operator">=</span> k
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			it<span class="token punctuation">.</span>elem <span class="token operator">=</span> e
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
			rk<span class="token punctuation">,</span> re <span class="token operator">:=</span> <span class="token function">mapaccessK</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
			<span class="token keyword">if</span> rk <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			it<span class="token punctuation">.</span>key <span class="token operator">=</span> rk
			it<span class="token punctuation">.</span>elem <span class="token operator">=</span> re
		<span class="token punctuation">}</span>
		it<span class="token punctuation">.</span>bucket <span class="token operator">=</span> bucket
		it<span class="token punctuation">.</span>i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// æ²¡æ‰¾åˆ°å°±å»æº¢å‡ºæ¡¶é‡Œé¢æ‰¾</span>
	b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	i <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token keyword">goto</span> next
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>åœ¨ä¸Šé¢çš„æ‰©å®¹åˆ¤æ–­æ¡ä»¶ä¸­ï¼Œæœ‰ä¸€ä¸ªè¡¨è¾¾å¼å¯èƒ½ä¼šè®©äººæ„Ÿåˆ°å›°æƒ‘ï¼Œå¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¹‹æ‰€ä»¥è¦å»åˆ¤æ–­<code>k</code>æ˜¯å¦ä¸è‡ªèº«ç›¸ç­‰ï¼Œæ˜¯ä¸ºäº†è¿‡æ»¤é”®ä¸º<code>Nan</code>çš„æƒ…å†µï¼Œå¦‚æœä¸€ä¸ªå…ƒç´ çš„é”®æ˜¯<code>Nan</code>ï¼Œé‚£ä¹ˆå°±ä¼šæ— æ³•æ­£å¸¸è®¿é—®è¯¥å…ƒç´ ï¼Œæ— è®ºæ˜¯éå†è¿˜æ˜¯ç›´æ¥è®¿é—®ï¼Œæˆ–è€…æ˜¯åˆ é™¤éƒ½æ— æ³•æ­£å¸¸è¿›è¡Œï¼Œå› ä¸º<code>Nan != Nan</code>æ°¸è¿œæˆç«‹ï¼Œä¹Ÿå°±æ°¸è¿œæ— æ³•æ‰¾åˆ°è¿™ä¸ªé”®ã€‚</p></div><p>é¦–å…ˆæ ¹æ®<code>i</code>å€¼å’Œ<code>offset</code>å€¼å–æ¨¡è¿ç®—å¾—åˆ°å¾…éå†çš„æ¡¶å†…ä¸‹æ ‡ï¼Œé€šè¿‡ç§»åŠ¨æŒ‡é’ˆè·å–é”®å€¼ï¼Œç”±äºåœ¨mapéå†æœŸé—´ï¼Œä¼šæœ‰å…¶å®ƒçš„å†™å…¥æ“ä½œè§¦å‘äº†mapçš„æ‰©å®¹ï¼Œæ‰€ä»¥å®é™…çš„é”®å€¼å¯èƒ½å·²ç»ä¸åœ¨åŸæ¥çš„ä½ç½®äº†ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å°±éœ€è¦ä½¿ç”¨<code>mapaccessK</code>å‡½æ•°å»é‡æ–°è·å–å®é™…çš„é”®å€¼ï¼Œè¯¥å‡½æ•°ç­¾åå¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapaccessK</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å®ƒçš„åŠŸèƒ½ä¸<code>mapaccess1</code>å‡½æ•°å®Œå…¨ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äº<code>mapaccessK</code>å‡½æ•°ä¼šåŒæ—¶è¿”å›keyå€¼å’Œvalueå€¼ã€‚æœ€ç»ˆè·å–åˆ°äº†é”®å€¼ä»¥åï¼Œå°†å…¶èµ‹å€¼ç»™è¿­ä»£å™¨çš„<code>key</code>ï¼Œ<code>elem</code>ï¼Œç„¶åæ›´æ–°è¿­ä»£å™¨çš„ä¸‹æ ‡ï¼Œè¿™æ ·å°±å®Œæˆäº†ä¸€æ¬¡è¿­ä»£ï¼Œä»£ç æ‰§è¡Œå°±å›åˆ°äº†<code>for range</code>çš„ä»£ç å—ä¸­ã€‚å¦‚æœåœ¨æ¡¶å†…æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±å†å»æº¢å‡ºæ¡¶é‡Œé¢æ‰¾ï¼Œç»§ç»­é‡å¤ä¸Šé¢çš„æ­¥éª¤ï¼Œç›´åˆ°æº¢å‡ºæ¡¶é“¾è¡¨éå†å®Œæ¯•åï¼Œå†ç»§ç»­è¿­ä»£ä¸‹ä¸€ä¸ªå“ˆå¸Œæ¡¶ã€‚</p><h2 id="ä¿®æ”¹" tabindex="-1"><a class="header-anchor" href="#ä¿®æ”¹" aria-hidden="true">#</a> ä¿®æ”¹</h2><p>ä¿®æ”¹mapçš„è¯­æ³•å¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åœ¨goä¸­ï¼Œå¯¹äºä¿®æ”¹mapçš„æ“ä½œï¼Œç”±<code>runtime.mapassign</code>å‡½æ•°æ¥å®Œæˆï¼Œè¯¥å‡½æ•°ç­¾åå¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapassign</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å…¶è®¿é—®è¿‡ç¨‹çš„é€»è¾‘ä¸<code>mapaccess1</code>ç›¸åŒï¼Œä¸è¿‡keyä¸å­˜åœ¨æ—¶ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªä½ç½®ï¼Œå¦‚æœå­˜åœ¨å°±æ›´æ–°ï¼Œæœ€åè¿”å›å…ƒç´ çš„æŒ‡é’ˆã€‚åœ¨å¼€å§‹æ—¶ï¼Œéœ€è¦åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œè¿™éƒ¨åˆ†å¯¹åº”çš„ä»£ç å¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// ä¸å…è®¸å†™å…¥ä¸ºnilçš„map</span>
<span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token function">plainError</span><span class="token punctuation">(</span><span class="token string">&quot;assignment to entry in nil map&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// ç¦æ­¢åŒæ—¶å¹¶å‘å†™</span>
<span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>hashWriting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">&quot;concurrent map writes&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// è®¡ç®—keyå“ˆå¸Œå€¼</span>
hash <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Hasher</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hash0<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// ä¿®æ”¹hmapçŠ¶æ€</span>
h<span class="token punctuation">.</span>flags <span class="token operator">^=</span> hashWriting

<span class="token comment">// åˆå§‹åŒ–å“ˆå¸Œæ¡¶</span>
<span class="token keyword">if</span> h<span class="token punctuation">.</span>buckets <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    h<span class="token punctuation">.</span>buckets <span class="token operator">=</span> <span class="token function">newobject</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Bucket<span class="token punctuation">)</span> <span class="token comment">// newarray(t.Bucket, 1)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹</p><ul><li>hmapçŠ¶æ€æ£€æŸ¥</li><li>è®¡ç®—keyçš„å“ˆå¸Œå€¼</li><li>æ£€æŸ¥å“ˆå¸Œæ¡¶æ˜¯å¦éœ€è¦åˆå§‹åŒ–</li></ul><p>å†ä¹‹åé€šè¿‡å“ˆå¸Œå€¼å–æ¨¡è¿ç®—å¾—åˆ°å“ˆå¸Œæ¡¶ä½ç½®ï¼Œä»¥åŠkeyçš„tophashï¼Œä»£ç å¯¹åº”å¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>again<span class="token punctuation">:</span>
	<span class="token comment">// hash % (1 &lt;&lt; B)</span>
	bucket <span class="token operator">:=</span> hash <span class="token operator">&amp;</span> <span class="token function">bucketMask</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>B<span class="token punctuation">)</span>
	<span class="token comment">// ç§»åŠ¨æŒ‡é’ˆè·å–æŒ‡å®šä½ç½®çš„bmap</span>
	b <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> bucket<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// è®¡ç®—tophash</span>
	top <span class="token operator">:=</span> <span class="token function">tophash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ç¡®å®šäº†æ¡¶çš„ä½ç½®ï¼Œbmapï¼Œtophashï¼Œå°±å¯ä»¥å¼€å§‹æŸ¥æ‰¾å…ƒç´ äº†ï¼Œè¿™éƒ¨åˆ†ä»£ç å¯¹åº”å¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// å¾…æ’å…¥çš„tophash</span>
<span class="token keyword">var</span> inserti <span class="token operator">*</span><span class="token builtin">uint8</span>
<span class="token comment">// å¾…æ’å…¥çš„keyå€¼æŒ‡é’ˆ</span>
<span class="token keyword">var</span> insertk unsafe<span class="token punctuation">.</span>Pointer
<span class="token comment">// å¾…æ’å…¥çš„valueå€¼æŒ‡é’ˆ</span>
<span class="token keyword">var</span> elem unsafe<span class="token punctuation">.</span>Pointer

bucketloop<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token comment">// éå†æ¡¶å†…çš„tophashæ•°ç»„</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            <span class="token comment">// tophashä¸ç›¸ç­‰</span>
			<span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> top <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœå½“å‰æ¡¶å†…ä¸‹æ ‡æ˜¯ç©ºçš„ï¼Œä¸”è¿˜æ²¡æœ‰æ’å…¥å…ƒç´ ï¼Œå°±é€‰å–è¯¥ä½ç½®æ’å…¥</span>
				<span class="token keyword">if</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> inserti <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æ‰¾åˆ°äº†ä¸€ä¸ªåˆé€‚çš„ä½ç½®åˆ†é…ç»™key</span>
					inserti <span class="token operator">=</span> <span class="token operator">&amp;</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
					insertk <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
					elem <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
                <span class="token comment">// éå†å®Œäº†å°±é€€å‡ºå¾ªç¯</span>
				<span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> emptyRest <span class="token punctuation">{</span>
					<span class="token keyword">break</span> bucketloop
				<span class="token punctuation">}</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
            <span class="token comment">// å¦‚æœtophashç›¸ç­‰çš„è¯ï¼Œåˆ™è¯´æ˜keyå¯èƒ½å·²ç»å­˜åœ¨äº†</span>
			k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				k <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
            <span class="token comment">// åˆ¤æ–­keyæ˜¯å¦ç›¸ç­‰</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// å¦‚æœéœ€è¦æ›´æ–°keyå€¼çš„è¯ï¼Œå°±å°†keyçš„å†…å­˜ç›´æ¥å¤åˆ¶åˆ°kå¤„</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">NeedKeyUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> k<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
            <span class="token comment">// å¾—åˆ°äº†å…ƒç´ çš„æŒ‡é’ˆ</span>
			elem <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// æ›´æ–°å®Œæ¯•ï¼Œè¿”å›å…ƒç´ æŒ‡é’ˆ</span>
			<span class="token keyword">goto</span> done
		<span class="token punctuation">}</span>
        <span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜æ²¡æ‰¾åˆ°keyï¼Œéå†æº¢å‡ºæ¡¶é“¾è¡¨ï¼Œç»§ç»­æ‰¾</span>
		ovf <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
		<span class="token keyword">if</span> ovf <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		b <span class="token operator">=</span> ovf
	<span class="token punctuation">}</span>

	<span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜keyæ²¡æœ‰å­˜åœ¨äºmapä¸­ï¼Œä½†å¯èƒ½å·²ç»æ‰¾åˆ°äº†ä¸€ä¸ªåˆé€‚çš„ä½ç½®åˆ†é…ç»™keyï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰</span>
	
	<span class="token comment">// æ²¡æœ‰æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„ä½ç½®åˆ†é…ç»™key</span>
	<span class="token keyword">if</span> inserti <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¯´æ˜å½“å‰çš„å“ˆå¸Œæ¡¶ä»¥åŠå®ƒçš„æº¢å‡ºæ¡¶éƒ½æ»¡äº†ï¼Œé‚£å°±å†åˆ†é…ä¸€ä¸ªæº¢å‡ºæ¡¶</span>
		newb <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">newoverflow</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
        <span class="token comment">// åœ¨æº¢å‡ºæ¡¶ä¸­åˆ†é…ä¸€ä¸ªä½ç½®ç»™key</span>
		inserti <span class="token operator">=</span> <span class="token operator">&amp;</span>newb<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
		insertk <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>newb<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token punctuation">)</span>
		elem <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>insertk<span class="token punctuation">,</span> bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// å¦‚æœå­˜æ”¾çš„æ˜¯keyæŒ‡é’ˆçš„è¯</span>
	<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ–°åˆ†é…å†…å­˜ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªunsafeæŒ‡é’ˆ</span>
		kmem <span class="token operator">:=</span> <span class="token function">newobject</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>insertk<span class="token punctuation">)</span> <span class="token operator">=</span> kmem
        <span class="token comment">// èµ‹å€¼ç»™insertkï¼Œæ–¹ä¾¿åé¢è¿›è¡Œkeyçš„å†…å­˜å¤åˆ¶</span>
		insertk <span class="token operator">=</span> kmem
	<span class="token punctuation">}</span>
	
	<span class="token comment">// å¦‚æœå­˜æ”¾çš„æ˜¯å…ƒç´ æŒ‡é’ˆ</span>
	<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ†é…å†…å­˜</span>
		vmem <span class="token operator">:=</span> <span class="token function">newobject</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Elem<span class="token punctuation">)</span>
        <span class="token comment">// è®©æŒ‡é’ˆæŒ‡å‘vmem</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token operator">=</span> vmem
	<span class="token punctuation">}</span>
	<span class="token comment">// å°†keyçš„å†…å­˜ç›´æ¥å¤åˆ¶åˆ°insertkçš„ä½ç½®</span>
	<span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> insertk<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token operator">*</span>inserti <span class="token operator">=</span> top
	<span class="token comment">// æ•°é‡åŠ ä¸€</span>
	h<span class="token punctuation">.</span>count<span class="token operator">++</span>

done<span class="token punctuation">:</span>
	<span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜ä¿®æ”¹è¿‡ç¨‹å·²ç»å®Œæˆäº†</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>hashWriting <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">&quot;concurrent map writes&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	h<span class="token punctuation">.</span>flags <span class="token operator">&amp;^=</span> hashWriting
	<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		elem <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// è¿”å›å…ƒç´ æŒ‡é’ˆ</span>
	<span class="token keyword">return</span> elem
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿°ä¸€å¤§æ®µä»£ç ä¸­ï¼Œé¦–å…ˆè¿›å…¥forå¾ªç¯å°è¯•åœ¨å“ˆå¸Œæ¡¶å’Œæº¢å‡ºæ¡¶ä¸­å»æŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾çš„é€»è¾‘ä¸<code>mapaccess</code>å®Œå…¨ä¸€è‡´ï¼Œæ­¤æ—¶æœ‰ä¸‰ç§å¯èƒ½</p><ul><li>ç¬¬ä¸€ç§ï¼Œåœ¨mapä¸­æ‰¾åˆ°äº†å·²ç»å­˜åœ¨çš„keyï¼Œç›´æ¥è·³åˆ°<code>done</code>ä»£ç å—ï¼Œè¿”å›å…ƒç´ æŒ‡é’ˆ</li><li>ç¬¬äºŒç§ï¼Œåœ¨mapä¸­æ‰¾åˆ°äº†ä¸€ä¸ªä½ç½®åˆ†é…ç»™keyä½¿ç”¨ï¼Œå°†keyå¤åˆ¶åˆ°æŒ‡å®šä½ç½®ï¼Œå¹¶è¿”å›å…ƒç´ æŒ‡é’ˆ</li><li>ç¬¬ä¸‰ç§ï¼Œæ‰€æœ‰æ¡¶éƒ½æ‰¾å®Œäº†ï¼Œæ²¡æœ‰åœ¨mapä¸­æ‰¾åˆ°å¯ä»¥åˆ†é…ç»™keyçš„ä½ç½®ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æº¢å‡ºæ¡¶ï¼Œå¹¶å°†keyåˆ†é…åˆ°æ¡¶ä¸­ï¼Œç„¶åå°†keyå¤åˆ¶åˆ°æŒ‡å®šä½ç½®ï¼Œå¹¶è¿”å›å…ƒç´ æŒ‡é’ˆ</li></ul><p>æœ€ç»ˆå¾—åˆ°äº†å…ƒç´ æŒ‡é’ˆåï¼Œå°±å¯ä»¥èµ‹å€¼äº†ï¼Œä¸è¿‡è¿™éƒ¨åˆ†æ“ä½œå¹¶ä¸ç”±<code>mapassign</code>å‡½æ•°æ¥å®Œæˆï¼Œå®ƒåªè´Ÿè´£è¿”å›å…ƒç´ æŒ‡é’ˆï¼Œèµ‹å€¼æ“ä½œæ˜¯åœ¨ç¼–è¯‘å™¨æœŸé—´æ’å…¥çš„ï¼Œåœ¨ä»£ç é‡Œé¢çœ‹ä¸è§ï¼Œä½†æ˜¯ç¼–è¯‘åçš„ä»£ç å¯ä»¥çœ‹è§ï¼Œå‡è®¾æœ‰ä¸‹é¢çš„ä»£ç </p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	dict <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
	dict<span class="token punctuation">[</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;world&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡å‘½ä»¤å¦‚ä¸‹å‘½ä»¤å¾—åˆ°æ±‡ç¼–ä»£ç </p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>go tool compile -S -N -l main.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å…³é”®çš„åœ°æ–¹å°±åœ¨è¿™éƒ¨åˆ†</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>0x004e 00078     LEAQ    type:map[string]string(SB), AX
0x0055 00085     CALL    runtime.mapassign_faststr(SB)
0x005a 00090     MOVQ    AX, main..autotmp_2+40(SP)
0x0083 00131     LEAQ    go:string.&quot;world&quot;(SB), CX
0x008a 00138     MOVQ    CX, (AX)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†<code>runtime.mapassign_faststr</code>ï¼Œå…¶é€»è¾‘ä¸<code>mapassign</code>å®Œå…¨ç›¸ä¼¼ï¼Œ<code>LEAQ go:string.&quot;world&quot;(SB), CX</code>å°±æ˜¯å°†å­—ç¬¦ä¸²çš„åœ°å€å­˜å‚¨åˆ°<code>CX</code>ä¸Šï¼Œ<code>MOVQ CX, (AX)</code>å†å°†å…¶å­˜å‚¨åˆ°äº†<code>AX</code>ä¸Šï¼Œäºæ˜¯å°±å®Œæˆäº†å…ƒç´ çš„èµ‹å€¼ã€‚</p><h2 id="åˆ é™¤" tabindex="-1"><a class="header-anchor" href="#åˆ é™¤" aria-hidden="true">#</a> åˆ é™¤</h2><p>åœ¨goä¸­ï¼Œè¦æƒ³åˆ é™¤ä¸€ä¸ªmapçš„å…ƒç´ ï¼Œåªèƒ½ä½¿ç”¨å†…ç½®å‡½æ•°<code>delete</code>ï¼Œå¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token function">delete</span><span class="token punctuation">(</span>dict<span class="token punctuation">,</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å…¶å†…éƒ¨è°ƒç”¨çš„æ˜¯<code>runtime.mapdelete</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ç­¾åå¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapdelete</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å®ƒä¼šåˆ é™¤mapä¸­æŒ‡å®škeyçš„å…ƒç´ ï¼Œä¸ç®¡å…ƒç´ æ˜¯å¦å­˜åœ¨äºmapä¸­ï¼Œå®ƒéƒ½ä¸ä¼šæœ‰ä»»ä½•ååº”ã€‚å‡½æ•°å¼€å¤´åšå‡†å¤‡å·¥ä½œçš„é€»è¾‘éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œæ— éå°±æ˜¯ä¸‹é¢å‡ ä»¶äº‹</p><ul><li>hmapçŠ¶æ€æ£€æŸ¥</li><li>è®¡ç®—keyçš„å“ˆå¸Œå€¼</li><li>å®šä½å“ˆå¸Œæ¡¶</li><li>è®¡ç®—tophash</li></ul><p>å‰é¢æœ‰å¾ˆå¤šé‡å¤çš„å†…å®¹ï¼Œå°±ä¸å†èµ˜è¿°äº†ï¼Œè¿™é‡Œåªå…³æ³¨å®ƒåˆ é™¤çš„é€»è¾‘ï¼Œå¯¹åº”çš„éƒ¨åˆ†ä»£ç å¦‚ä¸‹ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>bOrig <span class="token operator">:=</span> b
search<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">;</span> b <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> top <span class="token punctuation">{</span>
				<span class="token comment">// æ²¡æ‰¾åˆ°å°±é€€å‡ºå¾ªç¯</span>
				<span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> emptyRest <span class="token punctuation">{</span>
					<span class="token keyword">break</span> search
				<span class="token punctuation">}</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// ç§»åŠ¨æŒ‡é’ˆæ‰¾åˆ°keyçš„ä½ç½®</span>
			k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
			k2 <span class="token operator">:=</span> k
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				k2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k2<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> k2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			
			<span class="token comment">// åˆ é™¤key</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span>PtrBytes <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token function">memclrHasPointers</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span>Size_<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			 <span class="token comment">// ç§»åŠ¨æŒ‡é’ˆæ‰¾åˆ°å…ƒç´ çš„ä½ç½®</span>
			e <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
            
			<span class="token comment">// åˆ é™¤å…ƒç´ </span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> t<span class="token punctuation">.</span>Elem<span class="token punctuation">.</span>PtrBytes <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token function">memclrHasPointers</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">.</span>Elem<span class="token punctuation">.</span>Size_<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">memclrNoHeapPointers</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">.</span>Elem<span class="token punctuation">.</span>Size_<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
            
		notLast<span class="token punctuation">:</span>
			<span class="token comment">// æ•°é‡å‡ä¸€</span>
			h<span class="token punctuation">.</span>count<span class="token operator">--</span>
			<span class="token comment">// é‡ç½®å“ˆå¸Œç§å­ï¼Œå‡å°å†²çªå‘ç”Ÿæ¦‚ç‡</span>
			<span class="token keyword">if</span> h<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				h<span class="token punctuation">.</span>hash0 <span class="token operator">=</span> <span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span> search
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼ŒæŸ¥æ‰¾çš„é€»è¾‘è·Ÿå‰é¢çš„æ“ä½œæ˜¯å‡ ä¹å®Œå…¨ä¸€è‡´çš„ï¼Œæ‰¾åˆ°å…ƒç´ ï¼Œç„¶ååˆ é™¤ï¼Œhmapè®°å½•çš„æ•°é‡å‡ä¸€ï¼Œå½“æ•°é‡å‡ä¸º0æ—¶ï¼Œå°±é‡ç½®å“ˆå¸Œç§å­ã€‚</p><p>å¦ä¸€ä¸ªè¦æ³¨æ„çš„ç‚¹å°±æ˜¯ï¼Œåœ¨åˆ é™¤å®Œå…ƒç´ åï¼Œéœ€è¦ä¿®æ”¹å½“å‰ä¸‹æ ‡çš„tophashçŠ¶æ€ï¼Œè¿™éƒ¨åˆ†å¯¹åº”çš„ä»£ç å¦‚ä¸‹ã€‚å½“iåœ¨æ¡¶æœ«å°¾æ—¶ï¼Œåˆ¤æ–­æ ¹æ®ä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶æ¥åˆ¤æ–­å½“å‰å…ƒç´ æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªå¯ç”¨å…ƒç´ ï¼Œå¦åˆ™çš„è¯å°±ç›´æ¥æŸ¥çœ‹ç›¸é‚»å…ƒç´ çš„å“ˆå¸ŒçŠ¶æ€ã€‚å¦‚æœå½“å‰å…ƒç´ ä¸æ˜¯æœ€åä¸€ä¸ªå¯ç”¨çš„ï¼Œå°±å°†çŠ¶æ€ç½®ä¸º<code>emptyOne</code>ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// å°†å½“å‰tophashæ ‡è®°ä¸ºç©º</span>
b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> emptyOne

<span class="token comment">// å¦‚æœåœ¨tophashæœ«å°¾</span>
<span class="token keyword">if</span> i <span class="token operator">==</span> bucketCnt<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
    <span class="token comment">// æº¢å‡ºæ¡¶ä¸ä¸ºç©ºï¼Œä¸”æº¢å‡ºæ¡¶å†…æœ‰å…ƒç´ ï¼Œè¯´æ˜å½“å‰å…ƒç´ ä¸æ˜¯æœ€åä¸€ä¸ª</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>tophash<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> emptyRest <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> notLast
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç›¸é‚»å…ƒç´ ä¸ä¸ºç©º</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> emptyRest <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> notLast
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœå…ƒç´ ç¡®å®æ˜¯æœ€åä¸€ä¸ªå…ƒç´ çš„è¯ï¼Œå°±éœ€è¦ä¿®æ­£ä¸€ä¸‹æ¡¶é“¾è¡¨ä¸­éƒ¨åˆ†æ¡¶çš„tophashæ•°ç»„çš„å€¼ï¼Œå¦åˆ™çš„è¯åç»­éå†æ—¶ä¼šå¯¼è‡´æ— æ³•åœ¨æ­£ç¡®çš„ä½ç½®é€€å‡ºã€‚åœ¨mapåˆ›å»ºæº¢å‡ºæ¡¶çš„æ—¶å€™è®²è¿°è¿‡ï¼Œgoä¸ºäº†å‡å°‘è¿½è¸ªæº¢å‡ºæ¡¶çš„æˆæœ¬ï¼Œæœ€åä¸€ä¸ªæº¢å‡ºæ¡¶çš„<code>overflow</code>æŒ‡é’ˆå°±æ˜¯æŒ‡å‘å¤´éƒ¨çš„å“ˆå¸Œæ¡¶ï¼Œæ‰€ä»¥å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªå•å‘ç¯å½¢é“¾è¡¨ï¼Œé“¾è¡¨çš„â€œå¤´éƒ¨â€å°±æ˜¯å“ˆå¸Œæ¡¶ã€‚è€Œè¿™é‡Œçš„<code>b</code>æ˜¯æŸ¥æ‰¾è¿‡åçš„<code>b</code>ï¼Œå¾ˆå¯èƒ½æ˜¯é“¾è¡¨ä¸­é—´çš„æŸä¸€ä¸ªæº¢å‡ºæ¡¶ï¼Œé€†åºéå†ç¯å½¢é“¾è¡¨æŸ¥æ‰¾æœ€åä¸€ä¸ªå­˜åœ¨çš„å…ƒç´ ã€‚å°½ç®¡ä»£ç å†™çš„æ˜¯æ­£åºéå†ï¼Œç”±äºé“¾è¡¨æ˜¯ä¸€ä¸ªç¯ï¼Œå®ƒä¸æ–­æ­£åºéå†ç›´åˆ°å½“å‰æº¢å‡ºæ¡¶çš„å‰ä¸€ä¸ªä¸ºæ­¢ï¼Œä»ç»“æœä¸Šæ¥è¯´ç¡®å®æ˜¯é€†åºçš„ã€‚å†ç„¶åé€†åºéå†æ¡¶ä¸­çš„tophashæ•°ç»„ï¼Œå°†çŠ¶æ€ä¸º<code>emptyOne</code>çš„å…ƒç´ æ›´æ–°ä¸º<code>emptyRest</code>ï¼Œç›´åˆ°æ‰¾åˆ°æœ€åä¸€ä¸ªå­˜åœ¨çš„å…ƒç´ ã€‚ä¸ºé¿å…æ— é™é™·å…¥åœ¨ç¯ä¸­ï¼Œå½“å›åˆ°äº†æœ€å¼€å§‹çš„æ¡¶æ—¶ï¼Œä¹Ÿå°±æ˜¯<code>bOrig</code>ï¼Œè¯´æ˜æ­¤æ—¶é“¾è¡¨å†…å·²ç»æ²¡æœ‰å¯ç”¨çš„å…ƒç´ äº†ï¼Œå°±å¯ä»¥é€€å‡ºå¾ªç¯äº†ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜å½“å‰å…ƒç´ åé¢æ²¡æœ‰å…ƒç´ äº†</span>
<span class="token comment">// ä¸æ–­çš„å€’åºéå†bmapé“¾è¡¨ï¼Œå€’åºéå†æ¡¶å†…çš„tophash</span>
<span class="token comment">// å°†çŠ¶æ€ä¸ºemptyOneçš„æ›´æ–°ä¸ºemptyRest</span>
<span class="token keyword">for</span> <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> emptyRest
    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> b <span class="token operator">==</span> bOrig <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        
        c <span class="token operator">:=</span> b
		<span class="token comment">// æ‰¾åˆ°å½“å‰bmapé“¾è¡¨çš„å‰ä¸€ä¸ª</span>
        <span class="token keyword">for</span> b <span class="token operator">=</span> bOrig<span class="token punctuation">;</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">!=</span> c<span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        i <span class="token operator">=</span> bucketCnt <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> emptyOne <span class="token punctuation">{</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æ¸…ç©º" tabindex="-1"><a class="header-anchor" href="#æ¸…ç©º" aria-hidden="true">#</a> æ¸…ç©º</h2><p>åœ¨<code>go1.21</code>ç‰ˆæœ¬ä¸­ï¼Œæ–°å¢äº†å†…ç½®å‡½æ•°<code>clear</code>ï¼Œå¯ä»¥ç”¨äºæ¸…ç©ºmapä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œè¯­æ³•å¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token function">clear</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å…¶å†…éƒ¨è°ƒç”¨äº†<code>runtime.mapclear</code>å‡½æ•°ï¼Œå®ƒè´Ÿè´£åˆ é™¤mapä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œå…¶å‡½æ•°ç­¾åå¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapclear</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¯¥å‡½æ•°çš„é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œé¦–å…ˆéœ€è¦å°†æ•´ä¸ªmapæ ‡è®°ä¸ºç©ºï¼Œå¯¹åº”çš„ä»£ç å¦‚ä¸‹ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// éå†æ¯ä¸€ä¸ªæ¡¶ä»¥åŠæº¢å‡ºæ¡¶ï¼Œå°†æ‰€æœ‰çš„tophashå…ƒç´ ç½®ä¸ºemptyRest</span>
markBucketsEmpty <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>bucket unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> mask <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> mask<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        b <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">;</span> b <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> emptyRest
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">markBucketsEmpty</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> <span class="token function">bucketMask</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>B<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢ä»£ç åšçš„äº‹æƒ…å°±æ˜¯éå†æ¯ä¸€ä¸ªæ¡¶ï¼Œå°†æ¡¶ä¸­çš„tophashæ•°ç»„çš„å…ƒç´ éƒ½ç½®ä¸º<code>emptyRest</code>ï¼Œå°†mapæ ‡è®°ä¸ºç©ºï¼Œè¿™æ ·å°±èƒ½é˜»æ­¢è¿­ä»£å™¨ç»§ç»­è¿­ä»£ï¼Œç„¶åå†æ¸…ç©ºmapï¼Œå¯¹åº”çš„ä»£ç å¦‚ä¸‹ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// é‡ç½®å“ˆå¸Œç§å­</span>
h<span class="token punctuation">.</span>hash0 <span class="token operator">=</span> <span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// é‡ç½®extraç»“æ„ä½“</span>
<span class="token keyword">if</span> h<span class="token punctuation">.</span>extra <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>h<span class="token punctuation">.</span>extra <span class="token operator">=</span> mapextra<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// è¿™ä¸ªæ“ä½œä¼šæ¸…é™¤åŸæ¥bucketsçš„å†…å­˜ï¼Œå¹¶é‡æ–°åˆ†é…æ–°çš„æ¡¶</span>
<span class="token boolean">_</span><span class="token punctuation">,</span> nextOverflow <span class="token operator">:=</span> <span class="token function">makeBucketArray</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">.</span>B<span class="token punctuation">,</span> h<span class="token punctuation">.</span>buckets<span class="token punctuation">)</span>
<span class="token keyword">if</span> nextOverflow <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token comment">// åˆ†é…æ–°çš„ç©ºé—²æº¢å‡ºæ¡¶</span>
    h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>nextOverflow <span class="token operator">=</span> nextOverflow
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡<code>makeBucketArray</code>æ¸…é™¤ä¹‹å‰çš„æ¡¶çš„å†…å­˜ï¼Œç„¶åæ–°åˆ†é…ä¸€ä¸ªï¼Œè¿™æ ·ä¸€æ¥å°±å®Œæˆäº†æ¡¶çš„æ¸…é™¤ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€äº›ç»†èŠ‚ï¼Œæ¯”å¦‚è¯´å°†<code>count</code>ç½®0ï¼Œè¿˜æœ‰å…¶å®ƒçš„ä¸€äº›æ“ä½œå°±ä¸è¿‡å¤šèµ˜è¿°ã€‚</p><h2 id="æ‰©å®¹" tabindex="-1"><a class="header-anchor" href="#æ‰©å®¹" aria-hidden="true">#</a> æ‰©å®¹</h2><p>åœ¨ä¹‹å‰çš„æ‰€æœ‰æ“ä½œä¸­ï¼Œä¸ºäº†æ›´å…³æ³¨å…¶æœ¬èº«çš„é€»è¾‘ï¼Œæ‰€ä»¥å±è”½äº†å¾ˆå¤šè·Ÿæ‰©å®¹æœ‰å…³å†…å®¹ï¼Œè¿™æ ·ä¼šç®€å•å¾ˆå¤šã€‚æ‰©å®¹çš„é€»è¾‘å…¶å®æ¯”è¾ƒå¤æ‚ï¼Œæ”¾åœ¨æœ€åå°±æ˜¯ä¸å¸Œæœ›äº§ç”Ÿå¹²æ‰°ï¼Œé‚£ä¹ˆç°åœ¨å°±æ¥çœ‹çœ‹goæ˜¯å¦‚ä½•å¯¹mapè¿›è¡Œæ‰©å®¹çš„ï¼Œå‰é¢å·²ç»æåˆ°è¿‡ï¼Œè§¦å‘æ‰©å®¹æœ‰ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ul><li>è´Ÿè½½å› å­è¶…è¿‡6.5</li><li>æº¢å‡ºæ¡¶çš„æ•°é‡è¿‡å¤š</li></ul><p>åˆ¤æ–­è´Ÿè½½å› å­æ˜¯å¦è¶…è¿‡é˜ˆå€¼çš„å‡½æ•°æ˜¯<code>runtime.overLoadFactor</code>å‡½æ•°ï¼Œåœ¨å“ˆå¸Œå†²çªéƒ¨åˆ†å·²ç»é˜è¿°è¿‡ï¼Œè€Œåˆ¤æ–­æº¢å‡ºæ¡¶çš„æ•°é‡æ˜¯å¦è¿‡å¤šçš„å‡½æ•°æ˜¯<code>runtime.tooManyOverflowBuckets</code>ï¼Œå…¶å·¥ä½œåŸç†ä¹Ÿå¾ˆç®€å•ï¼Œä»£ç å¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">tooManyOverflowBuckets</span><span class="token punctuation">(</span>noverflow <span class="token builtin">uint16</span><span class="token punctuation">,</span> B <span class="token builtin">uint8</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> B <span class="token operator">&gt;</span> <span class="token number">15</span> <span class="token punctuation">{</span>
		B <span class="token operator">=</span> <span class="token number">15</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> noverflow <span class="token operator">&gt;=</span> <span class="token function">uint16</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>B<span class="token operator">&amp;</span><span class="token number">15</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç å¯ä»¥ç®€åŒ–æˆå¦‚ä¸‹è¡¨è¾¾å¼ï¼Œä¸€çœ¼å°±èƒ½çœ‹æ‡‚ã€‚</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>overflow &gt;= 1 &lt;&lt; (min(15,B) % 16)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åœ¨è¿™é‡Œï¼Œgoå¯¹äºtoo manyçš„å®šä¹‰æ˜¯ï¼šæº¢å‡ºæ¡¶çš„æ•°é‡è·Ÿå“ˆå¸Œæ¡¶çš„æ•°é‡å·®ä¸å¤šï¼Œå¦‚æœé˜ˆå€¼ä½äº†ï¼Œå°±ä¼šåšå¤šä½™çš„å·¥ä½œï¼Œå¦‚æœé˜ˆå€¼é«˜äº†ï¼Œé‚£ä¹ˆåœ¨æ‰©å®¹çš„æ—¶å€™å°±ä¼šå ç”¨å¤§é‡çš„å†…å­˜ã€‚åœ¨ä¿®æ”¹å’Œåˆ é™¤å…ƒç´ æ—¶å°±æœ‰å¯èƒ½è§¦å‘æ‰©å®¹ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹çš„ä»£ç å¦‚ä¸‹ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">growing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">overLoadFactor</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>count<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> h<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">tooManyOverflowBuckets</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>noverflow<span class="token punctuation">,</span> h<span class="token punctuation">.</span>B<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">hashGrow</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> again <span class="token comment">// Growing the table invalidates everything, so try again</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°çš„å°±æ˜¯è¿™ä¸‰ä¸ªæ¡ä»¶é™åˆ¶</p><ol><li>å½“å‰ä¸èƒ½æ­£åœ¨æ‰©å®¹</li><li>è´Ÿè½½å› å­å°äº6.5</li><li>æº¢å‡ºæ¡¶æ•°é‡ä¸èƒ½è¿‡å¤š</li></ol><p>è´Ÿè´£æ‰©å®¹çš„å‡½æ•°è‡ªç„¶å°±æ˜¯<code>runtime.hashGrow</code>ï¼Œå…¶å‡½æ•°ç­¾åå¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">hashGrow</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å®é™…ä¸Šï¼Œæ‰©å®¹ä¹Ÿåˆ†ç§ç±»ï¼Œæ ¹æ®ä¸åŒæ¡ä»¶è§¦å‘çš„æ‰©å®¹å…¶ç±»å‹ä¹Ÿä¸åŒï¼Œåˆ†ä¸ºä»¥ä¸‹ä¸¤ç§</p><ul><li>å¢é‡æ‰©å®¹</li><li>ç­‰é‡æ‰©å®¹</li></ul><h3 id="å¢é‡æ‰©å®¹" tabindex="-1"><a class="header-anchor" href="#å¢é‡æ‰©å®¹" aria-hidden="true">#</a> å¢é‡æ‰©å®¹</h3><p>å½“è´Ÿè½½å› å­è¿‡å¤§æ—¶ï¼Œå³å…ƒç´ æ•°é‡è¾ƒå¤§äºå“ˆå¸Œæ¡¶çš„æ•°é‡ï¼Œå½“å“ˆå¸Œå†²çªæ¯”è¾ƒä¸¥é‡çš„æ—¶å€™ï¼Œä¼šå½¢æˆå¾ˆå¤šæº¢å‡ºæ¡¶é“¾è¡¨ï¼Œè¿™æ ·ä¼šå¯¼è‡´mapè¯»å†™æ€§èƒ½ä¸‹é™ï¼Œå› ä¸ºéœ€è¦æŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ éå†æ›´å¤šçš„æº¢å‡ºæ¡¶é“¾è¡¨ï¼Œè€Œéå†çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(n)ï¼Œå“ˆå¸Œè¡¨æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸»è¦å–å†³äºå“ˆå¸Œå€¼çš„è®¡ç®—æ—¶é—´å’Œéå†çš„æ—¶é—´ï¼Œå½“éå†çš„æ—¶é—´è¿œå°äºè®¡ç®—å“ˆå¸Œçš„æ—¶é—´æ—¶ï¼ŒæŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦æ‰èƒ½ç§°ä¸ºO(1)ã€‚å€˜è‹¥å“ˆå¸Œå†²çªæ¯”è¾ƒé¢‘ç¹ï¼Œè¿‡å¤škeyéƒ½è¢«åˆ†é…åˆ°äº†åŒä¸€ä¸ªå“ˆå¸Œæ¡¶ï¼Œæº¢å‡ºæ¡¶é“¾è¡¨è¿‡é•¿å¯¼è‡´éå†æ—¶é—´å¢å¤§ï¼Œå°±ä¼šå¯¼è‡´æŸ¥æ‰¾æ—¶é—´å¢å¤§ï¼Œè€Œå¢åˆ æ”¹æ“ä½œéƒ½éœ€è¦å…ˆè¿›è¡ŒæŸ¥æ‰¾æ“ä½œï¼Œè¿™æ ·ä¸€æ¥çš„è¯å°±ä¼šå¯¼è‡´æ•´ä¸ªmapçš„æ€§èƒ½ä¸¥é‡ä¸‹é™ã€‚</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202310072010330.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>åƒå›¾ä¸­è¿™ç§æ¯”è¾ƒæç«¯çš„æƒ…å†µï¼ŒæŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦åŸºæœ¬ä¸Šè·ŸO(n)æ²¡å•¥åŒºåˆ«äº†ã€‚é¢å¯¹è¿™ç§æƒ…å†µï¼Œè§£å†³åŠæ³•å°±æ˜¯æ–°å¢æ›´å¤šçš„å“ˆå¸Œæ¡¶ï¼Œé¿å…å½¢æˆè¿‡é•¿çš„æº¢å‡ºæ¡¶é“¾è¡¨ï¼Œè¿™ç§æ–¹æ³•ä¹Ÿè¢«ç§°ä¸ºå¢é‡æ‰©å®¹ã€‚</p><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202310080936033.png" style="zoom:50%;"><p>åœ¨goä¸­ï¼Œå¢é‡æ‰©å®¹æ¯æ¬¡éƒ½ä¼šå°†BåŠ ä¸€ï¼Œä¹Ÿå°±æ˜¯å“ˆå¸Œæ¡¶çš„è§„æ¨¡æ¯æ¬¡æ‰©å¤§ä¸€å€ã€‚æ‰©å®¹åï¼Œéœ€è¦å°†æ—§æ•°æ®æ¬è¿åˆ°æ–°çš„mapä¸­ï¼Œå€˜è‹¥mapä¸­çš„å…ƒç´ æ•°é‡ä»¥åƒä¸‡ç”šè‡³äº¿è®¡ï¼Œä¸€æ¬¡æ€§å…¨éƒ¨æ¬è¿å®Œçš„è¯è€—æ—¶ä¼šå¾ˆä¹…ï¼Œæ‰€ä»¥goé‡‡ç”¨çš„æ˜¯é€æ­¥æ¬è¿çš„ç­–ç•¥ï¼Œä¸ºæ­¤ï¼Œgoä¼šå°†hampä¸­çš„<code>oldBuckets</code>æŒ‡å‘åŸæ¥çš„å“ˆå¸Œæ¡¶æ•°ç»„ï¼Œè¡¨ç¤ºè¿™æ˜¯æ—§æ•°æ®ï¼Œç„¶ååˆ›å»ºæ›´å¤§å®¹é‡çš„å“ˆå¸Œæ¡¶æ•°ç»„ï¼Œè®©<code>hmap</code>ä¸­çš„<code>buckets</code>æŒ‡å‘æ–°çš„å“ˆå¸Œæ¡¶æ•°ç»„ï¼Œç„¶ååœ¨æ¯ä¸€æ¬¡ä¿®æ”¹å’Œåˆ é™¤å…ƒç´ æ—¶ï¼Œå°†éƒ¨åˆ†å…ƒç´ æ¬è¿ä»æ—§æ¡¶æ¬åˆ°æ–°æ¡¶ï¼Œç›´åˆ°æ¬è¿å®Œæ¯•ï¼Œæ—§æ¡¶çš„å†…å­˜æ‰ä¼šè¢«é‡Šæ”¾æ‰ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">hashGrow</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// å·®å€¼</span>
	bigger <span class="token operator">:=</span> <span class="token function">uint8</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token comment">// æ—§æ¡¶</span>
	oldbuckets <span class="token operator">:=</span> h<span class="token punctuation">.</span>buckets
	<span class="token comment">// æ–°çš„å“ˆå¸Œæ¡¶</span>
	newbuckets<span class="token punctuation">,</span> nextOverflow <span class="token operator">:=</span> <span class="token function">makeBucketArray</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">.</span>B<span class="token operator">+</span>bigger<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>

	flags <span class="token operator">:=</span> h<span class="token punctuation">.</span>flags <span class="token operator">&amp;^</span> <span class="token punctuation">(</span>iterator <span class="token operator">|</span> oldIterator<span class="token punctuation">)</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>iterator <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		flags <span class="token operator">|=</span> oldIterator
	<span class="token punctuation">}</span>
	<span class="token comment">// B+bigger</span>
	h<span class="token punctuation">.</span>B <span class="token operator">+=</span> bigger
	h<span class="token punctuation">.</span>flags <span class="token operator">=</span> flags
	h<span class="token punctuation">.</span>oldbuckets <span class="token operator">=</span> oldbuckets
	h<span class="token punctuation">.</span>buckets <span class="token operator">=</span> newbuckets
	h<span class="token punctuation">.</span>nevacuate <span class="token operator">=</span> <span class="token number">0</span>
	h<span class="token punctuation">.</span>noverflow <span class="token operator">=</span> <span class="token number">0</span>
	
	<span class="token comment">// æº¢å‡ºæ¡¶ä¹Ÿè¦æŒ‡å®šæ—§æ¡¶å’Œæ–°æ¡¶</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span>extra <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>overflow <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>oldoverflow <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;oldoverflow is not nil&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>oldoverflow <span class="token operator">=</span> h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>overflow
		h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>overflow <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> nextOverflow <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> h<span class="token punctuation">.</span>extra <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			h<span class="token punctuation">.</span>extra <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>mapextra<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>nextOverflow <span class="token operator">=</span> nextOverflow
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç åšçš„äº‹æƒ…å°±æ˜¯åˆ›å»ºå¤§ä¸€å€å®¹é‡çš„æ–°å“ˆå¸Œæ¡¶ï¼Œç„¶åæŒ‡å®šå“ˆå¸Œæ–°æ—§æ¡¶çš„å¼•ç”¨ï¼Œä»¥åŠæº¢å‡ºæ–°æ—§æ¡¶çš„å¼•ç”¨ï¼Œè€Œå®é™…çš„æ¬è¿å·¥ä½œå¹¶ä¸ç”±<code>hashGrow</code>å‡½æ•°æ¥å®Œæˆï¼Œå®ƒåªè´Ÿè´£æŒ‡å®šæ–°æ—§æ¡¶ï¼Œå¹¶æ›´æ–°<code>hmap</code>çš„ä¸€äº›çŠ¶æ€ã€‚è¿™äº›å·¥ä½œå®é™…ä¸Šæ˜¯ç”±<code>runtime.growWork</code>å‡½æ•°å®Œæˆçš„ï¼Œå…¶å‡½æ•°ç­¾åå¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">growWork</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> bucket <span class="token builtin">uintptr</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å®ƒä¼šåœ¨<code>mapassign</code>å‡½æ•°å’Œ<code>mapdelete</code>å‡½æ•°ä¸­ï¼Œä»¥å¦‚ä¸‹çš„å½¢å¼è¢«è°ƒç”¨ï¼Œå…¶ä½œç”¨å°±æ˜¯å¦‚æœå½“å‰mapæ­£åœ¨æ‰©å®¹ä¸­ï¼Œå°±è¿›è¡Œä¸€æ¬¡éƒ¨åˆ†æ¬è¿å·¥ä½œã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> h<span class="token punctuation">.</span><span class="token function">growing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">growWork</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">,</span> bucket<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿›è¡Œä¿®æ”¹å’Œåˆ é™¤æ“ä½œæ—¶ï¼Œéœ€è¦åˆ¤æ–­å½“å‰æ˜¯å¦å¤„äºæ‰©å®¹ä¸­ï¼Œè¿™ä¸»è¦ç”±<code>hmap.growing</code>æ–¹æ³•æ¥å®Œæˆï¼Œå†…å®¹å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ¤æ–­<code>oldbuckets</code>æ˜¯å¦ä¸ºä¸ä¸ºç©ºï¼Œå¯¹åº”ä»£ç å¦‚ä¸‹ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>hmap<span class="token punctuation">)</span> <span class="token function">growing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> h<span class="token punctuation">.</span>oldbuckets <span class="token operator">!=</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥çœ‹çœ‹<code>growWork</code>å‡½æ•°éƒ½å¹²äº†äº›ä»€ä¹ˆã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">growWork</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> bucket <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// bucket % 1 &lt;&lt; (B-1)</span>
	<span class="token function">evacuate</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">,</span> bucket<span class="token operator">&amp;</span>h<span class="token punctuation">.</span><span class="token function">oldbucketmask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span><span class="token function">growing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">evacuate</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">,</span> h<span class="token punctuation">.</span>nevacuate<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­<code>bucket&amp;h.oldbucketmask()</code>æ“ä½œæ˜¯è®¡ç®—å¾—åˆ°æ—§æ¡¶çš„ä½ç½®ï¼Œç¡®ä¿å°†è¦æ¬è¿çš„æ˜¯å½“å‰æ¡¶çš„æ—§æ¡¶ã€‚ä»å‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°çœŸæ­£è´Ÿè´£æ¬è¿å·¥ä½œçš„æ˜¯<code>runtime.evacuate</code>å‡½æ•°ï¼Œå…¶ä¸­ç”¨åˆ°äº†<code>evaDst</code>ç»“æ„ä½“ç”¨æ¥è¡¨ç¤ºæ¬è¿ç›®çš„åœ°ï¼Œä¸»è¦ä½œç”¨æ˜¯åœ¨æ¬è¿çš„è¿‡ç¨‹ä¸­è¿­ä»£æ–°æ¡¶ï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> evacDst <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	b <span class="token operator">*</span>bmap          <span class="token comment">// æ¬è¿ç›®çš„åœ°çš„æ–°æ¡¶</span>
	i <span class="token builtin">int</span>            <span class="token comment">// æ¡¶å†…ä¸‹æ ‡</span>
	k unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// æŒ‡å‘æ–°é”®ç›®çš„åœ°çš„æŒ‡é’ˆ</span>
	e unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// æŒ‡å‘æ–°å€¼ç›®çš„åœ°çš„æŒ‡é’ˆ</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æ¬è¿å¼€å§‹ä¹‹å‰ï¼Œgoä¼šåˆ†é…ä¸¤ä¸ª<code>evacDst</code>ç»“æ„ä½“ï¼Œä¸€ä¸ªæŒ‡å‘æ–°å“ˆå¸Œæ¡¶çš„ä¸ŠåŠåŒºï¼Œå¦ä¸€ä¸ªæŒ‡å‘æ–°å“ˆå¸Œæ¡¶çš„ä¸‹åŠåŒºï¼Œå¯¹åº”çš„ä»£ç å¦‚ä¸‹</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// å®šä½æ—§æ¡¶ä¸­æŒ‡å®šçš„å“ˆå¸Œæ¡¶</span>
b <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>oldbuckets<span class="token punctuation">,</span> oldbucket<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// æ—§æ¡¶çš„é•¿åº¦ = 1 &lt;&lt; (B - 1)</span>
newbit <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">noldbuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> xy <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>evacDst
x <span class="token operator">:=</span> <span class="token operator">&amp;</span>xy<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token comment">// æŒ‡å‘æ–°æ¡¶çš„ä¸ŠåŠåŒº</span>
x<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> oldbucket<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
x<span class="token punctuation">.</span>k <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token punctuation">)</span>
x<span class="token punctuation">.</span>e <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>k<span class="token punctuation">,</span> bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯ç­‰é‡æ‰©å®¹</span>
<span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">sameSizeGrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    y <span class="token operator">:=</span> <span class="token operator">&amp;</span>xy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment">// æŒ‡å‘æ–°æ¡¶çš„ä¸‹åŠåŒº</span>
    y<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> <span class="token punctuation">(</span>oldbucket<span class="token operator">+</span>newbit<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    y<span class="token punctuation">.</span>k <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token punctuation">)</span>
    y<span class="token punctuation">.</span>e <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>k<span class="token punctuation">,</span> bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ—§æ¡¶çš„æ¬è¿ç›®çš„åœ°æ˜¯ä¸¤ä¸ªæ–°æ¡¶ï¼Œæ¬è¿åï¼Œæ¡¶ä¸­çš„éƒ¨åˆ†æ•°æ®ä¼šåœ¨ä¸ŠåŠåŒºï¼Œå¦ä¸€éƒ¨åˆ†çš„æ•°æ®ä¼šåœ¨ä¸‹åŠåŒºï¼Œè¿™æ ·åšæ˜¯å¸Œæœ›æ‰©å®¹åçš„æ•°æ®èƒ½å¤Ÿæ›´åŠ å‡åŒ€çš„åˆ†å¸ƒï¼Œåˆ†å¸ƒçš„è¶Šå‡åŒ€ï¼Œmapçš„æŸ¥æ‰¾æ€§èƒ½å°±ä¼šè¶Šå¥½ã€‚goå¦‚ä½•å°†æ•°æ®æ¬è¿åˆ°ä¸¤ä¸ªæ–°æ¡¶ä¸­ï¼Œå¯¹åº”ç€ä¸‹é¢çš„ä»£ç ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// éå†æº¢å‡ºæ¡¶é“¾è¡¨</span>
<span class="token keyword">for</span> <span class="token punctuation">;</span> b <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‹¿åˆ°æ¯ä¸ªæ¡¶çš„ç¬¬ä¸€é”®å€¼å¯¹</span>
    k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token punctuation">)</span>
    e <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// éå†æ¡¶ä¸­çš„æ¯ä¸€ä¸ªé”®å€¼å¯¹</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token punctuation">,</span> k<span class="token punctuation">,</span> e <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        top <span class="token operator">:=</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token comment">// å¦‚æœæ˜¯ç©ºçš„å°±è·³è¿‡</span>
        <span class="token keyword">if</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span>top<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> evacuatedEmpty
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ–°å“ˆå¸Œæ¡¶ä¸åº”è¯¥å¤„äºæ¬è¿çŠ¶æ€</span>
        <span class="token comment">// å¦åˆ™çš„è¯è‚¯å®šæ˜¯å‡ºé—®é¢˜äº†</span>
        <span class="token keyword">if</span> top <span class="token operator">&lt;</span> minTopHash <span class="token punctuation">{</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;bad map state&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        k2 <span class="token operator">:=</span> k
        <span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            k2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k2<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è¯¥å˜é‡å†³å®šäº†å½“å‰é”®å€¼å¯¹è¢«æ¬è¿åˆ°ä¸ŠåŠåŒºè¿˜æ˜¯ä¸‹åŠåŒº</span>
        <span class="token comment">// å®ƒçš„å€¼åªèƒ½æ˜¯0æˆ–1</span>
        <span class="token keyword">var</span> useY <span class="token builtin">uint8</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">sameSizeGrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// é‡æ–°è®¡ç®—å“ˆå¸Œå€¼</span>
            hash <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Hasher</span><span class="token punctuation">(</span>k2<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hash0<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// å¤„ç†k2 != k2çš„ç‰¹æ®Šæƒ…å†µï¼Œ</span>
            <span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>iterator <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">ReflexiveKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>k2<span class="token punctuation">,</span> k2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                useY <span class="token operator">=</span> top <span class="token operator">&amp;</span> <span class="token number">1</span>
                top <span class="token operator">=</span> <span class="token function">tophash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// hash % 1 &lt;&lt; (B - 1)</span>
                <span class="token keyword">if</span> hash<span class="token operator">&amp;</span>newbit <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                    useY <span class="token operator">=</span> <span class="token number">1</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ£€æŸ¥å¸¸é‡çš„å€¼</span>
        <span class="token keyword">if</span> evacuatedX<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">!=</span> evacuatedY <span class="token operator">||</span> evacuatedX<span class="token operator">^</span><span class="token number">1</span> <span class="token operator">!=</span> evacuatedY <span class="token punctuation">{</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;bad evacuatedN&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
		
        <span class="token comment">// æ›´æ–°æ—§æ¡¶çš„tophashï¼Œè¡¨ç¤ºå½“å‰å…ƒç´ å·²è¢«æ¬è¿</span>
        b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> evacuatedX <span class="token operator">+</span> useY <span class="token comment">// evacuatedX + 1 == evacuatedY</span>
        <span class="token comment">// æŒ‡å®šæ¬è¿ç›®çš„åœ°</span>
        dst <span class="token operator">:=</span> <span class="token operator">&amp;</span>xy<span class="token punctuation">[</span>useY<span class="token punctuation">]</span>                 <span class="token comment">// evacuation destination</span>
		
        <span class="token comment">// æ–°æ¡¶å®¹é‡ä¸å¤Ÿç”¨äº†å»ºä¸ªæº¢å‡ºæ¡¶</span>
        <span class="token keyword">if</span> dst<span class="token punctuation">.</span>i <span class="token operator">==</span> bucketCnt <span class="token punctuation">{</span>
            dst<span class="token punctuation">.</span>b <span class="token operator">=</span> h<span class="token punctuation">.</span><span class="token function">newoverflow</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>b<span class="token punctuation">)</span>
            dst<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token number">0</span>
            dst<span class="token punctuation">.</span>k <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>dst<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token punctuation">)</span>
            dst<span class="token punctuation">.</span>e <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>dst<span class="token punctuation">.</span>k<span class="token punctuation">,</span> bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        dst<span class="token punctuation">.</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>dst<span class="token punctuation">.</span>i<span class="token operator">&amp;</span><span class="token punctuation">(</span>bucketCnt<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> top <span class="token comment">// mask dst.i as an optimization, to avoid a bounds check</span>
        <span class="token comment">// å¤åˆ¶é”®</span>
        <span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>dst<span class="token punctuation">.</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> k2 <span class="token comment">// copy pointer</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>k<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token comment">// copy elem</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å¤åˆ¶å€¼</span>
        <span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">IndirectElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>dst<span class="token punctuation">.</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Elem<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>e<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// åç§»æ–°æ¡¶ç›®çš„æŒ‡é’ˆï¼Œä¸ºä¸‹ä¸€ä¸ªé”®å€¼åšå‡†å¤‡</span>
        dst<span class="token punctuation">.</span>i<span class="token operator">++</span>
        dst<span class="token punctuation">.</span>k <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>dst<span class="token punctuation">.</span>k<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
        dst<span class="token punctuation">.</span>e <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>dst<span class="token punctuation">.</span>e<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>ValueSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œgoä¼šéå†æ—§æ¡¶é“¾è¡¨ä¸­çš„æ¯ä¸€ä¸ªæ¡¶ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œå°†å…¶ä¸­çš„æ•°æ®æ¬åˆ°æ–°æ¡¶ä¸­ï¼Œå†³å®šæ•°æ®åˆ°åº•æ˜¯å»ä¸ŠåŠåŒºè¿˜æ˜¯ä¸‹åŠåŒºå–å†³äºé‡æ–°è®¡ç®—åçš„å“ˆå¸Œå€¼</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// hash % 1 &lt;&lt; (B - 1)</span>
<span class="token keyword">if</span> hash<span class="token operator">&amp;</span>newbit <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    useY <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æ¬è¿åï¼Œä¼šå°†å½“å‰å…ƒç´ çš„tophashç½®ä¸º<code>evacuatedX</code>æˆ–<code>evacuated</code>ï¼Œå¦‚æœåœ¨æ‰©å®¹çš„è¿‡ç¨‹ä¸­å°è¯•æŸ¥æ‰¾æ•°æ®ï¼Œé€šè¿‡æ­¤çŠ¶æ€å°±å¯ä»¥å¾—çŸ¥æ•°æ®å·²ç»è¢«æ¬è¿ï¼Œå°±çŸ¥é“è¦å»æ–°æ¡¶é‡Œé¢æ‰¾å¯¹åº”çš„æ•°æ®ã€‚è¿™éƒ¨åˆ†é€»è¾‘å¯¹åº”<code>runtime.mapaccess1</code>å‡½æ•°ä¸­çš„å¦‚ä¸‹ä»£ç ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> c <span class="token operator">:=</span> h<span class="token punctuation">.</span>oldbuckets<span class="token punctuation">;</span> c <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">sameSizeGrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// There used to be half as many buckets; mask down one more power of two.</span>
        m <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    oldb <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token punctuation">(</span>hash<span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// å¦‚æœæ—§æ¡¶å·²ç»è¢«æ¬è¿äº†å°±ä¸æ‰¾äº†</span>
    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">evacuated</span><span class="token punctuation">(</span>oldb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        b <span class="token operator">=</span> oldb
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è®¿é—®å…ƒç´ æ—¶ï¼Œå¦‚æœå½“å‰æ­£å¤„äºæ‰©å®¹çŠ¶æ€ï¼Œä¼šå…ˆå»å°è¯•å»æ—§æ¡¶é‡Œé¢æŸ¥æ‰¾ï¼Œå¦‚æœæ—§æ¡¶å·²ç»è¢«æ¬è¿äº†å°±ä¸å»æ—§æ¡¶é‡Œé¢æ‰¾ã€‚å›åˆ°æ¬è¿è¿™å—ï¼Œæ­¤æ—¶å·²ç»ç¡®å®šäº†æ¬è¿çš„ç›®çš„åœ°ï¼Œæ¥ä¸‹æ¥è¦åšå°±æ˜¯å°†æ•°æ®å¤åˆ¶åˆ°æ–°æ¡¶ä¸­ï¼Œç„¶åè®©<code>evacDst</code>ç»“æ„ä½“æŒ‡å‘ä¸‹ä¸€ä¸ªç›®çš„åœ°ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>dst <span class="token operator">:=</span> <span class="token operator">&amp;</span>xy<span class="token punctuation">[</span>useY<span class="token punctuation">]</span> 
dst<span class="token punctuation">.</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>dst<span class="token punctuation">.</span>i<span class="token operator">&amp;</span><span class="token punctuation">(</span>bucketCnt<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> top
<span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>k<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
<span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Elem<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>e<span class="token punctuation">,</span> e<span class="token punctuation">)</span>

<span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>oldIterator <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span>Bucket<span class="token punctuation">.</span>PtrBytes <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    b <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>oldbuckets<span class="token punctuation">,</span> oldbucket<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
    ptr <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> dataOffset<span class="token punctuation">)</span>
    n <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span> <span class="token operator">-</span> dataOffset
    <span class="token function">memclrHasPointers</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·æ“ä½œç›´åˆ°å½“å‰æ¡¶å…¨éƒ¨æ¬è¿å®Œæ¯•ï¼Œç„¶ågoå°±ä¼šå°†å½“å‰æ—§æ¡¶é”®å€¼æ•°æ®å…¨éƒ¨å†…å­˜æ¸…é™¤ï¼Œåªç•™ä¸‹ä¸€ä¸ªå“ˆå¸Œæ¡¶tophashæ•°ç»„ï¼ˆç•™ä¸‹æ˜¯å› ä¸ºåç»­è¦é tophashæ•°ç»„åˆ¤æ–­æ¬è¿çŠ¶æ€ï¼‰ï¼Œæ—§æ¡¶ä¸­çš„æº¢å‡ºæ¡¶å†…å­˜ç”±äºä¸å†è¢«å¼•ç”¨åç»­ä¼šè¢«GCå›æ”¶æ‰ã€‚<code>hmap</code>ä¸­æœ‰ä¸€ä¸ªå­—æ®µ<code>nevacuate</code>ç”¨æ¥è®°å½•æ¬è¿è¿›åº¦ï¼Œæ¯æ¬å®Œä¸€ä¸ªæ—§çš„å“ˆå¸Œæ¡¶ï¼Œå°±ä¼šåŠ ä¸€ï¼Œå½“å®ƒçš„å€¼ä¸æ—§æ¡¶çš„æ•°é‡ç›¸ç­‰æ—¶ï¼Œå°±è¯´æ˜æ•´ä¸ªmapçš„æ‰©å®¹å·²ç»å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å°±ç”±<code>runtime.advanceEvacuationMark</code>å‡½æ•°è¿›è¡Œæ‰©å®¹çš„æ”¶å°¾å·¥ä½œã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">advanceEvacuationMark</span><span class="token punctuation">(</span>h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> newbit <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	h<span class="token punctuation">.</span>nevacuate<span class="token operator">++</span>
	stop <span class="token operator">:=</span> h<span class="token punctuation">.</span>nevacuate <span class="token operator">+</span> <span class="token number">1024</span>
	<span class="token keyword">if</span> stop <span class="token operator">&gt;</span> newbit <span class="token punctuation">{</span>
		stop <span class="token operator">=</span> newbit
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> h<span class="token punctuation">.</span>nevacuate <span class="token operator">!=</span> stop <span class="token operator">&amp;&amp;</span> <span class="token function">bucketEvacuated</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">,</span> h<span class="token punctuation">.</span>nevacuate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		h<span class="token punctuation">.</span>nevacuate<span class="token operator">++</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">if</span> h<span class="token punctuation">.</span>nevacuate <span class="token operator">==</span> newbit <span class="token punctuation">{</span> <span class="token comment">// newbit = len(oldbuckets)</span>
		h<span class="token punctuation">.</span>oldbuckets <span class="token operator">=</span> <span class="token boolean">nil</span>
		<span class="token keyword">if</span> h<span class="token punctuation">.</span>extra <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>oldoverflow <span class="token operator">=</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		h<span class="token punctuation">.</span>flags <span class="token operator">&amp;^=</span> sameSizeGrow
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ƒä¼šç»Ÿè®¡å·²æ¬è¿æ•°é‡å¹¶ç¡®è®¤æ˜¯å¦ä¸æ—§æ¡¶æ•°é‡ç›¸ç­‰ï¼Œç›¸ç­‰çš„è¯å°±æ¸…é™¤å¯¹äºæ‰€æœ‰æ—§æ¡¶å’Œæ—§æº¢å‡ºæ¡¶çš„å¼•ç”¨ï¼Œè‡³æ­¤æ‰©å®¹å®Œæ¯•ã€‚</p><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202310081152771.png" style="zoom:50%;"><p>åœ¨<code>growWork</code>å‡½æ•°ä¸­ï¼Œæ€»å…±è°ƒç”¨äº†ä¸¤æ¬¡<code>evacuate</code>å‡½æ•°ï¼Œç¬¬ä¸€æ¬¡æ˜¯æ¬å½“å‰æ­£åœ¨è®¿é—®æ¡¶çš„æ—§æ¡¶ï¼Œç¬¬äºŒæ¬¡æ˜¯æ¬<code>h.nevacuate</code>æ‰€æŒ‡å‘çš„æ—§æ¡¶ï¼Œæ€»å…±æ¬äº†ä¸¤æ¬¡ï¼Œè¯´æ˜é€æ­¥æ¬è¿æ—¶ï¼Œæ¯ä¸€æ¬¡éƒ½ä¼šæ¬ä¸¤ä¸ªæ¡¶ã€‚</p><h3 id="ç­‰é‡æ‰©å®¹" tabindex="-1"><a class="header-anchor" href="#ç­‰é‡æ‰©å®¹" aria-hidden="true">#</a> ç­‰é‡æ‰©å®¹</h3><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202310081459150.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å‰é¢æåˆ°è¿‡ï¼Œç­‰é‡æ‰©å®¹çš„è§¦å‘æ¡ä»¶æ˜¯æº¢å‡ºæ¡¶æ•°é‡è¿‡å¤šï¼Œå‡å¦‚mapå…ˆæ˜¯æ·»åŠ äº†å¤§é‡çš„å…ƒç´ ï¼Œç„¶ååˆå¤§é‡åˆ é™¤å…ƒç´ ï¼Œè¿™æ ·ä¸€æ¥å¯èƒ½å¾ˆå¤šæ¡¶éƒ½æ˜¯ç©ºçš„ï¼Œå¯èƒ½æœ‰äº›æ¡¶æœ‰å¾ˆå¤šçš„å…ƒç´ ï¼Œæ•°æ®åˆ†å¸ƒååˆ†ä¸å‡åŒ€ï¼Œæœ‰ç›¸å½“å¤šçš„æº¢å‡ºæ¡¶éƒ½æ˜¯ç©ºçš„ï¼Œå ç”¨äº†ä¸å°‘çš„å†…å­˜ã€‚ä¸ºäº†è§£å†³è¿™ç±»é—®é¢˜ï¼Œå°±éœ€è¦åˆ›å»ºä¸€ä¸ªåŒç­‰å®¹é‡çš„æ–°mapï¼Œé‡æ–°åˆ†é…ä¸€æ¬¡å“ˆå¸Œæ¡¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«ç­‰é‡æ‰©å®¹ã€‚æ‰€ä»¥å…¶å®å¹¶ä¸æ˜¯æ‰©å®¹æ“ä½œï¼Œåªæ˜¯å°†æ‰€æœ‰å…ƒç´ äºŒæ¬¡åˆ†é…ä½¿æ•°æ®åˆ†å¸ƒæ›´åŠ å‡åŒ€ï¼Œç­‰é‡æ‰©å®¹æ“ä½œæ˜¯ç³…åˆåœ¨å¢é‡æ‰©å®¹æ“ä½œä¸­çš„ï¼Œå…¶é€»è¾‘ä¸å¢é‡æ‰©å®¹å®Œå…¨ä¸€è‡´ï¼Œæ–°æ—§mapå®¹é‡å®Œå…¨ç›¸ç­‰ã€‚</p><p>åœ¨<code>hashGrow</code>å‡½æ•°ä¸­ï¼Œå¦‚æœè´Ÿè½½å› å­æ²¡æœ‰è¶…è¿‡é˜ˆå€¼ï¼Œè¿›è¡Œçš„å°±æ˜¯ç­‰é‡æ‰©å®¹ï¼Œgoæ›´æ–°<code>h.flags</code>çš„çŠ¶æ€ä¸º<code>sameSizeGrow</code>ï¼Œ<code>h.B</code>ä¹Ÿä¸ä¼šåŠ ä¸€ï¼Œæ‰€ä»¥æ–°åˆ›å»ºçš„å“ˆå¸Œæ¡¶å®¹é‡ä¹Ÿä¸ä¼šæœ‰å˜åŒ–ï¼Œå¯¹åº”ä»£ç å¦‚ä¸‹ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>bigger <span class="token operator">:=</span> <span class="token function">uint8</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">overLoadFactor</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>count<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> h<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bigger <span class="token operator">=</span> <span class="token number">0</span>
    h<span class="token punctuation">.</span>flags <span class="token operator">|=</span> sameSizeGrow
<span class="token punctuation">}</span>
oldbuckets <span class="token operator">:=</span> h<span class="token punctuation">.</span>buckets
newbuckets<span class="token punctuation">,</span> nextOverflow <span class="token operator">:=</span> <span class="token function">makeBucketArray</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">.</span>B<span class="token operator">+</span>bigger<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨<code>evacuate</code>å‡½æ•°ä¸­ï¼Œåˆšå¼€å§‹åˆ›å»º<code>eavcDst</code>ç»“æ„ä½“æ—¶ï¼Œå¦‚æœæ˜¯ç­‰é‡æ‰©å®¹çš„è¯å°±åªä¼šåˆ›å»ºä¸€ä¸ªç»“æ„ä½“æŒ‡å‘æ–°æ¡¶ï¼Œå¯¹åº”ä»£ç å¦‚ä¸‹ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">sameSizeGrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    y <span class="token operator">:=</span> <span class="token operator">&amp;</span>xy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    y<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> <span class="token punctuation">(</span>oldbucket<span class="token operator">+</span>newbit<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>BucketSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    y<span class="token punctuation">.</span>k <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token punctuation">)</span>
    y<span class="token punctuation">.</span>e <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>k<span class="token punctuation">,</span> bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>KeySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¹¶ä¸”åœ¨æ¬è¿å…ƒç´ çš„æ—¶å€™ï¼Œç­‰é‡æ‰©å®¹ä¸ä¼šé‡æ–°è®¡ç®—å“ˆå¸Œå€¼ï¼Œä¹Ÿæ²¡æœ‰ä¸Šä¸‹åŠåŒºçš„é€‰æ‹©</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">sameSizeGrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é‡æ–°è®¡ç®—å“ˆå¸Œå€¼</span>
    hash <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Hasher</span><span class="token punctuation">(</span>k2<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hash0<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// å¤„ç†k2 != k2çš„ç‰¹æ®Šæƒ…å†µï¼Œ</span>
    <span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>iterator <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">ReflexiveKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>k2<span class="token punctuation">,</span> k2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        useY <span class="token operator">=</span> top <span class="token operator">&amp;</span> <span class="token number">1</span>
        top <span class="token operator">=</span> <span class="token function">tophash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// hash % 1 &lt;&lt; (B - 1)</span>
        <span class="token keyword">if</span> hash<span class="token operator">&amp;</span>newbit <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            useY <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é™¤äº†è¿™äº›ï¼Œå…¶å®ƒçš„é€»è¾‘ä¸å¢é‡æ‰©å®¹å®Œå…¨ä¸€è‡´ã€‚ç»è¿‡ç­‰é‡æ‰©å®¹å“ˆå¸Œæ¡¶é‡æ–°åˆ†é…è¿‡åï¼Œæº¢å‡ºæ¡¶çš„æ•°é‡å°±ä¼šå‡å°‘ï¼Œæ—§çš„æº¢å‡ºæ¡¶éƒ½ä¼šè¢«GCå›æ”¶æ‰ã€‚</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/CQUT-Programmer/Golang-Doc/edit/main/src/advance/impl/1.map.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 2633565580@qq.com">246859</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/advance/impl/0.slice.html" class="nav-link prev" aria-label="slice"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->slice</div></a><a href="/advance/impl/2.string.html" class="nav-link next" aria-label="string"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">string<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-3f1254a1.js" defer></script>
  </body>
</html>
